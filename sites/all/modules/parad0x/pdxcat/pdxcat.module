<?php
require_once getcwd() . '/sites/all/themes/pdxneedto/my.inc';

define('PDXCAT_NAME', 'catalog');
define('PDXCAT_FIELD', 'taxonomy_catalog');
define('PDXCAT_SUB_VID', 8);
define('PDXCAT_SUB_FIELD', 'field_subpart');
define('PDXCAT_SUB_VID2', 1);
define('PDXCAT_SUB_FIELD2', 'field_tags');
define('PDXCAT_ITEMS', 40);
define('PDXCAT_USERITEMS', 30);
define('PDXCAT_USERNAME', 'users/rents');

function pdxcat_menu() {
  $mypage = array();
  
  $terms = db_query('select tid, name from {taxonomy_term_data} where vid=2');
  while($term=$terms->fetchAssoc()){
    $mypage[PDXCAT_NAME.'/'.$term['tid']] = array(
        'title' => $term['name'],
        'page callback' => 'pdxcat_page_cat',
        'page arguments' => array($term['tid']),
        'access callback' => TRUE,
    );
  }
  $terms = db_query('select tid, name from {taxonomy_term_data} where vid=10');
  while($term=$terms->fetchAssoc()){
    $mypage[PDXCAT_NAME.'/'.$term['tid']] = array(
        'title' => $term['name'],
        'page callback' => 'pdxcat_page_cat2',
        'page arguments' => array($term['tid']),
        'access callback' => TRUE,
    );
  }
  $mypage[PDXCAT_USERNAME] = array(
    'title' => 'Все арендодатели в '.PDX_CITY_NAME2,
    'page callback' => 'pdxcat_page_cat3',
    'page arguments' => array(),
    'access callback' => TRUE,
  );

  return $mypage;
}

function pdxcat_page_cat($source_content = NULL) {
    $source_content='';
    
    if( !is_numeric(arg(1)) ){
        drupal_not_found();
        drupal_exit();            
    }

    
    $subpartid=0;
    if( is_string(arg(2)) ){
        if( is_numeric(arg(2)) ){
            $subpartid=arg(2);
            if( PDXCAT_SUB_VID>0 ){
                $subcat=db_query('select d.tid, d.name from {field_data_field_part} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid where f.entity_type=\'taxonomy_term\' and f.field_part_tid='.arg(1).' and d.vid='.PDXCAT_SUB_VID.' and d.tid='.arg(2).' order by d.weight');
                $subcat=$subcat->fetchAssoc();
                if( isset($subcat['name']) and strlen($subcat['name']) ){
                        drupal_set_title($subcat['name']);
                }else{
                    drupal_not_found();
                    drupal_exit();            
                }
            }else{
                drupal_not_found();
                drupal_exit();            
            }
        }else{
            drupal_not_found();
            drupal_exit();            
        }
    }

    $tagsid=0;
    if( is_string(arg(3)) ){
        if( is_numeric(arg(3)) ){
            $tagsid=arg(3);
            if( PDXCAT_SUB_VID2>0 ){
                $subcat=db_query('select d.tid, d.name from {field_data_field_subpart} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid where f.entity_type=\'taxonomy_term\' and f.field_subpart_tid='.arg(2).' and d.vid='.PDXCAT_SUB_VID2.' and d.tid='.arg(3).' order by d.weight');
                $subcat=$subcat->fetchAssoc();
                if( isset($subcat['name']) and strlen($subcat['name']) ){
                        drupal_set_title($subcat['name']);
                }else{
                    drupal_not_found();
                    drupal_exit();            
                }
            }else{
                drupal_not_found();
                drupal_exit();            
            }
        }else{
            drupal_not_found();
            drupal_exit();            
        }
    }

    $filter=array();
    
    if( function_exists('pdxfiltergen') ){
        $tmpfilt=pdxfiltergen(arg(1), $subpartid, $tagsid);
        if( isset($tmpfilt['filters']) ){
            $_SESSION['pdxpdx_filter_filters']=$tmpfilt['filters'];
        }
    }
    
    $filteryes=0;
    if( isset($_SESSION['pdxpdx_filter_filters']) and is_array($_SESSION['pdxpdx_filter_filters']) and count($_SESSION['pdxpdx_filter_filters']) ){
        foreach( $_SESSION['pdxpdx_filter_filters'] as $id => $weight ){
            if( isset( $_GET[$id] ) ){
                $filteryes=1;
                if( is_array($_GET[$id]) and count($_GET[$id]) ){
                    foreach( $_GET[$id] as $iid ){
                        $filter[$id][]=$iid;
                    }
                }elseif( is_numeric($_GET[$id]) ){
                    $filter[$id][]=$_GET[$id];
                }
            }elseif( isset( $_GET[$id.'_to'] ) and isset( $_GET[$id.'_from'] ) ){
                $filter[$id]['to']=$_GET[$id.'_to'];
                $filter[$id]['from']=$_GET[$id.'_from'];
                $filteryes=1;
            }elseif( isset( $_GET[$id.'_to'] ) ){
                $filter[$id]['to']=$_GET[$id.'_to'];
                $filter[$id]['from']=$_GET[$id.'_to'];
                $filteryes=1;
            }elseif( isset( $_GET[$id.'_from'] ) ){
                $filter[$id]['to']=$_GET[$id.'_from'];
                $filter[$id]['from']=$_GET[$id.'_from'];
                $filteryes=1;
            }else{
                $filter[$id]='-';
            }
        }
    }
    
    $page=1;
    if( isset( $_GET['page'] ) and is_numeric( $_GET['page'] ) ){
        $page=$_GET['page'];
    }
    $sort='created';
    if( isset( $_GET['sort_by'] ) and strlen( $_GET['sort_by'] ) ){
        $sort=$_GET['sort_by'];
    }
    
    $ispath=implode('/',arg());
    
    $source_content.=pdxcat_catalog($ispath, arg(1), $subpartid, $tagsid, $filter, $sort, $page, 0, 0, $filteryes);
    return $source_content;
}

function pdxcat_page_cat2($source_content = NULL) {
    $source_content='';
    
    if( !is_numeric(arg(1)) ){
        drupal_not_found();
        drupal_exit();            
    }

    $subpartid=0;
    $tagsid=0;

    $filter=array();
    
    if( function_exists('pdxfiltergen') ){
        $tmpfilt=pdxfiltergen(0, $subpartid, $tagsid, arg(1));
        if( isset($tmpfilt['filters']) ){
            $_SESSION['pdxpdx_filter_filters']=$tmpfilt['filters'];
        }
    }
    
    $filteryes=0;
    if( isset($_SESSION['pdxpdx_filter_filters']) and is_array($_SESSION['pdxpdx_filter_filters']) and count($_SESSION['pdxpdx_filter_filters']) ){
        foreach( $_SESSION['pdxpdx_filter_filters'] as $id => $weight ){
            if( isset( $_GET[$id] ) ){
                $filteryes=1;
                if( is_array($_GET[$id]) and count($_GET[$id]) ){
                    foreach( $_GET[$id] as $iid ){
                        $filter[$id][]=$iid;
                    }
                }elseif( is_numeric($_GET[$id]) ){
                    $filter[$id][]=$_GET[$id];
                }
            }elseif( isset( $_GET[$id.'_to'] ) and isset( $_GET[$id.'_from'] ) ){
                $filter[$id]['to']=$_GET[$id.'_to'];
                $filter[$id]['from']=$_GET[$id.'_from'];
                $filteryes=1;
            }elseif( isset( $_GET[$id.'_to'] ) ){
                $filter[$id]['to']=$_GET[$id.'_to'];
                $filter[$id]['from']=$_GET[$id.'_to'];
                $filteryes=1;
            }elseif( isset( $_GET[$id.'_from'] ) ){
                $filter[$id]['to']=$_GET[$id.'_from'];
                $filter[$id]['from']=$_GET[$id.'_from'];
                $filteryes=1;
            }else{
                $filter[$id]='-';
            }
        }
    }
    
    $page=1;
    if( isset( $_GET['page'] ) and is_numeric( $_GET['page'] ) ){
        $page=$_GET['page'];
    }
    $sort='created';
    if( isset( $_GET['sort_by'] ) and strlen( $_GET['sort_by'] ) ){
        $sort=$_GET['sort_by'];
    }
    
    $ispath=implode('/',arg());
    
    $source_content.=pdxcat_catalog($ispath, 0, $subpartid, $tagsid, $filter, $sort, $page, 0, 0, $filteryes, arg(1));
    return $source_content;
}

function pdxcat_page_cat3($source_content = NULL) {
    $source_content='';
    
    $subpartid=0;
    $tagsid=0;

    $filter=array();
    
    if( function_exists('pdxfiltergenusers') ){
        $tmpfilt=pdxfiltergenusers();
        if( isset($tmpfilt['filters']) ){
            $_SESSION['pdxpdx_filter_filters']=$tmpfilt['filters'];
        }
    }
    
    $filteryes=0;
    if( isset($_SESSION['pdxpdx_filter_filters']) and is_array($_SESSION['pdxpdx_filter_filters']) and count($_SESSION['pdxpdx_filter_filters']) ){
        foreach( $_SESSION['pdxpdx_filter_filters'] as $id => $weight ){
            if( isset( $_GET[$id] ) ){
                $filteryes=1;
                if( is_array($_GET[$id]) and count($_GET[$id]) ){
                    foreach( $_GET[$id] as $iid ){
                        $filter[$id][]=$iid;
                    }
                }elseif( is_numeric($_GET[$id]) ){
                    $filter[$id][]=$_GET[$id];
                }
            }elseif( isset( $_GET[$id.'_to'] ) and isset( $_GET[$id.'_from'] ) ){
                $filter[$id]['to']=$_GET[$id.'_to'];
                $filter[$id]['from']=$_GET[$id.'_from'];
                $filteryes=1;
            }elseif( isset( $_GET[$id.'_to'] ) ){
                $filter[$id]['to']=$_GET[$id.'_to'];
                $filter[$id]['from']=$_GET[$id.'_to'];
                $filteryes=1;
            }elseif( isset( $_GET[$id.'_from'] ) ){
                $filter[$id]['to']=$_GET[$id.'_from'];
                $filter[$id]['from']=$_GET[$id.'_from'];
                $filteryes=1;
            }else{
                $filter[$id]='-';
            }
        }
    }
    
    $page=1;
    if( isset( $_GET['page'] ) and is_numeric( $_GET['page'] ) ){
        $page=$_GET['page'];
    }
    $sort='created';
    if( isset( $_GET['sort_by'] ) and strlen( $_GET['sort_by'] ) ){
        $sort=$_GET['sort_by'];
    }
    
    $source_content.=pdxcat_catalog_user($filter, $sort, $page, 0, 0, $filteryes);
    return $source_content;
}

function pdxcat_catalogpre($ispath, $cat=0, $brand=0, $tags=0, $filter=array(), $sort='created', $page=1, $ajax=0, $rep=0, $filteryes=0, $celebration=0){
    if( function_exists('pdxfiltergen') ){
        $tmpfilt=pdxfiltergen($cat, $brand, $tags, $celebration);
        if( isset($tmpfilt['filters']) ){
            $_SESSION['pdxpdx_filter_filters']=$tmpfilt['filters'];
        }
    }
    $filteryes=0;

    
        if( isset($_SESSION['pdxpdx_filter_filters']) and is_array($_SESSION['pdxpdx_filter_filters']) and count($_SESSION['pdxpdx_filter_filters']) ){
            foreach( $_SESSION['pdxpdx_filter_filters'] as $id => $weight ){
                if( isset( $_GET[$id] ) ){
                    $filteryes=1;
                    if( is_array($_GET[$id]) and count($_GET[$id]) ){
                        foreach( $_GET[$id] as $iid ){
                            $filter[$id][]=$iid;
                        }
                    }elseif( is_numeric($_GET[$id]) ){
                        $filter[$id][]=$_GET[$id];
                    }
                }elseif( isset( $_GET[$id.'_to'] ) and isset( $_GET[$id.'_from'] ) ){
                    $filter[$id]['to']=$_GET[$id.'_to'];
                    $filter[$id]['from']=$_GET[$id.'_from'];
                    $filteryes=1;
                }elseif( isset( $_GET[$id.'_to'] ) ){
                    $filter[$id]['to']=$_GET[$id.'_to'];
                    $filter[$id]['from']=$_GET[$id.'_to'];
                    $filteryes=1;
                }elseif( isset( $_GET[$id.'_from'] ) ){
                    $filter[$id]['to']=$_GET[$id.'_from'];
                    $filter[$id]['from']=$_GET[$id.'_from'];
                    $filteryes=1;
                }else{
                    if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){  }else{
                        $filter[$id]='-';
                    }
                }
            }
        }
    return pdxcat_catalog($ispath, $cat, $brand, $tags, $filter, $sort, $page, $ajax, $rep, $filteryes, $celebration);
}

function pdxcat_catalogpre_user($filter=array(), $sort='created', $page=1, $ajax=0, $rep=0, $filteryes=0){
    if( function_exists('pdxfiltergenusers') ){
        $tmpfilt=pdxfiltergenusers();
        if( isset($tmpfilt['filters']) ){
            $_SESSION['pdxpdx_filter_filters']=$tmpfilt['filters'];
        }
    }
    $filteryes=0;

    
        if( isset($_SESSION['pdxpdx_filter_filters']) and is_array($_SESSION['pdxpdx_filter_filters']) and count($_SESSION['pdxpdx_filter_filters']) ){
            foreach( $_SESSION['pdxpdx_filter_filters'] as $id => $weight ){
                if( isset( $_GET[$id] ) ){
                    $filteryes=1;
                    if( is_array($_GET[$id]) and count($_GET[$id]) ){
                        foreach( $_GET[$id] as $iid ){
                            $filter[$id][]=$iid;
                        }
                    }elseif( is_numeric($_GET[$id]) ){
                        $filter[$id][]=$_GET[$id];
                    }
                }elseif( isset( $_GET[$id.'_to'] ) and isset( $_GET[$id.'_from'] ) ){
                    $filter[$id]['to']=$_GET[$id.'_to'];
                    $filter[$id]['from']=$_GET[$id.'_from'];
                    $filteryes=1;
                }elseif( isset( $_GET[$id.'_to'] ) ){
                    $filter[$id]['to']=$_GET[$id.'_to'];
                    $filter[$id]['from']=$_GET[$id.'_to'];
                    $filteryes=1;
                }elseif( isset( $_GET[$id.'_from'] ) ){
                    $filter[$id]['to']=$_GET[$id.'_from'];
                    $filter[$id]['from']=$_GET[$id.'_from'];
                    $filteryes=1;
                }else{
                    if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){  }else{
                        $filter[$id]='-';
                    }
                }
            }
        }
    return pdxcat_catalog_user($filter, $sort, $page, $ajax, $rep, $filteryes);
}

function pdxcat_catalog_user($filter=array(), $sort='created', $page=1, $ajax=0, $rep=0, $filteryes=0){
    $out='';
    
    $path='?';


    $fieldinfo=array();
    
    if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend/fields_info') ){
        $cacheis= file_get_contents('pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend/fields_info');
        if( isset($cacheis) and strlen($cacheis) ){
            $cacheis=unserialize($cacheis);
            if( isset($cacheis) and is_array($cacheis) and count($cacheis) ){ 
                $fieldinfo=$cacheis;
            }
        }
    }
    
    if( !isset($fieldinfo) or !is_array($fieldinfo) or !count($fieldinfo) ){
        $fieldinfo=pdxcat_fieldsinfo(1);
    }

    
    $ashops=array();
    
    $sqlinner='';
    $sqlwhere='';
    $sqlsort='';
    
    $sortsuff='&';
    if(mb_substr($path, mb_strlen($path)-1 )=='&'){
        $path=mb_substr($path, 0, mb_strlen($path)-1 );
    }
    if(mb_substr($path, mb_strlen($path)-1 )=='?'){
        $sortsuff='';
    }


    
    $filterstr='';
    
    if( function_exists('pdxfilterout') ){
        $tmpout=pdxfilterout($filter, $fieldinfo, '', 'user', 'uid');
        $filterstr=$tmpout['filterstr'];
        $sqlinner=$tmpout['sqlinner'];
        $sqlwhere=$tmpout['sqlwhere'];
    }

    
    if( !strlen($sort) ){
        $sort='created';
    }
    switch($sort){
    case 'userrat':
        $path.=$sortsuff.'sort_by='.$sort;
        if( strpos($sqlinner, 'field_data_field_userrat')===false ){
            $sqlinner.=' left join {field_data_field_userrat} as field_userrat on (n.uid=field_userrat.entity_id and field_userrat.entity_type=\'user\')';
        }
        $sqlsort=' order by field_userrat.field_userrat_value DESC, n.created DESC';
        break;
    default:
        $sort='created';
        $sqlsort=' order by fg.field_gold_value DESC, n.created DESC';
        break;
    }


    $sqlfilt='from {users} as n inner join {field_data_field_items_active} as field_items_active on (n.uid=field_items_active.entity_id and field_items_active.entity_type=\'user\') left join {field_data_field_gold} as fg on (n.uid=fg.entity_id and fg.entity_type=\'user\') left join {field_data_field_delete} as fd on (n.uid=fd.entity_id and fd.entity_type=\'user\') '.$sqlinner.' where n.status=1 and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and field_items_active.field_items_active_value>0 '.$sqlwhere;
    $sql=$sqlfilt.$sqlsort;

    $sqlcount='select COUNT(DISTINCT n.uid) '.$sql;
    $sqlall='select DISTINCT n.uid '.$sql;
    
    global $user;

    
    $ares=db_query($sqlcount);
    $ares=$ares->fetchAssoc();
    if( isset($ares['COUNT(DISTINCT n.uid)']) and is_numeric($ares['COUNT(DISTINCT n.uid)']) and $ares['COUNT(DISTINCT n.uid)']>0 ){
        $sqlcount=$ares['COUNT(DISTINCT n.uid)'];
        $pager_max=$sqlcount;
        $from=0;
        $to=$sqlcount;
        if( $sqlcount>PDXCAT_USERITEMS ){
            $pager_max=ceil($sqlcount/PDXCAT_USERITEMS);
            $from=($page-1)*PDXCAT_USERITEMS;
            $to=$page*PDXCAT_USERITEMS;
            $sqlall.=' limit '.$from.','.PDXCAT_USERITEMS;
        }

        
        $ares=db_query($sqlall);
        $formap=array();
        while( $are=$ares->fetchAssoc() ){
            $ashops[$are['uid']]=1;
            $formap[]=$are['uid'];
        }
        
        if( isset($ashops) and is_array($ashops) and count($ashops) ){
            $isadm=0;
            if(isset($user->roles[3]) or isset($user->roles[4]) ){ 
                $isadm=1;
            }
            
            $gets='';
            if( isset( $_GET['s'] ) and strlen( $_GET['s'] ) ){
                $gets['s']=trim(filter_xss(strip_tags($_GET['s'])));
            }


            if( $ajax ){
                if( $rep and function_exists('pdxcat_filter_user') ){
                    $out.='<script type="text/javascript"> 
                    jQuery(\'#mycatfilter\').html(\'<img alt="" src="'.PDX_IMGPATH.'/img/throbber.gif" />\');
                    jQuery.post(Drupal.settings.basePath + \'catfilteruser.php\', { str: \''.$filterstr.'\' }, function( data ) { jQuery(\'#mycatfilter\').html(data); } );
                    jQuery(\'.pager_find span\').html(\''.$sqlcount.'\');
                    var formap=\''.implode('|', $formap).'\';
                    jQuery(\'.preshowmapbtn\').html(\'<div class="showmapbtn" onclick=" showplaceonmap(formap, 0, 0); " title=" Показать результаты с этой страницы на карте ">Показать на карте</div>\');
                     </script>';
                }
            }else{
                if( ( $filteryes or $sqlcount>1 ) and function_exists('pdxcat_filter_user') ){
                    $out.='<div id="mycatfilter">'.pdxcat_filter_user($filter).'</div>';
                }

                $out.='<div class="view view-landlords view-id-landlords view-display-id-user"><div class="view-filters view-sorts">';
                $out.='<div class="preshowmapbtn"><div class="showmapbtn" onclick=" showplaceonmap(\''.implode('|', $formap).'\', 0, 0); " title=" Показать результаты с этой страницы на карте ">Показать на карте</div></div>';

                $out.='<div class="pager_find">арендодателей: <span>'.$sqlcount.'</span></div>';
                $out.='<div class="mysort" title="Способ сортировки">';

                $out.='<span class="sortgroup ';
                if((isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='created') or !isset($_REQUEST['sort_by'])){
                    $out.=' mactive';
                }
                $out.='"><span class="is_a asort amarker sortone';
                if((isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='created') or !isset($_REQUEST['sort_by'])){
                    $out.=' active';
                }
                $out.='" onclick=" jQuery(\'#my_sort_by\').val(\'created\'); gotocatuser('.$page.', 1); mycatsort(this); ">по дате создания</span></span>';

                $out.='<span class="sortgroup ';
                if(isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='userrat'){
                    $out.=' mactive';
                }
                $out.='"><span class="is_a asort amarker sortone';
                if(isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='userrat'){
                    $out.=' active';
                }
                $out.='" onclick=" jQuery(\'#my_sort_by\').val(\'userrat\'); gotocatuser('.$page.', 1); mycatsort(this); ">по рейтингу</span></span>';

                $out.='</div>';
                $out.='<div class="clear">&nbsp;</div><div style="display: none;"><form action="" id="mycatform" method="get">';
                $out.='<input type="hidden" name="sort_by" id="my_sort_by" value="'.$sort.'" />';
                if( isset($filter) and is_array($filter) and count($filter) ){

                    foreach( $filter as $fname=>$fval ){
                        if( isset($fieldinfo[$fname]['suffix']) ){
                            if( $fieldinfo[$fname]['suffix']=='tid' ){
                                if( isset($fieldinfo[$fname]['vid']) and is_numeric($fieldinfo[$fname]['vid']) ){
                                    $tidvals=db_query('select tid from {taxonomy_term_data} where vid='.$fieldinfo[$fname]['vid']);
                                    $out.='<select name="'.$fname.'[]" id="my_'.$fname.'" class="myf_hidden_select" multiple="multiple">';
                                    while( $tidval=$tidvals->fetchAssoc() ){
                                        if( isset($fval) and is_array($fval) and count($fval) ){
                                            if( array_search($tidval['tid'], $fval)===false ){
                                                $out.='<option value="'.$tidval['tid'].'">'.$tidval['tid'].'</option>';
                                            }else{
                                                $out.='<option value="'.$tidval['tid'].'" selected="selected">'.$tidval['tid'].'</option>';
                                            }
                                        }elseif( strlen($fval) and $fval=='-' ){
                                            $out.='<option value="'.$tidval['tid'].'">'.$tidval['tid'].'</option>';
                                        }
                                    }
                                    $out.='</select>';
                                }
                            }elseif( $fieldinfo[$fname]['suffix']=='nid' ){
                                if( isset($fieldinfo[$fname]['vid']) and strlen($fieldinfo[$fname]['vid']) ){
                                    $tidvals=db_query('select nid from {node} where status=1 and type IN ('.$fieldinfo[$fname]['vid'].')');
                                    $out.='<select name="'.$fname.'[]" id="my_'.$fname.'" class="myf_hidden_select" multiple="multiple">';
                                    while( $tidval=$tidvals->fetchAssoc() ){
                                        
                                        if( isset($fval) and is_array($fval) and count($fval) ){
                                            if( array_search($tidval['nid'], $fval)===false ){
                                                $out.='<option value="'.$tidval['nid'].'">'.$tidval['nid'].'</option>';
                                            }else{
                                                $out.='<option value="'.$tidval['nid'].'" selected="selected">'.$tidval['nid'].'</option>';
                                            }
                                        }elseif( strlen($fval) and $fval=='-' ){
                                            $out.='<option value="'.$tidval['nid'].'">'.$tidval['nid'].'</option>';
                                        }
                                    }
                                    $out.='</select>';
                                }
                            }elseif( $fieldinfo[$fname]['type']=='list_boolean' ){
                                $out.='<input type="hidden" class="myf_hidden_list" value="';
                                if( isset($fval) and is_numeric($fval) and $fval==1 ){
                                    $out.='1';
                                }
                                $out.='" name="'.$fname.'" id="my_'.$fname.'" />';
                            }elseif( $fieldinfo[$fname]['type']=='list_integer' ){
                                if( isset($fieldinfo[$fname]['vals']) and is_array($fieldinfo[$fname]['vals']) and count($fieldinfo[$fname]['vals']) ){
                                    $out.='<select name="'.$fname.'[]" id="my_'.$fname.'" class="myf_hidden_select" multiple="multiple">';
                                    foreach( $fieldinfo[$fname]['vals'] as $valid=>$valname ){
                                        if( isset($fval) and is_array($fval) and count($fval) ){
                                            if( array_search($valid, $fval)===false ){
                                                $out.='<option value="'.$valid.'">'.$valid.'</option>';
                                            }else{
                                                $out.='<option value="'.$valid.'" selected="selected">'.$valid.'</option>';
                                            }
                                        }elseif( strlen($fval) and $fval=='-' ){
                                            $out.='<option value="'.$valid.'">'.$valid.'</option>';
                                        }
                                    }
                                    $out.='</select>';
                                }
                            }elseif( $fieldinfo[$fname]['suffix']=='value' ){
                                if( strlen($fval) and $fval=='-' ){
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_from" value="" name="'.$fname.'_from" id="my_from_'.$fname.'" />';
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_to" value="" name="'.$fname.'_to" id="my_to_'.$fname.'" />';
                                }elseif( isset($fval) and is_array($fval) and count($fval)==2 and isset($fval['from']) and isset($fval['to']) and is_numeric($fval['from']) and is_numeric($fval['to']) ){
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_from" value="'.$fval['from'].'" name="'.$fname.'_from" id="my_from_'.$fname.'" />';
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_to" value="'.$fval['to'].'" name="'.$fname.'_to" id="my_to_'.$fname.'" />';
                                }else{
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_from" value="" name="'.$fname.'_from" id="my_from_'.$fname.'" />';
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_to" value="" name="'.$fname.'_to" id="my_to_'.$fname.'" />';
                                }
                            }
                        }
                    }
                }
                $out.='</form></div>';
                $out.='</div><div class="view-content view-content_mycat">';


            }

                if( strlen($path)>1 ){
            
                    $out.='<script type="text/javascript">
            history.pushState( null, null, "'.PDXCAT_USERNAME.'" );
            ';
                    $out.='
            filterArg="'.$path.'";';
                    $out.='
            </script>';
            
                    $path=PDXCAT_USERNAME.$path;
                    $path=str_replace('//', '/', $path);
                    $path=$GLOBALS['base_url'].$path;
                }

                       
            foreach( $ashops as $nid => $tmp ){
                $out.= '<div class="views-row">'.pdxgetmyuser($nid).'</div>';
            }

            if( strpos($path,'?')===false ){
                $path.='?';
            }else{
                if(mb_substr($path, mb_strlen($path)-1 )=='?'){}else{
                    $path.='&';
                }
            }
            if( $ajax ){
                $out.='<script type="text/javascript"> addadmuser(); updateswiperitem(); checkonline(); </script>';
                if( $to<$sqlcount ){
                    $pager_rest=$pager_rest2=$sqlcount-$to;
                    if( $pager_rest>PDXCAT_USERITEMS ){
                        $pager_rest=PDXCAT_USERITEMS;
                    }
                    
                    $out.='<script type="text/javascript"> jQuery(\'.mycatpager\').html(\'<div class="user_ontop"><a href="#region_content">^ к началу</a></div><ul class="pager"><li class="pager-next first last"><a href="'.$path.'page='.($page+1).'" onclick=" gotocatuser('.($page+1).', 0); catanimate(); return false; "><div class="mpi">Еще '.pdxnumfoot($pager_rest, 'арендодатель', 'арендодателей', 'арендодателя').'</div><div>(осталось '.$pager_rest2.')</div></a></li></ul>\'); </script>';
                }else{
                    $out.='<script type="text/javascript"> jQuery(\'.mycatpager\').html(\'\'); </script>';
                }
            }else{
                $out.='<div class="mycatalogmore"></div>';
                $out.='</div><div class="clear">&nbsp;</div>';
                if( $to<$sqlcount ){
                    $pager_rest=$pager_rest2=$sqlcount-$to;
                    if( $pager_rest>PDXCAT_USERITEMS ){
                        $pager_rest=PDXCAT_USERITEMS;
                    }
                    $out.='<div class="item-list mycatpager">';
                    $out.='<div class="user_ontop"><a href="#region_content">^ к началу</a></div>';
                    $out.='<ul class="pager"><li class="pager-next first last"><a href="'.$path.'page='.($page+1).'" onclick=" gotocatuser('.($page+1).', 0); catanimate(); return false; "><div class="mpi">Еще '.pdxnumfoot($pager_rest, 'арендодатель', 'арендодателей', 'арендодателя').'</div><div>(осталось '.$pager_rest2.')</div></a></li></ul></div>';
                    $out.='<div class="clear">&nbsp;</div>';
                }
                $out.='</div>';
            }
        }else{
            if( $ajax ){
                return;
            }else{
                $out.='<div class="notresults">Подходящих арендодателей в '.PDX_CITY_NAME2.' не найдено. Но мы делаем все возможное, чтобы они узнали о нас как можно быстрее.</div>';
//                if( isset($user->roles[3]) or isset($user->roles[4]) ){  }else{
//                    drupal_not_found();
//                    drupal_exit();            
//                }
            }
        }
        
    }else{
        if( $ajax ){
            echo '<div class="notresults">Подходящих арендодателей в '.PDX_CITY_NAME2.' не найдено. Но мы делаем все возможное, чтобы они узнали о нас как можно быстрее.</div>';
            return;
        }else{
            $out.='<div class="notresults">Подходящих арендодателей в '.PDX_CITY_NAME2.' не найдено. Но мы делаем все возможное, чтобы они узнали о нас как можно быстрее.</div>';
//            if( isset($user->roles[3]) or isset($user->roles[4]) ){  }else{
//                drupal_not_found();
//                drupal_exit();            
//            }
        }
    }
    
    

    return $out;
}

function pdxcat_catalog($ispath, $cat=0, $brand=0, $tags=0, $filter=array(), $sort='created', $page=1, $ajax=0, $rep=0, $filteryes=0, $celebration=0){
    $out='';
    
    $ispath=filter_xss(strip_tags($ispath));
    $ispath=str_replace('"','',str_replace('\'','',$ispath));
    
    $path='?';


    $fieldinfo=array();
    
    if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend/fields_info') ){
        $cacheis= file_get_contents('pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend/fields_info');
        if( isset($cacheis) and strlen($cacheis) ){
            $cacheis=unserialize($cacheis);
            if( isset($cacheis) and is_array($cacheis) and count($cacheis) ){ 
                $fieldinfo=$cacheis;
            }
        }
    }
    
    if( !isset($fieldinfo) or !is_array($fieldinfo) or !count($fieldinfo) ){
        $fieldinfo=pdxcat_fieldsinfo(1);
    }

    
    $ashops=array();
    
    $sqlinner='';
    $sqlwhere='';
    $sqlsort='';
    
    $sortsuff='&';
    if(mb_substr($path, mb_strlen($path)-1 )=='&'){
        $path=mb_substr($path, 0, mb_strlen($path)-1 );
    }
    if(mb_substr($path, mb_strlen($path)-1 )=='?'){
        $sortsuff='';
    }


    
    $filterstr='';
    
    if( $cat>0 ){
        $filter[PDXCAT_FIELD]=array();
        $filter[PDXCAT_FIELD][]=$cat;
    }
    if( $brand>0 ){
        $filter[PDXCAT_SUB_FIELD]=array();
        $filter[PDXCAT_SUB_FIELD][]=$brand;
    }
    if( $tags>0 ){
        $filter[PDXCAT_SUB_FIELD2]=array();
        $filter[PDXCAT_SUB_FIELD2][]=$tags;
    }
    if( $celebration>0 ){
        $filter['field_celebration']=array();
        $filter['field_celebration'][]=$celebration;
    }

    if( function_exists('pdxfilterout') ){
        $tmpout=pdxfilterout($filter, $fieldinfo);
        $filterstr=$tmpout['filterstr'];
        $sqlinner=$tmpout['sqlinner'];
        $sqlwhere=$tmpout['sqlwhere'];
    }
    
    if( !strlen($sort) ){
        $sort='created';
    }
    switch($sort){
    case 'field_sort_price_min_value':
        $path.=$sortsuff.'sort_by='.$sort;
        if( strpos($sqlinner, 'field_data_field_isnone')===false ){
            $sqlinner.=' left join {field_data_field_isnone} as field_isnone on (n.nid=field_isnone.entity_id and field_isnone.entity_type=\'node\')';
        }
        $sqlsort=' order by field_isnone.field_isnone_value ASC, field_sort_price_min.field_sort_price_min_value ASC';
        break;
    default:
        $sort='created';
//        $sqlsort=' order by n.sticky DESC, n.created DESC';
        $sqlsort=' order by n.created DESC';
        break;
    }


    $sqlfilt='from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\')'.$sqlinner.' where n.status=1 and n.type=\'item\' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 ) '.$sqlwhere;
    $sql=$sqlfilt.$sqlsort;

    $sqlcount='select COUNT(DISTINCT n.nid) '.$sql;
    $sqlall='select DISTINCT n.nid '.$sql;
    
    global $user;

    
    
    if( defined('PDXCAT_NAME') and arg(0)==PDXCAT_NAME and isset($_SESSION['pdxpdx_par_vid']) and is_numeric($_SESSION['pdxpdx_par_vid']) ){


        switch( $_SESSION['pdxpdx_par_vid'] ){
        case 2:
        case 8:
        case 1:
    
            $isyes='';
            $tids=db_query('select d.tid, d.name from {field_data_field_part} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid where f.entity_type=\'taxonomy_term\' and f.field_part_tid='.arg(1).' and d.vid=8 order by d.weight');
            while( $tid=$tids->fetchAssoc() ){
                $tid['name']=str_replace('Кардиотренажеры', 'Кардио-тренажеры', $tid['name']);
                $isyes.= '<div class="headcatis headcatis'.$tid['tid'].'"><a class="aheadcatis';
                if( is_numeric(arg(2)) and arg(2)==$tid['tid'] ){
                    $isyes.= ' active';
                }
                $isyes.= '" href="'.url(PDXCAT_NAME.'/'.arg(1).'/'.$tid['tid'], array('absolute'=>TRUE)).'"><span class="image"><img alt="" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/part/i'.$tid['tid'].'.png" /></span><span class="ttl partis'.$tid['tid'].' admlnk pdxobj'.$tid['tid'].' pdxot pdxpi">'.$tid['name'].'</span></a></div>';
            }
            if( isset($isyes) and strlen($isyes) ){
                $out.= '<div class="headtax">'.$isyes;
                if( is_numeric(arg(1)) and is_numeric(arg(2)) ){
                    $amass=array();
                    $amass[998][]=106;
                    $amass[106][]=998;
                    $amass[2634][]=71;
                    $amass[2634][]=13;
                    $amass[2962][]=71;
                    $amass[71][]=2634;
                    $amass[71][]=2962;
                    $amass[148][]=108;
                    $amass[108][]=148;
                    $amass[107][]=873;
                    $amass[107][]=1858;
                    $amass[107][]=875;
//                    $amass[107][]=1955;
                    $amass[873][]=107;
                    $amass[1858][]=107;
                    $amass[110][]=881;
                    $amass[881][]=110;
                    $amass[880][]=76;
                    $amass[76][]=880;
                    $amass[72][]=878;
                    $amass[878][]=72;
                    $amass[964][]=112;
                    $amass[111][]=112;
                    $amass[75][]=112;
                    $amass[112][]=964;
                    $amass[112][]=111;
                    $amass[112][]=75;
    
                    if( isset($amass[arg(2)]) and is_array($amass[arg(2)]) and count($amass[arg(2)]) ){
                        $out.= '<div class="headcatis headcatis_ttl"><span class="aheadcatis"><span class="ttl">Возможно, <br />Вас также заинтересует:</span></span></div>';
                        foreach( $amass[arg(2)] as $part ){
                            $num=db_query('select t.name, f.field_part_tid from {taxonomy_term_data} as t left join {field_data_field_part} as f on (t.tid=f.entity_id and f.entity_type=\'taxonomy_term\') where t.tid='.$part);
                            $num=$num->fetchAssoc();
                            if( isset($num['field_part_tid']) and is_numeric($num['field_part_tid']) ){
                                $isurl=PDXCAT_NAME.'/'.$num['field_part_tid'].'/'.$part;
                            }else{
                                $isurl=PDXCAT_NAME.'/'.$part;
                            }
                            $out.= '<div class="headcatis headcatis'.$part.'"><a class="aheadcatis" href="'.url($isurl, array('absolute'=>TRUE)).'"><span class="image"><img alt="" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/part/i'.$part.'.png" /></span><span class="ttl partis'.$part.'">'.$num['name'].'</span></a></div>';
                        }
                    }
                    
                }
                $out.= '</div>';
            }
            
            
            
            break;
        case 10:
            $out.= '<div class="taxpart_is taxpart10"><span class="lbl">Другие праздники: </span><ul>';
    
            $tids=db_query('select tid, name from {taxonomy_term_data} where vid=10 and tid<>'.$_SESSION['pdxpdx_par_tid'].' order by weight');
            // class="partis'.$tid['tid'].'"
            while( $tid=$tids->fetchAssoc() ){
                $out.= '<li><a href="'.url(PDXCAT_NAME.'/'.$tid['tid'], array('absolute'=>TRUE)).'">'.$tid['name'].'</a></li>';
            }
            
            $out.= '</ul></div>';
            break;
        }
        
        $out.= '<div class="clear">&nbsp;</div>';
        
    }
    
    if( $cat>0 ){
        $out.='<section id="block_rec_items_cat" class="cat_'.$cat.'_'.$brand.'_'.$tags.'_'.$celebration.'"></section>';
    }
    
    $ares=db_query($sqlcount);
    $ares=$ares->fetchAssoc();
    if( isset($ares['COUNT(DISTINCT n.nid)']) and is_numeric($ares['COUNT(DISTINCT n.nid)']) and $ares['COUNT(DISTINCT n.nid)']>0 ){
        $sqlcount=$ares['COUNT(DISTINCT n.nid)'];
        $pager_max=$sqlcount;
        $from=0;
        $to=$sqlcount;
        if( $sqlcount>PDXCAT_ITEMS ){
            $pager_max=ceil($sqlcount/PDXCAT_ITEMS);
            $from=($page-1)*PDXCAT_ITEMS;
            $to=$page*PDXCAT_ITEMS;
            $sqlall.=' limit '.$from.','.PDXCAT_ITEMS;
        }

        
        $ares=db_query($sqlall);
        while( $are=$ares->fetchAssoc() ){
            $ashops[$are['nid']]=1;
        }
        
        if( isset($ashops) and is_array($ashops) and count($ashops) ){
            $isadm=0;
            if(isset($user->roles[3]) or isset($user->roles[4]) ){ 
                $isadm=1;
            }
            
            $gets='';
            if( isset( $_GET['s'] ) and strlen( $_GET['s'] ) ){
                $gets['s']=trim(filter_xss(strip_tags($_GET['s'])));
            }


            if( $ajax ){
                if( $rep and function_exists('pdxcat_filter') ){
                    $out.='<script type="text/javascript"> 
                    jQuery(\'#mycatfilter\').html(\'<img alt="" src="'.PDX_IMGPATH.'/img/throbber.gif" />\');
                    jQuery.post(Drupal.settings.basePath + \'catfilter.php\', { ispath: \''.$ispath.'\', cat: '.$cat.', brand: '.$brand.', tags: '.$tags.', str: \''.$filterstr.'\', celebration: '.$celebration.' }, function( data ) { jQuery(\'#mycatfilter\').html(data); } );
                    jQuery(\'.pager_find span\').html(\''.$sqlcount.'\');
                     </script>';
                }
            }else{
                if( ( $filteryes or $sqlcount>1 ) and function_exists('pdxcat_filter') ){
                    $out.='<div id="mycatfilter">'.pdxcat_filter($ispath, $cat, $brand, $tags, $filter, $celebration).'</div>';
                }

                $out.='<div class="view view-taxonomy-term view-id-taxonomy_term view-display-id-item"><div class="view-filters view-sorts">';
                $out.='<div class="pager_find">объявлений: <span>'.$sqlcount.'</span></div>';
//                $out.='<div class="mysort">';
//                $out.='<strong>Сортировать:</strong>';
//                $out.='<span class="sortgroup ';
//                if((isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='totalcount') or !isset($_REQUEST['sort_by'])){
//                    $out.=' mactive';
//                }
//                $out.='"><span class="is_a asort amarker sortone';
//                if((isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='totalcount') or !isset($_REQUEST['sort_by'])){
//                    $out.=' active';
//                }
//                $out.='" onclick=" jQuery(\'#my_sort_by\').val(\'totalcount\'); gotocat(\''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', '.$page.', 1, '.$celebration.'); mycatsort(this); ">по популярности</span></span>';
    
//                $out.='<span class="sortgroup ';
//                if((isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='field_innal_value') ){
//                    $out.=' mactive';
//                }
//                $out.='"><span class="is_a asort amarker sortone';
//                if((isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='field_innal_value') ){
//                    $out.=' active';
//                }
//                $out.='" onclick=" jQuery(\'#my_sort_by\').val(\'field_innal_value\'); gotocat(\''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', '.$page.', 1, '.$celebration.'); mycatsort(this); ">в наличии</span></span>';
//                $out.='<span class="price">по цене:</span>';
//                $out.='<span class="sortgroup';
//                if(isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='field_sort_price_min_value' ) {
//                    $out.=' mactive';
//                }
//                $out.='"><span class="is_a asort';
//                if((isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='field_sort_price_min_value') ){
//                    $out.=' active';
//                }
//                $out.='" onclick=" jQuery(\'#my_sort_by\').val(\'field_sort_price_min_value\'); gotocat(\''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', '.$page.', 1, '.$celebration.'); mycatsort(this); ">дешевые</span></span>';
    
//                $out.='<span class="sortgroup';
//                if(isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='field_sort_price_max_value' ) {
//                    $out.=' mactive';
//                }
//                $out.='"><span class="is_a asort';
//                if((isset($_REQUEST['sort_by']) and $_REQUEST['sort_by']=='field_sort_price_max_value') ){
//                    $out.=' active';
//                }
//                $out.='" onclick=" jQuery(\'#my_sort_by\').val(\'field_sort_price_max_value\'); gotocat(\''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', '.$page.', 1, '.$celebration.'); mycatsort(this); ">дорогие</span></span>';
//                $out.='</div>';
                $out.='<div class="clear">&nbsp;</div><div style="display: none;"><form action="" id="mycatform" method="get">';
                $out.='<input type="hidden" name="sort_by" id="my_sort_by" value="'.$sort.'" />';
                if( isset($filter) and is_array($filter) and count($filter) ){

                    foreach( $filter as $fname=>$fval ){
                        if( $fname==PDXCAT_FIELD and $cat>0 ){
                            continue;
                        }
                        if( $fname==PDXCAT_SUB_FIELD and $brand>0 ){
                            continue;
                        }
                        if( $fname==PDXCAT_SUB_FIELD2 and $tags>0 ){
                            continue;
                        }
                        if( $fname=='field_celebration' and $celebration>0 ){
                            continue;
                        }

                        if( isset($fieldinfo[$fname]['suffix']) ){
                            if( $fieldinfo[$fname]['suffix']=='tid' ){
                                if( isset($fieldinfo[$fname]['vid']) and is_numeric($fieldinfo[$fname]['vid']) ){
                                    $tidvals=db_query('select tid from {taxonomy_term_data} where vid='.$fieldinfo[$fname]['vid']);
                                    $out.='<select name="'.$fname.'[]" id="my_'.$fname.'" class="myf_hidden_select" multiple="multiple">';
                                    while( $tidval=$tidvals->fetchAssoc() ){
                                        if( isset($fval) and is_array($fval) and count($fval) ){
                                            if( array_search($tidval['tid'], $fval)===false ){
                                                $out.='<option value="'.$tidval['tid'].'">'.$tidval['tid'].'</option>';
                                            }else{
                                                $out.='<option value="'.$tidval['tid'].'" selected="selected">'.$tidval['tid'].'</option>';
                                            }
                                        }elseif( strlen($fval) and $fval=='-' ){
                                            $out.='<option value="'.$tidval['tid'].'">'.$tidval['tid'].'</option>';
                                        }
                                    }
                                    $out.='</select>';
                                }
                            }if( $fieldinfo[$fname]['suffix']=='nid' ){
                                if( isset($fieldinfo[$fname]['vid']) and strlen($fieldinfo[$fname]['vid']) ){
                                    $tidvals=db_query('select nid from {node} where status=1 and type IN ('.$fieldinfo[$fname]['vid'].')');
                                    $out.='<select name="'.$fname.'[]" id="my_'.$fname.'" class="myf_hidden_select" multiple="multiple">';
                                    while( $tidval=$tidvals->fetchAssoc() ){
                                        
                                        if( isset($fval) and is_array($fval) and count($fval) ){
                                            if( array_search($tidval['nid'], $fval)===false ){
                                                $out.='<option value="'.$tidval['nid'].'">'.$tidval['nid'].'</option>';
                                            }else{
                                                $out.='<option value="'.$tidval['nid'].'" selected="selected">'.$tidval['nid'].'</option>';
                                            }
                                        }elseif( strlen($fval) and $fval=='-' ){
                                            $out.='<option value="'.$tidval['nid'].'">'.$tidval['nid'].'</option>';
                                        }
                                    }
                                    $out.='</select>';
                                }
                            }elseif( $fieldinfo[$fname]['type']=='list_boolean' ){
                                $out.='<input type="hidden" class="myf_hidden_list" value="';
                                if( isset($fval) and is_numeric($fval) and $fval==1 ){
                                    $out.='1';
                                }
                                $out.='" name="'.$fname.'" id="my_'.$fname.'" />';
                            }elseif( $fieldinfo[$fname]['type']=='list_integer' ){
                                if( isset($fieldinfo[$fname]['vals']) and is_array($fieldinfo[$fname]['vals']) and count($fieldinfo[$fname]['vals']) ){
                                    $out.='<select name="'.$fname.'[]" id="my_'.$fname.'" class="myf_hidden_select" multiple="multiple">';
                                    foreach( $fieldinfo[$fname]['vals'] as $valid=>$valname ){
                                        if( isset($fval) and is_array($fval) and count($fval) ){
                                            if( array_search($valid, $fval)===false ){
                                                $out.='<option value="'.$valid.'">'.$valid.'</option>';
                                            }else{
                                                $out.='<option value="'.$valid.'" selected="selected">'.$valid.'</option>';
                                            }
                                        }elseif( strlen($fval) and $fval=='-' ){
                                            $out.='<option value="'.$valid.'">'.$valid.'</option>';
                                        }
                                    }
                                    $out.='</select>';
                                }
                            }elseif( $fieldinfo[$fname]['suffix']=='value' ){
                                if( strlen($fval) and $fval=='-' ){
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_from" value="" name="'.$fname.'_from" id="my_from_'.$fname.'" />';
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_to" value="" name="'.$fname.'_to" id="my_to_'.$fname.'" />';
                                }elseif( isset($fval) and is_array($fval) and count($fval)==2 and isset($fval['from']) and isset($fval['to']) and is_numeric($fval['from']) and is_numeric($fval['to']) ){
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_from" value="'.$fval['from'].'" name="'.$fname.'_from" id="my_from_'.$fname.'" />';
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_to" value="'.$fval['to'].'" name="'.$fname.'_to" id="my_to_'.$fname.'" />';
                                }else{
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_from" value="" name="'.$fname.'_from" id="my_from_'.$fname.'" />';
                                    $out.='<input type="hidden" class="myf_hidden_num myf_hidden_num_to" value="" name="'.$fname.'_to" id="my_to_'.$fname.'" />';
                                }
                            }
                        }
                    }
                }
                $out.='</form></div>';
                $out.='</div><div class="view-content view-content_mycat">';


            }

                if( strlen($path)>1 ){
            
                    $ispath2=path_load($ispath);
                    if(strlen($ispath2['alias'])) $ispath=$ispath2['alias'].'/'; else $ispath=$ispath.'/'; 
                    $ispath=str_replace('//','/',$ispath);       
            
                    $out.='<script type="text/javascript">
            history.pushState( null, null, "'.$path.'" );
            ';
                    if( arg(0)=='find' ){
                    }else{
                        $out.='
            filterArg="'.$path.'";';
                    }
                        $out.='
            </script>';
            
                    $path=$ispath.$path;
                    $path=str_replace('//', '/', $path);
                    $path=$GLOBALS['base_url'].$path;
                    if( isset($user->roles[3])  or isset($user->roles[4]) ){
                        $out.='<input style="width: 100%;" type="text" value="'.$path.'" onclick=" jQuery(this).select(); " />';
                    }  
                }

                       
            foreach( $ashops as $nid => $tmp ){
                $out.= '<div class="views-row">'.pdxgetmyitem($nid).'</div>';
            }

            if( strpos($path,'?')===false ){
                $path.='?';
            }else{
                if(mb_substr($path, mb_strlen($path)-1 )=='?'){}else{
                    $path.='&';
                }
            }
            if( $ajax ){
                $out.='<script type="text/javascript"> preparecurrency(); addadmuser(); updateswiperitem(); </script>';
                if( $to<$sqlcount ){
                    $pager_rest=$pager_rest2=$sqlcount-$to;
                    if( $pager_rest>PDXCAT_ITEMS ){
                        $pager_rest=PDXCAT_ITEMS;
                    }
                    
                    $out.='<script type="text/javascript"> ispathcat=\''.$ispath.'\'; jQuery(\'.mycatpager\').html(\'<div class="user_ontop"><a href="#region_content">^ к началу</a></div><ul class="pager"><li class="pager-next first last"><a href="'.$path.'page='.($page+1).'" onclick=" gotocat(ispathcat, '.$cat.', '.$brand.', '.$tags.', '.($page+1).', 0, '.$celebration.'); catanimate(); return false; "><div class="mpi">Еще '.pdxnumfoot($pager_rest, 'объявление', 'объявлений', 'объявления').'</div><div>(осталось '.$pager_rest2.')</div></a></li></ul>\'); </script>';
                }else{
                    $out.='<script type="text/javascript"> jQuery(\'.mycatpager\').html(\'\'); </script>';
                }
            }else{
                $out.='<div class="mycatalogmore"></div>';
                $out.='</div><div class="clear">&nbsp;</div>';
                if( $to<$sqlcount ){
                    $pager_rest=$pager_rest2=$sqlcount-$to;
                    if( $pager_rest>PDXCAT_ITEMS ){
                        $pager_rest=PDXCAT_ITEMS;
                    }
                    $out.='<div class="item-list mycatpager">';
                    $out.='<div class="user_ontop"><a href="#region_content">^ к началу</a></div>';
                    $out.='<ul class="pager"><li class="pager-next first last"><a href="'.$path.'page='.($page+1).'" onclick=" gotocat(\''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', '.($page+1).', 0, '.$celebration.'); catanimate(); return false; "><div class="mpi">Еще '.pdxnumfoot($pager_rest, 'объявление', 'объявлений', 'объявления').'</div><div>(осталось '.$pager_rest2.')</div></a></li></ul></div>';
                    $out.='<div class="clear">&nbsp;</div>';
                }
                $out.='</div>';
            }
        }else{
            if( $ajax ){
                return;
            }else{
                $out.='<div class="notresults">Подходящих объявлений в '.PDX_CITY_NAME2.' не найдено. Но мы делаем все возможное, чтобы они появились как можно быстрее.</div>';
//                if( isset($user->roles[3]) or isset($user->roles[4]) ){  }else{
//                    drupal_not_found();
//                    drupal_exit();            
//                }
            }
        }
        
    }else{
        if( $ajax ){
            echo '<div class="notresults">Подходящих объявлений в '.PDX_CITY_NAME2.' не найдено</div>';
            return;
        }else{
            $out.='<div class="notresults">Подходящих объявлений в '.PDX_CITY_NAME2.' не найдено. Но мы делаем все возможное, чтобы они появились как можно быстрее.</div>';
//            if( isset($user->roles[3]) or isset($user->roles[4]) ){  }else{
//                drupal_not_found();
//                drupal_exit();            
//            }
        }
    }
    
    

    return $out;
}
function pdxcat_fieldsinfo($ret=0){
    $aout=array();
    
    $outs=db_query('select f.type, f.data, f.field_name from {field_config} as f where f.type in (\'number_integer\', \'number_decimal\', \'taxonomy_term_reference\', \'list_boolean\', \'node_reference\', \'list_integer\') and deleted=0');
    while( $out=$outs->fetchAssoc() ){
        
        $aout[$out['field_name']]['type']=$out['type'];
        if( $out['type']=='taxonomy_term_reference' ){
            $aout[$out['field_name']]['suffix']='tid';
            $out['data']=unserialize($out['data']);
            if( isset($out['data']['settings']['allowed_values'][0]['vocabulary']) and strlen( $out['data']['settings']['allowed_values'][0]['vocabulary'] ) ){
                $aout[$out['field_name']]['voc']=$out['data']['settings']['allowed_values'][0]['vocabulary'];
                $vid=db_query('select vid from {taxonomy_vocabulary} where machine_name=:combo', array(':combo'=>$out['data']['settings']['allowed_values'][0]['vocabulary']));
                $vid=$vid->fetchAssoc();
                if( isset($vid['vid']) and is_numeric($vid['vid']) ){
                    $aout[$out['field_name']]['vid']=$vid['vid'];
                }
            }
        }elseif( $out['type']=='node_reference' ){
            $aout[$out['field_name']]['suffix']='nid';
            $out['data']=unserialize($out['data']);
            $atypes=array();
            if( isset($out['data']['settings']['referenceable_types']) and is_array($out['data']['settings']['referenceable_types']) and count($out['data']['settings']['referenceable_types']) ){
                foreach( $out['data']['settings']['referenceable_types'] as $typeiv=>$typeval ){
                    if( isset($typeval) and strlen($typeval) and !is_numeric($typeval) ){
                        $atypes[]='\''.$typeval.'\'';
                    }
                }
            }
            if( isset($atypes) and is_array($atypes) and count($atypes) ){ 
                $aout[$out['field_name']]['vid']=implode(', ', $atypes);
            }
        }elseif( $out['type']=='list_integer' ){
            $aout[$out['field_name']]['suffix']='value';
            $out['data']=unserialize($out['data']);
            if( isset($out['data']['settings']['allowed_values']) and is_array($out['data']['settings']['allowed_values']) and count($out['data']['settings']['allowed_values']) ){
                $aout[$out['field_name']]['vals']=$out['data']['settings']['allowed_values'];
            }
        }else{
            $aout[$out['field_name']]['suffix']='value';
        }
    }
    
    if( !is_dir('pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend') ){
        mkdir('pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend');
    }
    if( isset($aout) and is_array($aout) and count($aout) ){
        $fp = fopen('pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend/fields_info', 'w');
        fwrite($fp, serialize($aout));
        fclose($fp);
    }
    
    
    if( $ret ){
        return $aout;
    }
}
function pdxcat_filter($ispath, $cat, $brand, $tags, $filter, $celebration=0){

    
    $outall='';

    $ispath=filter_xss(strip_tags($ispath));
    $ispath=str_replace('"','',str_replace('\'','',$ispath));

    $fieldinfo=array();
    if( file_exists('./pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend/fields_info') ){
        $cacheis= file_get_contents('./pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend/fields_info');
        if( isset($cacheis) and strlen($cacheis) ){
            $cacheis=unserialize($cacheis);
            if( isset($cacheis) and is_array($cacheis) and count($cacheis) ){ 
                $fieldinfo=$cacheis;
            }
        }
    }
    if( !isset($fieldinfo) or !is_array($fieldinfo) or !count($fieldinfo) ){
        $fieldinfo=pdxcat_fieldsinfo(1);
    }

    $filterstr='';
    $sqlinner='';
    $sqlwhere='';
    if( function_exists('pdxfilterout') ){
        $tmpout=pdxfilterout($filter, $fieldinfo);
        $filterstr=$tmpout['filterstr'];
        $sqlinner.=$tmpout['sqlinner'];
        $sqlwhere=$tmpout['sqlwhere'];
    }
    
    $sqlfilt='from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\')'.$sqlinner.' where n.status=1 and n.type=\'item\' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 ) '.$sqlwhere;
    $sql=$sqlfilt;
    
    if( isset($cat) and is_numeric($cat) and $cat>0 and isset($filter[PDXCAT_FIELD]) ){
        unset($filter[PDXCAT_FIELD]);
    }
    if( isset($brand) and is_numeric($brand) and $brand>0 and isset($filter[PDXCAT_SUB_FIELD]) ){
        unset($filter[PDXCAT_SUB_FIELD]);
    }
    if( isset($tags) and is_numeric($tags) and $tags>0 and isset($filter[PDXCAT_SUB_FIELD2]) ){
        unset($filter[PDXCAT_SUB_FIELD2]);
    }
    if( isset($celebration) and is_numeric($celebration) and $celebration>0 and isset($filter['field_celebration']) ){
        unset($filter['field_celebration']);
    }

    if( function_exists('pdxfiltergen') ){
        $tmpfilt=pdxfiltergen($cat, $brand, $tags, $celebration);
        if( isset($tmpfilt['nids']) ){
            $_SESSION['pdxpdx_filter_nids']=$tmpfilt['nids'];
        }
        if( isset($tmpfilt['filters']) ){
            $_SESSION['pdxpdx_filter_filters']=$tmpfilt['filters'];
        }
    }


    if( isset($_SESSION['pdxpdx_filter_filters']) and is_array($_SESSION['pdxpdx_filter_filters']) and count($_SESSION['pdxpdx_filter_filters']) ){
        asort($_SESSION['pdxpdx_filter_filters']);
        
        if( isset($_SESSION['pdxpdx_filter_filters']) and is_array($_SESSION['pdxpdx_filter_filters']) and count($_SESSION['pdxpdx_filter_filters']) ){
            $outall.='<div class="filter_main"><div class="filter_content">';
            $countfilt=0;
            
            $isfeat=array();
            $activestring_feat='';
            $activestring_feat_count=0;


            foreach( $_SESSION['pdxpdx_filter_filters'] as $id => $weight ){
                $out=$outonce='';
                $stopout=1;
                

                $newfilter = $filter;
                unset($newfilter[$id]);
                if( isset($cat) and is_numeric($cat) and $cat>0 ){
                    $newfilter[PDXCAT_FIELD]=array($cat);
                }
                if( isset($brand) and is_numeric($brand) and $brand>0 ){
                    $newfilter[PDXCAT_SUB_FIELD]=array($brand);
                }
                if( isset($tags) and is_numeric($tags) and $tags>0 ){
                    $newfilter[PDXCAT_SUB_FIELD2]=array($tags);
                }
                if( isset($celebration) and is_numeric($celebration) and $celebration>0 ){
                    $newfilter['field_celebration']=array($celebration);
                }
                
            
                $filterstr='';
                $sqlinner='';
                $sqlwhere='';
                if( function_exists('pdxfilterout') ){
                    $tmpout=pdxfilterout($newfilter, $fieldinfo);
                    $filterstr=$tmpout['filterstr'];
                    $sqlinner.=$tmpout['sqlinner'];
                    $sqlwhere=$tmpout['sqlwhere'];
                }



                $filterlbl=array();
                switch($id){
                case 'field_who':
                    $filterlbl['title']='Арендодатель';
                    $filterlbl['vals']=array(
                        1=>'Частное лицо',
                        2=>'Компания/магазин',
                    );
                    break;
                case 'field_addon1':
                    $filterlbl['title']='Цвет';
                    $filterlbl['title2']='цвета';
                    $filterlbl['title3']='цветов';
                    $filterlbl['desc']='Основной цвет предмета';
                    break;
                case 'field_addon2':
                    $filterlbl['title']='Размер';
                    $filterlbl['title2']='размера';
                    $filterlbl['title3']='размеров';
                    break;
                case 'field_addon3':
                    $filterlbl['title']='Возраст';
                    $filterlbl['title2']='возраста';
                    $filterlbl['title3']='возрастов';
                    $filterlbl['desc']='На людей какого возраста ориентирован предмет';
                    break;
                case 'field_status':
                    $filterlbl['title']='Статус';
                    break;
                case 'field_state':
                    $filterlbl['title']='Состояние';
                    $filterlbl['title2']='состояния';
                    $filterlbl['title3']='состояний';
                    break;
                case 'field_rent_price':
                    $filterlbl['title']='Залоговая сумма';
                    break;
                case 'field_price_hour':
                    $filterlbl['title']='Цена/час';
                    break;
                case 'field_price_day':
                    $filterlbl['title']='Цена/день';
                    break;
                case 'field_price_week':
                    $filterlbl['title']='Цена/неделя';
                    break;
                case 'field_price_month':
                    $filterlbl['title']='Цена/месяц';
                    break;
                case 'field_brand':
                    $filterlbl['title']='Бренд';
                    $filterlbl['title2']='бренда';
                    $filterlbl['title3']='брендов';
                    break;
                case 'field_who':
                    $filterlbl['title']='Арендодатель';
                    $filterlbl['title2']='арендодателя';
                    $filterlbl['title3']='арендодателей';
                    break;
                case 'field_rn':
                    $filterlbl['title']='Район';
                    $filterlbl['title2']='района';
                    $filterlbl['title3']='районов';
                    $filterlbl['desc']='Район, где находится офис или квартира арендодателя';
                    break;
                case 'taxonomy_catalog':
                    $filterlbl['title']='Раздел';
                    $filterlbl['title2']='раздела';
                    $filterlbl['title3']='разделов';
                    break;
                case 'field_subpart':
                    $filterlbl['title']='Подраздел';
                    $filterlbl['title2']='подраздела';
                    $filterlbl['title3']='подразделов';
                    break;
                case 'field_tags':
                    $filterlbl['title']='Предмет';
                    $filterlbl['title2']='предмета';
                    $filterlbl['title3']='предметов';
                    break;
                case 'field_celebration':
                    $filterlbl['title']='К празднику';
                    $filterlbl['title2']='праздника';
                    $filterlbl['title3']='праздников';
                    break;
                case 'field_delivery2':
                    $filterlbl['title']='Доставка по городу';
                    break;
                case 'field_delivery3':
                    $filterlbl['title']='Доставка за город';
                    break;
                case 'field_status':
                    $filterlbl['title']='Доступно к аренде';
                    break;
                }

                
                if( !isset($filterlbl['title']) or !strlen($filterlbl['title']) ){
                    continue;
                }

                if( isset($filterlbl['field_infeatures_value']) and $filterlbl['field_infeatures_value']==1 ){
                    $isfeat[$id]=$filterlbl['title'];

                    if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){
                        $activestring_feat_count++;

                        foreach( $filter[$id] as $tid ){
                            if( is_numeric($tid) ){
                                $name=db_query('select name from {taxonomy_term_data} where tid='.$tid);
                                $name=$name->fetchAssoc();
                                if( isset($name['name']) and strlen($name['name']) ){
                                    $activestring_feat='Особенность: '.$name['name'];
                                } 
                                break;
                            }
                        }
                    }
                    
                    continue;
                }
                
                $filterclass='';
                if( !isset($fieldinfo[$id]['type']) or !strlen($fieldinfo[$id]['type']) ){
                    continue;
                }
                switch($fieldinfo[$id]['type']){
                case 'number_integer':
                case 'number_decimal':
                    $filterclass='myfilter_number';
                    break;
                case 'list_boolean':
                    $filterclass='myfilter_bool';
                    break;
                case 'taxonomy_term_reference':
                    $filterclass='myfilter_term';
                    break;
                case 'node_reference':
                    $filterclass='myfilter_nid';
                    break;
                case 'list_integer':
                    $filterclass='myfilter_list';
                    break;
                }

                $countfilt++;
                $out.='<div class="myfilter_item mys" onclick=" stpr(event || window.event); ">';
                $out.='<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$filterlbl['title'].'</div></div>';
                $out.='<div class="myfilter_content '.$filterclass.' myfilter_content_'.$id.'" style="display: none;"><img class="closeimg" onclick=" jQuery(\'.myfilter_item\').removeClass(\'myfilter_active\'); " alt="x" src="'.PDX_IMGPATH.'/img/msg_close.png" />';
                
                switch($filterclass){
// ------------------------------------------------------------------------------------------------------------- //
                case 'myfilter_nid':

                    $avals=array();
                    $avals_first=array();
                    
                    if( isset($fieldinfo[$id]['vid']) and strlen($fieldinfo[$id]['vid']) ){
                        $stopout=0;

                        if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ */
    
    $newsql='from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\')'.$sqlinner.' where n.status=1 and n.type=\'item\' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 ) '.$sqlwhere;


                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';

                            if( strpos($newsql,'{node} as node_'.$id)===false ){
                                $newsql=str_replace(' where ', ' inner join {node} as node_'.$id.' on (node_'.$id.'.nid='.$id.'.'.$id.'_nid) where node_'.$id.'.type IN ('.$fieldinfo[$id]['vid'].') and ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {node} as n', 'from {node} as n inner join {field_data_'.$id.'} as '.$id.' on (n.nid='.$id.'.entity_id and '.$id.'.entity_type=\'node\')', $newsql);
                            }
                            $newsql='select DISTINCT node_'.$id.'.nid, node_'.$id.'.title '.$newsql;
                            
                            
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                $avals[$value['nid']]=$value['title'];
                            }
                            foreach( $filter[$id] as $filter_id => $tid  ){
                                if( !isset( $avals[$tid] ) ){
                                    unset( $filter[$id][$filter_id] );
                                }
                            }

                            if( isset($avals) and is_array($avals) and count($avals) ){

                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        if( isset($avals[$tid]) ){
                                            $avals_first[$tid]=$avals[$tid];
                                            unset($avals[$tid]);
                                        }
                                    }
                                }
                                asort($avals_first);
                                asort($avals);

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
                                            $out.= ' checked="checked"';
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        
                                        $out.= '<div class="myfilt_delim">&nbsp;</div>';
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.');">Применить</span></div>';


                            $activestring='';
                            if( count($filter[$id])>2 ){
                                switch(count($filter[$id])){
                                case 2:
                                case 3:
                                case 4:
                                    if( isset($filterlbl['title2']) and strlen($filterlbl['title2']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title2']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                    
                                    break;
                                default:
                                    if( isset($filterlbl['title3']) and strlen($filterlbl['title3']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title3']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                }
                            }else{  
                                $activestring=$filterlbl['title'].': ';
                                $aactivestring=array();
                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        $name=db_query('select title from {node} where nid='.$tid);
                                        $name=$name->fetchAssoc();
                                        if( isset($name['title']) and strlen($name['title']) ){
                                            if( $id=='field_rn' ){
                                                $name['title']=str_replace(' район', '', $name['title']);
                                            }
                                            $aactivestring[]=$name['title'];
                                        } 
                                    }
                                }
                                if( isset($aactivestring) and is_array($aactivestring) and count($aactivestring) ){
                                    $activestring.=implode(', ', $aactivestring);
                                }
                            }

                            $out=str_replace('class="myfilter_item ','class="myfilter_item myfilter_item_selected ',$out);
                            $out=str_replace('<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$filterlbl['title'].'</div><','<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$activestring.'<span class="myfilt_close" onclick=" stpr(event || window.event); myfilt_filter_reset(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.'); "><span class="myfilt_close_in">x</span></span></div><',$out);


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ конец */

                        }else{
                            
                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';
                            if( isset($filterlbl['desc']) and strlen($filterlbl['desc']) ){
                                $out.='<div class="desc">'.$filterlbl['desc'].'</div>';
                            }
                            $newsql=$sql;

                            if( strpos($newsql,'{node} as node_'.$id)===false ){
                                $newsql=str_replace(' where ', ' inner join {node} as node_'.$id.' on (node_'.$id.'.nid='.$id.'.'.$id.'_nid) where node_'.$id.'.type IN ('.$fieldinfo[$id]['vid'].') and ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {node} as n', 'from {node} as n inner join {field_data_'.$id.'} as '.$id.' on (n.nid='.$id.'.entity_id and '.$id.'.entity_type=\'node\')', $newsql);
                            }
                            $newsql='select DISTINCT node_'.$id.'.nid, node_'.$id.'.title '.$newsql;



                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                $avals[$value['nid']]=$value['title'];
                            }
                            if( isset($avals) and is_array($avals) and count($avals) ){
                                if( count($avals)==1 ){
                                    $outonce.='<div class="myfilter_item myfilter_item_once" onclick=" stpr(event || window.event); "><div class="myfilter_lbl"><div class="myfilter_lbl_in">'.$filterlbl['title'].': ';
                                    foreach( $avals as $tid => $name ){
                                        if( $id=='field_rn' ){
                                            $name=str_replace(' район', '', $name);
                                        }
                                        $outonce.= $name;
                                    }
                                    $outonce.='</div></div></div>';
                                }else{
                                
                                    asort($avals);
                                    if( count($avals)>9 ){
                                        if( isset($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and is_array($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and count($_SESSION['pdxpdx_filter_nids'][$id]['tid']) ){
                                            foreach( $_SESSION['pdxpdx_filter_nids'][$id]['tid'] as $td ){
                                                if( isset($avals[$td]) ){
                                                    $avals_first[$td]=$avals[$td];
                                                    unset($avals[$td]);
                                                }
                                            }
                                        }
                                    }

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                            if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                $out.= ' checked="checked"';
//                                            }
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        $out.='<div>&nbsp;</div>';
                                        
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                                }
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.');">Применить</span></div>';
                            
                        }
                    }
                    
                    
                    break;
// ------------------------------------------------------------------------------------------------------------- //
                case 'myfilter_term':

                    $avals=array();
                    $avals_first=array();
                    
                    if( isset($fieldinfo[$id]['vid']) and is_numeric($fieldinfo[$id]['vid']) and isset($fieldinfo[$id]['voc']) and strlen($fieldinfo[$id]['voc']) ){
                        $stopout=0;

                        if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ */

    
    $newsql='from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\')'.$sqlinner.' where n.status=1 and n.type=\'item\' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 ) '.$sqlwhere;


                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';

                            if( strpos($newsql,'{taxonomy_term_data}')===false ){
                                $newsql=str_replace(' where ', ' inner join {taxonomy_term_data} as taxonomy_term_data on (taxonomy_term_data.tid='.$id.'.'.$id.'_tid) where ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {node} as n', 'from {node} as n inner join {field_data_'.$id.'} as '.$id.' on (n.nid='.$id.'.entity_id and '.$id.'.entity_type=\'node\')', $newsql);
                            }
                            $newsql='select DISTINCT taxonomy_term_data.tid, taxonomy_term_data.name '.$newsql;
                            
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                $avals[$value['tid']]=$value['name'];
                            }
                            foreach( $filter[$id] as $filter_id => $tid  ){
                                if( !isset( $avals[$tid] ) ){
                                    unset( $filter[$id][$filter_id] );
                                }
                            }

                            if( isset($avals) and is_array($avals) and count($avals) ){

                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        if( isset($avals[$tid]) ){
                                            $avals_first[$tid]=$avals[$tid];
                                            unset($avals[$tid]);
                                        }
                                    }
                                }
                                asort($avals_first);
                                asort($avals);

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                                if( $id=='field_addon1' and function_exists('pdxgetcolortid') ){
                                                    $out.= ' style=" border-left: 3px solid #'.pdxgetcolortid($tid);
                                                    $out.= '; "';
                                                }

                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
                                            $out.= ' checked="checked"';
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        
                                        $out.= '<div class="myfilt_delim">&nbsp;</div>';
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                if( $id=='field_addon1' and function_exists('pdxgetcolortid') ){
                                                    $tmpout.= ' style=" border-left: 3px solid #'.pdxgetcolortid($tid);
                                                    $tmpout.= '; "';
                                                }

                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.');">Применить</span></div>';


                            $activestring='';
                            if( count($filter[$id])>2 ){
                                switch(count($filter[$id])){
                                case 2:
                                case 3:
                                case 4:
                                    if( isset($filterlbl['title2']) and strlen($filterlbl['title2']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title2']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                    
                                    break;
                                default:
                                    if( isset($filterlbl['title3']) and strlen($filterlbl['title3']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title3']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                }
                            }else{  
                                $activestring=$filterlbl['title'].': ';
                                $aactivestring=array();
                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        $name=db_query('select name from {taxonomy_term_data} where tid='.$tid);
                                        $name=$name->fetchAssoc();
                                        if( isset($name['name']) and strlen($name['name']) ){
                                            if( $id=='field_rn' ){
                                                $name['name']=str_replace(' район', '', $name['name']);
                                            }
                                            $aactivestring[]=$name['name'];
                                        } 
                                    }
                                }
                                if( isset($aactivestring) and is_array($aactivestring) and count($aactivestring) ){
                                    $activestring.=implode(', ', $aactivestring);
                                }
                            }

                            $out=str_replace('class="myfilter_item ','class="myfilter_item myfilter_item_selected ',$out);
                            $out=str_replace('<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$filterlbl['title'].'</div><','<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$activestring.'<span class="myfilt_close" onclick=" stpr(event || window.event); myfilt_filter_reset(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.'); "><span class="myfilt_close_in">x</span></span></div><',$out);


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ конец */

                        }else{
                            
                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';
                            if( isset($filterlbl['desc']) and strlen($filterlbl['desc']) ){
                                $out.='<div class="desc">'.$filterlbl['desc'].'</div>';
                            }
                            $newsql=$sql;
                            if( strpos($newsql,'{taxonomy_term_data}')===false ){
                                $newsql=str_replace(' where ', ' inner join {taxonomy_term_data} as taxonomy_term_data on (taxonomy_term_data.tid='.$id.'.'.$id.'_tid) where ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {node} as n', 'from {node} as n inner join {field_data_'.$id.'} as '.$id.' on (n.nid='.$id.'.entity_id and '.$id.'.entity_type=\'node\')', $newsql);
                            }
                            $newsql='select DISTINCT taxonomy_term_data.tid, taxonomy_term_data.name '.$newsql;
                            
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                $avals[$value['tid']]=$value['name'];
                            }
                            if( isset($avals) and is_array($avals) and count($avals) ){
                                if( count($avals)==1 ){
                                    $outonce.='<div class="myfilter_item myfilter_item_once" onclick=" stpr(event || window.event); "><div class="myfilter_lbl"><div class="myfilter_lbl_in">'.$filterlbl['title'].': ';
                                    foreach( $avals as $tid => $name ){
                                        if( $id=='field_rn' ){
                                            $name=str_replace(' район', '', $name);
                                        }
                                        $outonce.= $name;
                                    }
                                    $outonce.='</div></div></div>';
                                }else{
                                
                                    asort($avals);
                                    if( count($avals)>9 ){
                                        if( isset($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and is_array($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and count($_SESSION['pdxpdx_filter_nids'][$id]['tid']) ){
                                            foreach( $_SESSION['pdxpdx_filter_nids'][$id]['tid'] as $td ){
                                                if( isset($avals[$td]) ){
                                                    $avals_first[$td]=$avals[$td];
                                                    unset($avals[$td]);
                                                }
                                            }
                                        }
                                    }

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                                if( $id=='field_addon1' and function_exists('pdxgetcolortid') ){
                                                    $out.= ' style=" border-left: 3px solid #'.pdxgetcolortid($tid);
                                                    $out.= '; "';
                                                }

                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                            if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                $out.= ' checked="checked"';
//                                            }
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        $out.='<div>&nbsp;</div>';
                                        
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                if( $id=='field_addon1' and function_exists('pdxgetcolortid') ){
                                                    $tmpout.= ' style=" border-left: 3px solid #'.pdxgetcolortid($tid);
                                                    $tmpout.= '; "';
                                                }

                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }

                                                
                                                if( $id=='field_addon1' and function_exists('pdxgetcolortid') ){
                                                    $out.= ' style=" border-left: 3px solid #'.pdxgetcolortid($tid);
                                                    $out.= '; "';
                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                                }
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.');">Применить</span></div>';
                            
                        }
                    }
                    
                    
                    break;
// ------------------------------------------------------------------------------------------------------------- //
                case 'myfilter_list':

                    $avals=array();
                    $avals_first=array();
                    
                        $stopout=0;

                        if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ */

    
    $newsql='from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\')'.$sqlinner.' where n.status=1 and n.type=\'item\' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 ) '.$sqlwhere;


                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';

                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {node} as n', 'from {node} as n inner join {field_data_'.$id.'} as '.$id.' on (n.nid='.$id.'.entity_id and '.$id.'.entity_type=\'node\')', $newsql);
                            }
                            $newsql='select DISTINCT '.$id.'.'.$id.'_value '.$newsql;
                            
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                if( isset($filterlbl['vals'][$value[$id.'_value']]) and strlen($filterlbl['vals'][$value[$id.'_value']]) ){
                                    $avals[$value[$id.'_value']]=$filterlbl['vals'][$value[$id.'_value']];
                                }
                            }
                            foreach( $filter[$id] as $filter_id => $tid  ){
                                if( !isset( $avals[$tid] ) ){
                                    unset( $filter[$id][$filter_id] );
                                }
                            }

                            if( isset($avals) and is_array($avals) and count($avals) ){

                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        if( isset($avals[$tid]) ){
                                            $avals_first[$tid]=$avals[$tid];
                                            unset($avals[$tid]);
                                        }
                                    }
                                }
                                asort($avals_first);
                                asort($avals);

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
                                            $out.= ' checked="checked"';
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        
                                        $out.= '<div class="myfilt_delim">&nbsp;</div>';
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.');">Применить</span></div>';


                            $activestring='';
                            if( count($filter[$id])>2 ){
                                switch(count($filter[$id])){
                                case 2:
                                case 3:
                                case 4:
                                    if( isset($filterlbl['title2']) and strlen($filterlbl['title2']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title2']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                    
                                    break;
                                default:
                                    if( isset($filterlbl['title3']) and strlen($filterlbl['title3']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title3']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                }
                            }else{  
                                $activestring=$filterlbl['title'].': ';
                                $aactivestring=array();
                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        if( isset($filterlbl['vals'][$tid]) and strlen($filterlbl['vals'][$tid]) ){
                                            $aactivestring[]=$filterlbl['vals'][$tid];
                                        }
                                    }
                                }
                                if( isset($aactivestring) and is_array($aactivestring) and count($aactivestring) ){
                                    $activestring.=implode(', ', $aactivestring);
                                }
                            }

                            $out=str_replace('class="myfilter_item ','class="myfilter_item myfilter_item_selected ',$out);
                            $out=str_replace('<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$filterlbl['title'].'</div><','<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$activestring.'<span class="myfilt_close" onclick=" stpr(event || window.event); myfilt_filter_reset(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.'); "><span class="myfilt_close_in">x</span></span></div><',$out);


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ конец */

                        }else{
                            
                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';
                            if( isset($filterlbl['desc']) and strlen($filterlbl['desc']) ){
                                $out.='<div class="desc">'.$filterlbl['desc'].'</div>';
                            }
                            $newsql=$sql;
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {node} as n', 'from {node} as n inner join {field_data_'.$id.'} as '.$id.' on (n.nid='.$id.'.entity_id and '.$id.'.entity_type=\'node\')', $newsql);
                            }
                            $newsql='select DISTINCT '.$id.'.'.$id.'_value '.$newsql;
                            
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                if( isset($filterlbl['vals'][$value[$id.'_value']]) and strlen($filterlbl['vals'][$value[$id.'_value']]) ){
                                    $avals[$value[$id.'_value']]=$filterlbl['vals'][$value[$id.'_value']];
                                }
                            }
                            if( isset($avals) and is_array($avals) and count($avals) ){
                                if( count($avals)==1 ){
                                    $outonce.='<div class="myfilter_item myfilter_item_once" onclick=" stpr(event || window.event); "><div class="myfilter_lbl"><div class="myfilter_lbl_in">'.$filterlbl['title'].': ';
                                    foreach( $avals as $tid => $name ){
                                        if( $id=='field_rn' ){
                                            $name=str_replace(' район', '', $name);
                                        }
                                        $outonce.= $name;
                                    }
                                    $outonce.='</div></div></div>';
                                }else{
                                
                                    asort($avals);
                                    if( count($avals)>9 ){
                                        if( isset($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and is_array($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and count($_SESSION['pdxpdx_filter_nids'][$id]['tid']) ){
                                            foreach( $_SESSION['pdxpdx_filter_nids'][$id]['tid'] as $td ){
                                                if( isset($avals[$td]) ){
                                                    $avals_first[$td]=$avals[$td];
                                                    unset($avals[$td]);
                                                }
                                            }
                                        }
                                    }

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                            if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                $out.= ' checked="checked"';
//                                            }
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        $out.='<div>&nbsp;</div>';
                                        
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                                }
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.');">Применить</span></div>';
                            
                        }
                    
                    
                    break;
// ------------------------------------------------------------------------------------------------------------- //
                case 'myfilter_number':
                
                    $stopout=0;
                    $numbermore='';

                    $activestring='';
                    if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){
                        $activestring=$filterlbl['title'].': ';
                        if( isset($filter[$id]['from']) and is_numeric($filter[$id]['from']) ){
                            $activestring.=str_replace('.00', '', number_format($filter[$id]['from'], 2, '.', ' ') );
                        }
                        if( isset($filter[$id]['to']) and is_numeric($filter[$id]['to']) and ( !isset($filter[$id]['from']) or $filter[$id]['from']!=$filter[$id]['to'] ) ){
                            if( isset($filter[$id]['from']) and is_numeric($filter[$id]['from']) ){
                                $activestring.='-';
                            }
                            $activestring.=str_replace('.00', '', number_format($filter[$id]['to'], 2, '.', ' ') );
                        }
                    }


                    if( isset($activestring) and strlen($activestring) ){
                        $out=str_replace('class="myfilter_item ','class="myfilter_item myfilter_item_selected ',$out);
                        $out=str_replace('<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$filterlbl['title'].'</div><','<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$activestring.'<span class="myfilt_close" onclick=" stpr(event || window.event); myfilt_filter_reset(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.'); "><span class="myfilt_close_in">x</span></span></div><',$out);
                    }



                    $isact=0;
                    if( isset($_SESSION['pdxpdx_filter_nids'][$id]['min']) and is_array($_SESSION['pdxpdx_filter_nids'][$id]['min']) and count($_SESSION['pdxpdx_filter_nids'][$id]['min']) ){
                    foreach( $_SESSION['pdxpdx_filter_nids'][$id]['min'] as $delta => $var ){

                        if( !isset($_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]) or !strlen($_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]) ){
                            $_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]=str_replace('.00','',$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta]);
                        }
                        if( (!isset($_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]) or !strlen($_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta])) and (isset($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]) and strlen($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta])) ){
                            $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]=str_replace('.00','',$_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]);
                        }
                        $pricedelim='-';
                        if( $_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]==0 ){
                            $_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]='до';
                            $pricedelim=' ';
                        }
                        if( (!isset($_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]) or !strlen($_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta])) and (isset($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]) and strlen($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta])) ){
                            $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]=str_replace('.00','',$_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]);
                        }
                        if( $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]==-1 ){
                            $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]=$_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta];
                            $_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]='более';
                            $_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]=100000;
                            $pricedelim=' ';
                        }
    
                        $numbermore.= '<div class="num_more_item">';
                        if(isset($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]) and strlen($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta])){
                            $numbermore.= '<span class="';
                            if( isset($filter[$id]['from']) and $filter[$id]['from']==$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta] and isset($filter[$id]['to']) and $filter[$id]['to']==$_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta] ){
                                $numbermore.= 'active ';
                                $isact=1;
                            }
                            $numbermore.= 'is_a" onclick=" if( jQuery(this).hasClass(\'active\') ){ jQuery(\'#fedit_'.$id.'_min\').val( jQuery(this).parent().parent().parent().find(\'.minval_'.$id.'\').val() ); jQuery(\'#fedit_'.$id.'_max\').val( jQuery(this).parent().parent().parent().find(\'.maxval_'.$id.'\').val() );  }else{ jQuery(\'#fedit_'.$id.'_min\').val(\''.$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta].'\'); jQuery(\'#fedit_'.$id.'_max\').val(\''.$_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta].'\'); } jQuery(\'#fedit_'.$id.'_max, #fedit_'.$id.'_min\').change(); selectfilter(this, 0);">'.$_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta];
                            if( $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]!=$_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta] ){
                                $numbermore.= $pricedelim;
                                $numbermore.= $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta];
                            }
                            $numbermore.= '</span>';
                        }else{
                            $numbermore.= '<span class="';
                            if( isset($filter[$id]['from']) and $filter[$id]['from']==$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta]  ){
                                $numbermore.= 'active ';
                                $isact=1;
                            }
                            $numbermore.= 'is_a" onclick=" if( jQuery(this).hasClass(\'active\') ){ jQuery(\'#fedit_'.$id.'_min\').val( jQuery(this).parent().parent().parent().find(\'.minval_'.$id.'\').val() ); jQuery(\'#fedit_'.$id.'_max\').val( jQuery(this).parent().parent().parent().find(\'.maxval_'.$id.'\').val() ); }else{ jQuery(\'#fedit_'.$id.'_min\').val(\''.$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta].'\'); jQuery(\'#fedit_'.$id.'_max\').val(\''.$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta].'\'); } jQuery(\'#fedit_'.$id.'_max, #fedit_'.$id.'_min\').change(); selectfilter(this, 0);">'.$_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta].'</a>';
                        }
                        $numbermore.= '</div>';
                    }
                    }
                                            
                    if( isset($numbermore) and strlen($numbermore) ){
                        $out.= '<div class="num_more_items">';
                        $out.= $numbermore;
                        $out.= '</div>';
                    }
                    



    $newsql='from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\')'.$sqlinner.' where n.status=1 and n.type=\'item\' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 ) '.$sqlwhere;

    if( strpos($newsql,'{field_data_'.$id.'}')===false ){
        $newsql=str_replace('from {node} as n', 'from {node} as n inner join {field_data_'.$id.'} as '.$id.' on (n.nid='.$id.'.entity_id and '.$id.'.entity_type=\'node\')', $newsql);
    }
    

    
    
                            $max_price=$curmax_price=0;
                            $min_price=$curmin_price=0;

                            if( strlen($newsql) ){
                            
                                $map=db_query('select MAX('.$id.'.'.$id.'_value) '.$newsql);
                                $map=$map->fetchAssoc();

                                if( isset($map['MAX('.$id.'.'.$id.'_value)']) and is_numeric($map['MAX('.$id.'.'.$id.'_value)']) and $map['MAX('.$id.'.'.$id.'_value)']>0 ){
                                    $max_price=$curmax_price=round($map['MAX('.$id.'.'.$id.'_value)'],0);
                                }else{
                                    $stopout=1;
                                }
                            
                                $mip=db_query('select MIN('.$id.'.'.$id.'_value) '.$newsql.' and '.$id.'.'.$id.'_value>0');
                                $mip=$mip->fetchAssoc();
                                if( isset($mip['MIN('.$id.'.'.$id.'_value)']) and is_numeric($mip['MIN('.$id.'.'.$id.'_value)']) ){
                                    $min_price=$curmin_price=round($mip['MIN('.$id.'.'.$id.'_value)'],0);
                                }
                                
                                if( $max_price==$min_price ){
                                    $stopout=1;
                                }
                            
                            }else{
                                $max_price='1000000000';
                            }
                            
                            if( isset($filter[$id]['to']) and is_numeric($filter[$id]['to']) and $max_price>$filter[$id]['to'] ){
                                $curmax_price=$filter[$id]['to'];
                            }
                            if( isset($filter[$id]['from']) and is_numeric($filter[$id]['from']) and $min_price<$filter[$id]['from'] ){
                                $curmin_price=$filter[$id]['from'];
                            }
                            
                            $out.= '
                            
    <div class="slider_line">
    от <input id="fedit_'.$id.'_min" name="'.$id.'[min]" value="'.$curmin_price.'" size="9" maxlength="128" class="slider_from" type="text" /> до <input id="fedit_'.$id.'_max" name="'.$id.'[max]" value="'.$curmax_price.'" size="9" maxlength="128" class="slider_to" type="text" />
    </div>
                            
                            <div class="ffilter ffilter_'.$id.'">
                            <input type="hidden" value="'.$min_price.'" class="minval_'.$id.'" />
                            <input type="hidden" value="'.$max_price.'" class="maxval_'.$id.'" />
                            <div class="filter-price-slider" id="filter_'.$id.'"></div>
                            <div class="filter-apply filter-apply-is"><span class="is_a filter-apply-apply" onclick=" myfilt_apply_num(\''.$id.'\', \''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.'); ">Применить</span><span class="is_a filter-apply-clear" onclick=" jQuery(\'#fedit_'.$id.'_max\').val( jQuery(this).parent().parent().find(\'.maxval_'.$id.'\').val() ); jQuery(\'#fedit_'.$id.'_min\').val( jQuery(this).parent().parent().find(\'.minval_'.$id.'\').val() ); jQuery(\'#fedit_'.$id.'_max, #fedit_'.$id.'_min\').change(); jQuery(\'.myfilter_content_'.$id.' .num_more_items span.is_a\').removeClass(\'active\'); "><span class="in">Очистить</span></span><div class="clear">&nbsp;</div></div>
                            </div>';
    
        





                    break;
                }
                
                $out.='</div>';
                $out.='</div>';

                if( strlen($outonce) ){
                    $out=$outonce;
                }
                if( !$stopout ){
                    $outall.=$out;
                }
            }
            
            $out='';
            if( isset($isfeat) and is_array($isfeat) and count($isfeat) ){
                $stopout=0;

                if( $activestring_feat_count>1 ){
                    switch($activestring_feat_count){
                    case 2:
                    case 3:
                    case 4:
                        $activestring_feat=$activestring_feat_count.' особенности';
                        break;
                    default:
                        $activestring_feat=$activestring_feat_count.' особенностей';
                    }
                }
                if( isset($activestring_feat) and strlen($activestring_feat) ){
                    $out.='<div class="myfilter_item myfilter_item_selected" onclick=" stpr(event || window.event); "><div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$activestring_feat.'<span class="myfilt_close" onclick=" stpr(event || window.event);  myfilt_filter_feat_reset(\''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.'); "><span class="myfilt_close_in">x</span></span></div></div>';


                    $out.='<div class="myfilter_content" style="display: none;"><img class="closeimg" onclick=" jQuery(\'.myfilter_item\').removeClass(\'myfilter_active\'); " alt="x" src="'.PDX_IMGPATH.'/img/msg_close.png" />';
                    $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_feat">';
                    $avals=array();
                    $avals_first=array();

                    foreach( $isfeat as $id => $ttl ){
                        if( isset($fieldinfo[$id]['vid']) and is_numeric($fieldinfo[$id]['vid']) and isset($fieldinfo[$id]['voc']) and strlen($fieldinfo[$id]['voc']) ){
                            $newsql=$sql;
                            if( strpos($newsql,'{taxonomy_term_data}')===false ){
                                $newsql=str_replace(' where ', ' inner join {taxonomy_term_data} as taxonomy_term_data on (taxonomy_term_data.tid='.$id.'.'.$id.'_tid) where ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {node} as n', 'from {node} as n inner join {field_data_'.$id.'} as '.$id.' on (n.nid='.$id.'.entity_id and '.$id.'.entity_type=\'node\')', $newsql);
                            }
                            $newsql='select DISTINCT taxonomy_term_data.tid, taxonomy_term_data.name '.$newsql;
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                if( $fieldinfo[$id]['voc']=='yes_or_no' ){
                                    $avals[$id][82]=$ttl;
                                }else{
                                    $avals[$id][$value['tid']]=$value['name'];
                                }
                            }
                        }
                    }

                                if( isset($avals) and is_array($avals) and count($avals) ){
                                    foreach( $avals as $id => $aval ){
                                        asort($aval);
                                        if( isset($aval) and is_array($aval) and count($aval) ){
                                                foreach( $aval as $tid => $name ){
                                                    $out.= '<div class="myfilter_field"><label';
//                                                    if( mb_strlen($name)>11 ){
//                                                        $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                        $name=mb_substr($name,0,9).'...';
//                                                    }
                                                    $out.= '><input class="form-checkbox myfilt_val_term myfilt_feat myfilt_feat_'.$id.'" type="checkbox" value="'.$tid.'"';
                                                    if( $fieldinfo[$id]['voc']=='yes_or_no' ){
                                                        if( isset( $filter[$id] ) and is_array( $filter[$id] ) and count( $filter[$id] ) ){
                                                            $out.= ' checked="checked"';
                                                        }
                                                    }else{
                                                        if( isset( $filter[$id] ) and is_array( $filter[$id] ) and count( $filter[$id] ) ){
                                                            foreach( $filter[$id] as $td ){
                                                                if( $td==$tid ){
                                                                    $out.= ' checked="checked"';
                                                                }
                                                            }
                                                        }
                                                    }
                                                    $out.= ' /> ';
                                                    $out.= mb_strtolower($name);
                                                    $out.= '</label></div>';
                                                }
                                        }
                                    }
                                }else{
                                    $stopout=1;
                                }
                                $out.='</div>';
                                $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_feat(\''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.');">Применить</span></div>';


                    $out.='</div>';
                    $out.='</div>';
                }else{ 
                    $out.='<div class="myfilter_item mys" onclick=" stpr(event || window.event); "><div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">Особенности</div></div>';
                    $out.='<div class="myfilter_content" style="display: none;"><img class="closeimg" onclick=" jQuery(\'.myfilter_item\').removeClass(\'myfilter_active\'); " alt="x" src="'.PDX_IMGPATH.'/img/msg_close.png" />';
                    $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_feat">';
                    if( isset($filterlbl['desc']) and strlen($filterlbl['desc']) ){
                        $out.='<div class="desc">'.$filterlbl['desc'].'</div>';
                    }
                    $avals=array();
                    $avals_first=array();

                    foreach( $isfeat as $id => $ttl ){
                        if( isset($fieldinfo[$id]['vid']) and is_numeric($fieldinfo[$id]['vid']) and isset($fieldinfo[$id]['voc']) and strlen($fieldinfo[$id]['voc']) ){
                            $newsql=$sql;
                            if( strpos($newsql,'{taxonomy_term_data}')===false ){
                                $newsql=str_replace(' where ', ' inner join {taxonomy_term_data} as taxonomy_term_data on (taxonomy_term_data.tid='.$id.'.'.$id.'_tid) where ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {node} as n', 'from {node} as n inner join {field_data_'.$id.'} as '.$id.' on (n.nid='.$id.'.entity_id and '.$id.'.entity_type=\'node\')', $newsql);
                            }
                            $newsql='select DISTINCT taxonomy_term_data.tid, taxonomy_term_data.name '.$newsql;
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                if( $fieldinfo[$id]['voc']=='yes_or_no' ){
                                    $avals[$id][82]=$ttl;
                                }else{
                                    $avals[$id][$value['tid']]=$value['name'];
                                }
                            }
                        }
                    }

                                if( isset($avals) and is_array($avals) and count($avals) ){
                                    foreach( $avals as $id => $aval ){
                                        asort($aval);
                                        if( isset($aval) and is_array($aval) and count($aval) ){
                                                foreach( $aval as $tid => $name ){
                                                    $out.= '<div class="myfilter_field"><label';
//                                                    if( mb_strlen($name)>11 ){
//                                                        $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                        $name=mb_substr($name,0,9).'...';
//                                                    }
                                                    $out.= '><input class="form-checkbox myfilt_val_term myfilt_feat myfilt_feat_'.$id.'" type="checkbox" value="'.$tid.'"';
//                                                    if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                        $out.= ' checked="checked"';
//                                                    }
                                                    $out.= ' /> ';
                                                    $out.= mb_strtolower($name);
                                                    $out.= '</label></div>';
                                                }
                                        }
                                    }
                                }else{
                                    $stopout=1;
                                }
                                $out.='</div>';
                                $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_feat(\''.$ispath.'\', '.$cat.', '.$brand.', '.$tags.', 1, '.$celebration.');">Применить</span></div>';
                                
                    $out.='</div></div>';
                }
            }
            if( !$stopout ){
                $outall.=$out;
            }
            $outall.='</div></div>';
        }
        
//        $outall.='<pre>'.print_r($sql, true).'</pre>';

    }
    
    return $outall;
}
function pdxcat_filter_user($filter){

    
    $outall='';

    $ispath=PDXCAT_USERNAME;

    $fieldinfo=array();
    if( file_exists('./pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend/fields_info') ){
        $cacheis= file_get_contents('./pdxcache/'.$_SERVER['HTTP_HOST'].'/prepend/fields_info');
        if( isset($cacheis) and strlen($cacheis) ){
            $cacheis=unserialize($cacheis);
            if( isset($cacheis) and is_array($cacheis) and count($cacheis) ){ 
                $fieldinfo=$cacheis;
            }
        }
    }
    if( !isset($fieldinfo) or !is_array($fieldinfo) or !count($fieldinfo) ){
        $fieldinfo=pdxcat_fieldsinfo(1);
    }

    $filterstr='';
    $sqlinner='';
    $sqlwhere='';
    if( function_exists('pdxfilterout') ){
        $tmpout=pdxfilterout($filter, $fieldinfo, '', 'user', 'uid');
        $filterstr=$tmpout['filterstr'];
        $sqlinner.=$tmpout['sqlinner'];
        $sqlwhere=$tmpout['sqlwhere'];
    }
    

    $sqlfilt='from {users} as n inner join {field_data_field_items_active} as field_items_active on (n.uid=field_items_active.entity_id and field_items_active.entity_type=\'user\') left join {field_data_field_gold} as fg on (n.uid=fg.entity_id and fg.entity_type=\'user\') left join {field_data_field_delete} as fd on (n.uid=fd.entity_id and fd.entity_type=\'user\') '.$sqlinner.' where n.status=1 and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and field_items_active.field_items_active_value>0 '.$sqlwhere;
    $sql=$sqlfilt;
    
    if( function_exists('pdxfiltergenusers') ){
        $tmpfilt=pdxfiltergenusers();
        if( isset($tmpfilt['nids']) ){
            $_SESSION['pdxpdx_filter_nids']=$tmpfilt['nids'];
        }
        if( isset($tmpfilt['filters']) ){
            $_SESSION['pdxpdx_filter_filters']=$tmpfilt['filters'];
        }
    }


    if( isset($_SESSION['pdxpdx_filter_filters']) and is_array($_SESSION['pdxpdx_filter_filters']) and count($_SESSION['pdxpdx_filter_filters'])  ){
        asort($_SESSION['pdxpdx_filter_filters']);
        
        if( isset($_SESSION['pdxpdx_filter_filters']) and is_array($_SESSION['pdxpdx_filter_filters']) and count($_SESSION['pdxpdx_filter_filters']) ){
            $outall.='<div class="filter_main"><div class="filter_content">';
            $countfilt=0;
            
            $isfeat=array();
            $activestring_feat='';
            $activestring_feat_count=0;


            foreach( $_SESSION['pdxpdx_filter_filters'] as $id => $weight ){
                $out=$outonce='';
                $stopout=1;
                

                $newfilter = $filter;
                unset($newfilter[$id]);
                
            
                $filterstr='';
                $sqlinner='';
                $sqlwhere='';
                if( function_exists('pdxfilterout') ){
                    $tmpout=pdxfilterout($newfilter, $fieldinfo, '', 'user', 'uid');
                    $filterstr=$tmpout['filterstr'];
                    $sqlinner.=$tmpout['sqlinner'];
                    $sqlwhere=$tmpout['sqlwhere'];
                }



                $filterlbl=array();
                switch($id){
                case 'field_who':
                    $filterlbl['title']='Арендодатель';
                    $filterlbl['vals']=array(
                        1=>'Частное лицо',
                        2=>'Компания/магазин',
                    );
                    break;
                case 'field_items_active':
                    $filterlbl['title']='Объявлений';
                    break;
                case 'field_parts':
                    $filterlbl['title']='Раздел';
                    $filterlbl['title2']='раздела';
                    $filterlbl['title3']='разделов';
                    break;
                case 'field_rn':
                    $filterlbl['title']='Район';
                    $filterlbl['title2']='района';
                    $filterlbl['title3']='районов';
                    $filterlbl['desc']='Район, где находится офис или квартира арендодателя';
                    break;
                }

                
                if( !isset($filterlbl['title']) or !strlen($filterlbl['title']) ){
                    continue;
                }

                if( isset($filterlbl['field_infeatures_value']) and $filterlbl['field_infeatures_value']==1 ){
                    $isfeat[$id]=$filterlbl['title'];

                    if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){
                        $activestring_feat_count++;

                        foreach( $filter[$id] as $tid ){
                            if( is_numeric($tid) ){
                                $name=db_query('select name from {taxonomy_term_data} where tid='.$tid);
                                $name=$name->fetchAssoc();
                                if( isset($name['name']) and strlen($name['name']) ){
                                    $activestring_feat='Особенность: '.$name['name'];
                                } 
                                break;
                            }
                        }
                    }
                    
                    continue;
                }
                
                $filterclass='';
                if( !isset($fieldinfo[$id]['type']) or !strlen($fieldinfo[$id]['type']) ){
                    continue;
                }
                switch($fieldinfo[$id]['type']){
                case 'number_integer':
                case 'number_decimal':
                    $filterclass='myfilter_number';
                    break;
                case 'list_boolean':
                    $filterclass='myfilter_bool';
                    break;
                case 'taxonomy_term_reference':
                    $filterclass='myfilter_term';
                    break;
                case 'node_reference':
                    $filterclass='myfilter_nid';
                    break;
                case 'list_integer':
                    $filterclass='myfilter_list';
                    break;
                }

                $countfilt++;
                $out.='<div class="myfilter_item mys" onclick=" stpr(event || window.event); ">';
                $out.='<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$filterlbl['title'].'</div></div>';
                $out.='<div class="myfilter_content '.$filterclass.' myfilter_content_'.$id.'" style="display: none;"><img class="closeimg" onclick=" jQuery(\'.myfilter_item\').removeClass(\'myfilter_active\'); " alt="x" src="'.PDX_IMGPATH.'/img/msg_close.png" />';
                
                switch($filterclass){
// ------------------------------------------------------------------------------------------------------------- //
                case 'myfilter_nid':

                    $avals=array();
                    $avals_first=array();
                    
                    if( isset($fieldinfo[$id]['vid']) and strlen($fieldinfo[$id]['vid']) ){
                        $stopout=0;

                        if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ */

    $newsql='from {users} as n inner join {field_data_field_items_active} as field_items_active on (n.uid=field_items_active.entity_id and field_items_active.entity_type=\'user\') left join {field_data_field_gold} as fg on (n.uid=fg.entity_id and fg.entity_type=\'user\') left join {field_data_field_delete} as fd on (n.uid=fd.entity_id and fd.entity_type=\'user\') '.$sqlinner.' where n.status=1 and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and field_items_active.field_items_active_value>0 '.$sqlwhere;


                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';

                            if( strpos($newsql,'{node} as node_'.$id)===false ){
                                $newsql=str_replace(' where ', ' inner join {node} as node_'.$id.' on (node_'.$id.'.nid='.$id.'.'.$id.'_nid) where node_'.$id.'.type IN ('.$fieldinfo[$id]['vid'].') and ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {users} as n', 'from {users} as n inner join {field_data_'.$id.'} as '.$id.' on (n.uid='.$id.'.entity_id and '.$id.'.entity_type=\'user\')', $newsql);
                            }
                            $newsql='select DISTINCT node_'.$id.'.nid, node_'.$id.'.title '.$newsql;
                            
                            
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                $avals[$value['nid']]=$value['title'];
                            }
                            foreach( $filter[$id] as $filter_id => $tid  ){
                                if( !isset( $avals[$tid] ) ){
                                    unset( $filter[$id][$filter_id] );
                                }
                            }

                            if( isset($avals) and is_array($avals) and count($avals) ){

                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        if( isset($avals[$tid]) ){
                                            $avals_first[$tid]=$avals[$tid];
                                            unset($avals[$tid]);
                                        }
                                    }
                                }
                                asort($avals_first);
                                asort($avals);

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
                                            $out.= ' checked="checked"';
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        
                                        $out.= '<div class="myfilt_delim">&nbsp;</div>';
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \'\', 0, 0, 0, 2, 0);">Применить</span></div>';


                            $activestring='';
                            if( count($filter[$id])>2 ){
                                switch(count($filter[$id])){
                                case 2:
                                case 3:
                                case 4:
                                    if( isset($filterlbl['title2']) and strlen($filterlbl['title2']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title2']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                    
                                    break;
                                default:
                                    if( isset($filterlbl['title3']) and strlen($filterlbl['title3']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title3']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                }
                            }else{  
                                $activestring=$filterlbl['title'].': ';
                                $aactivestring=array();
                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        $name=db_query('select title from {node} where nid='.$tid);
                                        $name=$name->fetchAssoc();
                                        if( isset($name['title']) and strlen($name['title']) ){
                                            if( $id=='field_rn' ){
                                                $name['title']=str_replace(' район', '', $name['title']);
                                            }
                                            $aactivestring[]=$name['title'];
                                        } 
                                    }
                                }
                                if( isset($aactivestring) and is_array($aactivestring) and count($aactivestring) ){
                                    $activestring.=implode(', ', $aactivestring);
                                }
                            }

                            $out=str_replace('class="myfilter_item ','class="myfilter_item myfilter_item_selected ',$out);
                            $out=str_replace('<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$filterlbl['title'].'</div><','<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$activestring.'<span class="myfilt_close" onclick=" stpr(event || window.event); myfilt_filter_reset(\''.$id.'\', \'\', 0, 0, 0, 2, 0); "><span class="myfilt_close_in">x</span></span></div><',$out);


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ конец */

                        }else{
                            
                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';
                            if( isset($filterlbl['desc']) and strlen($filterlbl['desc']) ){
                                $out.='<div class="desc">'.$filterlbl['desc'].'</div>';
                            }
                            $newsql=$sql;

                            if( strpos($newsql,'{node} as node_'.$id)===false ){
                                $newsql=str_replace(' where ', ' inner join {node} as node_'.$id.' on (node_'.$id.'.nid='.$id.'.'.$id.'_nid) where node_'.$id.'.type IN ('.$fieldinfo[$id]['vid'].') and ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {users} as n', 'from {users} as n inner join {field_data_'.$id.'} as '.$id.' on (n.uid='.$id.'.entity_id and '.$id.'.entity_type=\'user\')', $newsql);
                            }
                            $newsql='select DISTINCT node_'.$id.'.nid, node_'.$id.'.title '.$newsql;



                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                $avals[$value['nid']]=$value['title'];
                            }
                            if( isset($avals) and is_array($avals) and count($avals) ){
                                if( count($avals)==1 ){
                                    $outonce.='<div class="myfilter_item myfilter_item_once" onclick=" stpr(event || window.event); "><div class="myfilter_lbl"><div class="myfilter_lbl_in">'.$filterlbl['title'].': ';
                                    foreach( $avals as $tid => $name ){
                                        if( $id=='field_rn' ){
                                            $name=str_replace(' район', '', $name);
                                        }
                                        $outonce.= $name;
                                    }
                                    $outonce.='</div></div></div>';
                                }else{
                                
                                    asort($avals);
                                    if( count($avals)>9 ){
                                        if( isset($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and is_array($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and count($_SESSION['pdxpdx_filter_nids'][$id]['tid']) ){
                                            foreach( $_SESSION['pdxpdx_filter_nids'][$id]['tid'] as $td ){
                                                if( isset($avals[$td]) ){
                                                    $avals_first[$td]=$avals[$td];
                                                    unset($avals[$td]);
                                                }
                                            }
                                        }
                                    }

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                            if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                $out.= ' checked="checked"';
//                                            }
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        $out.='<div>&nbsp;</div>';
                                        
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                                }
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \'\', 0, 0, 0, 2, 0);">Применить</span></div>';
                            
                        }
                    }
                    
                    
                    break;
// ------------------------------------------------------------------------------------------------------------- //
                case 'myfilter_term':

                    $avals=array();
                    $avals_first=array();
                    
                    if( isset($fieldinfo[$id]['vid']) and is_numeric($fieldinfo[$id]['vid']) and isset($fieldinfo[$id]['voc']) and strlen($fieldinfo[$id]['voc']) ){
                        $stopout=0;

                        if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ */

    
    $newsql='from {users} as n inner join {field_data_field_items_active} as field_items_active on (n.uid=field_items_active.entity_id and field_items_active.entity_type=\'user\') left join {field_data_field_gold} as fg on (n.uid=fg.entity_id and fg.entity_type=\'user\') left join {field_data_field_delete} as fd on (n.uid=fd.entity_id and fd.entity_type=\'user\') '.$sqlinner.' where n.status=1 and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and field_items_active.field_items_active_value>0 '.$sqlwhere;


                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';

                            if( strpos($newsql,'{taxonomy_term_data}')===false ){
                                $newsql=str_replace(' where ', ' inner join {taxonomy_term_data} as taxonomy_term_data on (taxonomy_term_data.tid='.$id.'.'.$id.'_tid) where ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {users} as n', 'from {users} as n inner join {field_data_'.$id.'} as '.$id.' on (n.uid='.$id.'.entity_id and '.$id.'.entity_type=\'user\')', $newsql);
                            }
                            $newsql='select DISTINCT taxonomy_term_data.tid, taxonomy_term_data.name '.$newsql;
                            
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                $avals[$value['tid']]=$value['name'];
                            }
                            foreach( $filter[$id] as $filter_id => $tid  ){
                                if( !isset( $avals[$tid] ) ){
                                    unset( $filter[$id][$filter_id] );
                                }
                            }

                            if( isset($avals) and is_array($avals) and count($avals) ){

                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        if( isset($avals[$tid]) ){
                                            $avals_first[$tid]=$avals[$tid];
                                            unset($avals[$tid]);
                                        }
                                    }
                                }
                                asort($avals_first);
                                asort($avals);

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
                                            $out.= ' checked="checked"';
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        
                                        $out.= '<div class="myfilt_delim">&nbsp;</div>';
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \'\', 0, 0, 0, 2, 0);">Применить</span></div>';


                            $activestring='';
                            if( count($filter[$id])>2 ){
                                switch(count($filter[$id])){
                                case 2:
                                case 3:
                                case 4:
                                    if( isset($filterlbl['title2']) and strlen($filterlbl['title2']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title2']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                    
                                    break;
                                default:
                                    if( isset($filterlbl['title3']) and strlen($filterlbl['title3']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title3']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                }
                            }else{  
                                $activestring=$filterlbl['title'].': ';
                                $aactivestring=array();
                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        $name=db_query('select name from {taxonomy_term_data} where tid='.$tid);
                                        $name=$name->fetchAssoc();
                                        if( isset($name['name']) and strlen($name['name']) ){
                                            if( $id=='field_rn' ){
                                                $name['name']=str_replace(' район', '', $name['name']);
                                            }
                                            $aactivestring[]=$name['name'];
                                        } 
                                    }
                                }
                                if( isset($aactivestring) and is_array($aactivestring) and count($aactivestring) ){
                                    $activestring.=implode(', ', $aactivestring);
                                }
                            }

                            $out=str_replace('class="myfilter_item ','class="myfilter_item myfilter_item_selected ',$out);
                            $out=str_replace('<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$filterlbl['title'].'</div><','<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$activestring.'<span class="myfilt_close" onclick=" stpr(event || window.event); myfilt_filter_reset(\''.$id.'\', \'\', 0, 0, 0, 2, 0); "><span class="myfilt_close_in">x</span></span></div><',$out);


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ конец */

                        }else{
                            
                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';
                            if( isset($filterlbl['desc']) and strlen($filterlbl['desc']) ){
                                $out.='<div class="desc">'.$filterlbl['desc'].'</div>';
                            }
                            $newsql=$sql;
                            if( strpos($newsql,'{taxonomy_term_data}')===false ){
                                $newsql=str_replace(' where ', ' inner join {taxonomy_term_data} as taxonomy_term_data on (taxonomy_term_data.tid='.$id.'.'.$id.'_tid) where ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {users} as n', 'from {users} as n inner join {field_data_'.$id.'} as '.$id.' on (n.uid='.$id.'.entity_id and '.$id.'.entity_type=\'user\')', $newsql);
                            }
                            $newsql='select DISTINCT taxonomy_term_data.tid, taxonomy_term_data.name '.$newsql;
                            
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                $avals[$value['tid']]=$value['name'];
                            }
                            if( isset($avals) and is_array($avals) and count($avals) ){
                                if( count($avals)==1 ){
                                    $outonce.='<div class="myfilter_item myfilter_item_once" onclick=" stpr(event || window.event); "><div class="myfilter_lbl"><div class="myfilter_lbl_in">'.$filterlbl['title'].': ';
                                    foreach( $avals as $tid => $name ){
                                        if( $id=='field_rn' ){
                                            $name=str_replace(' район', '', $name);
                                        }
                                        $outonce.= $name;
                                    }
                                    $outonce.='</div></div></div>';
                                }else{
                                
                                    asort($avals);
                                    if( count($avals)>9 ){
                                        if( isset($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and is_array($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and count($_SESSION['pdxpdx_filter_nids'][$id]['tid']) ){
                                            foreach( $_SESSION['pdxpdx_filter_nids'][$id]['tid'] as $td ){
                                                if( isset($avals[$td]) ){
                                                    $avals_first[$td]=$avals[$td];
                                                    unset($avals[$td]);
                                                }
                                            }
                                        }
                                    }

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                            if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                $out.= ' checked="checked"';
//                                            }
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        $out.='<div>&nbsp;</div>';
                                        
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                                }
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \'\', 0, 0, 0, 2, 0);">Применить</span></div>';
                            
                        }
                    }
                    
                    
                    break;
// ------------------------------------------------------------------------------------------------------------- //
                case 'myfilter_list':

                    $avals=array();
                    $avals_first=array();
                    
                        $stopout=0;

                        if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ */

    
    $newsql='from {users} as n inner join {field_data_field_items_active} as field_items_active on (n.uid=field_items_active.entity_id and field_items_active.entity_type=\'user\') left join {field_data_field_gold} as fg on (n.uid=fg.entity_id and fg.entity_type=\'user\') left join {field_data_field_delete} as fd on (n.uid=fd.entity_id and fd.entity_type=\'user\') '.$sqlinner.' where n.status=1 and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and field_items_active.field_items_active_value>0 '.$sqlwhere;


                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';

                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {users} as n', 'from {users} as n inner join {field_data_'.$id.'} as '.$id.' on (n.uid='.$id.'.entity_id and '.$id.'.entity_type=\'user\')', $newsql);
                            }
                            $newsql='select DISTINCT '.$id.'.'.$id.'_value '.$newsql;
                            
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                if( isset($filterlbl['vals'][$value[$id.'_value']]) and strlen($filterlbl['vals'][$value[$id.'_value']]) ){
                                    $avals[$value[$id.'_value']]=$filterlbl['vals'][$value[$id.'_value']];
                                }
                            }
                            foreach( $filter[$id] as $filter_id => $tid  ){
                                if( !isset( $avals[$tid] ) ){
                                    unset( $filter[$id][$filter_id] );
                                }
                            }

                            if( isset($avals) and is_array($avals) and count($avals) ){

                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        if( isset($avals[$tid]) ){
                                            $avals_first[$tid]=$avals[$tid];
                                            unset($avals[$tid]);
                                        }
                                    }
                                }
                                asort($avals_first);
                                asort($avals);

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
                                            $out.= ' checked="checked"';
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        
                                        $out.= '<div class="myfilt_delim">&nbsp;</div>';
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \'\', 0, 0, 0, 2, 0);">Применить</span></div>';


                            $activestring='';
                            if( count($filter[$id])>2 ){
                                switch(count($filter[$id])){
                                case 2:
                                case 3:
                                case 4:
                                    if( isset($filterlbl['title2']) and strlen($filterlbl['title2']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title2']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                    
                                    break;
                                default:
                                    if( isset($filterlbl['title3']) and strlen($filterlbl['title3']) ){
                                        $activestring=count($filter[$id]).' '.mb_strtolower($filterlbl['title3']);
                                    }else{
                                        $activestring=$filterlbl['title'].': '.count($filter[$id]);
                                    }
                                }
                            }else{  
                                $activestring=$filterlbl['title'].': ';
                                $aactivestring=array();
                                foreach( $filter[$id] as $tid ){
                                    if( is_numeric($tid) ){
                                        if( isset($filterlbl['vals'][$tid]) and strlen($filterlbl['vals'][$tid]) ){
                                            $aactivestring[]=$filterlbl['vals'][$tid];
                                        }
                                    }
                                }
                                if( isset($aactivestring) and is_array($aactivestring) and count($aactivestring) ){
                                    $activestring.=implode(', ', $aactivestring);
                                }
                            }

                            $out=str_replace('class="myfilter_item ','class="myfilter_item myfilter_item_selected ',$out);
                            $out=str_replace('<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$filterlbl['title'].'</div><','<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$activestring.'<span class="myfilt_close" onclick=" stpr(event || window.event); myfilt_filter_reset(\''.$id.'\', \'\', 0, 0, 0, 2, 0); "><span class="myfilt_close_in">x</span></span></div><',$out);


/* ---------------------АКТИВНЫЕ ФИЛЬТРЫ конец */

                        }else{
                            
                            $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_'.$id;
                            $out.='">';
                            if( isset($filterlbl['desc']) and strlen($filterlbl['desc']) ){
                                $out.='<div class="desc">'.$filterlbl['desc'].'</div>';
                            }
                            $newsql=$sql;
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {users} as n', 'from {users} as n inner join {field_data_'.$id.'} as '.$id.' on (n.uid='.$id.'.entity_id and '.$id.'.entity_type=\'user\')', $newsql);
                            }
                            $newsql='select DISTINCT '.$id.'.'.$id.'_value '.$newsql;
                            
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                if( isset($filterlbl['vals'][$value[$id.'_value']]) and strlen($filterlbl['vals'][$value[$id.'_value']]) ){
                                    $avals[$value[$id.'_value']]=$filterlbl['vals'][$value[$id.'_value']];
                                }
                            }
                            if( isset($avals) and is_array($avals) and count($avals) ){
                                if( count($avals)==1 ){
                                    $outonce.='<div class="myfilter_item myfilter_item_once" onclick=" stpr(event || window.event); "><div class="myfilter_lbl"><div class="myfilter_lbl_in">'.$filterlbl['title'].': ';
                                    foreach( $avals as $tid => $name ){
                                        if( $id=='field_rn' ){
                                            $name=str_replace(' район', '', $name);
                                        }
                                        $outonce.= $name;
                                    }
                                    $outonce.='</div></div></div>';
                                }else{
                                
                                    asort($avals);
                                    if( count($avals)>9 ){
                                        if( isset($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and is_array($_SESSION['pdxpdx_filter_nids'][$id]['tid']) and count($_SESSION['pdxpdx_filter_nids'][$id]['tid']) ){
                                            foreach( $_SESSION['pdxpdx_filter_nids'][$id]['tid'] as $td ){
                                                if( isset($avals[$td]) ){
                                                    $avals_first[$td]=$avals[$td];
                                                    unset($avals[$td]);
                                                }
                                            }
                                        }
                                    }

                                    if( isset($avals_first) and is_array($avals_first) and count($avals_first) ){
                                        foreach( $avals_first as $tid => $name ){
                                            $out.= '<div class="myfilter_field"><label class="val_first"';
//                                            if( mb_strlen($name)>11 ){
//                                                $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                $name=mb_substr($name,0,9).'...';
//                                            }
                                            $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                            if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                $out.= ' checked="checked"';
//                                            }
                                            $out.= ' /> '.$name.'</label></div>';
                                        }
                                        $out.='<div>&nbsp;</div>';
                                        
                                    }
                                    if( isset($avals) and is_array($avals) and count($avals) ){
                                        if( count($avals)>9 ){
                                            $bysign=array();
                                            $firstgroup='';
                                            foreach( $avals as $tid => $name ){
                                                if( !isset($bysign[mb_strtoupper(mb_substr($name,0,1))]) ){
                                                    $firstgroup=' myfilter_field_group1';
                                                }else{
                                                    $firstgroup='';
                                                }
                                                $tmpout= '<div class="myfilter_field'.$firstgroup.'"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $tmpout.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $tmpout.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $tmpout.= ' checked="checked"';
//                                                }
                                                $tmpout.= ' /> '.$name.'</label></div>';
                                                $bysign[mb_strtoupper(mb_substr($name,0,1))][]=$tmpout;
                                            }
                                            if( isset($bysign) and is_array($bysign) and count($bysign) ){
                                                $iscnt=0;
                                                foreach( $bysign as $sign => $name ){
                                                    if( $iscnt++ > 0 ){
                                                        $out.='<div class="myfilt_group">&nbsp;</div>';
                                                    }
                                                    $out.=implode('', $name);
                                                }
                                            }
                                            
                                        }else{
                                            foreach( $avals as $tid => $name ){
                                                $out.= '<div class="myfilter_field"><label';
//                                                if( mb_strlen($name)>11 ){
//                                                    $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                    $name=mb_substr($name,0,9).'...';
//                                                }
                                                $out.= '><input class="form-checkbox myfilt_val_term" type="checkbox" value="'.$tid.'"';
//                                                if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                    $out.= ' checked="checked"';
//                                                }
                                                $out.= ' /> ';
                                                $out.= $name;
                                                $out.= '</label></div>';
                                            }
                                        }
                                    }
                                
                                }
                            }else{
                                $stopout=1;
                            }
                            $out.='</div>';
                            $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_term(\''.$id.'\', \'\', 0, 0, 0, 2, 0);">Применить</span></div>';
                            
                        }
                    
                    
                    break;
// ------------------------------------------------------------------------------------------------------------- //
                case 'myfilter_number':
                
                    $stopout=0;
                    $numbermore='';

                    $activestring='';
                    if( isset($filter[$id]) and is_array($filter[$id]) and count($filter[$id]) ){
                        $activestring=$filterlbl['title'].': ';
                        if( isset($filter[$id]['from']) and is_numeric($filter[$id]['from']) ){
                            $activestring.=str_replace('.00', '', number_format($filter[$id]['from'], 2, '.', ' ') );
                        }
                        if( isset($filter[$id]['to']) and is_numeric($filter[$id]['to']) and ( !isset($filter[$id]['from']) or $filter[$id]['from']!=$filter[$id]['to'] ) ){
                            if( isset($filter[$id]['from']) and is_numeric($filter[$id]['from']) ){
                                $activestring.='-';
                            }
                            $activestring.=str_replace('.00', '', number_format($filter[$id]['to'], 2, '.', ' ') );
                        }
                    }


                    if( isset($activestring) and strlen($activestring) ){
                        $out=str_replace('class="myfilter_item ','class="myfilter_item myfilter_item_selected ',$out);
                        $out=str_replace('<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$filterlbl['title'].'</div><','<div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$activestring.'<span class="myfilt_close" onclick=" stpr(event || window.event); myfilt_filter_reset(\''.$id.'\', \'\', 0, 0, 0, 2, 0); "><span class="myfilt_close_in">x</span></span></div><',$out);
                    }



                    $isact=0;
                    if( isset($_SESSION['pdxpdx_filter_nids'][$id]['min']) and is_array($_SESSION['pdxpdx_filter_nids'][$id]['min']) and count($_SESSION['pdxpdx_filter_nids'][$id]['min']) ){
                    foreach( $_SESSION['pdxpdx_filter_nids'][$id]['min'] as $delta => $var ){

                        if( !isset($_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]) or !strlen($_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]) ){
                            $_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]=str_replace('.00','',$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta]);
                        }
                        if( (!isset($_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]) or !strlen($_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta])) and (isset($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]) and strlen($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta])) ){
                            $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]=str_replace('.00','',$_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]);
                        }
                        $pricedelim='-';
                        if( $_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]==0 ){
                            $_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]='до';
                            $pricedelim=' ';
                        }
                        if( (!isset($_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]) or !strlen($_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta])) and (isset($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]) and strlen($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta])) ){
                            $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]=str_replace('.00','',$_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]);
                        }
                        if( $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]==-1 ){
                            $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]=$_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta];
                            $_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta]='более';
                            $_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]=100000;
                            $pricedelim=' ';
                        }
    
                        $numbermore.= '<div class="num_more_item">';
                        if(isset($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta]) and strlen($_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta])){
                            $numbermore.= '<span class="';
                            if( isset($filter[$id]['from']) and $filter[$id]['from']==$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta] and isset($filter[$id]['to']) and $filter[$id]['to']==$_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta] ){
                                $numbermore.= 'active ';
                                $isact=1;
                            }
                            $numbermore.= 'is_a" onclick=" if( jQuery(this).hasClass(\'active\') ){ jQuery(\'#fedit_'.$id.'_min\').val( jQuery(this).parent().parent().parent().find(\'.minval_'.$id.'\').val() ); jQuery(\'#fedit_'.$id.'_max\').val( jQuery(this).parent().parent().parent().find(\'.maxval_'.$id.'\').val() );  }else{ jQuery(\'#fedit_'.$id.'_min\').val(\''.$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta].'\'); jQuery(\'#fedit_'.$id.'_max\').val(\''.$_SESSION['pdxpdx_filter_nids'][$id]['max'][$delta].'\'); } jQuery(\'#fedit_'.$id.'_max, #fedit_'.$id.'_min\').change(); selectfilter(this, 0);">'.$_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta];
                            if( $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta]!=$_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta] ){
                                $numbermore.= $pricedelim;
                                $numbermore.= $_SESSION['pdxpdx_filter_nids'][$id]['maxtitle'][$delta];
                            }
                            $numbermore.= '</span>';
                        }else{
                            $numbermore.= '<span class="';
                            if( isset($filter[$id]['from']) and $filter[$id]['from']==$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta]  ){
                                $numbermore.= 'active ';
                                $isact=1;
                            }
                            $numbermore.= 'is_a" onclick=" if( jQuery(this).hasClass(\'active\') ){ jQuery(\'#fedit_'.$id.'_min\').val( jQuery(this).parent().parent().parent().find(\'.minval_'.$id.'\').val() ); jQuery(\'#fedit_'.$id.'_max\').val( jQuery(this).parent().parent().parent().find(\'.maxval_'.$id.'\').val() ); }else{ jQuery(\'#fedit_'.$id.'_min\').val(\''.$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta].'\'); jQuery(\'#fedit_'.$id.'_max\').val(\''.$_SESSION['pdxpdx_filter_nids'][$id]['min'][$delta].'\'); } jQuery(\'#fedit_'.$id.'_max, #fedit_'.$id.'_min\').change(); selectfilter(this, 0);">'.$_SESSION['pdxpdx_filter_nids'][$id]['mintitle'][$delta].'</a>';
                        }
                        $numbermore.= '</div>';
                    }
                    }
                                            
                    if( isset($numbermore) and strlen($numbermore) ){
                        $out.= '<div class="num_more_items">';
                        $out.= $numbermore;
                        $out.= '</div>';
                    }
                    



    $newsql='from {users} as n inner join {field_data_field_items_active} as field_items_active on (n.uid=field_items_active.entity_id and field_items_active.entity_type=\'user\') left join {field_data_field_gold} as fg on (n.uid=fg.entity_id and fg.entity_type=\'user\') left join {field_data_field_delete} as fd on (n.uid=fd.entity_id and fd.entity_type=\'user\') '.$sqlinner.' where n.status=1 and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and field_items_active.field_items_active_value>0 '.$sqlwhere;

    if( strpos($newsql,'{field_data_'.$id.'}')===false ){
        $newsql=str_replace('from {users} as n', 'from {users} as n inner join {field_data_'.$id.'} as '.$id.' on (n.uid='.$id.'.entity_id and '.$id.'.entity_type=\'user\')', $newsql);
    }
    

    
    
                            $max_price=$curmax_price=0;
                            $min_price=$curmin_price=0;

                            if( strlen($newsql) ){
                            
                                $map=db_query('select MAX('.$id.'.'.$id.'_value) '.$newsql);
                                $map=$map->fetchAssoc();

                                if( isset($map['MAX('.$id.'.'.$id.'_value)']) and is_numeric($map['MAX('.$id.'.'.$id.'_value)']) and $map['MAX('.$id.'.'.$id.'_value)']>0 ){
                                    $max_price=$curmax_price=round($map['MAX('.$id.'.'.$id.'_value)'],0);
                                }else{
                                    $stopout=1;
                                }
                            
                                $mip=db_query('select MIN('.$id.'.'.$id.'_value) '.$newsql.' and '.$id.'.'.$id.'_value>0');
                                $mip=$mip->fetchAssoc();
                                if( isset($mip['MIN('.$id.'.'.$id.'_value)']) and is_numeric($mip['MIN('.$id.'.'.$id.'_value)']) ){
                                    $min_price=$curmin_price=round($mip['MIN('.$id.'.'.$id.'_value)'],0);
                                }
                                
                                if( $max_price==$min_price ){
                                    $stopout=1;
                                }
                            
                            }else{
                                $max_price='1000000000';
                            }
                            
                            if( isset($filter[$id]['to']) and is_numeric($filter[$id]['to']) and $max_price>$filter[$id]['to'] ){
                                $curmax_price=$filter[$id]['to'];
                            }
                            if( isset($filter[$id]['from']) and is_numeric($filter[$id]['from']) and $min_price<$filter[$id]['from'] ){
                                $curmin_price=$filter[$id]['from'];
                            }
                            
                            $out.= '
                            
    <div class="slider_line">
    от <input id="fedit_'.$id.'_min" name="'.$id.'[min]" value="'.$curmin_price.'" size="9" maxlength="128" class="slider_from" type="text" /> до <input id="fedit_'.$id.'_max" name="'.$id.'[max]" value="'.$curmax_price.'" size="9" maxlength="128" class="slider_to" type="text" />
    </div>
                            
                            <div class="ffilter ffilter_'.$id.'">
                            <input type="hidden" value="'.$min_price.'" class="minval_'.$id.'" />
                            <input type="hidden" value="'.$max_price.'" class="maxval_'.$id.'" />
                            <div class="filter-price-slider" id="filter_'.$id.'"></div>
                            <div class="filter-apply filter-apply-is"><span class="is_a filter-apply-apply" onclick=" myfilt_apply_num(\''.$id.'\', \'\', 0, 0, 0, 2, 0); ">Применить</span><span class="is_a filter-apply-clear" onclick=" jQuery(\'#fedit_'.$id.'_max\').val( jQuery(this).parent().parent().find(\'.maxval_'.$id.'\').val() ); jQuery(\'#fedit_'.$id.'_min\').val( jQuery(this).parent().parent().find(\'.minval_'.$id.'\').val() ); jQuery(\'#fedit_'.$id.'_max, #fedit_'.$id.'_min\').change(); jQuery(\'.myfilter_content_'.$id.' .num_more_items span.is_a\').removeClass(\'active\'); "><span class="in">Очистить</span></span><div class="clear">&nbsp;</div></div>
                            </div>';
    
        





                    break;
                }
                
                $out.='</div>';
                $out.='</div>';

                if( strlen($outonce) ){
                    $out=$outonce;
                }
                if( !$stopout ){
                    $outall.=$out;
                }
            }
            
            $out='';
            if( isset($isfeat) and is_array($isfeat) and count($isfeat) ){
                $stopout=0;

                if( $activestring_feat_count>1 ){
                    switch($activestring_feat_count){
                    case 2:
                    case 3:
                    case 4:
                        $activestring_feat=$activestring_feat_count.' особенности';
                        break;
                    default:
                        $activestring_feat=$activestring_feat_count.' особенностей';
                    }
                }
                if( isset($activestring_feat) and strlen($activestring_feat) ){
                    $out.='<div class="myfilter_item myfilter_item_selected" onclick=" stpr(event || window.event); "><div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">'.$activestring_feat.'<span class="myfilt_close" onclick=" stpr(event || window.event);  myfilt_filter_feat_reset(\'\', 0, 0, 0, 2, 0); "><span class="myfilt_close_in">x</span></span></div></div>';


                    $out.='<div class="myfilter_content" style="display: none;"><img class="closeimg" onclick=" jQuery(\'.myfilter_item\').removeClass(\'myfilter_active\'); " alt="x" src="'.PDX_IMGPATH.'/img/msg_close.png" />';
                    $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_feat">';
                    $avals=array();
                    $avals_first=array();

                    foreach( $isfeat as $id => $ttl ){
                        if( isset($fieldinfo[$id]['vid']) and is_numeric($fieldinfo[$id]['vid']) and isset($fieldinfo[$id]['voc']) and strlen($fieldinfo[$id]['voc']) ){
                            $newsql=$sql;
                            if( strpos($newsql,'{taxonomy_term_data}')===false ){
                                $newsql=str_replace(' where ', ' inner join {taxonomy_term_data} as taxonomy_term_data on (taxonomy_term_data.tid='.$id.'.'.$id.'_tid) where ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {users} as n', 'from {users} as n inner join {field_data_'.$id.'} as '.$id.' on (n.uid='.$id.'.entity_id and '.$id.'.entity_type=\'user\')', $newsql);
                            }
                            $newsql='select DISTINCT taxonomy_term_data.tid, taxonomy_term_data.name '.$newsql;
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                if( $fieldinfo[$id]['voc']=='yes_or_no' ){
                                    $avals[$id][82]=$ttl;
                                }else{
                                    $avals[$id][$value['tid']]=$value['name'];
                                }
                            }
                        }
                    }

                                if( isset($avals) and is_array($avals) and count($avals) ){
                                    foreach( $avals as $id => $aval ){
                                        asort($aval);
                                        if( isset($aval) and is_array($aval) and count($aval) ){
                                                foreach( $aval as $tid => $name ){
                                                    $out.= '<div class="myfilter_field"><label';
//                                                    if( mb_strlen($name)>11 ){
//                                                        $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                        $name=mb_substr($name,0,9).'...';
//                                                    }
                                                    $out.= '><input class="form-checkbox myfilt_val_term myfilt_feat myfilt_feat_'.$id.'" type="checkbox" value="'.$tid.'"';
                                                    if( $fieldinfo[$id]['voc']=='yes_or_no' ){
                                                        if( isset( $filter[$id] ) and is_array( $filter[$id] ) and count( $filter[$id] ) ){
                                                            $out.= ' checked="checked"';
                                                        }
                                                    }else{
                                                        if( isset( $filter[$id] ) and is_array( $filter[$id] ) and count( $filter[$id] ) ){
                                                            foreach( $filter[$id] as $td ){
                                                                if( $td==$tid ){
                                                                    $out.= ' checked="checked"';
                                                                }
                                                            }
                                                        }
                                                    }
                                                    $out.= ' /> ';
                                                    $out.= mb_strtolower($name);
                                                    $out.= '</label></div>';
                                                }
                                        }
                                    }
                                }else{
                                    $stopout=1;
                                }
                                $out.='</div>';
                                $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_feat(\'\', 0, 0, 0, 2, 0);">Применить</span></div>';


                    $out.='</div>';
                    $out.='</div>';
                }else{ 
                    $out.='<div class="myfilter_item mys" onclick=" stpr(event || window.event); "><div class="myfilter_lbl" onclick=" myfiltclick(this); "><div class="myfilter_lbl_in">Особенности</div></div>';
                    $out.='<div class="myfilter_content" style="display: none;"><img class="closeimg" onclick=" jQuery(\'.myfilter_item\').removeClass(\'myfilter_active\'); " alt="x" src="'.PDX_IMGPATH.'/img/msg_close.png" />';
                    $out.='<div class="myfilter_fields myfilter_fields_tax myfilter_fields_feat">';
                    if( isset($filterlbl['desc']) and strlen($filterlbl['desc']) ){
                        $out.='<div class="desc">'.$filterlbl['desc'].'</div>';
                    }
                    $avals=array();
                    $avals_first=array();

                    foreach( $isfeat as $id => $ttl ){
                        if( isset($fieldinfo[$id]['vid']) and is_numeric($fieldinfo[$id]['vid']) and isset($fieldinfo[$id]['voc']) and strlen($fieldinfo[$id]['voc']) ){
                            $newsql=$sql;
                            if( strpos($newsql,'{taxonomy_term_data}')===false ){
                                $newsql=str_replace(' where ', ' inner join {taxonomy_term_data} as taxonomy_term_data on (taxonomy_term_data.tid='.$id.'.'.$id.'_tid) where ', $newsql);
                            }
                            if( strpos($newsql,'{field_data_'.$id.'}')===false ){
                                $newsql=str_replace('from {users} as n', 'from {users} as n inner join {field_data_'.$id.'} as '.$id.' on (n.uid='.$id.'.entity_id and '.$id.'.entity_type=\'user\')', $newsql);
                            }
                            $newsql='select DISTINCT taxonomy_term_data.tid, taxonomy_term_data.name '.$newsql;
                            $values=db_query($newsql);
                            while( $value=$values->fetchAssoc() ){
                                if( $fieldinfo[$id]['voc']=='yes_or_no' ){
                                    $avals[$id][82]=$ttl;
                                }else{
                                    $avals[$id][$value['tid']]=$value['name'];
                                }
                            }
                        }
                    }

                                if( isset($avals) and is_array($avals) and count($avals) ){
                                    foreach( $avals as $id => $aval ){
                                        asort($aval);
                                        if( isset($aval) and is_array($aval) and count($aval) ){
                                                foreach( $aval as $tid => $name ){
                                                    $out.= '<div class="myfilter_field"><label';
//                                                    if( mb_strlen($name)>11 ){
//                                                        $out.= ' title="'.str_replace('"', '', $name).'"';
//                                                        $name=mb_substr($name,0,9).'...';
//                                                    }
                                                    $out.= '><input class="form-checkbox myfilt_val_term myfilt_feat myfilt_feat_'.$id.'" type="checkbox" value="'.$tid.'"';
//                                                    if( isset($allselected[$tid]) and $allselected[$tid]==1 ){
//                                                        $out.= ' checked="checked"';
//                                                    }
                                                    $out.= ' /> ';
                                                    $out.= mb_strtolower($name);
                                                    $out.= '</label></div>';
                                                }
                                        }
                                    }
                                }else{
                                    $stopout=1;
                                }
                                $out.='</div>';
                                $out.= '<div class="myfilt_apply_term"><span class="is_a" onclick="myfilt_apply_feat(\'\', 0, 0, 0, 2, 0);">Применить</span></div>';
                                
                    $out.='</div></div>';
                }
            }
            if( !$stopout ){
                $outall.=$out;
            }
            $outall.='</div></div>';
        }
        
//        $outall.='<pre>'.print_r($sql, true).'</pre>';

    }
    
    return $outall;
}
function pdxfilterout($filter, $fieldinfo, $issqlinner='', $entitytype='node', $enid='nid'){
    $filterstr=$sqlwhere='';
    $sqlinner=$issqlinner;
    
    if( isset($filter) and is_array($filter) and count($filter) ){
        foreach( $filter as $fname=>$fval ){
            if( isset($fieldinfo[$fname]['suffix']) ){
                if( $fieldinfo[$fname]['suffix']=='tid' ){
                    if( isset($fval) and is_array($fval) and count($fval) ){
                        $res=array();
                        foreach( $fval as $fv ){
                            if( is_numeric($fv) ){
                                $res[]=$fv;
                                
                                if( $filterstr!='' ){
                                    $filterstr.='&';
                                }
                                $filterstr.=$fname.'[]='.$fv;
                            }
                        }
                        if( isset($res) and is_array($res) and count($res) ){ 
                            if( strpos($sqlinner, 'field_data_'.$fname.'}')===false){
                                $sqlinner.=' inner join {field_data_'.$fname.'} as '.$fname.' on (n.'.$enid.'='.$fname.'.entity_id and '.$fname.'.entity_type=\''.$entitytype.'\')';
                            }
                            $sqlwhere.=' and '.$fname.'.'.$fname.'_tid IN ('.implode(',',$res).')';
                        }
                    }
                }elseif( $fieldinfo[$fname]['suffix']=='nid' ){
                    if( isset($fval) and is_array($fval) and count($fval) ){
                        $res=array();
                        foreach( $fval as $fv ){
                            if( is_numeric($fv) ){
                                $res[]=$fv;
                                
                                if( $filterstr!='' ){
                                    $filterstr.='&';
                                }
                                $filterstr.=$fname.'[]='.$fv;
                            }
                        }
                        if( isset($res) and is_array($res) and count($res) ){ 
                            if( strpos($sqlinner, 'field_data_'.$fname.'}')===false){
                                $sqlinner.=' inner join {field_data_'.$fname.'} as '.$fname.' on (n.'.$enid.'='.$fname.'.entity_id and '.$fname.'.entity_type=\''.$entitytype.'\')';
                            }
                            $sqlwhere.=' and '.$fname.'.'.$fname.'_nid IN ('.implode(',',$res).')';
                        }
                    }
                }elseif( $fieldinfo[$fname]['type']=='list_boolean'  ){
                    if( isset($fval) and is_numeric($fval) and $fval==1 ){
                        $filterstr.=$fname.'=1';
                        if( strpos($sqlinner, 'field_data_'.$fname.'}')===false){
                            $sqlinner.=' inner join {field_data_'.$fname.'} as '.$fname.' on (n.'.$enid.'='.$fname.'.entity_id and '.$fname.'.entity_type=\''.$entitytype.'\')';
                        }
                        $sqlwhere.=' and '.$fname.'.'.$fname.'_value = 1';
                    }
                }else{
                    if( $fieldinfo[$fname]['type']=='list_integer' ){
                        if( isset($fval) and is_array($fval) and count($fval) ){
                            $res=array();
                            foreach( $fval as $fv ){
                                if( is_numeric($fv) ){
                                    $res[]=$fv;
                                    
                                    if( $filterstr!='' ){
                                        $filterstr.='&';
                                    }
                                    $filterstr.=$fname.'[]='.$fv;
                                }
                            }
                            if( isset($res) and is_array($res) and count($res) ){ 
                                if( strpos($sqlinner, 'field_data_'.$fname.'}')===false){
                                    $sqlinner.=' inner join {field_data_'.$fname.'} as '.$fname.' on (n.'.$enid.'='.$fname.'.entity_id and '.$fname.'.entity_type=\''.$entitytype.'\')';
                                }
                                $sqlwhere.=' and '.$fname.'.'.$fname.'_value IN ('.implode(',',$res).')';
                            }
                        }
                    }else{
                        if( isset($fval) and is_array($fval) and count($fval) ){
                            if( isset( $fval['from'] ) and is_numeric( $fval['from'] ) ){
                                if( strpos($sqlinner, 'field_data_'.$fname.'}')===false and ($enid!='uid' or $fname!='field_items_active') ){
                                    $sqlinner.=' inner join {field_data_'.$fname.'} as '.$fname.' on (n.'.$enid.'='.$fname.'.entity_id and '.$fname.'.entity_type=\''.$entitytype.'\')';
                                }
                                $sqlwhere.=' and '.$fname.'.'.$fname.'_value >= '.$fval['from'];
                                
                                if( $filterstr!='' ){
                                    $filterstr.='&';
                                }
                                $filterstr.=$fname.'[from]='.$fval['from'];
                            }
                            if( isset( $fval['to'] ) and is_numeric( $fval['to'] ) ){
                                if( strpos($sqlinner, 'field_data_'.$fname.'}')===false and ($enid!='uid' or $fname!='field_items_active') ){
                                    $sqlinner.=' inner join {field_data_'.$fname.'} as '.$fname.' on (n.'.$enid.'='.$fname.'.entity_id and '.$fname.'.entity_type=\''.$entitytype.'\')';
                                }
                                $sqlwhere.=' and '.$fname.'.'.$fname.'_value <= '.$fval['to'];
    
                                if( $filterstr!='' ){
                                    $filterstr.='&';
                                }
                                $filterstr.=$fname.'[to]='.$fval['to'];
                            }
                        }
                    }
                }
            }
        }


    }
    return array('filterstr'=>$filterstr, 'sqlwhere'=>$sqlwhere, 'sqlinner'=>$sqlinner);
}
function pdxfilterparse($str){
    $filter=array();
    $str=str_replace('_to=','[to]=',str_replace('_from=','[from]=',$str));

    $activef=explode('&', $str);
                if( isset($activef) and is_array($activef) and count($activef) ){
                    foreach( $activef as $active ){
                        $active=explode('=',$active);
                        if( isset($active) and is_array($active) and count($active)==2 ){ 
                            if( strpos($active[0], '[]')===false ){
                                if( strpos($active[0], '[from]')===false ){
                                    if( strpos($active[0], '[to]')===false ){
                                        
                                    }else{
                                        $filter[ str_replace('[to]','',$active[0]) ]['to']=$active[1];
                                    }
                                }else{
                                    $filter[ str_replace('[from]','',$active[0]) ]['from']=$active[1];
                                }
                            }else{
                                $filter[ str_replace('[]','',$active[0]) ][]=$active[1];
                                if( is_numeric($active[1]) and $active[1]==82 ){
                                    $filter[ str_replace('[]','',$active[0]) ][]=517;
                                }
                            }
                        }
                    }
                }

            if( isset($filter) and is_array($filter) and count($filter) ){
                foreach( $filter as $fnm=>$fnv ){
                    if( isset($fnv) and is_array($fnv) ){
                        if( count($fnv)>1 and !isset( $fnv['from'] ) ){
                            $filter[$fnm]=array_unique($fnv);
                        }else{
                            if( isset($fnv['from']) and !isset( $fnv['to'] ) ){
                                $filter[$fnm]['to']=$filter[$fnm]['from'];
                            }elseif( !isset($fnv['from']) and isset( $fnv['to'] ) ){
                                $filter[$fnm]['from']=$filter[$fnm]['to'];
                            }
                        }
                    }
                }
            }
            
    return $filter;
}
function pdxfiltergenusers(){
    $out=array();
    $out['filters']=array(
        'field_parts'=>5,
        'field_rn'=>15,
        'field_who'=>25,
        'field_items_active'=>35,
    );
    $out['nids']=array(
        'field_brand'=>array(
        ),
    );
    return $out;
}
function pdxfiltergen($istid, $isbrand, $tags, $celebration=0){
    $pdxpdx_filter_tids=$pdxpdx_filter_tid='';
    $out=array();
    $out['filters']=array(
        'field_brand'=>3,
        'field_who'=>10,
        'field_rn'=>15,
        'field_delivery2'=>20,
        'field_delivery3'=>25,
        'field_rent_price'=>40,
        'field_price_hour'=>50,
        'field_price_day'=>60,
        'field_price_week'=>70,
        'field_price_month'=>80,
        'field_who'=>110,
    );

//        'field_state'=>90,
//        'field_status'=>100,

    switch($isbrand){
    case 2248:
    case 2704:
    case 998:
    case 108:
    case 107:
        $out['filters']['field_addon1']=100;
        $out['filters']['field_addon2']=110;
        break;
    case 68:
        $out['filters']['field_addon1']=100;
        $out['filters']['field_addon3']=110;
        break;
    case 67:
    case 69:
    case 80:
        $out['filters']['field_addon3']=110;
        break;
    }

    switch($istid){
    case 1: // дом
    case 2: // детский мир
    
    case 3: // спорт и отдых
    case 5: // хобби
    case 12: // техника
    case 13: // одежда и украшения
    case 109: // бизнес
    case 869: // транспорт
        $out['filters']['field_celebration']=17;
//        if( $isbrand==0 ){
//            $out['filters']['field_subpart']=1;
//        }
        if( $tags==0 ){
            $out['filters']['field_tags']=2;
        }
        break;
    case 0:
        $out['filters']['taxonomy_catalog']=0;
        $out['filters']['field_subpart']=1;
        $out['filters']['field_tags']=2;
    }
    $out['nids']=array(
        'field_brand'=>array(
        ),
        'field_rent_price'=>array(
        ),
    );

    switch($istid){
    case 1: // дом
        $out['nids']=array(
            'field_brand'=>array(
                'tid'=> array(1938, 2142, 1941, 1943, 2134),
            ),
        );
        if( isset($isbrand) and $isbrand>0 ){
            switch($isbrand){
            case 73: //ремонт
            $out['nids']=array(
                'field_brand'=>array(
                    'tid'=> array(1938, 2157, 1959, 2162, 2170),
                ),
            );
                break;
            }
        }
        break;
    case 2: // детский мир
        $out['nids']=array(
            'field_brand'=>array(
                'tid'=> array(2249, 2219, 2279, 2292, 2296),
            ),
        );
        if( isset($isbrand) and $isbrand>0 ){
            switch($isbrand){
            case 94: //для мамы
                break;
            case 67: //игрушки
                $out['nids']=array(
                    'field_brand'=>array(
                        'tid'=> array(2219, 2279, 2314, 2296, 2263),
                    ),
                );
                break;
            case 69: //мебель
                $out['nids']=array(
                    'field_brand'=>array(
                        'tid'=> array(2219, 2279, 2296, 2249, 2292),
                    ),
                );
                break;
            case 80: //гуляем
                $out['nids']=array(
                    'field_brand'=>array(
                        'tid'=> array(2292, 2219, 2316, 2312, 2348),
                    ),
                );
                break;
            case 148: //для праздника
                break;
            }
        }
        break;
    case 3: // спорт и отдых
        break;
    case 5: // хобби
        break;
    case 12: // техника
        $out['nids']=array(
            'field_brand'=>array(
                'tid'=> array(2472, 2439, 2405, 2396, 45),
            ),
        );
        break;
    case 13: // одежда и украшения
        break;
    case 109: // бизнес
        break;
    case 869: // транспорт
        break;
    case 0:
    }
    
    return $out;
}
/*
function pdxcat_field_attach_create_bundle($entity_type, $bundle) {
    if( function_exists('pdxcat_fieldsinfo') ){
        pdxcat_fieldsinfo(1);
    }
}
function pdxcat_field_attach_delete_bundle($entity_type, $bundle, $instances) {
    if( function_exists('pdxcat_fieldsinfo') ){
        pdxcat_fieldsinfo(1);
    }
}
function pdxcat_field_attach_update($entity_type, $entity) {
    if( function_exists('pdxcat_fieldsinfo') ){
        pdxcat_fieldsinfo(1);
    }
}
*/
function pdxcat_field_create_field($field) {
    if( function_exists('pdxcat_fieldsinfo') ){
        pdxcat_fieldsinfo(1);
    }
}
function pdxcat_field_delete_field($field) {
    if( function_exists('pdxcat_fieldsinfo') ){
        pdxcat_fieldsinfo(1);
    }
}
function pdxcat_field_update_field($field, $prior_field, $has_data) {
    if( function_exists('pdxcat_fieldsinfo') ){
        pdxcat_fieldsinfo(1);
    }
}
function pdxgetcolortid($tid){
                                                    $out='';
                                                    switch($tid){
                                                        case 2881:
                                                            $out.='42aaff';
                                                            break;
                                                        case 2879:
                                                            $out.='ffff00';
                                                            break;
                                                        case 2880:
                                                            $out.='008000';
                                                            break;
                                                        case 2877:
                                                            $out.='ff0000';
                                                            break;
                                                        case 2878:
                                                            $out.='ffa500';
                                                            break;
                                                        case 2886:
                                                            $out.='ffc0cb';
                                                            break;
                                                        case 2887:
                                                            $out.='808080';
                                                            break;
                                                        case 2882:
                                                            $out.='0000ff';
                                                            break;
                                                        case 2883:
                                                            $out.='8b00ff';
                                                            break;
                                                        case 2885:
                                                            $out.='000';
                                                            break;
                                                        default:
                                                            $out.='fff';
                                                    }
                                                    return $out;
}