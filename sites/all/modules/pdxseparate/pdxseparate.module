<?php
//variable_set('pdxnorest', 1);
if( isset($_SERVER['HTTP_HOST']) and strlen( $_SERVER['HTTP_HOST'] ) and strpos($_SERVER['HTTP_HOST'], 'site')===false and strpos($_SERVER['HTTP_HOST'], 'localhost')===false ){
//    define('PDX_IMGPATH', 'http://needtominsk.s3.amazonaws.com');
    define('PDX_IMGPATH', 'http://d4zbhil5kxgyr.cloudfront.net');
    define('PDX_JSPATH', 'http://d4zbhil5kxgyr.cloudfront.net/static/js');
    define('PDX_ISLOCAL', 0);
}else{
    define('PDX_IMGPATH', $GLOBALS['base_url'].'/sites/all/themes/pdxneedto');
    define('PDX_JSPATH', $GLOBALS['base_url'].'/sites/all/themes/pdxneedto/tb/js');
    define('PDX_ISLOCAL', 1);
}
function pdxseparate_field_update_instance($instance, $prior_instance) {
  if( function_exists('pdxcat_fieldsinfo') ){
    pdxcat_fieldsinfo();
  }
}
function pdxseparate_field_insert($entity_type, $entity, $field, $instance, $langcode, &$items) {
  if( function_exists('pdxcat_fieldsinfo') ){
    pdxcat_fieldsinfo();
  }
}
function pdxseparate_field_delete($entity_type, $entity, $field, $instance, $langcode, &$items) {
  if( function_exists('pdxcat_fieldsinfo') ){
    pdxcat_fieldsinfo();
  }
}
function pdxseparate_validate_product($node, &$form) {
        if( isset($form['input']['model']) and strlen($form['input']['model']) and $form['input']['model']!='dev.biz.ua new articul' ){
            $isset=db_query('select nid from {uc_products} where model=:combo', array(':combo'=>$form['input']['model']));
            $isset=$isset->fetchAssoc();
            if( isset($isset['nid']) and is_numeric($isset['nid']) ){
                if( arg(0)=='node' and ( !is_numeric(arg(1)) or arg(1)!=$isset['nid'] ) ){
                    form_set_error('model', '<a target="_blank" href="'.$GLOBALS['base_url'].'/node/'.$isset['nid'].'/edit">Товар</a> с данным артикулом уже есть на сайте! Артикул должен быть уникальным!' );
                }
            }
        }
}

function pdxseparate_getmnumass(){
    return array(
        'admin/doubleterm'=>'Поиск дублей терминов таксономии',
        'admin/delnodes'=>'Пакетное удаление материалов',
        'admin/doublesyn'=>'Дубли синонимов',
        'admin/commentsperday'=>'Количество комментариев за день',
        'admin/findrus'=>'Проверка на наличие русских букв в строке',
        'admin/unpubnodes'=>'Пакетное снятие с публикации материалов',
        'admin/pubnodes'=>'Пакетная публикация материалов',
        'admin/findsyn'=>'Поиск синонимов',
        'admin/addval'=>'Присвоить значение полю у всех материалов данного типа материала',
        'admin/findnoval'=>'Поиск материалов с невыставленными значениями',
        'admin/last100msg'=>'Последние 100 сообщений пользователей',
    );
}
function pdxseparate_menu() {
    global $user;
  $mypage = array();
  $mypage['user/item/export/xls'] = array(
    'title' => 'Экспорт активных объявлений в Excel',  
    'page callback' => 'pdxseparate_item_import' ,
    'access callback' => (bool) $user->uid,
    'type' => MENU_CALLBACK,
  );
  $mypage['user/item/export/doc'] = array(
    'title' => 'Экспорт активных объявлений в Word',  
    'page callback' => 'pdxseparate_item_export_doc' ,
    'access callback' => (bool) $user->uid,
    'type' => MENU_CALLBACK,
  );
  $mypage['user/item/export/pdf'] = array(
    'title' => 'Экспорт активных объявлений в PDF',  
    'page callback' => 'pdxseparate_item_export_pdf' ,
    'access callback' => (bool) $user->uid,
    'type' => MENU_CALLBACK,
  );
  $mypage['node'] = array(
    'title' => 'Главная',
    'page callback' => 'pdxseparate_node',
    'access callback' => TRUE,
    'type' => MENU_SUGGESTED_ITEM,
  );
  $mypage['fav'] = array(
    'title' => 'Избранные объявления',
    'page callback' => 'pdxseparate_fav',
    'access callback' => TRUE,
    'type' => MENU_SUGGESTED_ITEM,
  );
  $mypage['fav/users'] = array(
    'title' => 'Избранные пользователи',
    'page callback' => 'pdxseparate_fav_user',
    'access callback' => TRUE,
    'type' => MENU_SUGGESTED_ITEM,
  );
  $mypage['catalog'] = array(
    'title' => 'Каталог товаров, доступных к аренде',
    'page callback' => 'pdxseparate_catalog',
    'access callback' => TRUE,
    'type' => MENU_SUGGESTED_ITEM,
  );
  $mypage['item/rec'] = array(
    'title' => 'Рекомендуемые предложения',
    'page callback' => 'pdxseparate_rec',
    'access callback' => TRUE,
    'type' => MENU_SUGGESTED_ITEM,
  );
  $mypage['item/viewed'] = array(
    'title' => 'Последние просмотренные предложения',
    'page callback' => 'pdxseparate_viewed',
    'access callback' => TRUE,
    'type' => MENU_SUGGESTED_ITEM,
  );
  $mypage['admin/clearcaches'] = array(
    'title' => 'Очистка кешей',
    'page callback' => 'pdxseparate_p_clearcaches',
    'access callback' => 'pdxseparate_checkadm',
  );
/*    
  $mypage['admin/denomin'] = array(
    'title' => 'Деноминация цен',
    'page callback' => 'pdxseparate_denomin',
    'access callback' => 'pdxseparate_checkadm',
  );
*/
  return $mypage;
}
function pdxseparate_item_export_pdf($source_content = NULL){
    $source_content= '<div>См. также экспорт в: <a href="'.url('user/item/export/xls', array('absolute'=>TRUE)).'">XLS</a>, <a href="'.url('user/item/export/doc', array('absolute'=>TRUE)).'">DOC</a></div><div>&nbsp;</div>';
    global $user;

    $acols=array(
        'colpos1'=>'Артикул',
        'colpos2'=>'Название',
        'colpos3'=>'Раздел',
        'colpos4'=>'Подраздел',
        'colpos5'=>'Бренд',
        'colpos6'=>'Цена/час',
        'colpos7'=>'Цена/день',
        'colpos8'=>'Цена/неделю',
        'colpos9'=>'Цена/месяц',
        'colpos10'=>'Ссылка',
        'colpos11'=>'Картинка',
    );
    $acolsno=$acols;

    
    $addon=$addon2='';
    $source_content.= '<form action="/needto_op.php" method="post"><input type="hidden" value="3" name="op" />';
    $source_content.= '<div class="brands_line"><span class="brands_line_item brands_line_all brands_line_item_0';
    if( !isset( $_GET['brands'] ) or !is_numeric( $_GET['brands'] ) or $_GET['brands']==0 ){
        $source_content.= ' brands_line_active';
    }
    $source_content.= '" onclick="checkbrand(0, this, \'brands\');">Все бренды</span>';
    $brands=db_query('select DISTINCT d.tid, d.name from {taxonomy_term_data} as d inner join {field_data_field_brand} as f on (f.field_brand_tid=d.tid and f.entity_type=\'node\') inner join {node} as n on (f.entity_id=n.nid) left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$user->uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    while( $brand=$brands->fetchAssoc() ){
        $source_content.= '<span class="brands_line_item brands_line_item_'.$brand['tid'];
        if( isset( $_GET['brands'] ) and is_array( $_GET['brands'] ) and count( $_GET['brands'] ) ){
            if( array_search($brand['tid'], $_GET['brands'])===false ){
                $addon.= '<option value="'.$brand['tid'].'"></option>';
            }else{
                $source_content.= ' brands_line_active';
                $addon.= '<option value="'.$brand['tid'].'" selected="selected"></option>';
            }
        }else{
            $addon.= '<option value="'.$brand['tid'].'"></option>';
        }
        $source_content.= '" onclick="checkbrand('.$brand['tid'].', this, \'brands\');">'.$brand['name']. '</span>';
    }
    $source_content.= '</div><div class="cats_line"><span class="brands_line_item brands_line_all brands_line_item_0';
    if( !isset( $_GET['cats'] ) or !is_numeric( $_GET['cats'] ) or $_GET['cats']==0 ){
        $source_content.= ' brands_line_active';
    }
    $source_content.= '" onclick="checkbrand(0, this, \'cats\');">Все разделы</span>';
    $brands=db_query('select DISTINCT d.tid, d.name from {taxonomy_term_data} as d inner join {field_data_taxonomy_catalog} as f on (f.taxonomy_catalog_tid=d.tid and f.entity_type=\'node\') inner join {node} as n on (f.entity_id=n.nid) left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$user->uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    while( $brand=$brands->fetchAssoc() ){
        $source_content.= '<span class="brands_line_item brands_line_item_'.$brand['tid'];
        if( isset( $_GET['cats'] ) and is_array( $_GET['cats'] ) and count( $_GET['cats'] ) ){
            if( array_search($brand['tid'], $_GET['cats'])===false ){
                $addon2.= '<option value="'.$brand['tid'].'"></option>';
            }else{
                $source_content.= ' brands_line_active';
                $addon2.= '<option value="'.$brand['tid'].'" selected="selected"></option>';
            }
        }else{
            $addon2.= '<option value="'.$brand['tid'].'"></option>';
        }
        $source_content.= '" onclick="checkbrand('.$brand['tid'].', this, \'cats\');">'.$brand['name']. '</span>';
    }
    $source_content.= '</div><div style="display: none;"><div class="views-exposed-form-rest"><div class="form-item-brands"><select multiple="multiple" id="ibrands" name="brands[]"><option value="0"';
    if( !isset( $_GET['brands'] ) or !is_array( $_GET['brands'] ) or !count( $_GET['brands'] ) or $_GET['brands'][0]==0 ){
        $source_content.=' selected="selected"';
    }
    $source_content.= '></option>'.$addon;
    $source_content.= '</select></div><div class="form-item-cats"><select multiple="multiple" id="icats" name="cats[]"><option value="0"';
    if( !isset( $_GET['cats'] ) or !is_array( $_GET['cats'] ) or !count( $_GET['cats'] ) or $_GET['cats'][0]==0 ){
        $source_content.=' selected="selected"';
    }
    $source_content.= '></option>'.$addon2;
    $source_content.= '</select></div><input id="icols" name="cols" type="hidden" value="';
    $coldef='colpos1|colpos2|colpos3|colpos4|colpos5|colpos6|colpos7|colpos8|colpos9|colpos10|colpos11';
    if( !is_dir('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings') ){
        mkdir('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings');
    }
    if( !is_dir('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings/colorder3') ){
        mkdir('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings/colorder3');
    }
    if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings/colorder3/'.$user->uid) ){
        $coluser=file_get_contents('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings/colorder3/'.$user->uid);
        if( isset($coluser) and strlen($coluser) ){
            $coldef=filter_xss(strip_tags($coluser));
        }
    }
    if( !isset( $_GET['cols'] ) or !strlen( $_GET['cols'] ) or $_GET['cols']==$coldef ){
    }else{
        $coldef=filter_xss(strip_tags($_GET['cols']));
    }
    $source_content.= $coldef;
    $source_content.= '" /></div></div>';
    
    $source_content.= '<div class="export_col">';
    
    $source_content.= '
<div><strong>Выставьте содержимое документа в нужном порядке:</strong></div>
<div id="export_cols">
    <ul id="sortable" class="connectedSortable">';
    
    $coldef=explode('|', $coldef);
    if( isset($coldef) and is_array($coldef) and count($coldef) ){
        foreach( $coldef as $colde ){
            if( isset($acols[$colde]) and strlen($acols[$colde]) ){
                unset($acolsno[$colde]);
                $source_content.= '<li class="ui-state-default" id="'.$colde.'">'.$acols[$colde].'</li>';
            }
        }
    }
    
    
    $source_content.= '</ul>
</div>


<div class="sorthidden"><strong>Скрытые колонки:</strong></div><div id="export_cols2"><ul id="sortable2" class="connectedSortable"><li class="ui-state-default ui-state-disabled">Переместите сюда</li>';
    if( isset($acolsno) and is_array($acolsno) and count($acolsno) ){
        foreach( $acolsno as $colde=>$tmpme ){
            if( isset($acols[$colde]) and strlen($acols[$colde]) ){
                $source_content.= '<li class="ui-state-default ui-state-highlight" id="'.$colde.'">'.$acols[$colde].'</li>';
            }
        }
    }
    $source_content.= '</ul></div>

';
    $source_content.= '<div style="display: none;" class="savemyorder"><span class="th"></span><a href="javascript: void(0);" onclick="savemyorder(3);">Запомнить порядок колонок</a></div>';
    $source_content.= '</div>';
    
    $source_content.= '<div class="export_submit form-actions"><input type="submit" class="form-submit" value="Скачать PDF" /></div>';
    $source_content.= '</form>';
    
    
    return '<div class="nodecontent">'.$source_content.'</div>';    
}
function pdxseparate_item_export_doc($source_content = NULL){
    $source_content= '<div>См. также экспорт в: <a href="'.url('user/item/export/xls', array('absolute'=>TRUE)).'">XLS</a>, <a href="'.url('user/item/export/pdf', array('absolute'=>TRUE)).'">PDF</a></div><div>&nbsp;</div>';
    global $user;

    $acols=array(
        'colpos1'=>'Артикул',
        'colpos2'=>'Название',
        'colpos3'=>'Раздел',
        'colpos4'=>'Подраздел',
        'colpos5'=>'Бренд',
        'colpos6'=>'Цена/час',
        'colpos7'=>'Цена/день',
        'colpos8'=>'Цена/неделю',
        'colpos9'=>'Цена/месяц',
        'colpos10'=>'Ссылка',
        'colpos11'=>'Картинка',
    );
    $acolsno=$acols;
    
    $addon=$addon2='';
    $source_content.= '<form action="/needto_op.php" method="post"><input type="hidden" value="1" name="op" />';
    $source_content.= '<div class="brands_line"><span class="brands_line_item brands_line_all brands_line_item_0';
    if( !isset( $_GET['brands'] ) or !is_numeric( $_GET['brands'] ) or $_GET['brands']==0 ){
        $source_content.= ' brands_line_active';
    }
    $source_content.= '" onclick="checkbrand(0, this, \'brands\');">Все бренды</span>';
    $brands=db_query('select DISTINCT d.tid, d.name from {taxonomy_term_data} as d inner join {field_data_field_brand} as f on (f.field_brand_tid=d.tid and f.entity_type=\'node\') inner join {node} as n on (f.entity_id=n.nid) left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$user->uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    while( $brand=$brands->fetchAssoc() ){
        $source_content.= '<span class="brands_line_item brands_line_item_'.$brand['tid'];
        if( isset( $_GET['brands'] ) and is_array( $_GET['brands'] ) and count( $_GET['brands'] ) ){
            if( array_search($brand['tid'], $_GET['brands'])===false ){
                $addon.= '<option value="'.$brand['tid'].'"></option>';
            }else{
                $source_content.= ' brands_line_active';
                $addon.= '<option value="'.$brand['tid'].'" selected="selected"></option>';
            }
        }else{
            $addon.= '<option value="'.$brand['tid'].'"></option>';
        }
        $source_content.= '" onclick="checkbrand('.$brand['tid'].', this, \'brands\');">'.$brand['name']. '</span>';
    }
    $source_content.= '</div><div class="cats_line"><span class="brands_line_item brands_line_all brands_line_item_0';
    if( !isset( $_GET['cats'] ) or !is_numeric( $_GET['cats'] ) or $_GET['cats']==0 ){
        $source_content.= ' brands_line_active';
    }
    $source_content.= '" onclick="checkbrand(0, this, \'cats\');">Все разделы</span>';
    $brands=db_query('select DISTINCT d.tid, d.name from {taxonomy_term_data} as d inner join {field_data_taxonomy_catalog} as f on (f.taxonomy_catalog_tid=d.tid and f.entity_type=\'node\') inner join {node} as n on (f.entity_id=n.nid) left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$user->uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    while( $brand=$brands->fetchAssoc() ){
        $source_content.= '<span class="brands_line_item brands_line_item_'.$brand['tid'];
        if( isset( $_GET['cats'] ) and is_array( $_GET['cats'] ) and count( $_GET['cats'] ) ){
            if( array_search($brand['tid'], $_GET['cats'])===false ){
                $addon2.= '<option value="'.$brand['tid'].'"></option>';
            }else{
                $source_content.= ' brands_line_active';
                $addon2.= '<option value="'.$brand['tid'].'" selected="selected"></option>';
            }
        }else{
            $addon2.= '<option value="'.$brand['tid'].'"></option>';
        }
        $source_content.= '" onclick="checkbrand('.$brand['tid'].', this, \'cats\');">'.$brand['name']. '</span>';
    }
    $source_content.= '</div><div style="display: none;"><div class="views-exposed-form-rest"><div class="form-item-brands"><select multiple="multiple" id="ibrands" name="brands[]"><option value="0"';
    if( !isset( $_GET['brands'] ) or !is_array( $_GET['brands'] ) or !count( $_GET['brands'] ) or $_GET['brands'][0]==0 ){
        $source_content.=' selected="selected"';
    }
    $source_content.= '></option>'.$addon;
    $source_content.= '</select></div><div class="form-item-cats"><select multiple="multiple" id="icats" name="cats[]"><option value="0"';
    if( !isset( $_GET['cats'] ) or !is_array( $_GET['cats'] ) or !count( $_GET['cats'] ) or $_GET['cats'][0]==0 ){
        $source_content.=' selected="selected"';
    }
    $source_content.= '></option>'.$addon2;
    $source_content.= '</select></div><input id="icols" name="cols" type="hidden" value="';
    $coldef='colpos1|colpos2|colpos3|colpos4|colpos5|colpos6|colpos7|colpos8|colpos9|colpos10|colpos11';
    if( !is_dir('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings/colorder2') ){
        mkdir('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings/colorder2');
    }
    if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings/colorder2/'.$user->uid) ){
        $coluser=file_get_contents('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings/colorder2/'.$user->uid);
        if( isset($coluser) and strlen($coluser) ){
            $coldef=filter_xss(strip_tags($coluser));
        }
    }
    if( !isset( $_GET['cols'] ) or !strlen( $_GET['cols'] ) or $_GET['cols']==$coldef ){
    }else{
        $coldef=filter_xss(strip_tags($_GET['cols']));
    }
    $source_content.= $coldef;
    $source_content.= '" /></div></div>';
    
    $source_content.= '<div class="export_col">';
    
    $source_content.= '
<div><strong>Выставьте содержимое документа в нужном порядке:</strong></div>
<div id="export_cols">
    <ul id="sortable" class="connectedSortable">';
    
    $coldef=explode('|', $coldef);
    if( isset($coldef) and is_array($coldef) and count($coldef) ){
        foreach( $coldef as $colde ){
            if( isset($acols[$colde]) and strlen($acols[$colde]) ){
                unset($acolsno[$colde]);
                $source_content.= '<li class="ui-state-default" id="'.$colde.'">'.$acols[$colde].'</li>';
            }
        }
    }
    
    
    $source_content.= '</ul>
</div>


<div class="sorthidden"><strong>Скрытые колонки:</strong></div><div id="export_cols2"><ul id="sortable2" class="connectedSortable"><li class="ui-state-default ui-state-disabled">Переместите сюда</li>';
    if( isset($acolsno) and is_array($acolsno) and count($acolsno) ){
        foreach( $acolsno as $colde=>$tmpme ){
            if( isset($acols[$colde]) and strlen($acols[$colde]) ){
                $source_content.= '<li class="ui-state-default ui-state-highlight" id="'.$colde.'">'.$acols[$colde].'</li>';
            }
        }
    }
    $source_content.= '</ul></div>

';
    $source_content.= '<div style="display: none;" class="savemyorder"><span class="th"></span><a href="javascript: void(0);" onclick="savemyorder(2);">Запомнить порядок колонок</a></div>';
    $source_content.= '</div>';
    
    $source_content.= '<div class="export_submit form-actions"><input type="submit" class="form-submit" value="Скачать DOC" /></div>';
    $source_content.= '</form>';
    
    
    return '<div class="nodecontent">'.$source_content.'</div>';    
}
function pdxseparate_item_import($source_content = NULL){
    $source_content= '<div>См. также экспорт в: <a href="'.url('user/item/export/doc', array('absolute'=>TRUE)).'">DOC</a>, <a href="'.url('user/item/export/pdf', array('absolute'=>TRUE)).'">PDF</a></div><div>&nbsp;</div>';
    global $user;

    $acols=array(
        'colpos1'=>'Артикул',
        'colpos2'=>'Название',
        'colpos3'=>'Раздел',
        'colpos4'=>'Подраздел',
        'colpos5'=>'Бренд',
        'colpos6'=>'Цена/час',
        'colpos7'=>'Цена/день',
        'colpos8'=>'Цена/неделю',
        'colpos9'=>'Цена/месяц',
        'colpos10'=>'Ссылка',
        'colpos11'=>'Картинка',
    );
    $acolsno=$acols;

    
    $addon=$addon2='';
    $source_content.= '<form action="/needto_op.php" method="post"><input type="hidden" value="2" name="op" />';
    $source_content.= '<div class="brands_line"><span class="brands_line_item brands_line_all brands_line_item_0';
    if( !isset( $_GET['brands'] ) or !is_numeric( $_GET['brands'] ) or $_GET['brands']==0 ){
        $source_content.= ' brands_line_active';
    }
    $source_content.= '" onclick="checkbrand(0, this, \'brands\');">Все бренды</span>';
    $brands=db_query('select DISTINCT d.tid, d.name from {taxonomy_term_data} as d inner join {field_data_field_brand} as f on (f.field_brand_tid=d.tid and f.entity_type=\'node\') inner join {node} as n on (f.entity_id=n.nid) left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$user->uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    while( $brand=$brands->fetchAssoc() ){
        $source_content.= '<span class="brands_line_item brands_line_item_'.$brand['tid'];
        if( isset( $_GET['brands'] ) and is_array( $_GET['brands'] ) and count( $_GET['brands'] ) ){
            if( array_search($brand['tid'], $_GET['brands'])===false ){
                $addon.= '<option value="'.$brand['tid'].'"></option>';
            }else{
                $source_content.= ' brands_line_active';
                $addon.= '<option value="'.$brand['tid'].'" selected="selected"></option>';
            }
        }else{
            $addon.= '<option value="'.$brand['tid'].'"></option>';
        }
        $source_content.= '" onclick="checkbrand('.$brand['tid'].', this, \'brands\');">'.$brand['name']. '</span>';
    }
    $source_content.= '</div><div class="cats_line"><span class="brands_line_item brands_line_all brands_line_item_0';
    if( !isset( $_GET['cats'] ) or !is_numeric( $_GET['cats'] ) or $_GET['cats']==0 ){
        $source_content.= ' brands_line_active';
    }
    $source_content.= '" onclick="checkbrand(0, this, \'cats\');">Все разделы</span>';
    $brands=db_query('select DISTINCT d.tid, d.name from {taxonomy_term_data} as d inner join {field_data_taxonomy_catalog} as f on (f.taxonomy_catalog_tid=d.tid and f.entity_type=\'node\') inner join {node} as n on (f.entity_id=n.nid) left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$user->uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    while( $brand=$brands->fetchAssoc() ){
        $source_content.= '<span class="brands_line_item brands_line_item_'.$brand['tid'];
        if( isset( $_GET['cats'] ) and is_array( $_GET['cats'] ) and count( $_GET['cats'] ) ){
            if( array_search($brand['tid'], $_GET['cats'])===false ){
                $addon2.= '<option value="'.$brand['tid'].'"></option>';
            }else{
                $source_content.= ' brands_line_active';
                $addon2.= '<option value="'.$brand['tid'].'" selected="selected"></option>';
            }
        }else{
            $addon2.= '<option value="'.$brand['tid'].'"></option>';
        }
        $source_content.= '" onclick="checkbrand('.$brand['tid'].', this, \'cats\');">'.$brand['name']. '</span>';
    }
    $source_content.= '</div><div style="display: none;"><div class="views-exposed-form-rest"><div class="form-item-brands"><select multiple="multiple" id="ibrands" name="brands[]"><option value="0"';
    if( !isset( $_GET['brands'] ) or !is_array( $_GET['brands'] ) or !count( $_GET['brands'] ) or $_GET['brands'][0]==0 ){
        $source_content.=' selected="selected"';
    }
    $source_content.= '></option>'.$addon;
    $source_content.= '</select></div><div class="form-item-cats"><select multiple="multiple" id="icats" name="cats[]"><option value="0"';
    if( !isset( $_GET['cats'] ) or !is_array( $_GET['cats'] ) or !count( $_GET['cats'] ) or $_GET['cats'][0]==0 ){
        $source_content.=' selected="selected"';
    }
    $source_content.= '></option>'.$addon2;
    $source_content.= '</select></div><input id="icols" name="cols" type="hidden" value="';
    $coldef='colpos1|colpos2|colpos3|colpos4|colpos5|colpos6|colpos7|colpos8|colpos9|colpos10|colpos11';
    if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings/colorder/'.$user->uid) ){
        $coluser=file_get_contents('pdxcache/'.$_SERVER['HTTP_HOST'].'/settings/colorder/'.$user->uid);
        if( isset($coluser) and strlen($coluser) ){
            $coldef=filter_xss(strip_tags($coluser));
        }
    }
    if( !isset( $_GET['cols'] ) or !strlen( $_GET['cols'] ) or $_GET['cols']==$coldef ){
    }else{
        $coldef=filter_xss(strip_tags($_GET['cols']));
    }
    $source_content.= $coldef;
    $source_content.= '" /></div></div>';
    
    $source_content.= '<div class="export_col">';
    
    $source_content.= '
<div><strong>Выставьте колонки таблицы в нужном порядке:</strong></div>
<div id="export_cols">
    <ul id="sortable" class="connectedSortable">';
    
    $coldef=explode('|', $coldef);
    if( isset($coldef) and is_array($coldef) and count($coldef) ){
        foreach( $coldef as $colde ){
            if( isset($acols[$colde]) and strlen($acols[$colde]) ){
                unset($acolsno[$colde]);
                $source_content.= '<li class="ui-state-default" id="'.$colde.'">'.$acols[$colde].'</li>';
            }
        }
    }
    
    
    $source_content.= '</ul>
</div>


<div class="sorthidden"><strong>Скрытые колонки:</strong></div><div id="export_cols2"><ul id="sortable2" class="connectedSortable"><li class="ui-state-default ui-state-disabled">Переместите сюда</li>';
    if( isset($acolsno) and is_array($acolsno) and count($acolsno) ){
        foreach( $acolsno as $colde=>$tmpme ){
            if( isset($acols[$colde]) and strlen($acols[$colde]) ){
                $source_content.= '<li class="ui-state-default ui-state-highlight" id="'.$colde.'">'.$acols[$colde].'</li>';
            }
        }
    }
    $source_content.= '</ul></div>

';
    $source_content.= '<div style="display: none;" class="savemyorder"><span class="th"></span><a href="javascript: void(0);" onclick="savemyorder(1);">Запомнить порядок колонок</a></div>';
    $source_content.= '</div>';
    
    $source_content.= '<div class="export_submit form-actions"><input type="submit" class="form-submit" value="Скачать Excel" /></div>';
    $source_content.= '</form>';
    
    
    return '<div class="nodecontent">'.$source_content.'</div>';
}
function pdxgetcontacts(){
    $text='<h3>Контакты для связи</h3><p>E-mail: <span class="thismymail"></span></p><p>Телефон в Беларуси: +375 (25) 907-06-09 (Ирина)</p><p>Телефон в России: +8 (910) 600-51-01 (Наталья)</p><p>Телефон в Украине: +380 (68) 903-82-78 (Юлия)</p>';
    return $text;
}
function pdxgettexts($type){
    $text='';
    switch($type){
    case 'i':
        $text.='<p>Мы представляем одну из первых площадок, на которых любой пользователь может сдать свой товар в аренду.</p><p>&nbsp;</p>
<div class="block_right">
<p>Несмотря на то, что все операции на сайте абсолютно бесплатны, представлено огромное количество возможностей по монетизации ресурса. На данный момент поддерживаются следующие направления:</p>
<ul>
<li>никто не запрещает вам сдавать собственные товары в аренду;</li>
<li>реклама на сайте;</li>
<li>реклама в группах в социальных сетях, принадлежащих сайту;</li>
<li>приобретение голд-аккаунта на месяц, стоимость зависит от города;</li>
<li>покупка премиум статуса для объявления на две недели, стоимость зависит от города;</li>
<li>разовое поднятие объявления наверх, стоимость зависит от города;</li>
<li><a target="_blank" href="http://'.PDX_URL_HELP.'/help/franshiza-na-gorod">франшиза на определенный город</a>, позволяющая владельцу франшизы модерировать объявления в данном городе, получать средства, которые пользователи вносят на баланс, продавать рекламные места на сайте и в группах данного города в социальных сетях.</li>
</ul>
<p>Для интереса давайте попробуем рассчитать прибыль только с платных услуг на сайте для одного города. На примере города Минска.</p>
<p>На сайте 8 Разделов, внутри которых имеются Подразделы, а в них есть определенные Товары. Подразделов порядка 30. Товаров несколько сотен. Одно объявление может размещаться в одном Разделе, одном Подразделе и в одной единице товара. На одной странице Раздела/Подраздела/Товара выводится 40 объявлений.</p>
<p>Предположим, что на первой странице каталога 10 из этих объявлений– платные. Это вряд ли завышенная цифра, учитывая, что в Минске можно найти более 100 компаний, сдающих товары в аренду. А ведь платными услугами могут воспользоваться и обычные пользователи. Также стоит отметить, что эти 10 объявлений от разных аккаунтов, так как фирмы не сдают, например, сразу по десять разных велотренажеров. У каждой фирмы есть один вид велотренажера, который предоставляется в аренду.</p>
<p>Также предположим, что популярностью пользуются 10 Подразделов, 20 Товаров, и, конечно, 8 Главных разделов. Но, для достоверности, сократим эти цифры до 25 разделов каталога, в которых размещается по 10 платных объявлений.</p>
<p>Итак, по самым минимальным подсчетам в среднем получается: 250 платных рекламных мест (объявлений), среди которых будет идти постоянная конкуренция: покупка голд-аккаунтов, premium-объявлений, поднятий наверх. Следует также учесть, что поднятия наверх востребованы как среди обычных арендодателей, так и для тех, чьи объявления размещаются в приоритетной области каталога. Для обычных арендодателей это возможность сделать объявление первым после всех приоритетных. А для приоритетных это возможность сделать объявление вообще первым в каталоге.</p>
</div>
<div class="block_left">
<h3>Инвестирование в наш Интернет-ресурс</h3>
<p>Мы всегда открыты для сотрудничества! Если вы хотите безвозмездно или за определенный процент вложить в наш проект собственные средства, пишите нам на e-mail <span class="thismymail">&nbsp;</span>.</p>
<p>Мы готовы предложить вам долю в проекте при инвестициях от 20&nbsp;000 долларов.</p>
<h3>Покупка данного Интернет-ресурса (все города)</h3>
<p>При желании, рассмотрим предложения по продаже данного Интернет-ресурса. На данный момент мы готовы продать его за 100&nbsp;000 долларов.</p>
<p>В стоимость входит:</p>
<ul>
<li>доступы к хостингам, на которых размещены рабочие и тестовые версии сайта;</li>
<li>доступы к группам в социальных сетях;</li>
<li>домен;</li>
<li>инструкции по управлению сайтом в текстовом и видео-формате;</li>
<li>обучение Ваших контент-менеджеров использованию сайта;</li>
<li>бесплатное устранение ошибок, обнаруженных в работе текущего функционала сайта, на протяжении 1 года;</li>
<li>100 часов бесплатной поддержки для решения каких-либо технических вопросов, разработки нового функционала и т.п. *</li>
</ul>
<p>* Стоимость часа доработки сайта, сверх бесплатных 100 часов: 30 долларов.</p>
<p>&nbsp;</p>
<p><strong class="bg">Ждем Ваших замечаний и предложений, мы открыты для вас!</strong></p><h3>Контакты для связи</h3><p>E-mail: <span class="thismymail"></span></p><p>Телефон в Беларуси: +375 (29) 816-27-17 (Роман)</p><p>Телефон в России: +8 (910) 600-51-01 (Наталья)</p><p>Телефон в Украине: +380 (68) 903-82-78 (Юлия)</p>';
        $text.='</div>';
        break;
    case 'dev':
        $text.='
<p>Наша команда всегда готова предложить вам свои услуги по разработке проектов любой сложности. Мы занимаемся именно полным циклом запуска проекта: от его разработки, до запуска и первоначального продвижения.</p><div>&nbsp;</div>
<div class="block_right"><h3>Наша команда</h3>
<p><ul>
<li><strong>Клименко Роман.</strong> Разработка сайтов, координация действий (Украина)</li>
<li><strong>Куряча Яна.</strong> Дизайнер (Украина)</li>
<li><strong>Киселюк Юля.</strong> Реклама в социальных сетях, представитель и контактное лицо на Украине (Украина)</li>
<li><strong>Екатерина Жарко.</strong> Управление контент-менеджерами (Беларусь)</li>
<li><strong>Ирина Лядвик.</strong> Общение с клиентами и рекламодателями (Беларусь)</li>
<li><strong>Наталья Тренина.</strong> Представитель и контактное лицо в России (Россия)</li>
<li><strong>Людмила Волковская.</strong> Управление контент-менеджерами (Украина)</li>
</ul></p>
</div>
<div class="block_left">
<p>Мы специализируемся на разработке Интернет-ресурсов, предназначенных для взаимодействия пользователей друг с другом. То есть, ресурсов, подобных сайту '.$GLOBALS['base_url'].': где одни посетители что-либо предлагают, а другие пользуются их услугами. Например: доски объявлений, сайты услуг, сайты знакомств, фриланс-сайты, краудфандинг-системы и т.д. Поэтому в первую очередь нам интересны именно подобные проекты.</p>
<h3>Реализованный функционал</h3>
<p>Заказывая у нас сайт, вы гарантированно получаете следующий функционал.</p>
<p><strong>Профиль пользователя:</strong></p>
<p><ol>
<li>регистрация, в том числе через социальные сети;</li>
<li>личный кабинет;</li>
<li>баланс пользователя, который можно пополнить электронными деньгами и наличными;</li>
<li>избранные объявления;</li>
<li>избранные пользователи;</li>
<li>статус пользователя (онлайн/оффлайн);</li>
<li>общение между пользователями через сайт, посредством личных сообщений;</li>
<li>пожаловаться на объявление;</li>
<li>пожаловаться на арендодателя.</li>
</ol></p><div>&nbsp;</div>
<p><strong>Публикация материалов:</strong></p>
<p><ol>
<li>подача объявлений с премодерацией;</li>
<li>редактирование отдельных полей объявления без повторной модерации;</li>
<li>просмотр объявления и контактов арендодателя с защитой от сбора роботами;</li>
<li>подача заявки на аренду (регистрация сделки);</li>
<li>возможность оставить рейтинг и отзыв об арендодателе и арендаторе после официального завершения сделки;</li>
<li>новости сайта;</li>
<li>отображение магазинов арендодателей (юридических лиц) на Яндекс.Карте;</li>
<li>раздел, где посетитель мог бы оставить свою заявку на аренду нужной вещи;</li>
<li>функция <em>Мне повезет!</em> (случайное объявление);</li>
<li>возможность задания цены как в национальной валюте, так и в долларах; при этом цена на сайте будет выводиться в национальной валюте, в пересчете по курсу НБ на сегодняшний день;</li>
<li>возможность клонировать объявления;</li>
<li>возможность прикрепить к объявлению ссылки на другие объявления;</li>
<li>раздел Просмотренные объявления;</li>
<li>экспорт своих объявлений в Excel.</li>
</ol></p><div>&nbsp;</div>
<p><strong>Платные услуги:</strong></p>
<p><ol>
<li>покупка голд-аккаунта со следующими преимуществами: постмодерация, отсутствие рекламы на всех сайтах сети;</li>
<li>покупка статуса премиум для объявления; преимущества: объявление выводится выше обычных и выделяется особым образом;</li>
<li>оплата разового поднятия объявления наверх;</li>
<li>франшиза для отдельного города;</li>
<li>зачисление бонусных средств за выполнение определенных действий: регистрация на сайте, вступление в группу, поделиться новостью из группы на своей странице, разместить активную ссылку на своем сайте;</li>
<li>подарок на баланс случайному пользователю раз в неделю.</li>
</ol></p><div>&nbsp;</div>
<p><strong>Социальные медиа:</strong></p>
<p><ol>
<li>автоматический выпуск рассылки;</li>
<li>автоматическая публикация объявлений в группе ВКонтакте;</li>
<li>автоматическая публикация заголовков новых материалов в Twitter;</li>
<li>возможность отправить на указанный email ссылку на товар.</li>
</ol></p><div>&nbsp;</div>
<p><strong>Другое:</strong></p>
<p><ol>
<li>справочная система;</li>
<li>возможность выбора своего города, и показ объявлений только этого города;</li>
<li>возможность оставлять сообщения о найденных ошибках, и предложения по улучшению сайта;</li>
<li>административная панель для контент-менеджеров и администраторов.</li>
</ol></p><div>&nbsp;</div>
<h3>Что входит в стоимость заказа</h3>
<p>В стоимость входит разработка, продвижение и поддержка проекта. А именно:</p>
<p><ul>
<li>разработка ТехЗадания на сайт (ТЗ);</li>
<li>дизайн сайта;</li>
<li>дизайн первичных рекламных носителей (логотип, визитка, буклет A4 и A3, баннер 468x60);</li>
<li>верстка и разработка сайта;</li>
<li>бесплатное техническое сопровождение в течение 1 года (устранение найденных ошибок и обновление модулей);</li>
<li>услуги двух контентов в течение 1 мес, для первичного наполнения, ведения сайта, обучения ваших специалистов;</li>
<li>создание и ведение групп ВКонтакте, Facebook, Twitter в течение 3 месяцев;</li>
<li>настройка и запуск рекламной компании ВКонтакте, Facebook, а также в контекстных сетях Бегун, Яндекс.Директ, Google Adwords;</li>
<li>30 часов бесплатной разработки нового функционала*;</li>
<li>справочная система для пользователей сайта, включая видеоинструкции на канале YouTube;</li>
<li>справочная система по администрированию сайта, включая видеоинструкции;</li>
<li>перенос и установка сайта на хостинг;</li>
<li>разработка базовой версии мобильного приложения под Android;</li>
<li>разработка базовой версии мобильного приложения под IOS.</li>
</ul></p>
<div>&nbsp;</div>
<p>* Стоимость часа доработки сайта, сверх бесплатных 30 часов: 30 долларов.</p>
<h3>Стоимость и сроки</h3>
<p>Срок реализации проекта: 1-2 месяца после утверждения дизайна и ТЗ.</p>
<p>Стоимость услуги: <strong>25 000 $</strong> (в нац. валюте, по курсу). Оплата поэтапная:</p>
<ul>
<li><strong>3 000 $</strong> - предоплата;</li>
<li><strong>2 000 $</strong> - после утверждения ТЗ и дизайна;</li>
<li><strong>5 000 $</strong> - после завершения разработка сайта;</li>
<li><strong>5 000 $</strong> - после написания справочной информации и подготовки инфраструктуры: группы в соцсетях, облако, связь сайта и дев-версии через Git;</li>
<li><strong>5 000 $</strong> - после создания рекламных компаний ВКонтакте, Facebook, Бегун, Яндекс.Директ, Google Adwords; при этом на каждую из перечисленных рекламных компаний заносится <strong>200 $</strong>;</li>
<li><strong>5 000 $</strong> - после запуска проекта.</li>
</ul>
<p>Возможно, наши цены покажутся кому-то слишком завышенными. Но в данном случае вы платите за качество, опыт и уникальные наработки, которые не сможет предоставить какая-либо другая команда.</p>
<p>Ждем Ваших замечаний и предложений!</p>';
        if( function_exists('pdxgetcontacts') ){
            $text.=pdxgetcontacts();
        }
        $text.='</div>';
        break;
    case 'a':
        $text.='<p>Мы готовы поместить ваш баннер на главной странице сайта выбранного города, в разделах каталога, либо в предложениях выбранного вами раздела каталога. На данный момент вы можете разместить свою рекламу в одном и следующих разделов: <ul><li><em>детский мир</em> - целевая аудитория из молодых мам и пап;</li><li><em>одежда и украшения</em> - люди, интересующиеся модой, и желающие всегда выглядеть красиво;</li><li><em>спорт и отдых</em> - люди, следящие за своим физическим состоянием, а также интересующиеся активным отдыхом;</li><li><em>дом</em> - люди, заботящиеся о своем здоровье, и интересующиеся всем, что связано с ведением домохозяйства;</li><li><em>техника</em> - целевая аудитория, заинтересованная в приобретении какой-либо техники;</li><li><em>хобби</em> - люди, имеющие какое-либо хобби, и желающие развиваться в нем;</li><li><em>бизнес</em> - целевая аудитория из молодых бизнесменов и людей, интересующихся данной темой;</li><li><em>транспорт</em> - целевая аудитория из людей, которым требуется какая-либо транспортная техника.</li></ul></p><p>Также можем рассмотреть другие варианты сотрудничества.</p>
<p>Пишите или звоните нам по любым вопросам, связанным с рекламой на сайте.</p>';
        if( function_exists('pdxgetcontacts') ){
            $text.=pdxgetcontacts();
        }
        $text.='<p>В письме не забудьте указать, реклама на каком сайте какого именно города вас заинтересовала.</p>';
        break;
    case 'apply':
        $text.='<p>Я выражаю согласие на обработку своих персональных данных, включая сбор, систематизацию, накопление, хранение, уточнение, использование, уничтожение персональных данных. Персональные данные могут использоваться для корректной работы функций, связанных с основным назначением сайта. А также в целях сбора и обработки статистической информации и проведения маркетинговых исследований.</p>
<p>Соглашение распространяется на следующие персональные данные: имя, мобильный телефон, адрес электронной почты, пол, возраст.</p>
<p>Согласие на обработку персональных данных предоставляется до момента удаления моей учетной записи с сайта.</p>
<p>Я подтверждаю, что мне известна цель использования моих персональных данных и настоящим выражаю свое согласие на использование.</p>';
        break;
    case 'rules':
    $text.='<p>Данное Пользовательское соглашение описывает отношения между сайтом &laquo;Needto.me&raquo; и&nbsp;пользователем сети Интернет (&laquo;Пользователь&raquo;), возникающие при использовании интернет-ресурса '.$GLOBALS['base_url'].' (&laquo;Needto.me&raquo;) и его поддоменов, на указанных в Пользовательском соглашении условиях.</p>

<p>Любые действия Пользователя, направленные на использование Needto.me, в том числе: поиск, просмотр или подача объявлений, регистрация на сайте и прочие действия по использованию функциональности Needto.me, являются подтверждением принятия данного Пользовательского соглашения.</p>

<p>В любое время Needto.me может изменить пользовательское соглашение без специального уведомления об этом Пользователя. Новая редакция Пользовательского соглашения вступает в силу с момента ее размещения на сайте '.$GLOBALS['base_url'].'. И дальнейшее использование Пользователем сайта Needto.me является подтверждением согласия с новой редакцией Пользовательского соглашения.</p>

<h3>Термины и определения</h3>

<p>В данном Пользовательском соглашении используются термины, указанные ниже, в следующем контексте.</p>

<p><em>Сайт</em> &mdash; совокупность Интернет ресурсов, расположенных по адресам www.needto.me и needto.me (включая домены следующих уровней, относящиеся к данным адресам), а также Мобильные приложения, относящиеся к Needto.me.</p>

<p><em>Пользователь</em>&nbsp;&mdash; посетитель ресурсов сети Интернет, в том числе Needto.me.</p>

<p><em>Пользовательское соглашение</em>&nbsp;&mdash; настоящее соглашение и иные правила и документы, определяющие порядок использования Сервисов, опубликованные на&nbsp;Сайте.</p>

<p><em>Сервисы</em> &mdash; функциональные возможности, службы, услуги, инструменты, доступные для Пользователей на Needto.me.</p>

<p><em>Товар</em> &mdash; любой предмет, который один Пользователь сдает в аренду, а другой Пользователь может взять в аренду на оговоренное время.</p>

<p><em>Арендодатель</em> &mdash; Пользователь, который заявляет о своем желании сдать какой-либо Товар в прокат при помощи размещения Объявления об этом.</p>

<p><em>Арендатор</em> &mdash; Пользователь, который заявляет о своем желании взять какой-либо Товар, размещенный в виде Объявления на сайте Needto.me, в прокат.</p>

<p><em>Объявление</em> или <em>Предложение</em> &mdash; сообщение с предложением о Товаре (включая контактную информацию, и любую сопутствующую информацию) которое Пользователь размещает на сайте Needto.me, с целью сдать Товар в прокат.</p>

<p><em>Учетные данные</em> &mdash; уникальный логин (адрес электронной почты) и пароль, создаваемые самостоятельно Пользователем в процессе Регистрации на Сайте либо измененные в дальнейшем Пользователем через Личный кабинет. Доступ в Личный кабинет, публикация Объявления, ответ на Объявление возможны только после ввода Учетных данных.</p>

<h3>Доступ к сервисам сайта</h3>

<p>1.1. На условиях данного Пользовательского соглашения, Пользователь может воспользоваться всеми доступными сервисами Needto.me: размещением, поиском, просмотром, возможностью ответа на Объявления, а также другими Сервисами сайта. На отдельные Сервисы сайта могут быть установлены дополнительные условия использования, а также правила и ограничения. Условия предоставления Сервисов могут быть в любой момент пересмотрены Needto.me.</p>

<p>1.2. Если не указано обратное, Сервисы сайта предоставляются бесплатно.</p>

<p>1.3. Сайт Needto.me является площадкой, где Пользователи могут самостоятельно, под свою ответственность, заключать сделки по прокату вещей друг с другом. Needto.me не является организатором сделки, Арендодателем, Арендатором или представителем какого-либо Пользователя и/или заинтересованного лица. Все сделки, совершаемые благодаря размещению Объявлений на сайте Needto.me, заключаются и исполняются без прямого или косвенного участия Needto.me.</p>

<p>1.4. Просмотр информации, размещенной на сайте Needto.me, автоматически означает согласие Пользователя с правилами данного Пользовательского соглашения. Независимо от того, является данный Пользователь зарегистрированным, авторизированным или обычным анонимным посетителем.</p>

<p>1.5. Выражая согласие с данным Пользовательским соглашением, Пользователь гарантирует, что обладает всеми правами и полномочиями, необходимыми для заключения и исполнения Пользовательского соглашения. В том числе, достиг 16-летнего возраста, и является владельцем предмета, который собирается предложить к аренде. Сайт Needto.me имеет право в любое время потребовать от Пользователя предоставления документов и информации, подтверждающих его права и полномочия.</p>

<p>1.6. Все Сервисы, размещенные на сайте Needto.me, могут быть в любой момент изменены, обновлены, дополнены без предварительного уведомления Пользователя. Все Сервисы предоставляются в режиме &laquo;Как есть&raquo;. За любой вред, прямо или косвенно нанесенный сайтом Needto.me или отдельными его Сервисами, отвечает сам Пользователь. Needto.me может в любой момент приостановить или полностью отменить действие какого-либо из Сервисов, без предварительного уведомления Пользователей.</p>

<h3>Регистрация на сайте</h3>

<p>2.1. Пользователь может размещать Объявления, отправлять заявки на прокат, оставлять отзывы об услугах после Регистрации на Needto.me.</p>

<p>2.2. Пользователь обязан следить за сохранностью своих Учетных данных, и не раскрывать их третьим лицам. За любые последствия, которые могут возникнуть при передаче Учетных данных третьим лицам, несет ответственно исключительно пользователь.</p>

<p>2.3. Любые действия, совершенные под учетной записью пользователя (изменение Учетных данных, создание, редактирование, удаление Объявлений, работа с балансом пользователя) считаются действиями, совершенными самим пользователем. Это относится, в том числе, и к ответственности за нарушение настоящего Пользовательского соглашения, а также требований законодательства страны, город которой выбран в качестве города пользователя.</p>

<p>2.4. Если у пользователя появились малейшие причины подозревать, что его Учетные данные были скомпрометированы, он обязан немедленно изменить свои Учетные данные и в случае необходимости сообщить администраторам Needto.me.</p>

<p>2.5. Сайт Needto.me не гарантирует, что пользователь действительно является тем, кем он представился. Также не гарантируется, что информация, представленная пользователем, является достоверной. Needto.me настоятельно рекомендует соблюдать осторожность при совершении сделок и выборе Арендодателя или Арендатора.</p>

<p>2.6. Needto.me имеет право полностью блокировать учетную запись любого пользователя сайта. А также блокировать или удалять все, либо отдельные Объявления пользователя.</p>

<p>2.7. Любые действия на сайте Needto.me, не требующие регистрации (просмотр Объявлений, доступ к информации об арендодателях и т.п.), в любом случае подразумевают согласие и соблюдение с положениями Пользовательского соглашения.</p>

<h3>Предоставляемые пользователями сведения</h3>

<p>3.1. Пользователь обязуется предоставлять только достоверные сведения на сайте Needto.me: информацию о себе, данные Объявлений, отзывы об услуге и т.п. За достоверность любой информации, оставленной им на сайте Needto.me, пользователь несет ответственность. Пользователь обязуется следить за актуальностью предоставленных сведений, и своевременно их редактировать. Сайт Needto.me имеет право запрашивать подтверждения любых сведений, предоставленных пользователем.</p>

<p>3.2. Пользователь разрешает размещать в открытом доступе указанные им персональные данные и иные сведения о себе (фамилия, имя, отчество, адрес электронной почты, скайп, номера телефонов, район проживания, указанный адрес магазина, а также любую иную информацию) для целей исполнения Пользовательского соглашения.</p>

<p>3.3. Пользователь разрешает Needto.me и его аффилированным лицам обработку персональных и иных своих данных. А также их передачу для обработки другим пользователям и/или третьим лицам, действующим по поручению Needto.me. Needto.me принимает все необходимые меры для защиты персональных данных пользователя от несанкционированного доступа третьих лиц.</p>

<p>3.4. Любую информацию пользователь размещает на сайте Needto.me исключительно в своих интересах: для облегчения установления связи с Арендодателем или Арендатором. Пользователь понимает, что любая информация из Объявлений публикуется в открытом доступе, и является доступной для ознакомления любому посетителю сайта, независимо от страны, в которой он находится. Соответственно, пользователь понимает и принимает на себя все риски, связанные с таким размещением. В том числе, риски попадания в спам-рассылки, риски мошенничества, и иные риски, вытекающие из такого размещения информации.</p>

<p>3.5. Needto.me не обязан проверять достоверность указанных пользователем сведений.</p>

<p>3.6. Needto.me имеет право отказать в размещении Объявления любому пользователю, а также удалять любые сведения, размещенные пользователем, без объяснения причин.</p>

<p>3.7. Needto.me имеет право не рассматривать любые обращения пользователя по вопросам работы сайта, либо отдельных его Сервисов.</p>

<h3>Пользователь обязуется</h3>

<p>4.1. Действовать исключительно в соответствии с Пользовательским соглашением, а также законодательством страны, город которой он выбрал при регистрации или просмотре сайта Needto.me.</p>

<p>4.2. Использовать сервисы Needto.me, а также любую предоставленную на сайте информацию, исключительно по назначению.</p>

<p>4.3. Без разрешения Needto.me распространять, копировать и/или извлекать ручным или автоматическим способом любую информацию с сервисов Needto.me.</p>

<p>4.4. Не препятствовать полноценной деятельности сервисов Needto.me и не пытаться каким-либо образом замедлить работу сайта или отдельных его сервисов.</p>

<p>4.5. Не использовать любые данные, предоставленные на сайте Needto.me третьими лицами (другими пользователями), без письменного разрешения Needto.me.</p>

<p>4.6. Соблюдать осмотрительность при выборе арендодателя или арендатора.</p>

<h3>Рекламная информация на сайте</h3>

<p>5.1. Тем или иным образом используя сервисы Needto.me, пользователь автоматически соглашается на получение рекламной информации, размещенной на сайте третьими лицами.</p>

<p>5.2. Регистрируясь на сайте, пользователь осознает и принимает, что сообщения, отправляемые сайтом по электронной почте или посредством SMS, могут содержать рекламную информацию.</p>

<p>5.3. Регистрируясь на сайте, пользователь выражает согласие с тем, что Needto.me может направлять ему электронные письма или сообщения SMS на адреса, оставленные при регистрации (или переданные социальной сетью, через которую пользователь регистрировался).</p>

<h3>Гарантии и ответственность</h3>

<p>6.1. За действия, совершаемые на сайте Needto.me, пользователь несет ответственность в соответствии с законодательством той страны, город которой был выбран при посещении и/или регистрации на сайте.</p>

<p>6.2. Пользователь несет ответственность за свои действия на сайте: за то, какие Объявления добавляет, а также за то, какого арендатора или арендодателя выбирает. Все сделки, касающиеся Объявлений, заключаются между пользователями напрямую. И Needto.me не является участником или посредником сделок, а также, не несет ответственности за совершаемые сделки.</p>

<p>6.3. Сайт Needto.me не всегда проверяет Объявления, размещаемые пользователями. Таким образом, содержание Объявлений находится вне контроля Needto.me.</p>

<p>6.4. Сайт Needto.me не гарантирует бесперебойную деятельность своих сервисов.</p>

<p>6.5. Сайт Needto.me не гарантирует, что все сервисы и отдельный функционал сайта будет соответствовать ожиданиям пользователя.</p>

<p>6.6. Пользователь согласен, что Needto.me не несет ответственности за убытки, которые могут быть причинены пользователю вследствие блокировки его учетной записи, отдельных его Объявлений, либо нестабильной работы сервисов.</p>

<p>6.7. Пользователь понимает, что при использовании любых функций сайта, тем или иным образом связанных с передачей сообщений, однозначная доставка сообщения получателю не гарантируется.</p>

<p>6.8. Needto.me никоим образом не связан с любой предоставляемой пользователями информацией. В том числе, с содержанием объявлений.</p>

<p>6.9. Любые ссылки на сайты третьих лиц, размещаемые пользователями, не проверяются на соответствие требованиям законности, достоверности, полноты и т.п. Needto.me не несет ответственности за информацию, размещенную по этим ссылкам.</p>

<h3>Права на интеллектуальную собственность</h3>

<p>7.1. Все права на сайт Needto.me и отдельные его части, включая, но не ограничиваясь, доменное имя, логотип, базы данных, технические разработки, принадлежат непосредственно разработчику сайта Needto.me &ndash; Клименко Роману Александровичу (soonmy.com). Пользователь или иное лицо не в праве использовать сайт, отдельные его сервисы, исходные коды или размещенную на сайте информацию способами, отличными от описанных данным Пользовательским соглашением.</p>

<p>7.2. В целях исполнения настоящего Пользовательского соглашения пользователь предоставляет Needto.me право использовать любые сведения, которые он предоставил, любым способом на всех известных или неизвестных носителях, в течение всего срока действия данного Пользовательского соглашения. Пользователь разрешает передавать такое право третьим лицам.</p>

<p>7.3. Пользователь гарантирует, что предоставленные им сведения не нарушают любых прав третьих лиц.</p>

<h3>Период действия Пользовательского соглашения</h3>

<p>8.1. Настоящее Пользовательское соглашение вступает в силу с момента, когда пользователь начал использовать любые сервисы сайта, независимо от того, зарегистрирован он или нет, и действует бессрочно.</p>

<h3>Передача прав</h3>

<p>9.1. Пользователь согласен, что Needto.me имеет право передавать свои права и обязанности по данному Пользовательскому соглашению третьим лицам для предоставления аналогичных или похожих услуг.</p>

<p>&nbsp;</p>';
        break;
    case 'apime':
    $text.='<p>На данный момент для разработчиков мы предоставляем следующие возможности:</p><p><strong>Каталог.</strong> Актуальный список текущих разделов и подразделов сайта доступен по адресу <a href="'.PDX_IMGPATH.'/mobile/tax.zip">'.PDX_IMGPATH.'/mobile/tax.zip</a>. В данном архиве лежит файл <em>tax.dat</em>. Он содержит в себе JSON-последовательность. После декодирования JSON, вы получите массив, имеющий следующий формат:</p><div><pre>[0][id]=id первого раздела каталога
[0][name] = название первого раздела каталога
[0][link] = ссылка на раздел на сайте
[0][subparts][0][id] = id первого подраздела данного раздела
[0][subparts][0][name] = название
[0][subparts][0][link] = ссылка на подраздел на сайте</pre></div><div>&nbsp;</div><p>Получение картинок к разделам/подразделам каталога выполняется по id. Формат адреса картинки: <em>'.PDX_IMGPATH.'/static/part/i<strong>ID_города</strong>.png</em>. Например, <a target="_blank" href="'.PDX_IMGPATH.'/static/part/i2.png">'.PDX_IMGPATH.'/static/part/i2.png</a>.</p>
<p><strong>Базовая информация по объявлениям.</strong> Архив основной информации обо всех объявлениях доступен по ссылке '.PDX_IMGPATH.'/mobile/<strong>ID_города</strong>_items.zip. В этом архиве находится файл <em><strong>ID_города</strong>_items.dat</em>, содержащий данные в формате JSON. После декодирования JSON, вы получите массив вида:</p><div><pre>[ID подраздела][0][id] = id объявления
[ID подраздела][0][title] = Заголовок объявления
[ID подраздела][0][image1] = URL маленького изображения
[ID подраздела][0][image2] = URL большого изображения
[ID подраздела][0][link] = ссылка на объявление на сайте
[ID подраздела][0][price1] = цена за час
[ID подраздела][0][price2] = цена за день
[ID подраздела][0][price3] = цена за неделю
[ID подраздела][0][price4] = цена за месяц</pre></div><div>&nbsp;</div><p><strong>Курс доллара.</strong> Текущий курс валюты хранится в виде JSON-последовательности в файле '.PDX_IMGPATH.'/mobile/<strong>ID_страны</strong>_curs.dat. Пример содержимого данного файла: <em>{"21564"}</em>. То есть, курс НБ на нашем сайте: <em>21 564</em>.</p><p><strong>Погода.</strong> Температура за окном хранится в виде JSON-последовательности в файле '.PDX_IMGPATH.'/mobile/<strong>ID_города</strong>_grad.dat. Пример содержимого данного файла: <em>{"-10"}</em>. То есть, температура в выбраном городе: минус 10 градусов.</p><p>&nbsp;</p><p><strong>Подробная информация об объявлении и арендодателе.</strong> Доступ к полной информации об объявлении и арендодателе предоставляется по API. Чтобы воспользоваться API, необходимо получить ключ доступа. Ключи доступа выдаются на год, на платной основе.</p><p>Если вы хотите использовать данные нашего сайта в своих проектах или приложениях, пожалуйста, свяжитесь с нами для получения ключа доступа.</p><p>После получения ключа, вы сможете обращаться к нашему API по следующему адресу для выбранного вами города: http://сайт/call.php?v2. Например http://mn.needto.me/call.php?v2.</p><p>API-реализован на протоколе JSON-RPC 2.0. Например, для Java-программистов работа с JSON-RPC 2.0 возможна с помощью следующей библиотеки: <noindex><a rel="nofollow" href="http://software.dzhuvinov.com/json-rpc-2.0-client.html" target="_blank">http://software.dzhuvinov.com/json-rpc-2.0-client.html</a></noindex></p>';
        if( function_exists('pdxgetcontacts') ){
            $text.=pdxgetcontacts();
        }
        break;
    case 'press':
    $text.='<div class="block_right"><h3>Материалы для прессы</h3><p>Все фотографии, использованные в представленных рекламных материалах, были взяты с <noindex><a rel="nofollow" target="_blank" href="http://ru.freeimages.com/license">бесплатного фотостока</a></noindex>. Их разрешено использовать, в том числе, в прессе.</p><div class="imgbox">
    <div class="imgbox_line"><img width="143" height="111" alt="Не мучайся! Путешествуй налегке" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smauditory2.png" /><div class="imgbox_line_right"><em>Не мучайся! Путешествуй налегке</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory2.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory2.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>
    
    <div class="imgbox_line"><img width="143" height="111" alt="Не тормози! Реализуй свои идеи" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smauditory3.png" /><div class="imgbox_line_right"><em>Не тормози! Реализуй свои идеи</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory3.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory3.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>
    
    <div class="imgbox_line"><img width="143" height="111" alt="Ремонтируй! Без затрат и вложений" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smauditory4.png" /><div class="imgbox_line_right"><em>Ремонтируй! Без затрат и вложений</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory4.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory4.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>
    
    <div class="imgbox_line"><img width="143" height="111" alt="Ремонтируй! Без затрат и вложений" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smauditory4_1.png" /><div class="imgbox_line_right"><em>Ремонтируй! Без затрат и вложений</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory4_1.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory4_1.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>
    
    <div class="imgbox_line"><img width="143" height="111" alt="Не экономь на счастье родных" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smauditory5.png" /><div class="imgbox_line_right"><em>Не экономь на счастье родных</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory5.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory5.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>
    
    <div class="imgbox_line"><img width="143" height="111" alt="Найди себя! Реализуй свои мечты" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smauditory6.png" /><div class="imgbox_line_right"><em>Найди себя! Реализуй свои мечты</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory6.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory6.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>
    
    <div class="imgbox_line"><img width="143" height="111" alt="Нечего надеть? Одежда на любой случай жизни" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smauditory7.png" /><div class="imgbox_line_right"><em>Нечего надеть? Одежда на любой случай жизни</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory7.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory7.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>
    
    <div class="imgbox_line"><img width="143" height="111" alt="Развлекайся! Без существенных затрат" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smauditory8.png" /><div class="imgbox_line_right"><em>Развлекайся! Без существенных затрат</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory8.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/auditory8.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>
    
    <div class="imgbox_line"><img width="143" height="151" alt="Разделы сайта" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smcat.png" /><div class="imgbox_line_right"><em>Разделы сайта</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/cat.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/cat.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>

    <div class="imgbox_line"><img width="143" height="143" alt="Сокращенное лого сайта" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smicobg.png" /><div class="imgbox_line_right"><em>Сокращенное лого сайта</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/icobg.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/icobg.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>

    <div class="imgbox_line"><img width="143" height="151" alt="Логотип плюс разделы сайта" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smsrc512x512.png" /><div class="imgbox_line_right"><em>Логотип плюс разделы сайта 512x512 пикселей</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/src512x512.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/src512x512.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>

    <div class="imgbox_line"><img width="143" height="73" alt="Логотип плюс разделы сайта и мотиваторы" class="lazy" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/press/smsrc1000x512.png" /><div class="imgbox_line_right"><em>Логотип плюс разделы сайта и мотиваторы 1000x512 пикселей</em><br />Скачать:<ul><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/src1000x512.png">максимальное качество</a></li><li><a target="_blank" href="http://d4zbhil5kxgyr.cloudfront.net/static/press/src1000x512.jpg">для веб</a></li></ul></div><div class="clear">&nbsp;</div></div>
    
    </div></div><div class="block_left" style="padding-top: 21px;">';
        $text.='<p>Хотите написать о нас статью? Предложить сотрудничество? Задать какие-либо вопросы? Мы открыты для любого сотрудничества, и с радостью рассмотрим Ваше предложение.</p>';
        $text.='</div>';
        if( function_exists('pdxgetcontacts') ){
            $text.=pdxgetcontacts();
        }
        break;
    }
    return $text;
}
function pdxseparate_catalog($source_content = NULL){
    $source_content= '';

    $cats=db_query('select t.tid, t.name from {taxonomy_term_data} as t where t.vid=2 order by t.weight asc');
    while( $cat=$cats->fetchAssoc() ){
        $source_content.= '<div class="catalog_item">';
        
        $source_content.= '<div class="isttl"><a href="/'.PDXCAT_NAME.'/'.$cat['tid'].'">';
        $source_content.= '<span class="image"><img class="lazy" alt="'.$cat['name'].'" data-original="http://d4zbhil5kxgyr.cloudfront.net/static/part/i'.$cat['tid'].'.png" /></span>';
        $source_content.= '<span class="ttl admlnk pdxobj'.$cat['tid'].' pdxot partis'.$cat['tid'].'">'.$cat['name'].'</span>';
        $source_content.= '</a></div>';
    
        $source_content.= '<div class="cnt">';
    
    
        $tids=db_query('select d.tid, d.name from {field_data_field_part} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid where f.entity_type=\'taxonomy_term\' and f.field_part_tid='.$cat['tid'].' and d.vid=8 order by d.weight');
        while( $tid=$tids->fetchAssoc() ){
            $source_content.= '<div class="subcat_item">';
    
            $source_content.= '<div class="subcat_item_cnt_ttl"><a href="/'.PDXCAT_NAME.'/'.$cat['tid'].'/'.$tid['tid'].'" class=" admlnk pdxobj'.$tid['tid'].' pdxot partis'.$tid['tid'].'">'.$tid['name'].'</a></div>';
    

            $amore2=array();
            $countmore=0;
            $tids2=db_query('select d.tid, d.name from {field_data_field_part} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid inner join {field_data_field_subpart} as s on ( d.tid=s.entity_id and s.entity_type=\'taxonomy_term\' ) where f.entity_type=\'taxonomy_term\' and f.field_part_tid='.$cat['tid'].' and s.field_subpart_tid='.$tid['tid'].' and d.vid<>8 order by d.name');
            while( $tid2=$tids2->fetchAssoc() ){
        
                if( ++$countmore>3 ){
                    $amore2[]='<div class="submnu3 submnu3hide partis'.$tid2['tid'].'"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$cat['tid'].'/'.$tid['tid'].'/'.$tid2['tid'].'">'.$tid2['name'].'</a></div>';
                }else{
                    $amore2[]='<div class="submnu3 partis'.$tid2['tid'].'"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$cat['tid'].'/'.$tid['tid'].'/'.$tid2['tid'].'">'.$tid2['name'].'</a></div>';
                }
            }
            if( isset($amore2) and is_array($amore2) and count($amore2) ){
                $source_content.= '<div class="submnu_cnt submnu_cnt_tags predmet_items">';
                $source_content.= implode('', $amore2);
                if( $countmore>3 ){
                    $source_content.= '<div class="submnu3 submnu3expand"><a href="javascript: void(0);" onclick=" jQuery(this).parent().parent().find(\'.submnu3hide\').show(); jQuery(this).hide(); ">Раскрыть весь список</a></div>';
                }
                    $source_content.= '</div>';
            }

            $source_content.= '</div>';
    
        }
        $source_content.= '<div class="clear">&nbsp;</div></div>';
    
        $source_content.= '</div>';
    }
    $source_content.= '<div class="catalog_item">';
    $source_content.= '<div class="isttl">';
    $source_content.= '<span class="image"><img class="lazy" alt="К празднику" data-original="/sites/all/themes/pdxneedto/img/happy2.png" /></span>';
    $source_content.= '<span class="ttl">К празднику</span>';
    $source_content.= '</div>';
    $source_content.= '<div class="cnt">';
    $cats=db_query('select t.tid, t.name from {taxonomy_term_data} as t where t.vid=10 order by t.weight asc');
    while( $tid=$cats->fetchAssoc() ){
            $source_content.= '<div class="subcat_item">';
    
            $source_content.= '<div class="subcat_item_cnt_ttl"><a href="/'.PDXCAT_NAME.'/'.$tid['tid'].'" class=" admlnk pdxobj'.$tid['tid'].' pdxot">'.$tid['name'].'</a></div>';
    

            $amore2=array();
            $countmore=0;
            $tids2=db_query('select d.name, d.tid from {taxonomy_term_data} as d where d.vid=2 order by d.weight asc');
            while( $tid2=$tids2->fetchAssoc() ){
        
                if( ++$countmore>3 ){
                    $amore2[]='<div class="submnu3 submnu3hide"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$tid['tid'].'/?taxonomy_catalog='.$tid2['tid'].'">'.$tid2['name'].'</a></div>';
                }else{
                    $amore2[]='<div class="submnu3"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$tid['tid'].'?taxonomy_catalog='.$tid2['tid'].'">'.$tid2['name'].'</a></div>';
                }
            }
            if( isset($amore2) and is_array($amore2) and count($amore2) ){
                $source_content.= '<div class="submnu_cnt submnu_cnt_tags predmet_items">';
                $source_content.= implode('', $amore2);
                if( $countmore>3 ){
                    $source_content.= '<div class="submnu3 submnu3expand"><a href="javascript: void(0);" onclick=" jQuery(this).parent().parent().find(\'.submnu3hide\').show(); jQuery(this).hide(); ">Раскрыть весь список</a></div>';
                }
                    $source_content.= '</div>';
            }

            $source_content.= '</div>';
        
    }
    $source_content.= '<div class="clear">&nbsp;</div></div>';
    $source_content.= '</div>';


    return $source_content;
}
function pdxseparate_page_build(&$page) {
    global $user;
    drupal_add_js(' var searchLess = "Введите более 3 символов"; var curInNal="Это примерная цена по сегодняшнему курсу НБ. Точная цена: %curprice %cursign. Курс НБ на сегодня: %curs"; ', array('type' => 'inline', 'scope' => 'footer', 'weight' => 5) );
    if( $user->uid ){
        drupal_add_js(' var admDelMat="Удалить объявление"; var admEditNode="Редактировать объявление"; ', array('type' => 'inline', 'scope' => 'footer', 'weight' => 5) );
    }
}
function pdxseparate_denomin($source_content = NULL){
    $source_content= '';
    
    global $user;
    if(isset($user->roles[3]) or isset($user->roles[4])){
    }else{
        return '';
    }
    
    if( isset( $_GET['go'] ) ){

        $counter=0;

        //int
        $outs=db_query('select field_price_hour_value, entity_id, entity_type from {field_data_field_price_hour} where field_price_hour_value>3450');
        while( $out=$outs->fetchAssoc() ){
            $price=round($out['field_price_hour_value']/10000, 2);

            db_query('update {field_data_field_price_hour} set field_price_hour_value=:combo where entity_type=\''.$out['entity_type'].'\' and entity_id='.$out['entity_id'], array(':combo'=>$price));
            $counter++;
        }
        $outs=db_query('select field_price_day_value, entity_id, entity_type from {field_data_field_price_day} where field_price_day_value>3450');
        while( $out=$outs->fetchAssoc() ){
            $price=round($out['field_price_day_value']/10000, 2);

            db_query('update {field_data_field_price_day} set field_price_day_value=:combo where entity_type=\''.$out['entity_type'].'\' and entity_id='.$out['entity_id'], array(':combo'=>$price));
            $counter++;
        }
        $outs=db_query('select field_price_week_value, entity_id, entity_type from {field_data_field_price_week} where field_price_week_value>3450');
        while( $out=$outs->fetchAssoc() ){
            $price=round($out['field_price_week_value']/10000, 2);

            db_query('update {field_data_field_price_week} set field_price_week_value=:combo where entity_type=\''.$out['entity_type'].'\' and entity_id='.$out['entity_id'], array(':combo'=>$price));
            $counter++;
        }
        $outs=db_query('select field_price_month_value, entity_id, entity_type from {field_data_field_price_month} where field_price_month_value>3450');
        while( $out=$outs->fetchAssoc() ){
            $price=round($out['field_price_month_value']/10000, 2);

            db_query('update {field_data_field_price_month} set field_price_month_value=:combo where entity_type=\''.$out['entity_type'].'\' and entity_id='.$out['entity_id'], array(':combo'=>$price));
            $counter++;
        }
        $outs=db_query('select field_delivery1_price_value, entity_id, entity_type from {field_data_field_delivery1_price} where field_delivery1_price_value>3450');
        while( $out=$outs->fetchAssoc() ){
            $price=round($out['field_delivery1_price_value']/10000, 2);

            db_query('update {field_data_field_delivery1_price} set field_delivery1_price_value=:combo where entity_type=\''.$out['entity_type'].'\' and entity_id='.$out['entity_id'], array(':combo'=>$price));
            $counter++;
        }
        $outs=db_query('select field_rent_price_value, entity_id, entity_type from {field_data_field_rent_price} where field_rent_price_value>3450');
        while( $out=$outs->fetchAssoc() ){
            $price=round($out['field_rent_price_value']/10000, 2);

            db_query('update {field_data_field_rent_price} set field_rent_price_value=:combo where entity_type=\''.$out['entity_type'].'\' and entity_id='.$out['entity_id'], array(':combo'=>$price));
            $counter++;
        }
        $outs=db_query('select field_price_crashed_value, entity_id, entity_type from {field_data_field_price_crashed} where field_price_crashed_value>3450');
        while( $out=$outs->fetchAssoc() ){
            $price=round($out['field_price_crashed_value']/10000, 2);

            db_query('update {field_data_field_price_crashed} set field_price_crashed_value=:combo where entity_type=\''.$out['entity_type'].'\' and entity_id='.$out['entity_id'], array(':combo'=>$price));
            $counter++;
        }



        $source_content.= 'Выполнено для объектов: '.$counter;

    }else{
        $source_content.= 'please GO! ;-)';
    }
    
    return $source_content;
}
function pdxseparate_p_clearcaches($source_content = NULL){
    $source_content= '';

$source_content.='<div style="float: left; width: 233px;">
<h3>Очистка кеша</h3>
<ul>
<li><a target="_blank" href="/clearproductitem.php?type=100">Кеш анонимных пользователей</a></li>
<li><a target="_blank" href="/clearproductitem.php?type=99">Карточки объявлений</a></li>
<li><a target="_blank" href="/clearproductitem.php?type=98">Пользователи</a></li>
<li><a target="_blank" href="/clearproductitem.php?type=101">только базовые страницы</a></li>
<li><a target="_blank" href="/clearproductitem.php?type=102">только каталог</a></li>
<li><a target="_blank" href="/clearproductitem.php?type=103">только товары</a></li>
</ul>
<div>&nbsp;</div>
<ul>
<li><a href="?update=1">Обновить блоки пользователей</a></li>
<li><a href="?update=4">Обновить html с картинками пользователей</a></li>
<li><a href="?update=2">Обновить карты пользователей</a></li>
<li><a href="?update=3">Обновить справочную систему</a></li>
<li><a href="?update=5">Обновить needto.me</a></li>
<li><a href="?update=6">Обновить share node</a></li>
<li><a href="?update=7">Обновить share html с картинками пользователей</a></li>
<li><a href="?update=8">Новые и рекомендуемые товары</a></li>
</ul>
';

if( isset( $_GET['update'] ) and is_numeric($_GET['update']) ){
    switch($_GET['update']){
    case 1: //Обновить блоки пользователей
        $nums=db_query('select uid from {users} where uid>0');
        while( $num=$nums->fetchAssoc() ){
            if( isset($num['uid']) and is_numeric($num['uid']) ){
                htmlUserProf($num['uid']);
            }
        }
        $source_content.= '<strong>users block update ok</strong>';
        break;
    case 2: //Карты пользователей
        $nums=db_query('select uid from {users} where uid>0');
        while( $num=$nums->fetchAssoc() ){
            if( isset($num['uid']) and is_numeric($num['uid']) ){
                htmlUserMap(user_load($num['uid']));
            }
        }
        $source_content.= '<strong>maps update ok</strong>';
        break;
    case 3: //справочная система
        if( function_exists('pdxgenhelp') ){
            pdxgenhelp();
        }
        $source_content.= '<strong>help update ok</strong>';
        break;
    case 4: //картинки пользователей
        $nums=db_query('select uid from {users} where uid>0');
        while( $num=$nums->fetchAssoc() ){
            if( isset($num['uid']) and is_numeric($num['uid']) ){
                updateuseritemimgs($num['uid']);
            }
        }
        $source_content.= '<strong>images update ok</strong>';
        break;
    case 7: //share картинки пользователей
        $nums=db_query('select uid from {users} where uid>0');
        while( $num=$nums->fetchAssoc() ){
            if( isset($num['uid']) and is_numeric($num['uid']) ){
                updateuseritemimgshare($num['uid']);
            }
        }
        $source_content.= '<strong>share images update ok</strong>';
        break;
    case 5: //needto.me
        if( function_exists('pdxgenfront') ){
            pdxgenfront();
        }
        $source_content.= '<strong>front update ok</strong>';
        break;
    case 6: //share node
        if( function_exists('pdxshareme') ){
            $nums=db_query('select n.nid from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
            while( $num=$nums->fetchAssoc() ){
                pdxshareme(node_load($num['nid']));
            }
        }
        $source_content.= '<strong>share me update ok</strong>';
        break;
    case 8: //new and rec
        setlastnew();
        setrecall();
        break;
    }
}

$source_content.='</div>
<div style="margin-left: 311px;">
<h3>Админ-страницы</h3>
<ul>';

if( function_exists('pdxseparate_getmnumass') ){
    $list=pdxseparate_getmnumass();
    if( isset($list) and is_array($list) and count($list) ){
        foreach( $list as $path => $title ){
            $source_content.='<li><a target="_blank" href="/'.$path.'">'.$title.'</a></li>';
        }
    }
}

$source_content.='</ul></div><div class="clear">&nbsp;</div>

<iframe width="100%" height="537" src="http://localhost/html/'.PDX_CITY_ID.'/share/node/2866.htm" frameborder="0"></iframe>

';

    return $source_content;
}
function pdxseparate_viewed($source_content = NULL){
    $source_content= '<section id="block_viewed_items" class="block"></section>';
    return $source_content;
}
function pdxseparate_rec($source_content = NULL){
    $source_content= '<section id="block_recall_items" class="block"></section>';
    return $source_content;
}
function pdxseparate_fav($source_content = NULL){
    global $user;
    if( $user->uid ){
        $source_content= '<section id="block_favall_items" class="block"></section>';
    }else{
        $source_content= '<div>Для работы с Избранным необходимо авторизироваться.</div>';
        $source_content.='</div><div id="ulogin3" x-ulogin-params="display=small&fields=first_name,last_name,email,photo&optional=&providers=vkontakte,facebook,youtube,mailru,twitter,google,yandex,odnoklassniki,livejournal&redirect_uri='.urlencode($GLOBALS['base_url'].'/ulogin?destination='.implode('/', arg())).'"></div></div>';
    }
    return $source_content;
}
function pdxseparate_fav_user($source_content = NULL){
    global $user;
    if( $user->uid ){
        $source_content= '<section id="block_favuserall_items" class="block"></section>';
    }else{
        $source_content= '<div>Для работы с Избранным необходимо авторизироваться.</div>';
        $source_content.='</div><div id="ulogin3" x-ulogin-params="display=small&fields=first_name,last_name,email,photo&optional=&providers=vkontakte,facebook,youtube,mailru,twitter,google,yandex,odnoklassniki,livejournal&redirect_uri='.urlencode($GLOBALS['base_url'].'/ulogin?destination='.implode('/', arg())).'"></div></div>';
    }
    return $source_content;
}
function pdxseparate_form_alter(&$form, &$form_state, $form_id){
    global $user;
    switch($form_id){
    case 'taxonomy_form_term':
/*            
        if( PDX_CITY_ID!=28 and arg(0)=='admin' and is_string(arg(4)) and arg(4)=='add' ){
            $form=array();
            $form['#prefix']='Добавлять термины можно только на родительском сайте!';
        }
*/
        break;
    case 'views_exposed_form':
        switch(arg(0)){
        case 'brands':
            if( isset($form['name']) ){
                $form['name']['#attributes']['placeholder']='Введите начало названия бренда';
            }
            break;
        case 'user':
        case 'admin':
            if( isset($form['title']) ){
                $form['title']['#attributes']['placeholder']='Введите часть названия';
            }
            break;
        }
        break;
    case 'uc_cart_checkout_form':
        global $user; if( $user->uid ){ 
            $out = db_query('select field_phones_value from {field_data_field_phones} where entity_type=\'user\' and delta=0 and entity_id='.$user->uid);
            $out = $out->fetchAssoc();
            if( isset($out['field_phones_value']) and strlen($out['field_phones_value']) ){
                $form['panes']['billing']['address']['#default_value']->delivery_phone=$out['field_phones_value'];
                $form['panes']['billing']['address']['#default_value']->billing_phone=$out['field_phones_value'];
            }

            $out = db_query('select field_name_value from {field_data_field_name} where entity_type=\'user\' and delta=0 and entity_id='.$user->uid);
            $out = $out->fetchAssoc();
            if( isset($out['field_name_value']) and strlen($out['field_name_value']) ){
                $form['panes']['billing']['address']['#default_value']->delivery_first_name=$out['field_name_value'];
                $form['panes']['billing']['address']['#default_value']->billing_first_name=$out['field_name_value'];
            }
        }

            
        $form['panes']['payment']['#description']='';

//        if( isset($form['panes']['payment']['payment_method']['#options']['cod']) and strlen($form['panes']['payment']['payment_method']['#options']['cod']) ){
//        }
            if( isset($form['panes']['payment']) and is_array($form['panes']['payment']) and count($form['panes']['payment']) ){
                $form['panes']['payment']['details']['#prefix']='<div style="display: none;">'; 
                $form['panes']['payment']['details']['#suffix']='</div>'; 
            }
            if( isset($form['panes']['billing']) and is_array($form['panes']['billing']) and count($form['panes']['billing']) ){
                $form['panes']['billing']['#title']='';
                $form['panes']['billing']['#description']='';
                $form['panes']['billing']['select_address']['#prefix']='<div style="display: none;">';
                $form['panes']['billing']['select_address']['#suffix']='</div>';
            }
            if( isset($form['panes']['quotes']) and is_array($form['panes']['quotes']) and count($form['panes']['quotes']) ){
                $form['panes']['quotes']['#description']='';
                $form['panes']['quotes']['quote_button']['#prefix']='<div style="display: none;">';
                $form['panes']['quotes']['quote_button']['#suffix']='</div>';
            }
            if( isset($form['panes']['comments']) and is_array($form['panes']['comments']) and count($form['panes']['comments']) ){ 
//                $form['panes']['comments']['#title']='';
                $form['panes']['comments']['#description']='';
            }

            $form['actions']['cancel']['#prefix']='<div style="display: none;">';
            $form['actions']['cancel']['#suffix']='</div>';

            if( defined('PDX_CITY_MASK') ){
                $form['actions']['cancel']['#suffix'].=' <div style="display: none;" class="maskisme">'.PDX_CITY_MASK.'</div> ';
            }

            $form['actions']['continue']['#value']='Оформить заказ';
            
            break;
    case 'user_profile_form':
    
        if( isset($form['field_cur']['und']['#options'][1]) and strlen($form['field_cur']['und']['#options'][1]) and defined('PDX_CITY_CUR') ){
            $form['field_cur']['und']['#options'][1]=PDX_CITY_CUR;
        }
    
        if( isset($form['field_apply1']['und']['#title']) ){
            $form['field_apply1']['und']['#title']=str_replace('прочитал(а)','<a target="_blank" href="http://needto.me/rules.html">прочитал(а)</a>',$form['field_apply1']['und']['#title']);
        }

        if( isset($form['field_apply1']['und']['#default_value']) and is_numeric($form['field_apply1']['und']['#default_value']) and $form['field_apply1']['und']['#default_value']==1 ){
            $form['field_apply1']['und']['#prefix']='<div style="display: none;">';
            $form['field_apply1']['und']['#suffix']='</div>';
        }
        if( isset($form['field_apply2']['und']['#default_value']) and is_numeric($form['field_apply2']['und']['#default_value']) and $form['field_apply2']['und']['#default_value']==1 ){
            $form['field_apply2']['und']['#prefix']='<div style="display: none;">';
            $form['field_apply2']['und']['#suffix']='</div>';
        }

//        if( defined('PDX_CITY_ID') and PDX_CITY_ID>0 and !isset($form['field_city']['und']['#default_value'][0]) ){
//            $form['field_city']['und']['#default_value'][0]=PDX_CITY_ID;
//        }

        if( defined(PDX_CITY_CUR) ){
            $fieldis='field_delivery1_price';
            if( isset($form[$fieldis]['und']) ){
                if( !isset($form[$fieldis]['und']['#suffix']) ){
                    $form[$fieldis]['und']['#suffix']='';
                }
//                $form[$fieldis]['und']['#suffix']=' <span class="cursign">'.PDX_CITY_CUR.'</span>'.$form[$fieldis]['und']['#suffix'];
            }
        }
        
        if( isset($form['field_rn']['und']['#options']) and is_array($form['field_rn']['und']['#options']) and count($form['field_rn']['und']['#options']) ){
            foreach( $form['field_rn']['und']['#options'] as $id => $obj ){
                $form['field_rn']['und']['#options'][$id]=str_replace(' район', '', $obj);
            }
        }

        
        if( isset($user->roles[3]) or isset($user->roles[4])){  }else{
//            $form['field_city']['und']['#prefix']='<div style="display: none;">';
//            $form['field_city']['und']['#suffix']='</div>';
            $form['field_userrat']['und']['#prefix']='<div style="display: none;">';
            $form['field_userrat']['und']['#suffix']='</div>';
            $form['field_userrat2']['und']['#prefix']='<div style="display: none;">';
            $form['field_userrat2']['und']['#suffix']='</div>';
            $form['field_items_active']['und']['#prefix']='<div style="display: none;">';
            $form['field_items_active']['und']['#suffix']='</div>';
            $form['field_items_prokat']['und']['#prefix']='<div style="display: none;">';
            $form['field_items_prokat']['und']['#suffix']='</div>';
            $form['field_longitude']['und']['#prefix']='<div style="display: none;">';
            $form['field_longitude']['und']['#suffix']='</div>';
            $form['field_latitude']['und']['#prefix']='<div style="display: none;">';
            $form['field_latitude']['und']['#suffix']='</div>';


            unset($form['field_bonus_vk_enter']['und']);
            unset($form['field_bonus_fb_enter']['und']);
            unset($form['field_bonus_site']['und'][0]);
            unset($form['field_gold']['und'][0]);
            unset($form['field_merit']['und']);
            unset($form['field_parts']['und']);
            unset($form['field_bdaynum']['und'][0]);
            }
        
        break;
    case 'user_register_form':
    
        if( !isset($form['#prefix']) ){
            $form['#prefix']='';
        }
        if( !isset($form['#suffix']) ){
            $form['#suffix']='';
        }
        $form['#prefix'].='<div class="register_right usermore"><div class="ttl">Добро пожаловать в семью единомышленников</div><div>Регистрация на сайте предоставит вам следующие преимущества по сравнению с анонимным доступом к ресурсу:</div><div><ul><li>возможность сдавать свои вещи в аренду;</li><li>возможность официально оформлять сделки на нашем сайте;</li><li>возможность общаться с арендодателями посредством личных сообщений;</li><li>различные подарки и поощрения от нашей команды.</li></ul></div><div>Присоединяйтесь!</div></div><div class="register_left"><div class="register_left2">';
        $form['#suffix'].='</div></div><div class="clear">&nbsp;</div>';
        
        unset($form['field_phones']['und']);
        unset($form['field_apply1']['und']);
/*
        if( defined('PDX_CITY_MASK') ){
            $form['field_phones']['und'][0]['value']['#attributes'] = array('placeholder' => str_replace('9','_',PDX_CITY_MASK));
            $form['field_phones']['und'][1]['value']['#attributes'] = array('placeholder' => str_replace('9','_',PDX_CITY_MASK));
            $form['field_phones']['und'][2]['value']['#attributes'] = array('placeholder' => str_replace('9','_',PDX_CITY_MASK));
            $form['field_phones']['und']['#suffix']=' <script type="text/javascript"> 
            jQuery(document).ready(function($){  
                jQuery(\'.form-item-field-phones-und-0-value .form-text, .form-item-field-phones-und-1-value .form-text, .form-item-field-phones-und-2-value .form-text\').mask(\''.PDX_CITY_MASK.'\',{placeholder:\''.str_replace('9','_',PDX_CITY_MASK).'\'});
            });
             </script> ';
        }
*/
        if( isset($form['field_apply1']['und']['#title']) ){
            $form['field_apply1']['und']['#title']=str_replace('прочитал(а)','<a target="_blank" href="http://needto.me/rules.html">прочитал(а)</a>',$form['field_apply1']['und']['#title']);
        }
        if( isset($form['field_apply3']['und']['#title']) ){
            $form['field_apply3']['und']['#title']=str_replace('сбор и использование','<a target="_blank" href="http://needto.me/apply.html">сбор и использование</a>',$form['field_apply3']['und']['#title']);
        }
        
        
        
//        if( defined('PDX_CITY_ID') and PDX_CITY_ID>0 ){
//            $form['field_city']['und']['#default_value'][0]=PDX_CITY_ID;
//        }
//        $form['field_city']['und']['#prefix']='<div style="display: none;">';
//        $form['field_city']['und']['#suffix']='</div>';
        break;
    case 'arch_node_form':
//        if( defined('PDX_CITY_ID') and PDX_CITY_ID>0 ){
//            $form['field_city']['und']['#default_value'][0]=PDX_CITY_ID;
//        }
//        $form['field_city']['und']['#prefix']='<div style="display: none;">';
//        $form['field_city']['und']['#suffix']='</div>';
        break;
    case 'findmy_node_form':
//        if( defined('PDX_CITY_ID') and PDX_CITY_ID>0 and !isset($form['field_city']['und']['#default_value'][0]) ){
//            $form['field_city']['und']['#default_value'][0]=PDX_CITY_ID;
//        }
//        $form['field_city']['und']['#prefix']='<div style="display: none;">';
//        $form['field_city']['und']['#suffix']='</div>';
        
        if( isset( $_REQUEST['tid'] ) and is_numeric( $_REQUEST['tid'] ) and $_REQUEST['tid']>0 and isset($form['field_part']['und']['#options'][$_REQUEST['tid']]) ){
            $form['field_part']['und']['#default_value']=$_REQUEST['tid'];
        }
        
        $form['actions']['submit']['#value']='Подать заявку';
        
        if( arg(0)=='node' and is_numeric(arg(1)) and is_string(arg(2)) and arg(2)=='edit' ){}else{
            if( $user->uid ){
                $us1=prepuser($user->uid, 0);
                
                if( isset($us1->field_name['und'][0]['value']) and strlen($us1->field_name['und'][0]['value']) ){
                    $form['field_name']['und'][0]['value']['#default_value']=$us1->field_name['und'][0]['value'];
                }
                if( isset($us1->field_phones['und'][0]['value']) and strlen($us1->field_phones['und'][0]['value']) ){
                    $form['field_phones']['und'][0]['value']['#default_value']=$us1->field_phones['und'][0]['value'];
                    if( isset($us1->field_phones['und'][1]['value']) and strlen($us1->field_phones['und'][1]['value']) ){
                        $form['field_phones']['und'][1]['value']['#default_value']=$us1->field_phones['und'][1]['value'];
                        if( isset($us1->field_phones['und'][2]['value']) and strlen($us1->field_phones['und'][2]['value']) ){
                            $form['field_phones']['und'][2]['value']['#default_value']=$us1->field_phones['und'][2]['value'];
                        }
                    }
                }
                if( isset($us1->field_skype['und'][0]['value']) and strlen($us1->field_skype['und'][0]['value']) ){
                    $form['field_skype']['und'][0]['value']['#default_value']=$us1->field_skype['und'][0]['value'];
                }
                if( isset($us1->mail) and strlen($us1->mail) ){
                    $form['field_email']['und'][0]['email']['#default_value']=$us1->mail;
                }
            }
        }
        break;
    case 'item_node_form':
        $form['actions']['submit']['#submit'][] = 'pdxseparate_nomessage_form_submit';    

        if( isset($form['field_image']['und']['#file_upload_title']) and strlen( $form['field_image']['und']['#file_upload_title'] ) ){
            $form['field_image']['und']['#file_upload_title']='Добавить новое изображение:';
        }

        $ispart=0;
        if( isset($_GET['part']) and is_numeric($_GET['part']) ){
            $ispart=$_GET['part'];
        }elseif( isset($form['taxonomy_catalog']['und']['#default_value']) and is_numeric($form['taxonomy_catalog']['und']['#default_value']) ){
            $ispart=$form['taxonomy_catalog']['und']['#default_value'];
        }elseif( isset($_GET['clone']) and is_numeric($_GET['clone']) ){
            $ispart=db_query('select taxonomy_catalog_tid from {field_data_taxonomy_catalog} where entity_type=\'node\' and entity_id='.$_GET['clone'].' limit 0,1');
            $ispart=$ispart->fetchAssoc();
            if( isset($ispart['taxonomy_catalog_tid']) and is_numeric($ispart['taxonomy_catalog_tid']) ){
                $ispart=$ispart['taxonomy_catalog_tid'];
            }else{
                $ispart=0;
            }
        }
        
        if( isset($user->roles[3]) or isset($user->roles[4])){ 
            
            if(arg(0)=='node' and is_numeric(arg(1)) and is_string(arg(2)) and arg(2)=='edit'  and isset($form['field_subpart']['und']['#default_value']) and is_numeric($form['field_subpart']['und']['#default_value']) ){
                $deladdon=1; //цвет
                switch($form['field_subpart']['und']['#default_value']){
                case 2248:
                case 2704:
                case 998:
                case 68:
                case 108:
                case 107:
                    $deladdon=0;
                    break;
                }
                if($deladdon){
                    unset($form['field_addon1']['und']);
                }

                $deladdon=1; //размер
                switch($form['field_subpart']['und']['#default_value']){
                case 2248:
                case 2704:
                case 998:
                case 108:
                case 107:
                    $deladdon=0;
                    break;
                }
                if($deladdon){
                    unset($form['field_addon2']['und']);
                }


                $deladdon=1; //возраст
                switch($form['field_subpart']['und']['#default_value']){
                case 67:
                case 69:
                case 68:
                case 80:
                    $deladdon=0;
                    break;
                }
                if($deladdon){
                    unset($form['field_addon3']['und']);
                }
            }else{
                unset($form['field_addon1']['und']);
                unset($form['field_addon2']['und']);
                unset($form['field_addon3']['und']);
            }
            
        }else{

            unset($form['field_addon1']['und']);
            unset($form['field_addon2']['und']);
            unset($form['field_addon3']['und']);
            unset($form['field_premium']['und'][0]);
            unset($form['field_moderate']['und']);
            unset($form['field_block']['und']);
            if( isset( $ispart ) and is_numeric($ispart) and isset($form['field_subpart']['und']['#options']) ){
                if( isset($form['field_subpart']['und']['#options']) and is_array($form['field_subpart']['und']['#options']) and count($form['field_subpart']['und']['#options']) ){
                    $atids=array();
                    $tids=db_query('select entity_id from {field_data_field_part} where entity_type=\'taxonomy_term\' and bundle=\'subpart\' and field_part_tid='.$ispart);
                    while( $tid=$tids->fetchAssoc() ){
                        $atids[]=$tid['entity_id'];
                    }
                    foreach( $form['field_subpart']['und']['#options'] as $td=>$pname ){
                        if( is_numeric($td) and array_search($td, $atids)===false ){
//                            unset( $form['field_subpart']['und']['#options'][$td] );
                        }
                    }
                }
            }
            unset($form['field_moderate_reason']['und'][0]);

            $form['field_rn']['und']['#prefix']='<div style="display: none;">';
            $form['field_rn']['und']['#suffix']='</div>';
            $form['field_who']['und']['#prefix']='<div style="display: none;">';
            $form['field_who']['und']['#suffix']='</div>';

        }
        
        if( !isset($form['#prefix']) ){
            $form['#prefix']='';
        }
        
        $iscnt=0;
        if( arg(0)=='node' and is_numeric(arg(1)) and is_string(arg(2)) ){
            if( isset($user->roles[3]) or isset($user->roles[4])){
                if( isset($form['uid']['#value']) and $form['uid']['#value']!=$user->uid ){
                    $iscnt=1;
                }
            }
        }
        
        if( $iscnt ){
            unset($form['field_delete']['und']);
            unset($form['field_state']['und']);
            unset($form['field_price_hour']['und']);
            unset($form['field_price_day']['und']);
            unset($form['field_price_week']['und']);
            unset($form['field_price_month']['und']);
            unset($form['field_price_min']['und']);
            unset($form['field_delivery1']['und']);
            unset($form['field_delivery2']['und']);
            unset($form['field_delivery1_price']['und']);
            unset($form['field_delivery3']['und']);
            unset($form['field_rent_apply1']['und']);
            unset($form['field_rent_apply4']['und']);
            unset($form['field_rent_apply3']['und']);
            unset($form['field_rent_apply2']['und']);
            unset($form['field_rent_apply7']['und']);
            unset($form['field_rent_price']['und']);
            unset($form['field_rent_apply5']['und']);
            unset($form['field_onlycompany']['und']);
            unset($form['field_price_crashed']['und']);
            unset($form['field_tobuy']['und']);
            unset($form['field_instruction']['und']);
            unset($form['field_status']['und']);
            unset($form['field_cur']['und']);
//            unset($form['field_datend']['und']);
        }else{
            $form['#prefix'].='<div class="itemalert"><p><strong>Запрещено сдавать в аренду:</strong></p><ul><li>холодное и любое другое оружие;</li><li>любые предметы, используемые в целях наркомании;</li><li>любые предметы интимного характера;</li><li>украденные предметы;</li><li>любые другие предметы, законодательно запрещенные к обороту.</li></ul></div>';
            if( arg(0)=='node' and is_numeric(arg(1)) and is_string(arg(2)) and arg(2)=='edit' ){
                $form['#prefix'].='<div class="node_prim">Любые изменения в полях, выделенных знаком <img alt="" class="lazy" data-original="'.PDX_IMGPATH.'/img/moderate.png" />, приводят к отправке объявления на модерацию!</div>';
            }
        }
        
        if( isset($form['field_block']['und']['#default_value']) and is_numeric($form['field_block']['und']['#default_value']) and $form['field_block']['und']['#default_value']==1 ){
            $form['#prefix'].='<div class="wrnblock">Данное объявление заблокировано модератором.';
            if( isset( $form['field_moderate_reason']['und'][0]['value']['#default_value'] ) and strlen( $form['field_moderate_reason']['und'][0]['value']['#default_value'] ) ){
                $form['#prefix'].=' <strong>Причина:</strong>';
                $form['#prefix'].='<div>'. 	
check_markup($form['field_moderate_reason']['und'][0]['value']['#default_value'], 'limited').'</div>';
            }
            $form['#prefix'].='</div>';
        }
        
        if( is_string(arg(1)) and arg(1)=='add' ){
            $form['field_status']['und']['#prefix']='<div style="display: none;">';
            $form['field_status']['und']['#suffix']='</div>';
        }

        if( isset($form['field_cur']['und']['#options'][1]) and strlen($form['field_cur']['und']['#options'][1]) and defined('PDX_CITY_CUR') ){
            $form['field_cur']['und']['#options'][1]=PDX_CITY_CUR;
        }
        
        if($user->uid and arg(0)=='node' and is_string(arg(1)) and arg(1)=='add' and !isset( $_GET['clone'] ) ){
            $us1=prepuser($user->uid);
            
            if( isset($us1->field_rent_apply1['und'][0]['value']) and $us1->field_rent_apply1['und'][0]['value']==1 ){
                $form['field_rent_apply1']['und']['#default_value']=1;
            }
            if( isset($us1->field_rent_apply7['und'][0]['value']) and $us1->field_rent_apply7['und'][0]['value']==1 ){
                $form['field_rent_apply7']['und']['#default_value']=1;
            }
            if( isset($us1->field_rent_apply6['und'][0]['value']) and strlen($us1->field_rent_apply6['und'][0]['value']) ){
                $form['field_rent_apply6']['und'][0]['value']['#default_value']=$us1->field_rent_apply6['und'][0]['value'];
            }
            if( isset($us1->field_rent_apply3['und'][0]['value']) and $us1->field_rent_apply3['und'][0]['value']==1 ){
                $form['field_rent_apply3']['und']['#default_value']=1;
            }
            if( isset($us1->field_delivery1['und'][0]['value']) and $us1->field_delivery1['und'][0]['value']==1 ){
                $form['field_delivery1']['und']['#default_value']=1;
            }
            if( isset($us1->field_delivery2['und'][0]['value']) and $us1->field_delivery2['und'][0]['value']==1 ){
                $form['field_delivery2']['und']['#default_value']=1;
            }
            if( isset($us1->field_delivery3['und'][0]['value']) and $us1->field_delivery3['und'][0]['value']==1 ){
                $form['field_delivery3']['und']['#default_value']=1;
            }
            if( isset($us1->field_delivery1_price['und'][0]['value']) and is_numeric($us1->field_delivery1_price['und'][0]['value']) ){
                $form['field_delivery1_price']['und'][0]['value']['#default_value']=$us1->field_delivery1_price['und'][0]['value'];
            }
            if( isset($us1->field_time['und'][0]['value']) and strlen($us1->field_time['und'][0]['value']) ){
                $form['field_time']['und'][0]['value']['#default_value']=$us1->field_time['und'][0]['value'];
            }
            if( isset($us1->field_cur['und'][0]['value']) and is_numeric($us1->field_cur['und'][0]['value']) ){
                $form['field_cur']['und']['#default_value']=$us1->field_cur['und'][0]['value'];
            }
        }
        
//        if( defined('PDX_CITY_ID') and PDX_CITY_ID>0 ){
//            $form['field_city']['und']['#default_value'][0]=PDX_CITY_ID;
//        }
//        $form['field_city']['und']['#prefix']='<div style="display: none;">';
//        $form['field_city']['und']['#suffix']='</div>';


        
        if( isset($_GET['subpart']) and is_numeric($_GET['subpart']) and isset($form['field_celebration']['und']) ){
            switch($_GET['subpart']){
            case 871: //автобусы
                $form['field_celebration']['und']['#default_value'][2166]=2166; //корпоратив
                $form['field_celebration']['und']['#default_value'][1955]=1955; //свадьба
                break;
            case 148: //все для праздника
                $form['field_celebration']['und']['#default_value'][1953]=1953; //день рождения
                break;
            case 107: //для свадьбы
                $form['field_celebration']['und']['#default_value'][1955]=1955; //свадьба
                break;
            case 873: //лимузины
            case 110: //для вечеринок и шоу
                $form['field_celebration']['und']['#default_value'][1953]=1953; //день рождения
                $form['field_celebration']['und']['#default_value'][1955]=1955; //свадьба
                break;
            case 111: //настольные игры
                $form['field_celebration']['und']['#default_value'][2166]=2166; //корпоратив
                $form['field_celebration']['und']['#default_value'][1954]=1954; //новый год
                break;
            case 112: //игровые приставки
                $form['field_celebration']['und']['#default_value'][2166]=2166; //корпоратив
                $form['field_celebration']['und']['#default_value'][1953]=1953; //день рождения
                break;
            }
        }

        if(isset($user->roles[3]) or isset($user->roles[4])){  }else{
            if( isset($form['field_brand']['und']) ){
                unset($form['field_brand']['und']);
            }
        }
        
        if( is_string(arg(2)) and arg(2)=='edit' and (isset($user->roles[3]) or isset($user->roles[4])) ){  }else{
            if( isset($ispart) and is_numeric($ispart) and isset($form['taxonomy_catalog']['und']['#options'][$ispart]) ){
                switch($ispart){
                case 4:
                case 23:
                case 5:
                    if( isset($form['field_brand']['und']) ){
                        unset($form['field_brand']['und']);
                    }
                    break;
                }
                
                $form['taxonomy_catalog']['und']['#default_value']=$ispart;
                
                if(isset($user->roles[3]) or isset($user->roles[4])){  }else{
                    $form['taxonomy_catalog']['und']['#prefix']='<div style="display: none;">';
                    $form['taxonomy_catalog']['und']['#suffix']='</div>';
                }

                
                if( isset($form['field_subpart']) ){
                    
                    if( isset($form['field_subpart']['und']['#options']) and is_array($form['field_subpart']['und']['#options']) and count($form['field_subpart']['und']['#options']) ){
                        $atids=array();
                        $tids=db_query('select entity_id from {field_data_field_part} where entity_type=\'taxonomy_term\' and field_part_tid='.$ispart);
                        while( $tid=$tids->fetchAssoc() ){
                            $atids[]=$tid['entity_id'];
                        }
                        if( isset($atids) and is_array($atids) and count($atids) ){
                            foreach( $form['field_subpart']['und']['#options'] as $td => $nm ){
                                if( is_numeric($td) and array_search($td, $atids)===false ){
                                    unset( $form['field_subpart']['und']['#options'][$td] );
                                }
                            }
                        }else{
                            if( isset($form['field_subpart']['und']) ){
                                unset($form['field_subpart']['und']);
                            }
                        }
                    }
                    
                }
                if( isset($_GET['subpart']) and is_numeric($_GET['subpart']) and isset($form['field_subpart']['und']['#options'][$_GET['subpart']]) ){
                    $form['field_subpart']['und']['#default_value']=$_GET['subpart'];
                    if( isset($_GET['tag']) and is_numeric($_GET['tag']) and isset($form['field_tags']['und']['#options'][$_GET['tag']]) ){
                        $form['field_tags']['und']['#default_value']=$_GET['tag'];
                    }
                }


                if( isset($form['field_tags']) ){
                    
                    if( isset($form['field_tags']['und']['#options']) and is_array($form['field_tags']['und']['#options']) and count($form['field_tags']['und']['#options']) ){
                        $atids=array();
                        $tids=db_query('select entity_id from {field_data_field_part} where entity_type=\'taxonomy_term\' and field_part_tid='.$ispart);
                        while( $tid=$tids->fetchAssoc() ){
                            $atids[]=$tid['entity_id'];
                        }
                        if( isset($atids) and is_array($atids) and count($atids) ){
                            foreach( $form['field_tags']['und']['#options'] as $td => $nm ){
                                if( is_numeric($td) and array_search($td, $atids)===false ){
                                    unset( $form['field_tags']['und']['#options'][$td] );
                                }
                            }
                        }else{
//                            if( isset($form['field_tags']) ){
//                                unset($form['field_tags']);
//                            }
                        }





                    }
                    
                }    
    
            }else{
                $form['field_subpart']['und']['#prefix']='<div style="display: none;">';
                $form['field_subpart']['und']['#suffix']='</div>';
//                if( isset($form['field_subpart']) ){
//                    unset($form['field_subpart']);
//                }
            }
        }


        if( defined('PDX_CITY_CUR') ){
            $fieldis='field_price_hour';
            if( isset($form[$fieldis]['und']) ){
                if( !isset($form[$fieldis]['und']['#suffix']) ){
                    $form[$fieldis]['und']['#suffix']='';
                }
//                $form[$fieldis]['und']['#suffix']=' <span class="cursign">'.PDX_CITY_CUR.'</span>'.$form[$fieldis]['und']['#suffix'];
            }
            $fieldis='field_price_day';
            if( isset($form[$fieldis]['und']) ){
                if( !isset($form[$fieldis]['und']['#suffix']) ){
                    $form[$fieldis]['und']['#suffix']='';
                }
//                $form[$fieldis]['und']['#suffix']=' <span class="cursign">'.PDX_CITY_CUR.'</span>'.$form[$fieldis]['und']['#suffix'];
            }
            $fieldis='field_price_week';
            if( isset($form[$fieldis]['und']) ){
                if( !isset($form[$fieldis]['und']['#suffix']) ){
                    $form[$fieldis]['und']['#suffix']='';
                }
//                $form[$fieldis]['und']['#suffix']=' <span class="cursign">'.PDX_CITY_CUR.'</span>'.$form[$fieldis]['und']['#suffix'];
            }
            $fieldis='field_price_month';
            if( isset($form[$fieldis]['und']) ){
                if( !isset($form[$fieldis]['und']['#suffix']) ){
                    $form[$fieldis]['und']['#suffix']='';
                }
//                $form[$fieldis]['und']['#suffix']=' <span class="cursign">'.PDX_CITY_CUR.'</span>'.$form[$fieldis]['und']['#suffix'];
            }
            $fieldis='field_delivery1_price';
            if( isset($form[$fieldis]['und']) ){
                if( !isset($form[$fieldis]['und']['#suffix']) ){
                    $form[$fieldis]['und']['#suffix']='';
                }
//                $form[$fieldis]['und']['#suffix']=' <span class="cursign">'.PDX_CITY_CUR.'</span>'.$form[$fieldis]['und']['#suffix'];
            }
            $fieldis='field_rent_price';
            if( isset($form[$fieldis]['und']) ){
//                $form[$fieldis]['und'][0]['value']['#title'].=', <span class="cursign">'.PDX_CITY_CUR.'</span>:';
            }
            $fieldis='field_price_crashed';
            if( isset($form[$fieldis]['und']) ){
                if( !isset($form[$fieldis]['und']['#suffix']) ){
                    $form[$fieldis]['und']['#suffix']='';
                }
//                $form[$fieldis]['und']['#suffix']=' <span class="cursign">'.PDX_CITY_CUR.'</span>'.$form[$fieldis]['und']['#suffix'];
            }
        }
        break;
    case 'product_node_form':
        if( isset($form['#validate']) and is_array($form['#validate']) and count($form['#validate']) ){
            $form['#validate'][] = 'pdxseparate_validate_product';
        }else{
            $form['#validate'] = array('pdxseparate_validate_product');
        }
        break;
    }
}
function pdxseparate_userpoints_info() {
  return array(
    'pdx_addbalance' => array(
      'description' => 'Пополнение баланса'
    ),
    'pdx_lucky' => array(
      'description' => 'Подарок от '.$_SERVER['HTTP_HOST']
    ),
    'pdx_bonus_reg' => array(
      'description' => 'Бонус за регистрацию 10 "нид"'
    ),
    'pdx_bonus_vk_enter' => array(
      'description' => 'Бонус за вступление ВКонтакте 30 "нид"'
    ),
    'pdx_bonus_fb_enter' => array(
      'description' => 'Бонус за вступление Facebook 30 "нид"'
    ),
    'pdx_bonus_vk_pub' => array(
      'description' => 'Бонус за размещение поста ВКонтакте 5 "нид"'
    ),
    'pdx_bonus_site' => array(
      'description' => 'Ежедневный бонус за ссылку на своем сайте 1 "нид"'
    ),
    'pdx_del_gold1' => array(
      'description' => 'Покупка GOLD-аккаунта на 1 месяц'
    ),
    'pdx_del_premium' => array(
      'description' => 'Покупка Premium-статуса для объявления'
    ),
    'pdx_del_top' => array(
      'description' => 'Поднятие объявления в списках'
    ),
  );
}
function pdxseparate_uc_add_to_cart($nid, $qty, $data) {
    uc_cart_empty();
}
function pdxgetdescforpayment($payment){
    switch( $payment ){
    case 'cod':
        $text.='В ближайшее время с вами свяжется наш менеджер для согласования времени и места встречи.';
        break;
    default:
        $text.='После подтверждения оплаты, Ваш баланс будет пополнен.';
    }
}

function pdxcleartermcaches($term){
    $pages=array();
    $pages2=array();

    $city=0;
    if( defined('PDX_CITY_ID') and is_numeric(PDX_CITY_ID) ){
        $city=PDX_CITY_ID;
    }
    
    if( isset($term->tid) and is_numeric($term->tid) ){
        
        switch( $term->vid ){
        case 1:
            if( isset($term->field_part['und'][0]['tid']) and is_numeric($term->field_part['und'][0]['tid']) ){
                if( file_exists('pdxcache/amenu/'.PDX_CITY_ID.'_'.$term->field_part['und'][0]['tid']) ){
                    unlink('pdxcache/amenu/'.PDX_CITY_ID.'_'.$term->field_part['und'][0]['tid']);
                }
                if( isset($term->field_subpart['und'][0]['tid']) and is_numeric($term->field_subpart['und'][0]['tid']) ){
                    $pages[]='_'.PDXCAT_NAME.'_'.$term->field_part['und'][0]['tid'].'_'.$term->field_subpart['und'][0]['tid'].'_'.$term->tid;
                }
            }
            if( function_exists('getaddtocat') ){
                getaddtocat();
            }
            break;
        case 2:
            if( function_exists('pdxcreate_dirty') ){
                pdxcreate_dirty('tax');
            }

            if( file_exists('pdxcache/amenu/'.PDX_CITY_ID.'_'.$term->field_part['und'][0]['tid']) ){
                unlink('pdxcache/amenu/'.PDX_CITY_ID.'_'.$term->field_part['und'][0]['tid']);
            }
            $pages[]='_'.PDXCAT_NAME.'_'.$term->tid;
            if( function_exists('getaddtocat') ){
                getaddtocat();
            }
            break;
        case 8:
            if( function_exists('pdxcreate_dirty') ){
                pdxcreate_dirty('tax');
            }

            if( isset($term->field_part['und'][0]['tid']) and is_numeric($term->field_part['und'][0]['tid']) ){
                if( file_exists('pdxcache/amenu/'.PDX_CITY_ID.'_'.$term->field_part['und'][0]['tid']) ){
                    unlink('pdxcache/amenu/'.PDX_CITY_ID.'_'.$term->field_part['und'][0]['tid']);
                }
                $pages[]='_'.PDXCAT_NAME.'_'.$term->field_part['und'][0]['tid'].'_'.$term->tid;
            }
            if( function_exists('getaddtocat') ){
                getaddtocat();
            }
            break;
        case 10:
            if( function_exists('pdxcreate_dirty') ){
                pdxcreate_dirty('tax');
            }

            $pages[]='_'.PDXCAT_NAME.'_'.$term->tid;
            if( file_exists('pdxcache/amenu/'.PDX_CITY_ID.'_0') ){
                unlink('pdxcache/amenu/'.PDX_CITY_ID.'_0');
            }
            break;
        default:
            $path=path_load('taxonomy/term/'.$term->tid);
            if( isset($path['alias']) and strlen($path['alias'])){
                $url='/'.$path['alias'];
            }else{
                $url='/taxonomy/term/'.$term->tid;
            }
            
            $url=str_replace('//', '/', $url);
            $pages[]=str_replace('/','_',$url);
        }
        
    
        if( function_exists('pdxclearmycache') ){
            pdxclearmycache($pages);
        }
        
        if( isset($pages2) and is_array($pages2) and count($pages2) ){
            foreach($pages2 as $pattern){
                $files=scandir('pdxcache/pages/'.$_SERVER['HTTP_HOST'].'/');
                if( isset($files) and is_array($files) and count($files) ){
                    foreach( $files as $file ){
                        if( strpos($file, $pattern.'?')===false ){}else{
                            unlink('pdxcache/pages/'.$_SERVER['HTTP_HOST'].'/'.$file);
                        }
                    }
                }
            }
        }
    
    }
    
}
function pdxclearnodecaches($node){
    
    $pages=array();
    $pages2=array();

    $city=0;
    if( defined('PDX_CITY_ID') and PDX_CITY_ID>0 ){
        $city=PDX_CITY_ID;
    }
    
    if( isset($node->type) and strlen($node->type) ){
        $patterns=array();
//        $patterns[]='cache_field-field node '.$node->nid;
        $pathis=getcwd().'/mcache/filecache-default/';
        
        switch($node->type){
        case 'page':
            $path=path_load('node/'.$node->nid);
            if( isset($path['alias']) and strlen($path['alias'])){
                $url='/'.$path['alias'];
            }else{
                $url='/node/'.$node->nid;
            }
            
            $url=str_replace('//', '/', $url);
            $pages[]=str_replace('/','_',$url);
            break;
        case 'faq':
    //        $patterns[]='cache_block-views frontcat_block';
            $patterns[]='cache_views_data-ask';
            $pages[]='_faq';
    
            $path=path_load('node/'.$node->nid);
            if( isset($path['alias']) and strlen($path['alias'])){
                $url='/'.$path['alias'];
            }else{
                $url='/node/'.$node->nid;
            }
            
            $url=str_replace('//', '/', $url);
            $pages[]=str_replace('/','_',$url);
    
    
                $count=db_query('select count(nid) from {node} where status=1 and type=:combo', array(':combo'=>$node->type));
                $count=$count->fetchAssoc();
                if( isset($count['count(nid)']) and is_numeric($count['count(nid)']) and $count['count(nid)']>0 ){
                    $count=ceil($count['count(nid)']/10)+1;
                    for( $i=1; $i<=$count; $i++ ){
                        $pages[]='_faq?page='.$i;
                    }
                }
            break;
        case 'news':
    //        $patterns[]='cache_block-views frontcat_block';
            $patterns[]='cache_views_data-news';
            $pages[]='_news';
            if( function_exists('pdxcreate_dirty') ){
                pdxcreate_dirty('allpubs');
            }
            
            if( defined('PDX_CITY_ID') and is_numeric(PDX_CITY_ID) and PDX_CITY_ID==28 and function_exists('pdxgenfront') ){
                pdxgenfront();
            }
    
            $path=path_load('node/'.$node->nid);
            if( isset($path['alias']) and strlen($path['alias'])){
                $url='/'.$path['alias'];
            }else{
                $url='/node/'.$node->nid;
            }
            
            $url=str_replace('//', '/', $url);
            $pages[]=str_replace('/','_',$url);
    
    
                $count=db_query('select count(nid) from {node} where status=1 and type=:combo', array(':combo'=>$node->type));
                $count=$count->fetchAssoc();
                if( isset($count['count(nid)']) and is_numeric($count['count(nid)']) and $count['count(nid)']>0 ){
                    $count=ceil($count['count(nid)']/20)+1;
                    for( $i=1; $i<=$count; $i++ ){
                        $pages[]='_news?page='.$i;
                    }
                }
            break;
        case 'action':
    //        $patterns[]='cache_block-views frontcat_block';
            $patterns[]='cache_views_data-action';
            $pages[]='_action';
    
            $path=path_load('node/'.$node->nid);
            if( isset($path['alias']) and strlen($path['alias'])){
                $url='/'.$path['alias'];
            }else{
                $url='/node/'.$node->nid;
            }
            
            $url=str_replace('//', '/', $url);
            $pages[]=str_replace('/','_',$url);
    
    
                $count=db_query('select count(nid) from {node} where status=1 and type=:combo', array(':combo'=>$node->type));
                $count=$count->fetchAssoc();
                if( isset($count['count(nid)']) and is_numeric($count['count(nid)']) and $count['count(nid)']>0 ){
                    $count=ceil($count['count(nid)']/10)+1;
                    for( $i=1; $i<=$count; $i++ ){
                        $pages[]='_action?page='.$i;
                    }
                }
            break;
        case 'article':
            $pages[]='_help';
            
            if( defined('PDX_CITY_ID') and is_numeric(PDX_CITY_ID) and PDX_CITY_ID==28 and function_exists('pdxgenhelp') ){
                pdxgenhelp();
            }else{
                $path=path_load('node/'.$node->nid);
                if( isset($path['alias']) and strlen($path['alias'])){
                    $url='/'.$path['alias'];
                }else{
                    $url='/node/'.$node->nid;
                }
                
                $url=str_replace('//', '/', $url);
                $pages[]=str_replace('/','_',$url);
            }
    
            break;
        case 'findmy':
            $pages[]='_findmy';
            if( function_exists('pdxcreate_dirty') ){
                pdxcreate_dirty('allpubs');
            }
    
            if( isset($node->field_part['und'][0]['tid']) ){
                $pages[]='_findmy_'.$node->field_part['und'][0]['tid'];
            }
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$node->uid.'_sm_needto') ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$node->uid.'_sm_needto');
            }
    
            break;
        case 'item':
            if( function_exists('pdxcreate_dirty') ){
                pdxcreate_dirty('items');
                pdxcreate_dirty('items2');
                pdxcreate_dirty('allpubs');
                pdxcreate_dirty($node->uid, 'users');
            }
            updateuseritemimgshare($node->uid);
            updateuseritemimgs($node->uid);
            
    //        $pages[]='_';
    
            $path=path_load('node/'.$node->nid);
            if( isset($path['alias']) and strlen($path['alias'])){
                $url='/'.$path['alias'];
            }else{
                $url='/node/'.$node->nid;
            }
            $url=str_replace('//', '/', $url);
            $pages[]=str_replace('/','_',$url);
    
    
            $path=path_load('user/'.$node->uid);
            if( isset($path['alias']) and strlen($path['alias'])){
                $url='/'.$path['alias'];
            }else{
                $url='/user/'.$node->uid;
            }
            $url=str_replace('//', '/', $url);
            $pages[]=str_replace('/','_',$url);
    
    
            if( isset($node->taxonomy_catalog['und'][0]['tid']) ){
                $pages[]='_'.PDXCAT_NAME.'_'.$node->taxonomy_catalog['und'][0]['tid'];
                if( isset($node->field_subpart['und'][0]['tid']) ){
                    $pages[]='_'.PDXCAT_NAME.'_'.$node->taxonomy_catalog['und'][0]['tid'].'_'.$node->field_subpart['und'][0]['tid'];
                    if( isset($node->field_tags['und'][0]['tid']) ){
                        $pages[]='_'.PDXCAT_NAME.'_'.$node->taxonomy_catalog['und'][0]['tid'].'_'.$node->field_subpart['und'][0]['tid'].'_'.$node->field_tags['und'][0]['tid'];
                    }
                }
            }
    
    
    
            if( isset($node->field_celebration['und'][0]['tid']) ){
                $pages[]='_'.PDXCAT_NAME.'_'.$node->field_celebration['und'][0]['tid'];
                if( isset($node->field_celebration['und'][1]['tid']) ){
                    $pages[]='_'.PDXCAT_NAME.'_'.$node->field_celebration['und'][1]['tid'];
                    if( isset($node->field_celebration['und'][2]['tid']) ){
                        $pages[]='_'.PDXCAT_NAME.'_'.$node->field_celebration['und'][2]['tid'];
                    }
                }
            }
    
            break;
        default:
            $path=path_load('node/'.$node->nid);
            if( isset($path['alias']) and strlen($path['alias'])){
                $url='/'.$path['alias'];
            }else{
                $url='/node/'.$node->nid;
            }
            
            $url=str_replace('//', '/', $url);
            $pages[]=str_replace('/','_',$url);
        }
    
        if( function_exists('uc_product_is_product') and uc_product_is_product($node->type) ){
            $patterns[]='cache_views_data-product_hit';
            $patterns[]='cache_views_data-uc_catalog';
    //        $patterns[]='cache_block-views uc_catalog_rec';
    //        $patterns[]='cache_block-views product_hit';
    //        $patterns[]='cache_block-views product_special';
    
            $path=path_load('node/'.$node->nid);
            if( isset($path['alias']) and strlen($path['alias'])){
                $url='/'.$path['alias'];
            }else{
                $url='/node/'.$node->nid;
            }
            
            $url=str_replace('//', '/', $url);
            $pages[]=str_replace('/','_',$url);
    
    
                    if( isset($node->taxonomy_catalog['und'][0]['tid']) ){
                        foreach( $node->taxonomy_catalog['und'] as $tax ){
    
                            $path=path_load('catalog/'.$tax['tid']);
                            if( isset($path['alias']) and strlen($path['alias'])){
                                $url='/'.$path['alias'];
                            }else{
                                $url='/catalog/'.$tax['tid'];
                            }
                            $url=str_replace('//', '/', $url);
                            $pages[]=str_replace('/','_',$url);
                            
                            $parents=taxonomy_get_parents_all($tax['tid']);
                            if($parents and is_array($parents) and count($parents)){
                                foreach($parents as $parent){
                                    $path=path_load('catalog/'.$parent->tid);
                                    if( isset($path['alias']) and strlen($path['alias'])){
                                        $url='/'.$path['alias'];
                                    }else{
                                        $url='/catalog/'.$parent->tid;
                                    }
                                    $url=str_replace('//', '/', $url);
                                    $pages[]=str_replace('/','_',$url);
    
                                    if( isset($node->field_brand['und'][0]['tid']) and is_numeric($node->field_brand['und'][0]['tid']) ){
            
                                        $path=path_load('catalog/'.$parent->tid.'/'.$node->field_brand['und'][0]['tid']);
                                        if( isset($path['alias']) and strlen($path['alias'])){
                                            $url='/'.$path['alias'];
                                        }else{
                                            $url='/catalog/'.$parent->tid.'/'.$node->field_brand['und'][0]['tid'];
                                        }
                                        $url=str_replace('//', '/', $url);
                                        $pages[]=str_replace('/','_',$url);
                                        
                                    }
    
                                }
                            }
    
                        }
                    }
        }
    
        $files=scandir($pathis);
        if( isset($files) and is_array($files) and count($files) ){
            if( isset($patterns) and is_array($patterns) and count($patterns) ){
                foreach($patterns as $pattern){
                    foreach($files as $file){
                        if( strpos($file,$pattern)===false ){}else{
                            unlink($pathis.$file);
                        }
                    }
                }
            }
        }
        
        if( !function_exists('pdxclearmycache') ){
            define('DRUPAL_ROOT', getcwd());
            require_once DRUPAL_ROOT . '/sites/all/themes/pdxneedto/my.inc';
        }
        if( isset($pages) and is_array($pages) and count($pages) ){
            pdxclearmycache($pages, $city);
        }
    
        if( isset($pages2) and is_array($pages2) and count($pages2) ){
            foreach($pages2 as $pattern){
                $files=scandir('pdxcache/pages/'.$_SERVER['HTTP_HOST'].'/');
                if( isset($files) and is_array($files) and count($files) ){
                    foreach( $files as $file ){
                        if( strpos($file, $pattern.'?')===false ){}else{
                            unlink('pdxcache/pages/'.$_SERVER['HTTP_HOST'].'/'.$file);
                        }
                    }
                }
            }
        }
    
    }
//    cache_clear_all('field:node:' . $node->nid, 'cache_field', true);
    
}

function pdxseparate_webform_submission_insert($node, $submission) {
    if( function_exists('pdxcreate_dirty') ){
        pdxcreate_dirty('admin');
    }
}
function pdxisstoppremod($node, $nodeold){
    $stop=0;
    if( $node->title != $nodeold->title ){
        $stop=1;
    }
    if( $node->body['und'][0]['value'] != $nodeold->body['und'][0]['value'] ){
        $stop=1;
    }
    if( isset($node->field_image) and isset($node->field_image['und']) and isset($nodeold->field_image) and isset($nodeold->field_image['und']) ){
        if( count($node->field_image['und']) != count($nodeold->field_image['und']) ){
            $stop=1;
        }else{
            foreach( $node->field_image['und'] as $und => $image ){
                if( $image['fid']!= $nodeold->field_image['und'][$und]['fid'] ){
                    $stop=1;
                    break;
                }
            }
        }
    }
    if( isset($nodeold->field_youtube['und'][0]['input']) ){
        if( !isset($node->field_youtube['und'][0]['input']) or $nodeold->field_youtube['und'][0]['input']!=$node->field_youtube['und'][0]['input'] ){
            $stop=1;
        }
    }else{
        if( isset($node->field_youtube['und'][0]['input']) ){
            $stop=1;
        }
    }
    if( isset($nodeold->field_url['und'][0]['value']) ){
        if( !isset($node->field_url['und'][0]['value']) or $nodeold->field_url['und'][0]['value']!=$node->field_url['und'][0]['value'] ){
            $stop=1;
        }
    }else{
        if( isset($node->field_url['und'][0]['value']) ){
            $stop=1;
        }
    }
    if( isset($nodeold->field_tags['und'][0]['tid']) ){
        if( !isset($node->field_tags['und'][0]['tid']) or $nodeold->field_tags['und'][0]['tid']!=$node->field_tags['und'][0]['tid'] ){
            $stop=1;
        }
    }else{
        if( isset($node->field_tags['und'][0]['tid']) ){
            $stop=1;
        }
    }
    if( isset($nodeold->field_brand['und'][0]['tid']) ){
        if( !isset($node->field_brand['und'][0]['tid']) or $nodeold->field_brand['und'][0]['tid']!=$node->field_brand['und'][0]['tid'] ){
            $stop=1;
        }
    }else{
        if( isset($node->field_brand['und'][0]['tid']) ){
            $stop=1;
        }
    }
    if( isset($nodeold->field_celebration['und'][0]['tid']) ){
        if( !isset($node->field_celebration['und'][0]['tid']) or $nodeold->field_celebration['und'][0]['tid']!=$node->field_celebration['und'][0]['tid'] ){
            $stop=1;
        }
    }else{
        if( isset($node->field_celebration['und'][0]['tid']) ){
            $stop=1;
        }
    }
    if( isset($nodeold->field_price_about['und'][0]['value']) ){
        if( !isset($node->field_price_about['und'][0]['value']) or $nodeold->field_price_about['und'][0]['value']!=$node->field_price_about['und'][0]['value'] ){
            $stop=1;
        }
    }else{
        if( isset($node->field_price_about['und'][0]['value']) ){
            $stop=1;
        }
    }
    if( isset($nodeold->field_time['und'][0]['value']) ){
        if( !isset($node->field_time['und'][0]['value']) or $nodeold->field_time['und'][0]['value']!=$node->field_time['und'][0]['value'] ){
            $stop=1;
        }
    }else{
        if( isset($node->field_time['und'][0]['value']) ){
            $stop=1;
        }
    }
    if( isset($nodeold->field_rent_apply6['und'][0]['value']) ){
        if( !isset($node->field_rent_apply6['und'][0]['value']) or $nodeold->field_rent_apply6['und'][0]['value']!=$node->field_rent_apply6['und'][0]['value'] ){
            $stop=1;
        }
    }else{
        if( isset($node->field_rent_apply6['und'][0]['value']) ){
            $stop=1;
        }
    }
        
    return $stop;
}
function pdxshareme($node){
    if( !is_dir('html/'.PDX_CITY_ID) ){
        mkdir('html/'.PDX_CITY_ID);
    }
    if( !is_dir('html/'.PDX_CITY_ID.'/share') ){
        mkdir('html/'.PDX_CITY_ID.'/share');
    }
    if( !is_dir('html/'.PDX_CITY_ID.'/share/node') ){
        mkdir('html/'.PDX_CITY_ID.'/share/node');
    }
    if( !isset($node) or !isset($node->title) ){
        return;
    }
    $out='';
    //<a href="'.url('node/'.$node->nid, array('absolute'=>TRUE) ).'" class="sharelogo"><img alt="" src="'.PDX_IMGPATH.'/img/wlogo.png" /></a>
    $out.='<div class="shareme"><div class="ttlbox"><div class="ttl">'.$node->title.'</div><div class="clear">&nbsp;</div></div>';
    $out.='<div class="btmttlbox">Аренда в '.PDX_CITY_NAME2.' без проблем</div>';
    $out.='<div class="precntall"><div class="cntall">';
    
    if(isset($node->field_image['und'][0]['fid']) and strlen($node->field_image['und'][0]['fid'])){
        $uri = file_load($node->field_image['und'][0]['fid'])->uri;

        $imgis=theme('image_style', array('style_name' => 'news_preview', 'path' => $uri, 'alt' => $node->field_image['und'][0]['alt'], 'title' => $node->field_image['und'][0]['alt'], 'attributes' => array('class' => 'image'), 'getsize' => FALSE,));
        $out.= '<div class="cntleft">'.$imgis.'</div>';
    }
    
    $out.='<div class="cntright">';
    


    $sign='';
    if( defined('PDX_CITY_CUR') ){
        $sign=PDX_CITY_CUR;
    }
    
    if( isset( $node->field_cur['und'][0]['value'] ) and $node->field_cur['und'][0]['value']>1 ){
        switch($node->field_cur['und'][0]['value']){
        case 2:
            $sign='$';
            break;
        default:
            $sign='€';
            break;
        }
    }
    if( strlen($sign) ){
        $sign='<span class="signcur">'.$sign.'</span>';
    }


    $out.= '<div class="price">';
    $price1=$price2=$price4=$price3=$yesprice=$pricelen=0;
    
    if( isset($node->field_price_month['und'][0]['value']) and is_numeric($node->field_price_month['und'][0]['value']) ){
        $price4=$node->field_price_month['und'][0]['value'];
        $price3=round($node->field_price_month['und'][0]['value']/4, 2);
        $price2=round($node->field_price_month['und'][0]['value']/30, 2);
        $price1=round($price2/24, 2);
        $yesprice=1;
    }
    if( isset($node->field_price_week['und'][0]['value']) and is_numeric($node->field_price_week['und'][0]['value']) ){
        $price3=$node->field_price_week['und'][0]['value'];
        $price2=round($node->field_price_week['und'][0]['value']/7, 2);
        if( !isset($price4) or !is_numeric($price4) or $price4<1 ){
            $price4=$price2*30;
        }
        $price1=round($price2/24, 2);
        $yesprice=1;
    }
    if( isset($node->field_price_day['und'][0]['value']) and is_numeric($node->field_price_day['und'][0]['value']) ){
        $price2=$node->field_price_day['und'][0]['value'];
        if( !isset($price4) or !is_numeric($price4) or $price4<1 ){
            $price4=$price2*30;
        }
        if( !isset($price3) or !is_numeric($price3) or $price3<1 ){
            $price3=$price2*7;
        }
        $price1=round($price2/24, 2);
        $yesprice=1;
    }
    if( isset($node->field_price_hour['und'][0]['value']) and is_numeric($node->field_price_hour['und'][0]['value']) ){
        $price1=$node->field_price_hour['und'][0]['value'];
        if( !isset($price2) or !is_numeric($price2) or $price2<1 ){
            $price2=$price1*24;
        }
        if( !isset($price4) or !is_numeric($price4) or $price4<1 ){
            $price4=$price2*30;
        }
        if( !isset($price3) or !is_numeric($price3) or $price3<1 ){
            $price3=$price2*7;
        }
        $yesprice=1;
    }
    if( isset($node->field_price_min['und'][0]['value']) and is_numeric($node->field_price_min['und'][0]['value']) ){
        if( $node->field_price_min['und'][0]['value']>23 ){
            $price1=0;
            if( $node->field_price_min['und'][0]['value']>167 ){
                $price2=0;
            }
        }
    }
    
    if( $yesprice ){
        $nodiscount=$isdisc=0;
        if( isset($price1) and is_numeric($price1) and $price1>0 ){
            $out.= '<div class="priceitem price1">';
            $out.= '<strong class="isprice">';
            $tmponly=number_format($price1, 2, '.', ' ');
            $out.= $tmponly.'</strong>';
            $out.= ' '.$sign;
            $out.= ' / час</div>';
        }
        if( isset($price1) and is_numeric($price1) and $price1>0 ){
            $nodiscount=$price1*24;
        }
        if( isset($price2) and is_numeric($price2) and $price2>0 ){
            $out.= '<div class="priceitem price2">';
            $out.= '<strong class="isprice">';
            $tmponly=number_format($price2, 2, '.', ' ');
            $out.= $tmponly.'</strong>';
            $out.= ' '.$sign;
            $out.= ' / день (24 ч)';
            if( $nodiscount>0 and $nodiscount>$price2 ){
                $isdisc=$nodiscount-$price2;
                $isdisc=floor(($isdisc/$nodiscount)*100);
                if( $isdisc>0 ){
                    $out.= ' <sub title="Скидка за весь период, по сравнению с ценой за минимальный период">'.$isdisc.'%</sub>';
                }
            }
            $out.= '</div>';
        }
        if( isset($price1) and is_numeric($price1) and $price1>0 ){
            $nodiscount=$price1*168;
        }elseif( isset($price2) and is_numeric($price2) and $price2>0 ){
            $nodiscount=$price2*7;
        }
        if( isset($price3) and is_numeric($price3) and $price3>0 ){
            $out.= '<div class="priceitem price3">';
            $out.= '<strong class="isprice">';
            $tmponly=number_format($price3, 2, '.', ' ');
            $out.= $tmponly.'</strong>';
            $out.= ' '.$sign;
            $out.= ' / неделю';
            if( $nodiscount>0 and $nodiscount>$price3 ){
                $isdisc=$nodiscount-$price3;
                $isdisc=floor(($isdisc/$nodiscount)*100);
                if( $isdisc>0 ){
                    $out.= ' <sub title="Скидка за весь период, по сравнению с ценой за минимальный период">'.$isdisc.'%</sub>';
                }
            }
            $out.= '</div>';
        }
        if( isset($price1) and is_numeric($price1) and $price1>0 ){
            $nodiscount=$price1*672;
        }elseif( isset($price2) and is_numeric($price2) and $price2>0 ){
            $nodiscount=$price2*28;
        }elseif( isset($price3) and is_numeric($price3) and $price3>0 ){
            $nodiscount=$price2*4;
        }
        if( isset($price4) and is_numeric($price4) and $price4>0 ){
            $out.= '<div class="priceitem price4">';
            $out.= '<strong class="isprice">'.number_format($price4, 2, '.', ' ').'</strong>';
            $out.= ' '.$sign;
            $out.= ' / месяц (30 дн)';
            if( $nodiscount>0 and $nodiscount>$price4 ){
                $isdisc=$nodiscount-$price4;
                $isdisc=floor(($isdisc/$nodiscount)*100);
                if( $isdisc>0 ){
                    $out.= ' <sub title="Скидка за весь период, по сравнению с ценой за минимальный период">'.$isdisc.'%</sub>';
                }
            }
            $out.= '</div>';
        }
       
    }

    if(isset($node->field_price_about['und'][0]['value']) and strlen($node->field_price_about['und'][0]['value'])){
        $out.= '<div class="price_more"><div class="body_restrict">';

        $ismytext=$node->field_price_about['und'][0]['value'];
        if( mb_strpos($ismytext, '<p>')===false and mb_strpos($ismytext, '<li>')===false and mb_strpos($ismytext, '<div>')===false ){
            $ismytext=nl2br($ismytext);
        }
        $ismytext=str_replace('<a ', '<noindex><a rel="nofollow" target="_blank" ', $ismytext);
        $ismytext=str_replace('</a>', '</a></noindex>', $ismytext);
        $out.= $ismytext;

        $out.= '</div></div>';
    }

    $out.= '</div>';

    
    if(isset($node->body['und'][0]['value']) and strlen($node->body['und'][0]['value'])){
        $out.= $node->body['und'][0]['value'];
    }
    
    
    $out.= '</div>';
    
    
    $out.='<div class="clear">&nbsp;</div></div></div><div class="sharebtm">';

$out.='<div class="yashare-auto-init" data-yashareL10n="ru" data-yashareType="small" data-yashareQuickServices="vkontakte,facebook,twitter,odnoklassniki,moimir" data-yashareTheme="counter"  data-yashareLink="';
$path=path_load('node/'.$node->nid); if(strlen($path['alias'])) $path=$path['alias']; else $path='node/'.$node->nid;
$out.= $GLOBALS['base_url'].'/';
$out.= $path;
$out.='" data-yashareTitle="';
$str=str_replace('"', '', 'Возьми в аренду в '.PDX_CITY_NAME2.': '.$node->title);
if( mb_strlen($str)>64 ){
    $str=mb_substr($str,0,61).'...';
}
$out.= $str;
$out.='" data-yashareDescription="';
$str='';
if( isset($price1) and is_numeric($price1) and $price1>0 ){
    $str.=number_format($price1, 2, '.', ' ').' '.strip_tags($sign).' / час. ';
}elseif( isset($price2) and is_numeric($price2) and $price2>0 ){
    $str.=number_format($price2, 2, '.', ' ').' '.strip_tags($sign).' / день. ';
}elseif( isset($price3) and is_numeric($price3) and $price3>0 ){
    $str.=number_format($price3, 2, '.', ' ').' '.strip_tags($sign).' / месяц. ';
}
$str.=str_replace('"', '', strip_tags($node->body['und'][0]['value']));
if( mb_strlen($str)>127 ){
    $str=mb_substr($str,0,123).'...';
}
$out.= $str;
$out.='" data-yashareImage="';
if(isset($uri) and strlen($uri)){
    $uri = image_style_url('product_full', $uri);
    if(isset($uri) and strlen($uri)){
        $out.= $uri;
    }
}
$out.='" ></div>';

    
    $out.='<a target="_blank" href="'.url('node/'.$node->nid, array('absolute'=>TRUE) ).'">Взять в аренду</a></div>';
    $out.='</div>';

    $fp = fopen('html/'.PDX_CITY_ID.'/share/node/'.$node->nid.'.htm', 'w');
    fwrite($fp, '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru" dir="ltr"><head><title>Аренда needto.me: '.$node->title.'</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><script type="text/javascript" src="//yastatic.net/share/share.js" charset="utf-8"></script><style type="text/css">
    .shareme *{
    font-family:Arial,sans-serif;
    }
    .shareme .cntright{
    position: relative;
    left: +0px;
    margin-left: 233px;
    max-height: 377px;
    overflow: auto;
    }
    .shareme .precntall{
        padding: 0 3px 3px 3px;
        margin: 0px;
        background: #00d4d0;
    }
    .shareme .sharebtm{
        background: #000;
        padding: 3px 7px 7px 11px;
        margin: 0px;
    }
    .shareme .yashare-auto-init{
    float: right;
    }
    .shareme .sharebtm a{
        color: #fff;
        font-size: 10pt;
    }
    .shareme .cntall{
        position: relative;
        left: +0px;
        padding: 11px 11px 7px 11px;
        margin: 0px;
        background: #fff;
    }
    .shareme .cntleft{
        width: 223px;
        float: left;
        padding: 17px 11px 21px 0;
        margin: 0px;
    }
    .shareme .price{
    padding: 0 0 17px 0;
    margin: 0 0 21px 0px;
    border-bottom: 1px solid #e6e6e6;
    }
    .shareme .price_more{
    padding: 7px 0 0 0;
    margin: 11px 0 0 0px;
    border-top: 1px solid #e6e6e6;
    }
    .shareme .priceitem{
    padding-right: 21px;
    display: inline-block;
    }
    .shareme .btmttlbox{
    padding: 3px 11px 3px 11px;
    margin: 0px;
    background: #00d4d0;
    color: #fff;
    font-size: 10pt;
    }
    .shareme .ttlbox{
    position: relative;
    left: +0px;
    padding: 7px 11px;
    margin: 0px;
    background: #000;
    }
    .shareme .clear{
    height: 0px;
    clear: both;
    overflow: hidden;
    }
    .shareme .sharelogo{
    float: left;
    height: 37px;
    overflow: hidden;
    display: inline-block;
    }
    .shareme .ttl{
    font-size: 15pt;
    color: #ccc;
    padding: 3px 0 7px 0;
    }
    @media screen and (max-width: 531px) {
        .shareme .cntright{
        margin-left: 0;
        clear: both;
        max-height: none;
    }
        .shareme .cntleft{
        float: none;
        width: auto;
        text-align: center;
        }
    .shareme .cntall{
        max-height: 377px;
        overflow: auto;
    }
    }
    </style></head><body id="start" style="padding: 11px 0 0 0px;
    margin: 0px;">'.$out.'</body></html>'); fclose($fp);
    
}
function pdxseparate_node($source_content = NULL){
    $source_content= '';
    return $source_content;
}
function pdxseparate_node_delete($node) {
    if( function_exists('pdxclearnodecaches') ){
        pdxclearnodecaches($node);
    }

    global $user;
    switch($node->type){
        case 'item': //----------------------------объявление
        if(isset($user->roles[3]) or isset($user->roles[4])){
        
            $ismail=db_query('select u.mail, f.field_name_value from {users} as u left join {field_data_field_name} as f on (u.uid=f.entity_id and f.entity_type=\'user\') where u.uid='.$node->uid);
            $ismail=$ismail->fetchAssoc();
            if( isset($ismail['mail']) and strlen($ismail['mail']) and valid_email_address($ismail['mail']) and function_exists('pdxmail') ){
                $usname='';
                if( isset($ismail['field_name_value']) and strlen($ismail['field_name_value']) ){
                    $usname=', '.$ismail['field_name_value'];
                }
                $msg='<p>Здравствуй'.$usname.'.</p>';
                $msg.='<p>К сожалению, объявление "'.$node->title.'" было полностью удалено модератором сайта '.$GLOBALS['base_url'].' без возможности восстановления =(</p><p>Это может значить, что объявление нарушает законодательство страны, либо не является предложением по аренде.</p>';
            
                pdxmail($ismail['mail'], $msg, 'Объявление удалено с сайта '.$GLOBALS['base_url']);
            }
        
            if( function_exists('pdxcreate_dirty') ){
                pdxcreate_dirty('admin');
            }

        }
        pdxcd('item', $node->nid, 1);
        break;
    }
}
function pdxupdadv(){
    $out='var ball=new Array(); var bi=new Array(); ';
    $aterms=array();
    $terms=db_query('select tid from {taxonomy_term_data} where vid=2 order by weight asc');
    while($term = $terms->fetchAssoc() ){
        $aterms[]=$term['tid'];
        $out.='bi['.$term['tid'].']=new Array(); ';
    }
    
    $nids=db_query('select t.taxonomy_catalog_tid, i.field_image_fid, i.field_image_alt, u.field_url_value, n.title, n.nid from {node} as n inner join {field_data_field_url} as u on (n.nid=u.entity_id and u.entity_type=\'node\') inner join {field_data_field_image} as i on (n.nid=i.entity_id and i.entity_type=\'node\') left join {field_data_taxonomy_catalog} as t on (n.nid=t.entity_id and t.entity_type=\'node\') where n.status=1 and n.type=\'action\'');
    while( $nid=$nids->fetchAssoc() ){
        if( !isset( $nid['taxonomy_catalog_tid'] ) ){
            $nid['taxonomy_catalog_tid']=0;
        }
        if( isset($aterms) and is_array($aterms) and count($aterms) ){
            foreach($aterms as $tmpval ){
                if( $nid['taxonomy_catalog_tid']==0 or $nid['taxonomy_catalog_tid']==$tmpval ){
                    $out.='bi['.$tmpval.'].push('.$nid['nid'].'); ';
                }
            }
        }
        $nid['field_url_value']=str_replace("'", '', str_replace('"', '', $nid['field_url_value']));
        $nid['title']=str_replace("'", '', str_replace('"', '', $nid['title']));
        $nid['field_image_alt']=str_replace("'", '', str_replace('"', '', $nid['field_image_alt']));
        
        $uri = file_load($nid['field_image_fid'])->uri;
        $uri = file_create_url($uri);
        if(isset($uri) and strlen($uri)){
            $out.=' ball['.$nid['nid'].']=\'<a target="_blank" href="'.$nid['field_url_value'].'"><img title="'.$nid['title'].'" alt="'.$nid['field_image_alt'].'" src="'.$uri.'" /></a>\'; ';
        }
    }
    
    if( !is_dir('js/'.$_SERVER['HTTP_HOST']) ){
        mkdir('js/'.$_SERVER['HTTP_HOST']);
    }
    $fp = fopen( 'js/'.$_SERVER['HTTP_HOST'].'/ball.js', 'w');
    fwrite($fp, $out);
    fclose($fp);
    
}
function pdxseparate_node_update($node) {
    if( function_exists('pdxclearnodecaches') ){
        pdxclearnodecaches($node);
    }
    global $user;
    switch($node->type){
    case 'findmy': //---------------------найти вещь
        if(isset($user->roles[3]) or isset($user->roles[4])){
            if( $node->original->status==0 and $node->status==1 ){
                //pub to twitter
                if( !is_dir('pdxcache/social') ){
                    mkdir('pdxcache/social');
                }
                if( !is_dir('pdxcache/social/twitter') ){
                    mkdir('pdxcache/social/twitter');
                }
                if( !file_exists('pdxcache/social/twitter/'.$node->nid.'|||'.$node->type) ){

                    $desc='Возьму в аренду #'.PDX_CITY_NAME.' #Ищу';
                    $path='findmy#findmy_nid_'.$node->nid;
                    $desc.=' '.$GLOBALS['base_url'].'/'.$path;
                    $desc.=': '.$node->title;
                    if( mb_strlen($desc)>127 ){
                        $desc=mb_substr($desc, 0, 125).'..';
                    }

                    $fp = fopen('pdxcache/social/twitter/'.$node->nid.'|||'.$node->type, 'w'); fwrite($fp, $desc); fclose($fp);
                }
                
                //pub to fb
                $link=url('findmy', array('absolute'=>TRUE) );
            
                $style= image_style_load('news_full');
                $uri=$img='';
                if( isset($node->field_image2['und'][0]['fid']) and strlen($node->field_image2['und'][0]['fid']) ){
                    $uri = file_load($node->field_image2['und'][0]['fid'])->uri;
            //            $uri = file_load($node->field_image2['und'][0]['fid'])->uri;
                    $real = drupal_realpath($uri);
                    $img = image_style_url('news_full', $uri);
                    $uri = image_style_path('news_full', $uri);
                    $uri = drupal_realpath($uri);
                    if( !file_exists($uri) ){
                        image_style_create_derivative($style, $real, $uri);
                    }
                }
                
                $page_id = '996282783743830';
                $fb = facebook_autopost('post');
                
                $publication = array(
                'type' => 'post',
                'params' => array(
                'name' => 'Подана заявка на аренду новой вещи',
                'link' => $link,
                'picture' => $img,
                'description' => $node->title,
                ),
                );
                $fb->publish($publication, $page_id);


            }
        }
        break;
    case 'item': //----------------------------объявление

        if( function_exists('pdxshareme') ){
            pdxshareme($node);
        }
        
        if(isset($user->roles[3]) or isset($user->roles[4])){
            
            if( $node->original->field_block['und'][0]['value']==0 and $node->field_block['und'][0]['value']==1 ){
                $ismail=db_query('select u.mail, f.field_name_value from {users} as u left join {field_data_field_name} as f on (u.uid=f.entity_id and f.entity_type=\'user\') where u.uid='.$node->uid);
                $ismail=$ismail->fetchAssoc();
                if( isset($ismail['mail']) and strlen($ismail['mail']) and valid_email_address($ismail['mail']) ){
                    $path=path_load('node/'.$node->nid); if(strlen($path['alias'])) $path=$path['alias']; else $path='node/'.$node->nid;
                    $usname='';
                    if( isset($ismail['field_name_value']) and strlen($ismail['field_name_value']) ){
                        $usname=', '.$ismail['field_name_value'];
                    }
                    $msg='<p>Здравствуй'.$usname.'.</p>';
                    $msg.='<p>К сожалению, объявление "<a href="'.$GLOBALS['base_url'].'/'.$path.'">'.$node->title.'</a>" было заблокировано модератором сайта '.$GLOBALS['base_url'].' =(</p>';
                    if( isset($node->field_moderate_reason['und'][0]['value']) and strlen($node->field_moderate_reason['und'][0]['value']) ){
                        $msg.='<p><strong>Причина блокировки:</strong></p>';
                        $msg.='<div>'.nl2br($node->field_moderate_reason['und'][0]['value']).'</div>';
                    }
                
                    pdxmail($ismail['mail'], $msg, 'Объявление заблокировано на сайте '.$GLOBALS['base_url']);
                }
            
                if( function_exists('pdxcreate_dirty') ){
                    pdxcreate_dirty('admin');
                }
            
            }elseif( $node->original->field_block['und'][0]['value']==1 and $node->field_block['und'][0]['value']==0 ){
                $ismail=db_query('select u.mail, f.field_name_value from {users} as u left join {field_data_field_name} as f on (u.uid=f.entity_id and f.entity_type=\'user\') where u.uid='.$node->uid);
                $ismail=$ismail->fetchAssoc();
                if( isset($ismail['mail']) and strlen($ismail['mail']) and valid_email_address($ismail['mail']) ){
                    $path=path_load('node/'.$node->nid); if(strlen($path['alias'])) $path=$path['alias']; else $path='node/'.$node->nid;
                    $usname='';
                    if( isset($ismail['field_name_value']) and strlen($ismail['field_name_value']) ){
                        $usname=', '.$ismail['field_name_value'];
                    }
                    $msg='<p>Здравствуй'.$usname.'.</p>';
                    $msg.='<p>Поздравляем, с объявления "<a href="'.$GLOBALS['base_url'].'/'.$path.'">'.$node->title.'</a>" снята блокировка на сайте '.$GLOBALS['base_url'].' =(</p>';
                
                    pdxmail($ismail['mail'], $msg, 'Объявление восстановлено на сайте '.$GLOBALS['base_url']);
                }
            
                if( function_exists('pdxcreate_dirty') ){
                    pdxcreate_dirty('admin');
                }
            
            }else{
                if( $node->original->status==0 and $node->status==1 ){
                    $ismail=db_query('select mail from {users} where uid='.$node->uid);
                    $ismail=$ismail->fetchAssoc();
                    if( isset($ismail['mail']) and strlen($ismail['mail']) and valid_email_address($ismail['mail']) ){
                        pdxcreate_mail($ismail['mail'], $node->nid, $node->title, 1);
                    }

/*
                    $style= image_style_load('product_full');
                    $img = image_style_url('news_full', $node->field_image['und'][0]['uri']);
                    $path=path_load('node/'.$node->nid); if(strlen($path['alias'])) $path=$GLOBALS['base_url'].'/'.$path['alias']; else $path=$GLOBALS['base_url'].'/node/'.$node->nid;
                    $page_id = '996282783743830';
                    $fb = facebook_autopost('post');
                    
                    $publication = array(
                    'type' => 'post',
                    'params' => array(
                    'name' => 'Возьми в аренду в Минске: новое предложение',
                    'link' => $path,
                    'picture' => $img,
                    'description' => $node->title,
                    ),
                    );
                    $fb->publish($publication, $page_id);
*/
    
                }
            
                if( function_exists('pdxcreate_dirty') ){
                    pdxcreate_dirty('admin');
                }
            
            }
            
            //pub to twitter
            if( $node->original->status==0 and $node->status==1 ){
                if( !is_dir('pdxcache/social') ){
                    mkdir('pdxcache/social');
                }
                if( !is_dir('pdxcache/social/twitter') ){
                    mkdir('pdxcache/social/twitter');
                }
                if( !file_exists('pdxcache/social/twitter/'.$node->nid.'|||'.$node->type) ){

                    $desc='#Аренда #'.PDX_CITY_NAME;
                    if( isset( $node->taxonomy_catalog['und'][0]['tid'] ) and is_numeric( $node->taxonomy_catalog['und'][0]['tid'] ) ){
                        $name=db_query('select name from {taxonomy_term_data} where tid='.$node->taxonomy_catalog['und'][0]['tid']);
                        $name=$name->fetchAssoc();
                        if( isset($name['name']) and strlen($name['name']) ){
                            $desc.=' #'.str_replace(' ', '', str_replace(' и ', '', $name['name']));
                        }
                    }
                    if( isset( $node->field_brand['und'][0]['tid'] ) and is_numeric( $node->field_brand['und'][0]['tid'] ) ){
                        $name=db_query('select name from {taxonomy_term_data} where tid='.$node->field_brand['und'][0]['tid']);
                        $name=$name->fetchAssoc();
                        if( isset($name['name']) and strlen($name['name']) ){
                            $desc.=' #'.str_replace(' ', '', $name['name']);
                        }
                    }
                    if( isset( $node->field_celebration['und'][0]['tid'] ) and is_numeric( $node->field_celebration['und'][0]['tid'] ) ){
                        $name=db_query('select name from {taxonomy_term_data} where tid='.$node->field_celebration['und'][0]['tid']);
                        $name=$name->fetchAssoc();
                        if( isset($name['name']) and strlen($name['name']) ){
                            $desc.=' #'.str_replace(' ', '', str_replace(' и ', '', $name['name']));
                        }
                    }
                    $path=path_load('node/'.$node->nid); if(strlen($path['alias'])) $path=$path['alias']; else $path='node/'.$node->nid;
                    $desc.=' '.$GLOBALS['base_url'].'/'.$path;
                    $desc.=': '.$node->title;
                    if( mb_strlen($desc)>127 ){
                        $desc=mb_substr($desc, 0, 125).'..';
                    }
                    $img='';

                    if( isset( $node->field_image['und'][0]['fid'] ) and is_numeric( $node->field_image['und'][0]['fid'] ) ){
                        $file = file_load($node->field_image['und'][0]['fid']);
                        if( isset( $file->uri ) and strlen( $file->uri ) ){
                            $img=image_style_url('news_preview', $file->uri);
                        }
                    }
                    if( strlen($img) ){
                        $img='|||'.urlencode($img);
                    }

                    $fp = fopen('pdxcache/social/twitter/'.$node->nid.'|||'.$node->type.$img, 'w'); fwrite($fp, $desc); fclose($fp);
                }
            }
            
        }
        pdxgetmyitem($node->nid, $node);
        if( function_exists('htmlNodeVideo') ){
            htmlNodeVideo($node);
        }
        break;
    }
}
function pdxseparate_node_insert($node) {
    if( function_exists('pdxclearnodecaches') ){
        pdxclearnodecaches($node);
    }
    global $user;
    switch($node->type){
    case 'findmy': // найти вещь
        if( $user->uid ){
            //pub to twitter
            if( !is_dir('pdxcache/social') ){
                mkdir('pdxcache/social');
            }
            if( !is_dir('pdxcache/social/twitter') ){
                mkdir('pdxcache/social/twitter');
            }
            if( !file_exists('pdxcache/social/twitter/'.$node->nid.'|||'.$node->type) ){
                $desc='Возьму в аренду, #'.PDX_CITY_NAME.' #Ищу';
                $path='findmy#findmy_nid_'.$node->nid;
                $desc.=' '.$GLOBALS['base_url'].'/'.$path;
                $desc=': '.$node->title;
                
                if( mb_strlen($desc)>127 ){
                    $desc=mb_substr($desc, 0, 125).'..';
                }
    
                $fp = fopen('pdxcache/social/twitter/'.$node->nid.'|||'.$node->type, 'w'); fwrite($fp, $desc); fclose($fp);
            }
            
            //post to fb
            $link=url('findmy', array('absolute'=>TRUE) );
        
            $style= image_style_load('news_full');
            $uri=$img='';
            if( isset($node->field_image2['und'][0]['fid']) and strlen($node->field_image2['und'][0]['fid']) ){
                $uri = file_load($node->field_image2['und'][0]['fid'])->uri;
                $real = drupal_realpath($uri);
                $img = image_style_url('news_full', $uri);
                $uri = image_style_path('news_full', $uri);
                $uri = drupal_realpath($uri);
                if( !file_exists($uri) ){
                    image_style_create_derivative($style, $real, $uri);
                }
            }
            
            $page_id = '996282783743830';
            $fb = facebook_autopost('post');
            
            $publication = array(
            'type' => 'post',
            'params' => array(
            'name' => 'Подана заявка на аренду новой вещи',
            'link' => $link,
            'picture' => $img,
            'description' => $node->title,
            ),
            );
            $fb->publish($publication, $page_id);
    
        }
        break;
    case 'item': //----------------------------объявление

       
        if( function_exists('htmlNodeVideo') ){
            htmlNodeVideo($node);
        }
        if( function_exists('pdxshareme') ){
            pdxshareme($node);
        }
        
        if(!isset($user->roles[8])){ // ---не Gold
            $moreadv='';
            if( isset( $node->taxonomy_catalog['und'][0]['tid'] ) and is_numeric( $node->taxonomy_catalog['und'][0]['tid'] ) ){
                $moreadv.='?part='.$node->taxonomy_catalog['und'][0]['tid'];
                if( isset( $node->field_subpart['und'][0]['tid'] ) and is_numeric( $node->field_subpart['und'][0]['tid'] ) ){
                    $moreadv.='&subpart='.$node->field_subpart['und'][0]['tid'];
                    if( isset( $node->field_tags['und'][0]['tid'] ) and is_numeric( $node->field_tags['und'][0]['tid'] ) ){
                        $moreadv.='&tag='.$node->field_tags['und'][0]['tid'];
                    }
                }
            }
            drupal_set_message('<div>Спасибо, Ваше предложение принято. После модерации оно будет опубликовано на сайте.</div><div>Хотите добавить еще одно объявление в тот же раздел? <a href="/node/add/item'.$moreadv.'">Да, добавить</a></div>');
        }else{
            
            if( $node->uid==$user->uid ){
                if( isset($user->roles[3]) or isset($user->roles[4]) ){ }else{

                    //pub to twitter
                    if( !is_dir('pdxcache/social') ){
                        mkdir('pdxcache/social');
                    }
                    if( !is_dir('pdxcache/social/twitter') ){
                        mkdir('pdxcache/social/twitter');
                    }
                    if( !file_exists('pdxcache/social/twitter/'.$node->nid.'|||'.$node->type) ){
    
                        $desc='#Аренда #'.PDX_CITY_NAME;
                        if( isset( $node->taxonomy_catalog['und'][0]['tid'] ) and is_numeric( $node->taxonomy_catalog['und'][0]['tid'] ) ){
                            $name=db_query('select name from {taxonomy_term_data} where tid='.$node->taxonomy_catalog['und'][0]['tid']);
                            $name=$name->fetchAssoc();
                            if( isset($name['name']) and strlen($name['name']) ){
                                $desc.=' #'.str_replace(' ', '', str_replace(' и ', '', $name['name']));
                            }
                        }
                        if( isset( $node->field_brand['und'][0]['tid'] ) and is_numeric( $node->field_brand['und'][0]['tid'] ) ){
                            $name=db_query('select name from {taxonomy_term_data} where tid='.$node->field_brand['und'][0]['tid']);
                            $name=$name->fetchAssoc();
                            if( isset($name['name']) and strlen($name['name']) ){
                                $desc.=' #'.str_replace(' ', '', $name['name']);
                            }
                        }
                        if( isset( $node->field_celebration['und'][0]['tid'] ) and is_numeric( $node->field_celebration['und'][0]['tid'] ) ){
                            $name=db_query('select name from {taxonomy_term_data} where tid='.$node->field_celebration['und'][0]['tid']);
                            $name=$name->fetchAssoc();
                            if( isset($name['name']) and strlen($name['name']) ){
                                $desc.=' #'.str_replace(' ', '', str_replace(' и ', '', $name['name']));
                            }
                        }
                        $path=path_load('node/'.$node->nid); if(strlen($path['alias'])) $path=$path['alias']; else $path='node/'.$node->nid;
                        $desc.=' '.$GLOBALS['base_url'].'/'.$path;
                        $desc.=': '.$node->title;
                        
                        if( mb_strlen($desc)>127 ){
                            $desc=mb_substr($desc, 0, 125).'..';
                        }
                        $img='';

                        if( isset( $node->field_image['und'][0]['fid'] ) and is_numeric( $node->field_image['und'][0]['fid'] ) ){
                            $file = file_load($node->field_image['und'][0]['fid']);
                            if( isset( $file->uri ) and strlen( $file->uri ) ){
                                $img=image_style_url('news_preview', $file->uri);
                            }
                        }
                        if( strlen($img) ){
                            $img='|||'.urlencode($img);
                        }
    
                        $fp = fopen('pdxcache/social/twitter/'.$node->nid.'|||'.$node->type.$img, 'w'); fwrite($fp, $desc); fclose($fp);
                    }

                    
                }
            }

/*
            $style= image_style_load('product_full');
            $img = image_style_url('news_full', $node->field_image['und'][0]['uri']);
            $path=path_load('node/'.$node->nid); if(strlen($path['alias'])) $path=$GLOBALS['base_url'].'/'.$path['alias']; else $path=$GLOBALS['base_url'].'/node/'.$node->nid;
            $page_id = '996282783743830';
            $fb = facebook_autopost('post');
            
            $publication = array(
            'type' => 'post',
            'params' => array(
            'name' => 'Возьми в аренду в Минске: новое предложение',
            'link' => $path,
            'picture' => $img,
            'description' => $node->title,
            ),
            );
            $fb->publish($publication, $page_id);
*/
            
        }
        pdxgetmyitem($node->nid, $node);

        if( isset($user->roles[3]) or isset($user->roles[4]) ){  }else{
            if( function_exists('pdxcreate_dirty') ){
                pdxcreate_dirty('admin');
            }
        }

        break;
    }
}
function pdxseparate_node_presave($node) {
    $allowed='<br><br/><p><a><hr><strong><ul><ol><li><em><div>';
    $allowed2=array('br','p','a','hr','strong','ul','ol','li','em','div');
    
    global $user;
    switch($node->type){
    case 'item':
        if( isset($node->body) and is_array($node->body) and count($node->body) ){
            foreach( $node->body as $und => $arr ){
                if( isset($arr) and is_array($arr) and count($arr) ){
                    foreach( $arr as $ind => $val ){
                        if( isset($val) and is_array($val) and count($val) and isset($val['value']) ){ 
                            $node->body[$und][$ind]['value']=trim(filter_xss(strip_tags($node->body[$und][$ind]['value'], $allowed), $allowed2));
                        }
                    }
                }
            }
        }
    case 'findmy':
        $node->title=trim(filter_xss(strip_tags($node->title)));
        foreach( $node as $id => $obj ){
            if( strpos($id, 'field_')===false ){}else{
                if( isset($obj) and is_array($obj) and count($obj) ){
                    foreach( $obj as $und => $arr ){
                        if( isset($arr) and is_array($arr) and count($arr) ){
                            foreach( $arr as $ind => $val ){
                                if( isset($val) and is_array($val) and count($val) and isset($val['value']) ){
                                    switch($id){
                                    case 'field_price_about':
                                    case 'field_rent_apply6':
                                        $node->{$id}[$und][$ind]['value']=trim(filter_xss(strip_tags($node->{$id}[$und][$ind]['value'], $allowed), $allowed2));
                                        break;
                                    default:
                                        $node->{$id}[$und][$ind]['value']=trim(filter_xss(strip_tags($node->{$id}[$und][$ind]['value'])));
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        break;
    }
    switch($node->type){
    case 'findmy': //----------------------------поиск вещи
        if( !$user->uid ){
            $node->status=0;
            drupal_set_message('Спасибо, Ваша заявка принята. После модерации она будет опубликована на сайте.');
            if( isset($user->roles[3]) or isset($user->roles[4]) ){  }else{
                if( function_exists('pdxcreate_dirty') ){
                    pdxcreate_dirty('admin');
                }
            }
        }
        break;
    case 'item': //----------------------------объявление

        if( !isset($node->field_delivery2['und'][0]['value']) or $node->field_delivery2['und'][0]['value']!=1 ){
            unset($node->field_delivery1_price['und'][0]['value']);
        }
        
        if( !isset($node->field_status['und'][0]['value']) or $node->field_status['und'][0]['value']!=2 ){
            unset($node->field_datend['und'][0]['value']);
        }

        $alt='';
        $term=array();
        if(isset($node->taxonomy_catalog['und']) and is_array($node->taxonomy_catalog['und']) and count($node->taxonomy_catalog['und'])){
            $name=db_query('select name from {taxonomy_term_data} where tid='.$node->taxonomy_catalog['und'][0]['tid']);
            $name=$name->fetchAssoc();
            if( isset($name['name']) and strlen($name['name']) ){
                $alt=$name['name'].', ';
            }
        }
        $alt.=$node->title;
        
        $alt=str_replace('"','',$alt);
        $alt=str_replace("'",'',$alt);
        
        if( isset($node->field_image['und']) and is_array($node->field_image['und']) and count($node->field_image['und']) ){
            foreach( $node->field_image['und'] as $delta=>$image ){
                $node->field_image['und'][$delta]['alt']=$alt;
            }
        }



//        if( defined('PDX_CITY_ID') and PDX_CITY_ID>0 ){
//            if( isset($node->field_city['und'][0]['tid']) and is_numeric($node->field_city['und'][0]['tid']) and $node->field_city['und'][0]['tid']==PDX_CITY_ID ){ }else{
//                $city=taxonomy_term_load(PDX_CITY_ID);
//                if( isset($city->tid) ){
//                    $node->field_city['und'][0]=(array) $city;
//                }
//            }
//        }
        
        $isset=db_query('select field_rn_nid from {field_data_field_rn} where entity_type=\'user\' and entity_id='.$node->uid);
        $isset=$isset->fetchAssoc();
        if( isset($isset['field_rn_nid']) and is_numeric($isset['field_rn_nid']) ){
            $node->field_rn['und'][0]['nid']=$isset['field_rn_nid'];
        }
        
        $isset=db_query('select field_who_value from {field_data_field_who} where entity_type=\'user\' and entity_id='.$node->uid);
        $isset=$isset->fetchAssoc();
        if( isset($isset['field_who_value']) and is_numeric($isset['field_who_value']) ){
            $node->field_who['und'][0]['value']= $isset['field_who_value'];
        }



        if(isset($user->roles[3]) or isset($user->roles[4])){

        }else{
            if( isset( $node->original ) ){
                if( isset($node->original->field_premium) and isset($node->original->field_premium['und'][0]['value']) and strlen($node->original->field_premium['und'][0]['value']) ){
                    if( isset($node->field_premium['und'][0]['value']) and strlen($node->field_premium['und'][0]['value']) and $node->original->field_premium['und'][0]['value']!=$node->field_premium['und'][0]['value'] ){
                        $node->field_premium['und'][0]['value']=$node->original->field_premium['und'][0]['value'];
                    }
                }else{
                    if( isset($node->field_premium['und'][0]['value']) and strlen($node->field_premium['und'][0]['value']) ){
                        $node->field_premium['und'][0]['value']='';
                    }
                }
        
                if( isset($node->original->field_moderate) and isset($node->original->field_moderate['und'][0]['value']) and strlen($node->original->field_moderate['und'][0]['value']) ){
                    if( isset($node->field_moderate['und'][0]['value']) and strlen($node->field_moderate['und'][0]['value']) and $node->original->field_moderate['und'][0]['value']!=$node->field_moderate['und'][0]['value'] ){
                        $node->field_moderate['und'][0]['value']=$node->original->field_moderate['und'][0]['value'];
                    }
                }else{
                    if( isset($node->field_moderate['und'][0]['value']) and strlen($node->field_moderate['und'][0]['value']) ){
                        $node->field_moderate['und'][0]['value']='';
                    }
                }
        
                if( isset($node->original->field_block) and isset($node->original->field_block['und'][0]['value']) and strlen($node->original->field_block['und'][0]['value']) ){
                    if( isset($node->field_block['und'][0]['value']) and strlen($node->field_block['und'][0]['value']) and $node->original->field_block['und'][0]['value']!=$node->field_block['und'][0]['value'] ){
                        $node->field_block['und'][0]['value']=$node->original->field_block['und'][0]['value'];
                    }
                }else{
                    if( isset($node->field_block['und'][0]['value']) and strlen($node->field_block['und'][0]['value']) ){
                        $node->field_block['und'][0]['value']='';
                    }
                }
            }
        }

        if(isset($user->roles[8]) ){ // ---Gold
            if($user->uid==$node->uid ){
                if( isset( $node->original ) ){
                    $stop=0;
                    if( function_exists('pdxisstoppremod') ){
                        $stop=pdxisstoppremod($node, $node->original);
                    }
                    
                    if($stop){
                        $node->field_moderate['und'][0]['value']=1;
                        if( function_exists('pdxcreate_dirty') ){
                            pdxcreate_dirty('admin');
                        }
                    }
                    
                }else{
                    $node->field_moderate['und'][0]['value']=1;
                    $node->status=1;
                    $node->sticky=1;
                }
            }
        }elseif( !isset($user->roles[3]) and !isset($user->roles[4]) ){
            if( isset( $node->original ) ){
                $stop=0;
                if( function_exists('pdxisstoppremod') ){
                    $stop=pdxisstoppremod($node, $node->original);
                }
                if( $stop ){
                    $node->status=0;
                    
                    drupal_set_message('Ваше предложение отправлено на повторную модерацию. После модерации оно будет опубликовано на сайте.');

                    if( function_exists('pdxcreate_dirty') ){
                        pdxcreate_dirty('admin');
                    }
                    
                }
            }
        }

        
        break;
    }


//    drupal_set_message('we<pre>'.print_r($node->field_price_day, true). '</pre>');
//    drupal_set_message('we<pre>'.print_r($node->original->field_price_day, true). '</pre>');
}
function pdxseparate_user_insert(&$edit, $account, $category) {

    if( function_exists('pdxcreate_dirty') ){
        pdxcreate_dirty('user');
    }

            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid) ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid);
            }

    $pages=array();
    $pages[]='_users/rents';

        if( function_exists('pdxclearmycache') ){
            pdxclearmycache($pages);
        }

//    drupal_goto('user/'.$account->uid.'/edit', array());
//    drupal_set_message('<p><strong>Спасибо, что выбрали наш сервис!</strong></p><p>Пожалуйста, заполните информацию о себе. Не следует забывать, что чем полнее заполнена информация, тем больше доверия будут оказывать вам арендодатели и арендаторы.</p>', 'status', TRUE);

}
function pdxseparate_user_update(&$edit, $account, $category) {
    global $user;
    clearusercaches($account->uid);

    if( !isset($account->is_new) or !is_numeric($account->is_new) or $account->is_new!=1 ){
        
        if( !isset($account->original->field_delete['und'][0]['value']) or !isset( $account->field_delete['und'][0]['value'] ) or $account->original->field_delete['und'][0]['value'] != $account->field_delete['und'][0]['value'] ){

            $pages=array();
            if( isset($account->field_delete['und'][0]['value']) and $account->field_delete['und'][0]['value']==1 ){
        
                if( isset($account->mail) and strlen($account->mail) and valid_email_address($account->mail) and function_exists('pdxmail') ){
                    $usname='';
                    if( isset($account->field_name['und'][0]['value']) and strlen($account->field_name['und'][0]['value']) ){
                        $usname=', '.$account->field_name['und'][0]['value'];
                    }
                    $msg='<p>Здравствуй'.$usname.'.</p>';
                    $msg.='<p>Ты или кто-то другой только что удалил учетную запись "<a href="'.$GLOBALS['base_url'].'/user/'.$account->uid.'">'.$account->field_name['und'][0]['value'].'</a>" с сайта '.$GLOBALS['base_url'].'. Если это был не ты, восстанови учетную запись, и смени доступы к ней.</p>';
                    pdxmail($account->mail, $msg, 'Учетная запись удалена на сайте '.$GLOBALS['base_url']);
                }
        
                
                
            }
        
                $outs=db_query('select nid from {node} where status=1 and uid='.$account->uid);
                while( $out=$outs->fetchAssoc() ){
                    $path=path_load('node/'.$out['nid']);
                    if( isset($path['alias']) and strlen($path['alias'])){
                        $url='/'.$path['alias'];
                    }else{
                        $url='/node/'.$out['nid'];
                    }
                    $url=str_replace('//', '/', $url);
                    $pages[]=str_replace('/','_',$url);
                }
            if( function_exists('pdxclearmycache') ){
                pdxclearmycache($pages);
            }
        
        }

        if(isset($user->roles[3]) or isset($user->roles[4])){
            if( (!isset($account->original->field_bonus_vk_enter['und'][0]['value']) or $account->original->field_bonus_vk_enter['und'][0]['value']!=1) and isset($account->field_bonus_vk_enter['und'][0]['value']) and $account->field_bonus_vk_enter['und'][0]['value']==1 ){
                $params = array(
                    'uid' => $account->uid,
                    'points' => 30,
                    'operation' => 'pdx_bonus_vk_enter',
                );
                userpoints_userpointsapi($params);
            }
    
            if( (!isset($account->original->field_bonus_fb_enter['und'][0]['value']) or $account->original->field_bonus_fb_enter['und'][0]['value']!=1) and isset($account->field_bonus_fb_enter['und'][0]['value']) and $account->field_bonus_fb_enter['und'][0]['value']==1 ){
                $params = array(
                    'uid' => $account->uid,
                    'points' => 30,
                    'operation' => 'pdx_bonus_fb_enter',
                );
                userpoints_userpointsapi($params);
                
            }
            
        }
        
        
        $cleans=array();
        
        if( !isset( $account->field_rn['und'][0]['nid'] ) or !is_numeric( $account->field_rn['und'][0]['nid'] ) ){
            $nids=db_query('select n.nid from {node} as n inner join {field_data_field_rn} as f on (n.nid=f.entity_id and f.entity_type=\'node\') where n.uid='.$account->uid);
            while( $nid=$nids->fetchAssoc() ){
                db_query('delete from {field_data_field_rn} where entity_type=\'node\' and entity_id='.$nid['nid']);
                $cleans[$nid['nid']]=1;
            }
        }else{
            if( !isset($account->original->field_rn['und'][0]['nid']) or !is_numeric($account->original->field_rn['und'][0]['nid']) or $account->original->field_rn['und'][0]['nid']!=$account->field_rn['und'][0]['nid'] ){
                $nids=db_query('select n.nid, n.type, f.field_rn_nid from {node} as n left join {field_data_field_rn} as f on (n.nid=f.entity_id and f.entity_type=\'node\') where n.uid='.$account->uid);
                while( $nid=$nids->fetchAssoc() ){
                    if(!isset($nid['field_rn_nid'])){
                        db_query('insert into {field_data_field_rn} (entity_type, bundle, deleted, entity_id, revision_id, language, delta, field_rn_nid) values (\'node\', \''.$nid['type'].'\', 0, '.$nid['nid'].', '.$nid['nid'].', \'und\', 0, '.$account->field_rn['und'][0]['nid'].')');
                    }else{
                        db_query('update {field_data_field_rn} set field_rn_nid=:combo where entity_type=\'node\' and entity_id='.$nid['nid'], array(':combo' => $account->field_rn['und'][0]['nid'] ));
                    }
                    $cleans[$nid['nid']]=1;
                }
            }
        }
    
        if( !isset( $account->field_who['und'][0]['value'] ) or !is_numeric( $account->field_who['und'][0]['value'] ) ){
            $nids=db_query('select n.nid from {node} as n inner join {field_data_field_who} as f on (n.nid=f.entity_id and f.entity_type=\'node\') where n.uid='.$account->uid);
            while( $nid=$nids->fetchAssoc() ){
                db_query('delete from {field_data_field_who} where entity_type=\'node\' and entity_id='.$nid['nid']);
                $cleans[$nid['nid']]=1;
            }
        }else{
            if( !isset($account->original->field_who['und'][0]['value']) or !is_numeric($account->original->field_who['und'][0]['value']) or $account->original->field_who['und'][0]['value']!=$account->field_who['und'][0]['value'] ){
                $nids=db_query('select n.nid, n.type, f.field_who_value from {node} as n left join {field_data_field_who} as f on (n.nid=f.entity_id and f.entity_type=\'node\') where n.uid='.$account->uid);
                while( $nid=$nids->fetchAssoc() ){
                    if(!isset($nid['field_who_value'])){
                        db_query('insert into {field_data_field_who} (entity_type, bundle, deleted, entity_id, revision_id, language, delta, field_who_value) values (\'node\', \''.$nid['type'].'\', 0, '.$nid['nid'].', '.$nid['nid'].', \'und\', 0, '.$account->field_who['und'][0]['value'].')');
                    }else{
                        db_query('update {field_data_field_who} set field_who_value=:combo where entity_type=\'node\' and entity_id='.$nid['nid'], array(':combo' => $account->field_who['und'][0]['value'] ));
                    }
                    $cleans[$nid['nid']]=1;
                }
            }
        }    
        
        if( isset($cleans) and is_array($cleans) and count($cleans) ){
            foreach( $cleans as $nid=>$tmp ){
                cache_clear_all('field:node:' . $nid, 'cache_field', true);
            }
        }

    }

    $pages=array();

        if( function_exists('pdxupdateuserrat') ){
            pdxupdateuserrat($account->uid, 'field_rat1');
            pdxupdateuserrat($account->uid, 'field_rat2', 'field_userrat2', 'user2');
        }
        if( function_exists('htmlUserMap') ){
            htmlUserMap($account);
        }
                        
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid) ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid);
            }
        
    $path=path_load('user/'.$account->uid);
    if( isset($path['alias']) and strlen($path['alias'])){
        $url='/'.$path['alias'];
    }else{
        $url='/user/'.$account->uid;
    }
    $url=str_replace('//', '/', $url);
    $pages[]=str_replace('/','_',$url);

    $pages[]='_users_rents';

        if( function_exists('pdxclearmycache') ){
            pdxclearmycache($pages);
        }





}
function pdxseparate_user_presave(&$edit, $account, $category) {
    global $user;

    if( !isset($account->is_new) or !is_numeric($account->is_new) or $account->is_new!=1 ){

        if(isset($user->roles[3]) or isset($user->roles[4])){
        }else{
    
            if( isset($account->original->field_bonus_site['und'][0]['value']) and strlen($account->original->field_bonus_site['und'][0]['value']) ){
                if( !isset($account->field_bonus_site['und'][0]['value']) or !strlen($account->field_bonus_site['und'][0]['value']) or $account->original->field_bonus_site['und'][0]['value']!=$account->field_bonus_site['und'][0]['value'] ){
                    $edit['field_bonus_site']['und'][0]['value']=$account->original->field_bonus_site['und'][0]['value'];
                }
            }else{
                if( isset($account->field_bonus_site['und'][0]['value']) and strlen($account->field_bonus_site['und'][0]['value']) ){
                    $edit['field_bonus_site']['und'][0]['value']='';
                }
            }
    

            if( isset($account->original->field_bonus_vk_enter['und'][0]['value']) and is_numeric($account->original->field_bonus_vk_enter['und'][0]['value']) ){
                $edit['field_bonus_vk_enter']['und'][0]['value']=$account->original->field_bonus_vk_enter['und'][0]['value'];
            }else{
                $edit['field_bonus_vk_enter']['und'][0]['value']=0;
            }

            if( isset($account->original->field_bonus_fb_enter['und'][0]['value']) and is_numeric($account->original->field_bonus_fb_enter['und'][0]['value']) ){
                $edit['field_bonus_fb_enter']['und'][0]['value']=$account->original->field_bonus_fb_enter['und'][0]['value'];
            }else{
                $edit['field_bonus_fb_enter']['und'][0]['value']=0;
            }
    
        }

    }
      
    if( isset( $edit['field_bday']['und'][0]['value'] ) and strlen( $edit['field_bday']['und'][0]['value'] ) ){

        $date = date_create_from_format('Y-m-d', str_replace(' 00:00:00','',$edit['field_bday']['und'][0]['value']));
        
        $age=date('Y', time())-date_format($date, 'Y');
        if( date('n', time())<date_format($date, 'n') ){
            $age--;
        }elseif( date('n', time())==date_format($date, 'n') ){ 
            if( date('j', time())<date_format($date, 'j') ){
                $age--;
            }
        }
        
        if( isset($age) and is_numeric($age) and $age>0 ){
            $edit['field_bdaynum']['und'][0]['value']=$age;
        }
    }


        $allowed='<br><br/><p><a><hr><strong><ul><ol><li><em><div>';
        $allowed2=array('br','p','a','hr','strong','ul','ol','li','em','div');
        
        foreach( $edit as $id => $obj ){
        
            if( strpos($id, 'field_')===false ){}else{
                if( isset($obj) and is_array($obj) and count($obj) ){
                    foreach( $obj as $und => $arr ){
                        if( isset($arr) and is_array($arr) and count($arr) ){
                            foreach( $arr as $ind => $val ){
                                if( isset($val) and is_array($val) and count($val) and isset($val['value']) and strlen($val['value']) ){ 
                                    switch($id){
                                    case 'field_rent_apply6':
                                    case 'field_payments':
                                    case 'field_about':
                                        $edit[$id][$und][$ind]['value']=trim(filter_xss(strip_tags($edit[$id][$und][$ind]['value'], $allowed), $allowed2));
                                        break;
                                    default:
                                        $edit[$id][$und][$ind]['value']=trim(filter_xss(strip_tags($edit[$id][$und][$ind]['value'])));
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

    
    
//        $ct=taxonomy_term_load(PDX_CITY_ID);
        if( defined('PDX_CITY_NAME') ){
            
            $addrs=array();
            if( isset($edit['field_address']['und']) and is_array($edit['field_address']['und']) and count($edit['field_address']['und']) ){
                $addrs=$edit['field_address']['und'];
            }elseif( isset($account->field_address['und']) and is_array($account->field_address['und']) and count($account->field_address['und']) ){
                $addrs=$account->field_address['und'];
            }
            
            if( !isset( $addrs[0]['value'] ) or !strlen($addrs[0]['value']) ){
                $edit['field_latitude']['und']=array();
                $edit['field_latitude']['und'][0]['value']='';
                $edit['field_longitude']['und'][0]['value']='';
            }else{
                
                $precity=PDX_CITY_NAME;
                foreach( $addrs as $delta => $addr ){
    
                    $city=$addr['value'];
                    $params = array( 'geocode' => $precity.', '.$city, 'format'  => 'json', 'results' => 1, );
    
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_URL, 'https://geocode-maps.yandex.ru/1.x/?' . http_build_query($params));
        $data = curl_exec($ch);
        curl_close($ch);
    
        $response = json_decode($data);
    
                    unset($point);
                    if (isset($response->response->GeoObjectCollection->metaDataProperty->GeocoderResponseMetaData->found) and $response->response->GeoObjectCollection->metaDataProperty->GeocoderResponseMetaData->found > 0){
                        if(isset($response->response->GeoObjectCollection->featureMember[0]->GeoObject->Point->pos)){
                            $point=explode(' ', $response->response->GeoObjectCollection->featureMember[0]->GeoObject->Point->pos);
                        }
                    }
                    if(isset($point) and is_array($point) and count($point)==2){
                        $edit['field_latitude']['und'][$delta]['value']=$point[0];
                        $edit['field_longitude']['und'][$delta]['value']=$point[1];
                    }
                }
    
            }
            
            
//            $account->field_city['und'][0]=(array) $ct;
        }
    
    
    
    $num=db_query('select COUNT(n.nid) from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$account->uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    $num=$num->fetchAssoc();
    if( isset($num['COUNT(n.nid)']) and $num['COUNT(n.nid)']>1 ){
        $num=$num['COUNT(n.nid)'];
    }else{
        $num=0;
    }
    $edit['field_items_active']['und'][0]['value']=$num;
    
    $num=db_query('select COUNT(n.nid) from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') inner join {field_data_field_status} as s on (n.nid=s.entity_id and s.entity_type=\'node\') where n.status=1 and n.type=\'item\' and s.field_status_value=2 and n.uid='.$account->uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    $num=$num->fetchAssoc();
    if( isset($num['COUNT(n.nid)']) and $num['COUNT(n.nid)']>0 ){
        $num=$num['COUNT(n.nid)'];
    }else{
        $num=0;
    }
    $edit['field_items_prokat']['und'][0]['value']=$num;
    
    
    



}
function pdxseparate_user_delete($account) {

    if( function_exists('pdxcreate_dirty') ){
        pdxcreate_dirty('user');
    }

            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid) ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid);
            }
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid.'_sm') ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid.'_sm');
            }
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid.'_sm_needto') ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid.'_sm_needto');
            }
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid.'_item') ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid.'_item');
            }
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid.'_o') ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$account->uid.'_o');
            }



    $pages=array();
    $pages[]='_users/rents';

        if( function_exists('pdxclearmycache') ){
            pdxclearmycache($pages);
        }
    

}

function pdxgetuseritems($uid, $page, $pager_cat){

        $pager_items=12;
        $pager_page=$page;
        
        $acats=array();
        $aitems=array();
            
            if( $pager_cat>0 ){
                $isvid=db_query('select vid from {taxonomy_term_data} where tid='.$pager_cat);
                $isvid=$isvid->fetchAssoc();
                if( isset($isvid['vid']) and is_numeric($isvid['vid']) ){
                    switch($isvid['vid']){
                    case 2:
                        $ares=db_query('select n.nid from {node} as n inner join {field_data_taxonomy_catalog} as t on (n.nid=t.entity_id and t.entity_type=\'node\') left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$uid.' and t.taxonomy_catalog_tid='.$pager_cat.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
                        break;
                    default:
                        $ares=db_query('select n.nid from {node} as n inner join {field_data_field_subpart} as t on (n.nid=t.entity_id and t.entity_type=\'node\') left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$uid.' and t.field_subpart_tid='.$pager_cat.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
                    }
                }
                while( $are=$ares->fetchAssoc() ){
                    $aitems[$are['nid']]=1;
                }
            }else{
                $ares=db_query('select n.nid from {node} as n inner join {field_data_taxonomy_catalog} as t on (n.nid=t.entity_id and t.entity_type=\'node\') left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
                while( $are=$ares->fetchAssoc() ){
                    $aitems[$are['nid']]=1;
                }
            }
            $ares=db_query('select d.tid, d.name from {field_data_field_parts} as t inner join {taxonomy_term_data} as d on d.tid=t.field_parts_tid where t.entity_type=\'user\' and t.entity_id='.$uid);
            while( $are=$ares->fetchAssoc() ){
                $acats[$are['tid']]['name']=$are['name'];
            }
            $ares=db_query('select DISTINCT d.tid, d.name, p.field_part_tid from {node} as n inner join {field_data_field_subpart} as t on (n.nid=t.entity_id and t.entity_type=\'node\') inner join {taxonomy_term_data} as d on d.tid=t.field_subpart_tid inner join {field_data_field_part} as p on (p.entity_id=d.tid and p.entity_type=\'taxonomy_term\') left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
            while( $are=$ares->fetchAssoc() ){
                $acats[$are['field_part_tid']]['subparts'][$are['tid']]=$are['name'];
            }
    

        
        if( isset($aitems) and is_array($aitems) and count($aitems) ){
            krsort($aitems, SORT_NUMERIC);
            echo '<div id="itemofuseris" class="preitemofuser"><div id="itemofuser_'.$uid.'" class="itemofuser">';
            echo '<div class="itemofuser_title">Объявления арендодателя</div>';
            echo '<div class="itemofuser_expose">';
            echo '<span class="label">Раздел:</span>';
            echo '<select onchange=" jQuery(\'#itemofuser_content_'.$uid.'\').html(\'<img src=/sites/all/libraries/img/throbber.gif />\'); gotoshop('.$uid.', 1, jQuery(this).val());">
            <option value="0">Любой</option>
            ';
            if( isset($acats) and is_array($acats) and count($acats) ){
                asort($acats);
                foreach( $acats as $tid=>$obj ){
                    echo '<option value="'.$tid.'"';
                    if( $tid==$pager_cat ){
                        echo ' selected="selected"';
                    }
                    echo '>'.$obj['name'].'</option>';

                    if( isset($obj['subparts']) and is_array($obj['subparts']) and count($obj['subparts']) ){
                        foreach( $obj['subparts'] as $tid2=>$obj2 ){
                            if( isset($obj2) and strlen($obj2) ){
                                echo '<option value="'.$tid2.'"';
                                if( $tid2==$pager_cat ){
                                    echo ' selected="selected"';
                                }
                                echo '>---'.$obj2.'</option>';
                            }
                        }
                    }
                }
            }
            echo '</select>';
            echo '</div>';
            $countis=0;
            
            $pager_max=ceil(count($aitems)/$pager_items);
            
            echo '<div class="itemofuser_content" id="itemofuser_content_'.$uid.'">';
            foreach( $aitems as $ashop=>$title ){
                $countis++;
                
                $from=($pager_page-1)*$pager_items;
                $to=$pager_page*$pager_items;
                
                if( $countis<=$from ){
                    continue;
                }
                if( $countis>$to ){
                    continue;
                }
                
                
                echo '<div class="itemofuser_line itemofuser_line_'.$countis.'">';
                
                if( function_exists('pdxgetmyitem') ){
                    echo pdxgetmyitem($ashop);
                }
    
                echo '</div>';
            }
            echo '</div>';
            
            if( count($aitems)>$pager_items ){
                echo '<div class="itemofuser_pager">';
                echo '<div class="user_ontop"><a href="#itemofuseris">^ к началу</a></div>';
                echo '<span class="throbber"></span>';
                echo '<ul>';
                $i=1;
                if( $pager_page>1 ){
                    echo '<li class="prev"><span onclick="gotoshop('.$uid.', '.($pager_page-1).', '.$pager_cat.');">Предыдущая</span></li>';
                    if( $pager_page>5 ){
                        echo '<li>...</li>';
                        $i=$pager_page-5;
                    }
                }
                $maxis=$pager_max;
                if( ($maxis-$pager_page)>5 ){
                    $maxis=$pager_page+5;
                }
                
                for( $i; $i<=$maxis; $i++ ){
                    if( $i==$pager_page ){
                        echo '<li class="current"><span>'.$i.'</span></li>';
                    }else{
                        echo '<li class="item"><span onclick="gotoshop('.$uid.', '.$i.', '.$pager_cat.');">'.$i.'</span></li>';
                    }
                }
                if( $pager_page<$pager_max ){
                    if( ($pager_max-$pager_page)>5 ){
                        echo '<li>...</li>';
                    }
                    echo '<li class="next"><span onclick="gotoshop('.$uid.', '.($pager_page+1).', '.$pager_cat.');">Следующая</span></li>';
                }
                echo '</ul>';
                echo '</div>';
            }
            
            echo '</div>';
            echo '</div>';
        }
    
}

function pdxgetmyuser($uid){

    if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_item') and filectime('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_item')>(time()-376400) ){
        return @file_get_contents('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_item');
    }else{
        
    $path=path_load('user/'.$uid);
    if(strlen($path['alias'])) $path=$path['alias']; else $path='user/'.$uid;
    
    $out='';
    if( isset($uid) and is_numeric($uid) ){
        $usr=prepuser($uid);
        if( isset( $usr->uid ) and ( !isset( $usr->field_delete['und'][0]['value'] ) or $usr->field_delete['und'][0]['value']==0 ) ){
        
        $out.='<div class="user_item user_item_'.$usr->uid.'">';
        $out.= '<div class="image">';
        
        $out.='<a href="/'.$path.'">';
        if( isset($usr->field_company_logo['und'][0]['fid']) and strlen($usr->field_company_logo['und'][0]['fid']) ){
            $uri = file_load($usr->field_company_logo['und'][0]['fid'])->uri;
            $uri = image_style_url('logo', $uri);
            if(isset($uri) and strlen($uri)){
                $out.='<img alt="" class="lazy" data-original="'.$uri.'" />';
            }
        }else{
            if(isset($usr->picture->uri) and strlen($usr->picture->uri)){
                $uri = image_style_url('userbg', $usr->picture->uri);
                if(isset($uri) and strlen($uri)){
                    $out.='<img alt="" class="lazy" data-original="'.$uri.'" />';
                }
            }else{
                $out.='<img alt="" class="lazy" data-original="'.PDX_IMGPATH.'/img/user_def.png" />';
            }
        }
        $out.='</a>';
    
        $out.='</div>';
    
        $out.='<div class="user_item_right">';

        
        if( isset( $usr->field_userrat['und'][0]['value'] ) and is_numeric($usr->field_userrat['und'][0]['value']) and $usr->field_userrat['und'][0]['value']>0 ){
                    $usr->field_userrat['und'][0]['value']=intval($usr->field_userrat['und'][0]['value']/10);
                    $out.= '<div class="user_rat">';
                    if( $usr->field_userrat['und'][0]['value']>=1 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                    }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
        
                    if( $usr->field_userrat['und'][0]['value']>=2 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                    }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
        
                    if( $usr->field_userrat['und'][0]['value']>=3 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                    }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
        
                    if( $usr->field_userrat['und'][0]['value']>=4 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                    }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
        
                    if( $usr->field_userrat['und'][0]['value']>=5 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                    }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
        
                    if( $usr->field_userrat['und'][0]['value']>=6 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                    }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
        
                    if( $usr->field_userrat['und'][0]['value']>=7 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                    }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
        
                    if( $usr->field_userrat['und'][0]['value']>=8 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                    }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
        
                    if( $usr->field_userrat['und'][0]['value']>=9 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                    }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
        
                    if( $usr->field_userrat['und'][0]['value']==10 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                    }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
        
                    $out.= '</div>';
        }else{
            $out.= '<div class="user_rat">&nbsp;</div>';
        }

        $out.='<div class="user_item_icons">';
        $out.= '<div class="user_item_icon"><div class="favbutton favbutton_user fav_user_'.$usr->uid.'" style="display: none;"><span class="fv" onclick="favswitch(\'user\', '.$usr->uid.');">&nbsp;</span></div></div>';

        if( isset($usr->field_who['und'][0]['value']) and is_numeric($usr->field_who['und'][0]['value']) and $usr->field_who['und'][0]['value']>0 ){

                    $out.= '<div class="user_item_icon"><a class="item_user_who" target="_blank" href="'.url('user/'.$usr->uid, array('absolute'=>TRUE)).'"><img alt="" src="'.PDX_IMGPATH.'/img/';
                    $name=db_query('select field_name_value from {field_data_field_name} where entity_type=\'user\' and entity_id='.$usr->uid);
                    $name=$name->fetchAssoc();
                    switch($usr->field_who['und'][0]['value']){
                    case 2:
                        $out.='item_yur.png" title="Компания';
                        if( isset($name['field_name_value']) and strlen($name['field_name_value']) ){
                            $name2=db_query('select field_company_name_value from {field_data_field_company_name} where entity_type=\'user\' and entity_id='.$usr->uid);
                            $name2=$name2->fetchAssoc();
                            if( isset($name['field_company_name_value']) and strlen($name['field_company_name_value']) ){
                                $out.=' '.str_replace('"', '', $name['field_company_name_value']);
                            }else{
                                $out.=' '.str_replace('"', '', $name['field_name_value']);
                            }
                        }
                        break;
                    default:
                        $out.='item_fiz.png" title="Частное лицо';
                        if( isset($name['field_name_value']) and strlen($name['field_name_value']) ){
                            $out.=' '.str_replace('"', '', $name['field_name_value']);
                        }
                    }
                    $out.= '" /></a></div>';


            if( $usr->field_who['und'][0]['value']==2 and isset( $usr->field_address['und'][0]['value'] ) and strlen( $usr->field_address['und'][0]['value'] ) and isset($usr->field_longitude['und'][0]['value']) and strlen($usr->field_longitude['und'][0]['value']) and isset($usr->field_latitude['und'][0]['value']) and strlen($usr->field_latitude['und'][0]['value']) ){
                $usr->field_address['und'][0]['value']=filter_xss(strip_tags($usr->field_address['und'][0]['value']));
                $out.= '<div class="user_item_icon" onclick=" showmap('.$usr->uid.'); "><img alt="" src="'.PDX_IMGPATH.'/img/pointmap.png" title="Посмотреть на карте" /></div>';
            }
        }
        if(isset($usr->roles[8])){ 
            $out.= '<div class="user_item_icon"><img alt="" title="Gold-аккаунт" src="'.PDX_IMGPATH.'/img/trophy_sm.png" /></div>';
        }

        $out.='</div>';

        
                $out.= '<div class="user_item_nids">';
                if( isset($usr->field_items_active['und'][0]['value']) and is_numeric($usr->field_items_active['und'][0]['value']) and $usr->field_items_active['und'][0]['value']>1 ){
                    $out.= '<span class="slink" onclick=" smmi('.$usr->uid.');">';
                    if( function_exists('pdxnumfoot') ){
                        $out.= pdxnumfoot($usr->field_items_active['und'][0]['value'], 'объявление', 'объявлений', 'объявления');
                    }else{
                        $out.= $usr->field_items_active['und'][0]['value'].' объявления';
                    }
    /*
                    if( isset($usr->field_items_prokat['und'][0]['value']) and is_numeric($usr->field_items_prokat['und'][0]['value']) and $usr->field_items_prokat['und'][0]['value']>0 ){
                        $out.= '<br />';
                        $out.= $usr->field_items_prokat['und'][0]['value'];
                        $out.= ' сейчас в прокате';
                    }
    */
                    $out.= '</span>';
                }else{
                    $out.= '&nbsp;';
                }
                $out.= '</div>';
                
                if( isset($usr->field_parts['und']) and is_array($usr->field_parts['und']) and count($usr->field_parts['und']) ){
                    $anm=array();
                    foreach( $usr->field_parts['und'] as $part ){
                        $name=db_query('select name from {taxonomy_term_data} where tid='.$part['tid']);
                        $name=$name->fetchAssoc();
                        if( isset($name['name']) and strlen($name['name']) ){
                            $anm[]=$name['name'];
                        }
                    }
                    if( isset($anm) and is_array($anm) and count($anm) ){ 
                        $out.= '<div class="parts">'.implode(', ', $anm).'</div>';
                    }
                }
    
            $out.='</div>';
            $out.='<div class="clear">&nbsp;</div>';
            $out.= '<div class="title admlnk pdxobj'.$usr->uid.' pdxou pdxpp"><a href="/'.$path.'" class="isuser'.$usr->uid.'">';
            if( isset( $usr->field_name['und'][0]['value'] ) and strlen($usr->field_name['und'][0]['value']) ){
                $out.= $usr->field_name['und'][0]['value'];
            }
            if( isset($usr->field_company_name['und'][0]['value']) and strlen($usr->field_company_name['und'][0]['value']) ){
                $out.= ' ('.$usr->field_company_name['und'][0]['value'].')';
            }
            $out.= '</a><span title="offline" class="ustat ustat_'.$usr->uid.'"></span></div>';
            $out.='</div>';
        }else{
            $out.='<div class="inmod">Профиль временно удален</div>';
            $out.= '<div class="favbutton favbutton_user fav_user_'.$usr->uid.'" style="display: none;"><span class="fv" onclick="favswitch(\'user\', '.$usr->uid.');">&nbsp;</span><a target="_blank" href="http://'.PDX_URL_HELP.'/izbrannye-polzovateli.html" class="smhelp">&nbsp;</a></div>';
        }
    }
    
        if( isset($out) and strlen($out) ){
            $fp=fopen('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_item', "w");
            if($fp){
                fwrite($fp, $out); fclose($fp);
            }
            return $out;
        }
    
    
    }
}
function pdxgetmyitem($nid, $nd=false){
    global $user;
    $out='';
    if( isset($nd->nid) ){}else{
        $out=pdxcr('item', $nid, 1);
    }
    if( strlen($out) ){
        return $out;
    }else{
    
        $out='';
        
        
        $path=path_load('node/'.$nid); if(strlen($path['alias'])) $path=$path['alias']; else $path='node/'.$nid;
        
        if( !isset($nd->nid) ){
            $nd=node_load($nid);
        }
        if( !isset($nd->nid) ){
            return;
        }
        
        $out.= '<div id="item_nid_'.$nid.'" class="item_uid_'.$nd->uid.' item';
        if( isset($nd->field_status['und'][0]['value']) and is_numeric($nd->field_status['und'][0]['value']) and $nd->field_status['und'][0]['value']==2 ){
            $out.= ' item_offline';
        }
        if( isset($nd->sticky) and is_numeric($nd->sticky) and $nd->sticky==1 ){
            $out.= ' item_sticky';
        }
        $out.= '">';
        
        $num=db_query('select field_delete_value from {field_data_field_delete} where entity_type=\'user\' and entity_id='.$nd->uid);
        $num=$num->fetchAssoc();
        if( isset($num['field_delete_value']) and $num['field_delete_value']==1 ){
            $out.= '<div class="inmod">Извините, <br />аккаунт временно удален</div>';
        }else{
        if( $nd->status==1 ){
        if( isset($nd->field_delete['und'][0]['value']) and $nd->field_delete['und'][0]['value']==1 ){
            $out.= '<div class="inmod">Извините, <br />объявление <span>'.$nd->title.'</span> удалено автором</div>';
        }elseif( isset($nd->field_block['und'][0]['value']) and $nd->field_block['und'][0]['value']==1 ){
            $out.= '<div class="inmod">Извините, <br />объявление <span>'.$nd->title.'</span> заблокировано модератором</div>';
        }else{
        if( isset($nd->field_who['und'][0]['value']) and is_numeric($nd->field_who['und'][0]['value']) ){
                    $out.= '<a class="item_user_who" target="_blank" href="'.url('user/'.$nd->uid, array('absolute'=>TRUE)).'"><img alt="" src="'.PDX_IMGPATH.'/img/';
                    $name=db_query('select field_name_value from {field_data_field_name} where entity_type=\'user\' and entity_id='.$nd->uid);
                    $name=$name->fetchAssoc();
                    switch($nd->field_who['und'][0]['value']){
                    case 2:
                        $out.='item_yur.png" title="Компания';
                        if( isset($name['field_name_value']) and strlen($name['field_name_value']) ){
                            $name2=db_query('select field_company_name_value from {field_data_field_company_name} where entity_type=\'user\' and entity_id='.$nd->uid);
                            $name2=$name2->fetchAssoc();
                            if( isset($name['field_company_name_value']) and strlen($name['field_company_name_value']) ){
                                $out.=' '.str_replace('"', '', $name['field_company_name_value']);
                            }else{
                                $out.=' '.str_replace('"', '', $name['field_name_value']);
                            }
                        }
                        break;
                    default:
                        $out.='item_fiz.png" title="Частное лицо';
                        if( isset($name['field_name_value']) and strlen($name['field_name_value']) ){
                            $out.=' '.str_replace('"', '', $name['field_name_value']);
                        }
                    }
                    $out.= '" /></a>';
        }
/*
        $allimgs=array();
        if(isset($nd->field_image['und'][0]['uri']) and strlen($nd->field_image['und'][0]['uri'])){
            foreach( $nd->field_image['und'] as $img ){
                $uri = image_style_url('news_preview', $img['uri']);
                if(isset($uri) and strlen($uri)){
                    $allimgs[]='<div class="swiper-slide"><img alt="" src="'.$uri.'" /></div>';
                }
            }
        }
        if( isset( $allimgs ) and is_array( $allimgs ) and count( $allimgs ) ){
                $out.='<div class="image swiper-container swiper-container-item swiper-container-item-'.$nid.'"><div class="swiper-wrapper">'.implode('', $allimgs).'</div><div class="swiper-pagination swiper-pagination-item swiper-pagination-item-'.$nid.'"></div></div>';
        }
*/ 
        $out.='<div class="image"><a href="'.$GLOBALS['base_url'].'/'.$path.'">';
        if(isset($nd->field_image['und'][0]['fid']) and strlen($nd->field_image['und'][0]['fid'])){
            $uri = file_load($nd->field_image['und'][0]['fid'])->uri;
            $uri = image_style_url('news_preview', $uri);
            if(isset($uri) and strlen($uri)){
                $out.='<img alt="" class="lazy" data-original="'.$uri.'" />';
            }else{
                $out.='<img alt="" class="lazy" data-original="'.PDX_IMGPATH.'/img/notfound.png" />';
            }
        }else{
            $out.='<img alt="" class="lazy" data-original="'.PDX_IMGPATH.'/img/noimage.png" />';
        }
        $out.='</a></div>';
        
        $out.= '<div class="title admlnk pdxobj'.$nid.' pdxona pdxpp">';
        if( isset( $nd->title ) and strlen( $nd->title ) ){
            $ttl='';
            if( mb_strlen($nd->title)>63 ){
                $ttl=' title="'.str_replace('"', '', $nd->title).'"';
                $nd->title=mb_substr($nd->title, 0, 61).'..';
            }
            $out.= '<a href="'.$GLOBALS['base_url'].'/'.$path.'"'.$ttl.' class="isitemtitle">'.$nd->title.'</a>';
        }
        $out.= '</div>';


        $aparts=array();
        if( isset( $nd->taxonomy_catalog['und'][0]['tid'] ) and is_numeric( $nd->taxonomy_catalog['und'][0]['tid'] ) ){
            if( isset( $nd->field_brand['und'][0]['tid'] ) and is_numeric( $nd->field_brand['und'][0]['tid'] ) ){
                $name=db_query('select name from {taxonomy_term_data} where tid='.$nd->field_brand['und'][0]['tid']);
                $name=$name->fetchAssoc();
                if( isset($name['name']) and strlen($name['name']) ){
                    $aparts[]= '<a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$nd->taxonomy_catalog['und'][0]['tid'].'?field_brand='.$nd->field_brand['und'][0]['tid'].'">'.$name['name'].'</a>';
                }
            }
            $name=db_query('select name from {taxonomy_term_data} where tid='.$nd->taxonomy_catalog['und'][0]['tid']);
            $name=$name->fetchAssoc();
            if( isset($name['name']) and strlen($name['name']) ){
                $aparts[]= '<a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$nd->taxonomy_catalog['und'][0]['tid'].'">'.$name['name'].'</a>';
            }
            if( isset( $nd->field_subpart['und'][0]['tid'] ) and is_numeric( $nd->field_subpart['und'][0]['tid'] ) ){
                $name=db_query('select name from {taxonomy_term_data} where tid='.$nd->field_subpart['und'][0]['tid']);
                $name=$name->fetchAssoc();
                if( isset($name['name']) and strlen($name['name']) ){
                    $aparts[]= '<a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$nd->taxonomy_catalog['und'][0]['tid'].'/'.$nd->field_subpart['und'][0]['tid'].'">'.$name['name'].'</a>';
                }
                if( isset( $nd->field_tags['und'][0]['tid'] ) and is_numeric( $nd->field_tags['und'][0]['tid'] ) ){
                    $name=db_query('select name from {taxonomy_term_data} where tid='.$nd->field_tags['und'][0]['tid']);
                    $name=$name->fetchAssoc();
                    if( isset($name['name']) and strlen($name['name']) ){
                        $aparts[]= '<a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$nd->taxonomy_catalog['und'][0]['tid'].'/'.$nd->field_subpart['und'][0]['tid'].'/'.$nd->field_tags['und'][0]['tid'].'">'.$name['name'].'</a>';
                    }
                }
            }
        }
        if( isset($aparts) and is_array($aparts) and count($aparts) ){
            $out.= '<div class="parts">';
            $out.= implode('&nbsp;/ ', $aparts);
            $out.= '</div>';
        }

        
        $out.= '<div class="price">';
        
        $price1=$price2=$price3=$price4=$yesprice=$pricelen=0;
        if( isset($nd->field_price_month['und'][0]['value']) and is_numeric($nd->field_price_month['und'][0]['value']) ){
            $price4=$nd->field_price_month['und'][0]['value'];
            $price3=round($nd->field_price_month['und'][0]['value']/4, 2);
            $pricelen=strlen(number_format($price3, 2, '.', ' '));
            $price2=round($nd->field_price_month['und'][0]['value']/30, 2);
            $price1=round($price2/24, 2);
            $yesprice=1;
        }
        if( isset($nd->field_price_week['und'][0]['value']) and is_numeric($nd->field_price_week['und'][0]['value']) ){
            $price3=$nd->field_price_week['und'][0]['value'];
            $pricelen=strlen(number_format($price3, 2, '.', ' '));
            $price2=round($nd->field_price_week['und'][0]['value']/7, 2);
            if( !isset($price4) or !is_numeric($price4) or $price4<1 ){
                $price4=$price2*30;
            }
            $price1=round($price2/24, 2);
            $yesprice=1;
        }
        if( isset($nd->field_price_day['und'][0]['value']) and is_numeric($nd->field_price_day['und'][0]['value']) ){
            $price2=$nd->field_price_day['und'][0]['value'];
            if( !isset($price4) or !is_numeric($price4) or $price4<1 ){
                $price4=$price2*30;
            }
            if( !isset($price3) or !is_numeric($price3) or $price3<1 ){
                $price3=$price2*7;
                $pricelen=strlen(number_format($price3, 2, '.', ' '));
            }
            $price1=round($price2/24, 2);
            $yesprice=1;
        }
        if( isset($nd->field_price_hour['und'][0]['value']) and is_numeric($nd->field_price_hour['und'][0]['value']) ){
            $price1=$nd->field_price_hour['und'][0]['value'];
            if( !isset($price2) or !is_numeric($price2) or $price2<1 ){
                $price2=$price1*24;
            }
            if( !isset($price4) or !is_numeric($price4) or $price4<1 ){
                $price4=$price2*30;
            }
            if( !isset($price3) or !is_numeric($price3) or $price3<1 ){
                $price3=$price2*7;
                $pricelen=strlen(number_format($price3, 2, '.', ' '));
            }
            $yesprice=1;
        }
        if( isset($nd->field_price_min['und'][0]['value']) and is_numeric($nd->field_price_min['und'][0]['value']) ){
            if( $nd->field_price_min['und'][0]['value']>23 ){
                $price1=0;
                if( $nd->field_price_min['und'][0]['value']>167 ){
                    $price2=0;
                    if( $nd->field_price_min['und'][0]['value']>719 ){
                        $price3=0;
                    }
                }
            }
        }
        
        $sign='';
        if( defined('PDX_CITY_CUR') ){
            $sign=PDX_CITY_CUR;
        }
        
        if( isset( $nd->field_cur['und'][0]['value'] ) and $nd->field_cur['und'][0]['value']>1 ){
            switch($nd->field_cur['und'][0]['value']){
            case 2:
                $sign='$';
                break;
            default:
                $sign='€';
            }
        }
        if( strlen($sign) ){
            $sign='<span class="signcur">'.$sign.'</span>';
        }
        
        
        if( $yesprice ){
            
            if( isset($price1) and is_numeric($price1) and $price1>0 ){
                if( isset( $nd->field_cur['und'][0]['value'] ) and $nd->field_cur['und'][0]['value']>1 ){
                    switch( $nd->field_cur['und'][0]['value'] ){
                    case 2:
                        $out.= '<div class="price1"><strong class="isprice">';
                        break;
                    default:
                        $out.= '<div class="price1"><strong class="isprice2">';
                    }
                }else{
                    $out.= '<div class="price1"><strong>';
                }
                $tmponly=number_format($price1, 2, '.', ' ').'</strong>';
/*
                if( $pricelen>0 and $pricelen>strlen($tmponly) ){
                    switch($pricelen-strlen($tmponly)){
                    case 10: $out.= '&nbsp;';
                    case 9: $out.= '&nbsp;';
                    case 8: $out.= '&nbsp;';
                    case 7: $out.= '&nbsp;';
                    case 6: $out.= '&nbsp;';
                    case 5: $out.= '&nbsp;';
                    case 4: $out.= '&nbsp;';
                    case 3: $out.= '&nbsp;';
                    case 2: $out.= '&nbsp;';
                    case 1: $out.= '&nbsp;';
                    }
                }
*/
                $out.= $tmponly;
                $out.= ' '.$sign;
                $out.= ' / час</div>';
            }else{
                $out.= '<div class="price0"><strong>';
/*
                if( $pricelen>0 and $pricelen>1 ){
                    switch($pricelen-1){
                    case 10: $out.= '&nbsp;';
                    case 9: $out.= '&nbsp;';
                    case 8: $out.= '&nbsp;';
                    case 7: $out.= '&nbsp;';
                    case 6: $out.= '&nbsp;';
                    case 5: $out.= '&nbsp;';
                    case 4: $out.= '&nbsp;';
                    case 3: $out.= '&nbsp;';
                    case 2: $out.= '&nbsp;';
                    case 1: $out.= '&nbsp;';
                    }
                }
*/
                $out.= '-</strong>';
                $out.= ' / час</div>';
            }
            if( isset($price2) and is_numeric($price2) and $price2>0 ){
                if( isset( $nd->field_cur['und'][0]['value'] ) and $nd->field_cur['und'][0]['value']>1 ){
                    switch( $nd->field_cur['und'][0]['value'] ){
                    case 2:
                        $out.= '<div class="price1"><strong class="isprice">';
                        break;
                    default:
                        $out.= '<div class="price1"><strong class="isprice2">';
                    }
                }else{
                    $out.= '<div class="price1"><strong>';
                }
                $tmponly=number_format($price2, 2, '.', ' ').'</strong>';
/*
                if( $pricelen>0 and $pricelen>strlen($tmponly) ){
                    switch($pricelen-strlen($tmponly)){
                    case 10: $out.= '&nbsp;';
                    case 9: $out.= '&nbsp;';
                    case 8: $out.= '&nbsp;';
                    case 7: $out.= '&nbsp;';
                    case 6: $out.= '&nbsp;';
                    case 5: $out.= '&nbsp;';
                    case 4: $out.= '&nbsp;';
                    case 3: $out.= '&nbsp;';
                    case 2: $out.= '&nbsp;';
                    case 1: $out.= '&nbsp;';
                    }
                }
*/
                $out.= $tmponly;
                $out.= ' '.$sign;
                $out.= ' / день</div>';
            }else{
                $out.= '<div class="price0"><strong>';
/*
                if( $pricelen>0 and $pricelen>1 ){
                    switch($pricelen-1){
                    case 10: $out.= '&nbsp;';
                    case 9: $out.= '&nbsp;';
                    case 8: $out.= '&nbsp;';
                    case 7: $out.= '&nbsp;';
                    case 6: $out.= '&nbsp;';
                    case 5: $out.= '&nbsp;';
                    case 4: $out.= '&nbsp;';
                    case 3: $out.= '&nbsp;';
                    case 2: $out.= '&nbsp;';
                    case 1: $out.= '&nbsp;';
                    }
                }
*/
                $out.= '-</strong>';
                $out.= ' / день</div>';
            }
            if( isset($price3) and is_numeric($price3) and $price3>0 ){
                if( isset( $nd->field_cur['und'][0]['value'] ) and $nd->field_cur['und'][0]['value']>1 ){
                    switch( $nd->field_cur['und'][0]['value'] ){
                    case 2:
                        $out.= '<div class="price1"><strong class="isprice">';
                        break;
                    default:
                        $out.= '<div class="price1"><strong class="isprice2">';
                    }
                }else{
                    $out.= '<div class="price1"><strong>';
                }

                $out.= number_format($price3, 2, '.', ' ').'</strong>';
                $out.= ' '.$sign;
                $out.= ' / неделю</div>';
            }else{
                if( isset($price4) and is_numeric($price4) and $price4>0 ){
                    if( isset( $nd->field_cur['und'][0]['value'] ) and $nd->field_cur['und'][0]['value']>1 ){
                        switch( $nd->field_cur['und'][0]['value'] ){
                        case 2:
                            $out.= '<div class="price1"><strong class="isprice">';
                            break;
                        default:
                            $out.= '<div class="price1"><strong class="isprice2">';
                        }
                    }else{
                        $out.= '<div class="price1"><strong>';
                    }
    
                    $out.= number_format($price4, 2, '.', ' ').'</strong>';
                    $out.= ' '.$sign;
                    $out.= ' / месяц</div>';
                }else{
                    echo '<div class="price1">&nbsp;</div>';
                }

            }
            
        }else{
            $out.= '<strong>цену уточняйте</strong>';
        }
        if( isset($nd->field_price_min['und'][0]['value']) and is_numeric($nd->field_price_min['und'][0]['value']) ){
            $suffix= 'ч';
            if( $nd->field_price_min['und'][0]['value']>23 ){
                $nd->field_price_min['und'][0]['value']=round($nd->field_price_min['und'][0]['value']/24, 0);
                $suffix= 'дней';
                if( $nd->field_price_min['und'][0]['value']==1 ){
                    $suffix= 'дня';
                }
            }
            if( $nd->field_price_min['und'][0]['value']>29 ){
                $nd->field_price_min['und'][0]['value']=round($nd->field_price_min['und'][0]['value']/30, 0);
                $suffix= 'месяца';
            }
            $out.= '<div class="price_from">Аренда от '.$nd->field_price_min['und'][0]['value'].' '.$suffix;
            $out.= '</div>';
        }
        
        $out.= '</div>';
        if( isset($nd->field_status['und'][0]['value']) and is_numeric($nd->field_status['und'][0]['value']) and $nd->field_status['und'][0]['value']==2 ){
            $out.= '<div class="item_offline_text';
            $out.= '">В прокате';
            if( isset($nd->field_datend['und'][0]['value']) and strlen($nd->field_datend['und'][0]['value']) ){
                $nd->field_datend['und'][0]['value']=str_replace(' 00:00:00','',$nd->field_datend['und'][0]['value']);
                $eventdate=strtotime($nd->field_datend['und'][0]['value']);
                if( isset($eventdate) and is_numeric($eventdate) and $eventdate>0 and $eventdate>time() ){
                    $out.= '<span class="item_offline_text_dt item_offline_text_dt_'.$eventdate.'"> до '.$nd->field_datend['und'][0]['value'].'</span>';
                }
            }
            $out.= '</div>';
        }
        }
        }else{
            $out.= '<div class="inmod">Извините, <br />объявление <span>'.$nd->title.'</span> на модерации</div>';
        }
        }        
        $out.= '<div class="favbutton favbutton_item fav_node_'.$nid.'" style="display: none;"><span class="fv" onclick="favswitch(\'node\', '.$nid.');" title="В избранное">&nbsp;</span></div>';
        $out.= '<div class="clear">&nbsp;</div></div>';

        if( isset($out) and strlen($out) ){
            pdxcw('item', $nid, $out, 1);


            return $out;
        }
    
    
    }
    
}
function pdxgetemailtitle($name){
    return $name.' отправил(а) вам сообщение с сайта '.$GLOBALS['base_url'].' (прокат нужных вещей)';
}
function pdxupdateuserrat($uid, $rat, $field='field_userrat', $us='user1'){
    $count=0;
    $avg=0;
    
        $cmts=db_query('select t.'.$rat.'_value from {field_data_'.$rat.'} as t inner join {field_data_field_'.$us.'} as r on (t.entity_id=r.entity_id and r.entity_type=\'node\') inner join {node} as n on n.nid=t.entity_id where n.status=1 and n.type=\'deal\' and t.entity_type=\'node\' and r.field_'.$us.'_uid='.$uid);
        while( $cmt=$cmts->fetchAssoc() ){
            $count++;
            $avg+=$cmt[$rat.'_value']*20;
        }
        if( $count>0 ){
            $avg=intval($avg/$count);
            
            $hit=db_query('select '.$field.'_value from {field_data_'.$field.'} where entity_type=\'user\' and entity_id='.$uid);
            $hit=$hit->fetchAssoc();
            if(!isset($hit[$field.'_value'])){
                db_query('insert into {field_data_'.$field.'} (entity_type, bundle, deleted, entity_id, revision_id, language, delta, '.$field.'_value) values (\'user\', \'user\', 0, '.$uid.', '.$uid.', \'und\', 0, '.$avg.')');
            }else{
                db_query('update {field_data_'.$field.'} set '.$field.'_value=:combo where entity_id='.$uid, array(':combo' => $avg ));
            }
            
            cache_clear_all('field:user:' . $uid, 'cache_field', true);
            
        }    
}


function prepuser($uid, $all=1){
    if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_o') and filesize('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_o') and file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_o_needto') and filesize('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_o_needto') ){
        $mass1=unserialize(@file_get_contents('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_o'));
        if( !$all ){
            return $mass1;
        }
        $mass2=unserialize(@file_get_contents('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_o_needto'));
        foreach( $mass2 as $field=>$val ){
            $mass1->{$field}=$mass2->{$field};
        }
        return $mass1;
    }
    $usr=user_load($uid);
    if( defined('PDX_PROFILE') and strlen(PDX_PROFILE) ){
        $outprofile=unserialize(PDX_PROFILE);
        if( isset($outprofile) and is_array($outprofile) and count($outprofile) ){
            $mass1= new stdClass();
            $mass2= new stdClass();
            foreach( $usr as $field=>$val ){
                if(strlen($field)){
                    if( isset( $outprofile[$field] ) ){
                        $mass1->{$field}=$usr->{$field};
                    }else{
                        $mass2->{$field}=$usr->{$field};
                    }
                }
            }

            
            $fp=fopen('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_o', "w");
            if($fp){
                fwrite($fp, serialize($mass1) ); fclose($fp);
            }
            $fp=fopen('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_o_needto', "w");
            if($fp){
                fwrite($fp, serialize($mass2) ); fclose($fp);
            }
        }
    }
    return $usr;
}

function setlastnew(){
    if( defined('PDX_CITY_ID') and is_numeric(PDX_CITY_ID) ){
        $anids=$anids2=array();
        $nums=db_query('select n.nid from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_delete} as fd2 on (n.uid=fd2.entity_id and fd2.entity_type=\'user\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fd2.field_delete_value IS NULL or fd2.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 ) order by n.nid desc limit 0,4');
        while( $num=$nums->fetchAssoc() ){
            $anids[]=$num['nid'];
        }
        pdxcw('vars', PDX_CITY_ID.'_items_new', serialize($anids), 1);

        if( function_exists('pdxcreate_dirty') ){
            pdxcreate_dirty('new');
        }

    }
}
function setrecall(){
    if( defined('PDX_CITY_ID') and is_numeric(PDX_CITY_ID) ){
        $anids=array();
        $nums=db_query('select n.nid from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_delete} as fd2 on (n.uid=fd2.entity_id and fd2.entity_type=\'user\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.sticky=1 and n.type=\'item\' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fd2.field_delete_value IS NULL or fd2.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 ) order by n.nid desc');
        while( $num=$nums->fetchAssoc() ){
            $anids[]=$num['nid'];
        }
        pdxcw('vars', PDX_CITY_ID.'_items_rec', serialize($anids), 1);
    }
}
/* обновление картинок объявлений */
function updateuseritemimgs($uid){
    if( !is_dir('html/'.PDX_CITY_ID) ){
        mkdir('html/'.PDX_CITY_ID);
    }
    if( !is_dir('html/'.PDX_CITY_ID.'/userimgs') ){
        mkdir('html/'.PDX_CITY_ID.'/userimgs');
    }
    $username='';
    $count=0;
    
    $num=db_query('select f1.field_name_value, f2.field_company_name_value from {field_data_field_name} as f1 left join {field_data_field_company_name} as f2 on (f1.entity_id=f2.entity_id and f2.entity_type=\'user\') where f1.entity_type=\'user\' and f1.entity_id='.$uid);
    $num=$num->fetchAssoc();
    if( isset($num['field_name_value']) and strlen($num['field_name_value']) ){
        $username= $num['field_name_value'];
        if( isset($num['field_company_name_value']) and strlen($num['field_company_name_value']) ){
            $username= $num['field_company_name_value'].' ('.$username.')';
        }
    }
    $out='';
    
    $nums=db_query('select n.title, n.nid, i.field_image_fid from {node} as n left join {field_data_field_image} as i on (n.nid=i.entity_id and i.entity_type=\'node\' and i.delta=0) left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    while( $num=$nums->fetchAssoc() ){
        $count++;

        $file = file_load($num['field_image_fid']);
        if( isset( $file->uri ) and strlen( $file->uri ) ){
            $img=image_style_url('news_preview', $file->uri);
        }
        if( !isset($img) or !strlen($img) ){
            $img=PDX_IMGPATH.'/img/noimage.png';
        }
        $out.='<div class="itemimgel"><a href="'.url('node/'.$num['nid'], array('absolute'=>TRUE)).'"><span class="ttl">'.$num['title'].'</span><img alt="" src="'.$img.'" /></a></div>';
    }
    
    
    
    
    $fp = fopen('html/'.PDX_CITY_ID.'/userimgs/'.$uid.'.htm', 'w'); fwrite($fp, '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru" dir="ltr"><head><title>Аренда вещей без проблем</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body id="start"><div class="inlinebodydiv" id="showuserimgs'.$uid.'" style="display: none;"><img class="closeimg" onclick=" jQuery(this).parent().hide(); " alt="x" src="'.PDX_IMGPATH.'/img/ico_close.png" /><div class="inlinetitle"><div class="inlinetitlein"><a href="'.url('user/'.$uid, array('absolute'=>TRUE)).'">Объявления пользователя '.$username.' <span>('.$count.' шт.)</span></a></div></div><div class="sharehtml sharehtmlp"><div class="ttl">Поделиться фотографиями на своем сайте (HTML): (<a target="_blank" href="http://'. $_SERVER['HTTP_HOST'].'/html/'.PDX_CITY_ID.'/share/userpic/'. $uid.'.htm">см. как выглядит</a>)</div>
<div class="sharehtmlmn">
<input type="text" value=\'<iframe width="100%" height="537" src="http://'. $_SERVER['HTTP_HOST'].'/html/'.PDX_CITY_ID.'/share/userpic/'. $uid.'.htm" frameborder="0"></iframe>\' onclick=" jQuery(this).select(); " />
</div>
</div><div class="fieldset-wrapper2">'.$out.'</div></div><script type="text/javascript"> jQuery(\'#showuserimgs'.$uid.'\').show(); jQuery(\'.slinkta\').removeClass(\'thr\'); </script></body></html>'); fclose($fp);
}

/* обновление картинок объявлений */
function updateuseritemimgshare($uid){
    if( !is_dir('html/'.PDX_CITY_ID) ){
        mkdir('html/'.PDX_CITY_ID);
    }
    if( !is_dir('html/'.PDX_CITY_ID.'/share') ){
        mkdir('html/'.PDX_CITY_ID.'/share');
    }
    if( !is_dir('html/'.PDX_CITY_ID.'/share/userpic') ){
        mkdir('html/'.PDX_CITY_ID.'/share/userpic');
    }
    $username='';
    $count=0;
    
    $num=db_query('select f1.field_name_value, f2.field_company_name_value from {field_data_field_name} as f1 left join {field_data_field_company_name} as f2 on (f1.entity_id=f2.entity_id and f2.entity_type=\'user\') where f1.entity_type=\'user\' and f1.entity_id='.$uid);
    $num=$num->fetchAssoc();
    if( isset($num['field_name_value']) and strlen($num['field_name_value']) ){
        $username= $num['field_name_value'];
        if( isset($num['field_company_name_value']) and strlen($num['field_company_name_value']) ){
            $username= $num['field_company_name_value'].' ('.$username.')';
        }
    }
    $out='<div class="shareme sharepicts"><div class="ttlbox"><div class="ttl">Объвления пользователя '.$username.' <span>('.$count.' шт.)</span></div><div class="clear">&nbsp;</div></div>';
    $out.='<div class="btmttlbox">Аренда в '.PDX_CITY_NAME2.' без проблем</div>';
    $out.='<div class="precntall"><div class="cntall">';
    
    $nums=db_query('select n.title, n.nid, i.field_image_fid from {node} as n left join {field_data_field_image} as i on (n.nid=i.entity_id and i.entity_type=\'node\' and i.delta=0) left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    while( $num=$nums->fetchAssoc() ){
        $count++;

        $file = file_load($num['field_image_fid']);
        if( isset( $file->uri ) and strlen( $file->uri ) ){
            $img=image_style_url('news_preview', $file->uri);
        }
        if( !isset($img) or !strlen($img) ){
            $img=PDX_IMGPATH.'/img/noimage.png';
        }
        $out.='<div class="itemimgel"><a target="_blank" href="'.url('node/'.$num['nid'], array('absolute'=>TRUE)).'"><span class="ttl">'.$num['title'].'</span><img alt="" src="'.$img.'" /></a></div>';
    }
    $out=str_replace('(0 шт.)', '('.$count.' шт.)', $out);
    
    $out.='<div class="clear">&nbsp;</div></div></div><div class="sharebtm">';

$out.='<div class="yashare-auto-init" data-yashareL10n="ru" data-yashareType="small" data-yashareQuickServices="vkontakte,facebook,twitter,odnoklassniki,moimir" data-yashareTheme="counter"  data-yashareLink="';
$path=path_load('user/'.$uid); if(strlen($path['alias'])) $path=$path['alias']; else $path='user/'.$uid;
$out.= $GLOBALS['base_url'].'/';
$out.= $path;
$out.='" data-yashareTitle="';
$str=str_replace('"', '', 'Объявления пользователя '.$username.' в '.PDX_CITY_NAME2);
if( mb_strlen($str)>64 ){
    $str=mb_substr($str,0,61).'...';
}
$out.= $str;
$out.='" data-yashareDescription="';
$str='';
$str.=str_replace('"', '', 'Объявления пользователя '.$username.' в '.PDX_CITY_NAME2);
if( mb_strlen($str)>64 ){
    $str=mb_substr($str,0,61).'...';
}
$out.= $str;
$out.='" data-yashareImage="';
    $out.=$GLOBALS['base_url'].'/sites/all/themes/pdxneedto/logovk150.png';
$out.='" ></div>';

    
    $out.='<a target="_blank" href="'.url('user/'.$uid, array('absolute'=>TRUE) ).'">Профиль пользователя '.$username.'</a></div>';
    $out.='</div>';
    
    
    
    $fp = fopen('html/'.PDX_CITY_ID.'/share/userpic/'.$uid.'.htm', 'w'); fwrite($fp, '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru" dir="ltr"><head><title>Аренда: предложения пользователя '.$username.'</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><script type="text/javascript" src="//yastatic.net/share/share.js" charset="utf-8"></script><style type="text/css">
    .shareme *{
    font-family:Arial,sans-serif;
    }
    .shareme .precntall{
        padding: 0 3px 3px 3px;
        margin: 0px;
        background: #00d4d0;
    }
    .shareme .sharebtm{
        background: #000;
        padding: 3px 7px 7px 11px;
        margin: 0px;
        text-align: left;
    }
    .shareme .yashare-auto-init{
    float: right;
    }
    .shareme .sharebtm a{
        color: #fff;
        font-size: 10pt;
    }
    .shareme .cntall{
        position: relative;
        left: +0px;
        padding: 11px 11px 7px 11px;
        margin: 0px;
        background: #fff;
    }
    .shareme .btmttlbox{
    padding: 3px 11px 3px 11px;
    margin: 0px;
    background: #00d4d0;
    color: #fff;
    font-size: 10pt;
    }
    .shareme .ttlbox{
    position: relative;
    left: +0px;
    padding: 7px 11px;
    margin: 0px;
    background: #000;
    }
    .shareme .clear{
    height: 0px;
    clear: both;
    overflow: hidden;
    }
    .shareme .sharelogo{
    float: left;
    height: 37px;
    overflow: hidden;
    display: inline-block;
    }
    .shareme .ttl{
    font-size: 15pt;
    color: #ccc;
    padding: 3px 0 7px 0;
    }
    
    .itemimgel,
.itemimgel a{
    display: inline-block;
    width: 217px;
    height: 217px;
    position: relative; left: +0px;
    margin: 1px;
    text-align: center;
}
.fieldset-wrapper2{
    text-align: center;
}
.itemimgel .ttl{
    position: absolute; left: 0px; bottom: 0px;
    width: 204px;
    height: 31px;
    overflow: hidden;
    padding: 3px 7px;
    background: transparent url(\'http://d4zbhil5kxgyr.cloudfront.net/img/bg_trans2.png\') repeat left top;
    display: block;
    font-size: 10pt;
    text-align: center;
    font-weight: bold;
    line-height: 1.1em;
    color: #fff;
}
.itemimgel a:hover .ttl{
    color: #f3b100;
}

    
    </style></head><body id="start"><div class="sharepicts"><div class="inlinetitle"><div class="inlinetitlein"><a href="'.url('user/'.$uid, array('absolute'=>TRUE)).'"></a></div></div><div class="fieldset-wrapper2">'.$out.'</div></div></body></html>'); fclose($fp);
}
/* изменения в аккаунте при редактировании/удалении объявлений */
function updateuseritem($uid){
    $num=db_query('select COUNT(n.nid) from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.type=\'item\' and n.uid='.$uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    $num=$num->fetchAssoc();
    if( isset($num['COUNT(n.nid)']) and $num['COUNT(n.nid)']>1 ){
        $num=$num['COUNT(n.nid)'];
    }else{
        $num=0;
    }
    $hit=db_query('select field_items_active_value from {field_data_field_items_active} where entity_type=\'user\' and entity_id='.$uid);
    $hit=$hit->fetchAssoc();
    if(!isset($hit['field_items_active_value'])){
        db_query('insert into {field_data_field_items_active} (entity_type, bundle, deleted, entity_id, revision_id, language, delta, field_items_active_value) values (\'user\',\'user\',0,'.$uid.','.$uid.',\'und\',0,:combo)', array(':combo' => $num ));
    }else{
        db_query('update {field_data_field_items_active} set field_items_active_value=:combo where entity_type=\'user\' and entity_id='.$uid, array(':combo' => $num ));
    }



    $num=db_query('select COUNT(n.nid) from {node} as n left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') inner join {field_data_field_status} as s on (n.nid=s.entity_id and s.entity_type=\'node\') where n.status=1 and n.type=\'item\' and s.field_status_value=2 and n.uid='.$uid.' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    $num=$num->fetchAssoc();
    if( isset($num['COUNT(n.nid)']) and $num['COUNT(n.nid)']>0 ){
        $num=$num['COUNT(n.nid)'];
    }else{
        $num=0;
    }
    $hit=db_query('select field_items_prokat_value from {field_data_field_items_prokat} where entity_type=\'user\' and entity_id='.$uid);
    $hit=$hit->fetchAssoc();
    if(!isset($hit['field_items_prokat_value'])){
        db_query('insert into {field_data_field_items_prokat} (entity_type, bundle, deleted, entity_id, revision_id, language, delta, field_items_prokat_value) values (\'user\',\'user\',0,'.$uid.','.$uid.',\'und\',0,:combo)', array(':combo' => $num ));
    }else{
        db_query('update {field_data_field_items_prokat} set field_items_prokat_value=:combo where entity_type=\'user\' and entity_id='.$uid, array(':combo' => $num ));
    }

    db_query('delete from {field_data_field_parts} where entity_type=\'user\' and entity_id='.$uid);
    $delta=0;
    $nums=db_query('select DISTINCT t.taxonomy_catalog_tid from {field_data_taxonomy_catalog} as t inner join {node} as n on (t.entity_id=n.nid)  left join {field_data_field_delete} as fd on (n.nid=fd.entity_id and fd.entity_type=\'node\') left join {field_data_field_block} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.status=1 and n.uid='.$uid.' and t.bundle=\'item\' and ( fd.field_delete_value IS NULL or fd.field_delete_value=0 ) and ( fb.field_block_value IS NULL or fb.field_block_value=0 )');
    while( $num=$nums->fetchAssoc() ){
        db_query('insert into {field_data_field_parts} (entity_type, bundle, deleted, entity_id, revision_id, language, delta, field_parts_tid) values (\'user\',\'user\',0,'.$uid.','.$uid.',\'und\','.$delta.',:combo)', array(':combo' => $num['taxonomy_catalog_tid'] ));
        $delta++;
    }
            
    clearusercaches($uid);
    
    if( defined('PDX_CITY_ID') and is_numeric(PDX_CITY_ID) ){
        $r=db_query('select o.entity_id from {field_data_field_longitude} as o inner join {field_data_field_latitude} as a on (o.entity_id=a.entity_id and a.entity_type=\'user\') inner join {field_data_field_address} as d on (o.entity_id=d.entity_id and d.entity_type=\'user\') where o.entity_type=\'user\' and o.entity_id='.$uid);
        $r=$r->fetchAssoc();
        if( isset($r['entity_id']) and is_numeric($r['entity_id']) ){
        
            $r=db_query('select field_rn_nid from {field_data_field_rn} where entity_type=\'user\' and entity_id='.$uid);
            $r=$r->fetchAssoc();
            
            $nums=db_query('select field_parts_tid from {field_data_field_parts} where entity_type=\'user\' and entity_id='.$uid);
            while( $num=$nums->fetchAssoc() ){
                if( file_exists('pdxcache/maps/'.PDX_CITY_ID.'_0_'.$num['field_parts_tid']) ){
                    unlink('pdxcache/maps/'.PDX_CITY_ID.'_0_'.$num['field_parts_tid']);
                }
                if( isset($r['field_rn_nid']) and is_numeric($r['field_rn_nid']) and file_exists('pdxcache/maps/'.PDX_CITY_ID.'_'.$r['field_rn_nid'].'_'.$num['field_parts_tid']) ){
                    unlink('pdxcache/maps/'.PDX_CITY_ID.'_'.$r['field_rn_nid'].'_'.$num['field_parts_tid']);
                }
            }
        }
    }
}
function clearusercaches($uid){
            cache_clear_all('field:user:' . $uid, 'cache_field', true);
            htmlUserProf($uid);
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_sm') ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_sm');
            }
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_sm_needto') ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_sm_needto');
            }
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_item') ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_item');
            }
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_o') ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$uid.'_o');
            }

}
function getaddtocat(){
    $out='';

    if( !is_dir('html/amenu') ){
        mkdir('html/amenu');
    }
        $outis='';
        $outis.='<div class="catsubmenu_post">';
                
    $outis.= '<div class="submnu_ttl partis0">';
    $outis.= '<img class="ttlimg" alt="" src="'.PDX_IMGPATH.'/img/happy2.png" /><span>Товары к празднику</span></div>';
    
                $amore=array();
                $tids=db_query('select tid, name from {taxonomy_term_data} where vid=10 order by weight');
                while( $tid=$tids->fetchAssoc() ){
    
                    $tmp='';
                    $tmp.='<div class="submnu2"><div class="submnu2_ttl"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$tid['tid'].'">'.$tid['name'].'</a></div>';
    
                    $amore2=array();
                    $countmore=0;
                    $tids2=db_query('select d.name, d.tid from {taxonomy_term_data} as d where d.vid=2 order by d.weight asc');
                    while( $tid2=$tids2->fetchAssoc() ){
        
                        if( ++$countmore>3 ){
                            $amore2[]='<div class="submnu3 submnu3hide"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$tid['tid'].'?taxonomy_catalog='.$tid2['tid'].'">'.$tid2['name'].'</a></div>';
                        }else{
                            $amore2[]='<div class="submnu3"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$tid['tid'].'?taxonomy_catalog='.$tid2['tid'].'">'.$tid2['name'].'</a></div>';
                        }
                    }
                    if( isset($amore2) and is_array($amore2) and count($amore2) ){
                        $tmp.= '<div class="submnu_cnt submnu_cnt_tags">';
                        $tmp.= implode('', $amore2);
                        if( $countmore>3 ){
                            $tmp.= '<div class="submnu3 submnu3expand"><a href="javascript: void(0);" onclick=" jQuery(this).parent().parent().find(\'.submnu3hide\').show(); jQuery(this).hide(); ">Раскрыть весь список</a></div>';
                        }
                        $tmp.= '</div>';
                    }
                    
                    $tmp.='</div>';
                    
                    $amore[]=$tmp;
                }
                if( isset($amore) and is_array($amore) and count($amore) ){ 
                    $outis.= '<div class="submnu_cnt">';
                    $outis.= implode('', $amore);
                    $outis.= '</div>';
                }
                $outis.='<div class="clear">&nbsp;</div></div>';
                if( isset($outis) and strlen($outis) ){
                    $fp=fopen('html/amenu/'.PDX_CITY_ID.'_0.htm', "w");
                    if($fp){
                        fwrite($fp, '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru" dir="ltr"><head><title>Аренда вещей без проблем</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body id="start">'.$outis.'</body></html>'); fclose($fp);
                    }
                }
                
                
    
        $terms=db_query('select t.tid, t.name from {taxonomy_term_data} as t where t.vid=2 order by t.weight asc');
        while($term = $terms->fetchAssoc()){




        $outis='';
        $outis.='<div class="catsubmenu_post">';
            
        $abrands=array();
        $nums=db_query('select d.tid, d.name from {field_data_field_brands} as f inner join {taxonomy_term_data} as d on f.field_brands_tid=d.tid where f.entity_type=\'taxonomy_term\' and f.entity_id='.$term['tid']);
        while( $num=$nums->fetchAssoc() ){

            $abrands[]= '<div class="mnu_brand_item"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$term['tid'].'?field_brand='.$num['tid'].'">'.$num['name'].'</a></div>';
        }
        if( isset($abrands) and is_array($abrands) and count($abrands) ){ 
            $outis.= '<div class="part_rents part_rents_brands"><div class="ttl">Популярные бренды:</div><div class="cnt">';
            $outis.= implode('', $abrands);
            $outis.= '</div></div>';
        }
                
        $outis.= '<div class="catsub_left';
        if( isset($abrands) and is_array($abrands) and count($abrands) ){ }else{
            $outis.= ' catsub_left_noright';
        }
        $outis.= '">';
                
        $name=db_query('select t.name from {taxonomy_term_data} as t where t.tid='.$term['tid']);
        $name=$name->fetchAssoc();
        if( isset($name['name']) and strlen($name['name']) ){
                    
            $outis.= '<div class="submnu_ttl partis'.$term['tid'].'">';
            $outis.= '<img class="ttlimg" alt="" src="http://d4zbhil5kxgyr.cloudfront.net/static/part/i'.$term['tid'].'.png" />';
                    
            $outis.= '<a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$term['tid'].'">'.$name['name'].'</a></div>';
        }

        $amore=array();
        $tids=db_query('select d.tid, d.name from {field_data_field_part} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid where f.entity_type=\'taxonomy_term\' and f.field_part_tid='.$term['tid'].' and d.vid=8 order by d.weight');
        while( $tid=$tids->fetchAssoc() ){
    
            $tmp='';
            $tmp.='<div class="submnu2"><div class="partis'.$tid['tid'].' submnu2_ttl"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$term['tid'].'/'.$tid['tid'].'">'.$tid['name'].'</a></div>';
    
            $amore2=array();
            $countmore=0;
            $tids2=db_query('select d.tid, d.name from {field_data_field_part} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid inner join {field_data_field_subpart} as s on ( d.tid=s.entity_id and s.entity_type=\'taxonomy_term\' ) where f.entity_type=\'taxonomy_term\' and f.field_part_tid='.$term['tid'].' and s.field_subpart_tid='.$tid['tid'].' and d.vid<>8 order by d.name');
            while( $tid2=$tids2->fetchAssoc() ){
        
                if( ++$countmore>3 ){
                    $amore2[]='<div class="submnu3 submnu3hide partis'.$tid2['tid'].'"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$term['tid'].'/'.$tid['tid'].'/'.$tid2['tid'].'">'.$tid2['name'].'</a></div>';
                }else{
                    $amore2[]='<div class="submnu3 partis'.$tid2['tid'].'"><a href="'.$GLOBALS['base_url'].'/'.PDXCAT_NAME.'/'.$term['tid'].'/'.$tid['tid'].'/'.$tid2['tid'].'">'.$tid2['name'].'</a></div>';
                }
            }
            if( isset($amore2) and is_array($amore2) and count($amore2) ){
                $tmp.= '<div class="submnu_cnt submnu_cnt_tags">';
                $tmp.= implode('', $amore2);
                if( $countmore>3 ){
                    $tmp.= '<div class="submnu3 submnu3expand"><a href="javascript: void(0);" onclick=" jQuery(this).parent().parent().find(\'.submnu3hide\').show(); jQuery(this).hide(); ">Раскрыть весь список</a></div>';
                }
                    $tmp.= '</div>';
            }
            $tmp.='</div>';
                    
            $amore[]=$tmp;
        }
        if( isset($amore) and is_array($amore) and count($amore) ){ 
            $outis.= '<div class="submnu_cnt">';
            $outis.= implode('', $amore);
            $outis.= '</div>';
/*
        }else{
            $amore2=array();
            $tids=db_query('select d.tid, d.name from {field_data_field_part} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid where f.entity_type=\'taxonomy_term\' and f.field_part_tid='.$term['tid'].' and d.vid<>8 order by d.name');
            while( $tid=$tids->fetchAssoc() ){
                $path=path_load('taxonomy/term/'.$tid['tid']);
                if(strlen($path['alias'])) $path=$path['alias']; else $path='taxonomy/term/'.$tid['tid'];
                $amore2[]='<div class="submnu2 partis'.$tid['tid'].'"><a href="'.$GLOBALS['base_url'].'/'.$path.'">'.$tid['name'].'</a></div>';
            }
            if( isset($amore2) and is_array($amore2) and count($amore2) ){ 
                $outis.= '<div class="submnu_cnt submnu_cnt_tags">';
                $outis.= implode('', $amore2);
                $outis.= '</div>';
            }
*/
        }
        $outis.='</div>';
        $outis.='<div class="clear">&nbsp;</div></div>';

                    if( isset($outis) and strlen($outis) ){
                    $fp=fopen('html/amenu/'.PDX_CITY_ID.'_'.$term['tid'].'.htm', "w");
                    if($fp){
                        fwrite($fp, '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru" dir="ltr"><head><title>Аренда вещей без проблем</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body id="start">'.$outis.'</body></html>'); fclose($fp);
                    }
                    }




            $out.='<div class="additem_part">';

            if( isset($term['name']) and strlen($term['name']) ){

                $out.= '<div class="submnu_ttl partis'.$term['tid'].'">';
                $out.= '<img class="ttlimg" alt="" src="http://d4zbhil5kxgyr.cloudfront.net/static/part/i'.$term['tid'].'.png" />';
                
                $out.= '<a href="'.$GLOBALS['base_url'].'/node/add/item?part='.$term['tid'].'">'.$term['name'].'</a></div>';
            }
            
            $amore=array();
            $tids=db_query('select d.tid, d.name from {field_data_field_part} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid where f.entity_type=\'taxonomy_term\' and f.field_part_tid='.$term['tid'].' and d.vid=8 order by d.weight');
            while( $tid=$tids->fetchAssoc() ){

                $tmp='';
                $tmp.='<div class="submnu2"><div class="partis'.$tid['tid'].' submnu2_ttl"><a href="'.$GLOBALS['base_url'].'/node/add/item?part='.$term['tid'].'&subpart='.$tid['tid'].'">'.$tid['name'].'</a></div>';

                $amore2=array();
                $countmore=0;
                $tids2=db_query('select d.tid, d.name from {field_data_field_part} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid inner join {field_data_field_subpart} as s on ( d.tid=s.entity_id and s.entity_type=\'taxonomy_term\' ) where f.entity_type=\'taxonomy_term\' and f.field_part_tid='.$term['tid'].' and s.field_subpart_tid='.$tid['tid'].' and d.vid<>8 order by d.name');
                while( $tid2=$tids2->fetchAssoc() ){
    
                    if( ++$countmore>3 ){
                        $amore2[]='<div class="submnu3 submnu3hide partis'.$tid2['tid'].'"><a href="'.$GLOBALS['base_url'].'/node/add/item?part='.$term['tid'].'&subpart='.$tid['tid'].'&tag='.$tid2['tid'].'">'.$tid2['name'].'</a></div>';
                    }else{
                        $amore2[]='<div class="submnu3 partis'.$tid2['tid'].'"><a href="'.$GLOBALS['base_url'].'/node/add/item?part='.$term['tid'].'&subpart='.$tid['tid'].'&tag='.$tid2['tid'].'">'.$tid2['name'].'</a></div>';
                    }
                }
                if( isset($amore2) and is_array($amore2) and count($amore2) ){
//                    $tmp=str_replace('submnu2_ttl">', 'submnu2_ttl"><div class="submnu2ex" onclick=" if( jQuery(this).parent().parent().hasClass(\'submnu2ac\') ){ jQuery(this).parent().parent().removeClass(\'submnu2ac\'); }else{ jQuery(this).parent().parent().addClass(\'submnu2ac\'); } ">&nbsp;</div>', $tmp);
                    $tmp.= '<div class="submnu_cnt submnu_cnt_tags">';
                    $tmp.= implode('', $amore2);
                    if( $countmore>3 ){
                        $tmp.= '<div class="submnu3 submnu3expand"><a href="javascript: void(0);" onclick=" jQuery(this).parent().parent().find(\'.submnu3hide\').show(); jQuery(this).hide(); ">Раскрыть весь список</a></div>';
                    }
                    $tmp.= '</div>';
                }

                $tmp.='</div>';
                
                $amore[]=$tmp;
            }
            if( isset($amore) and is_array($amore) and count($amore) ){ 
                $out.= '<div class="submnu_cnt">';
                $out.= implode('', $amore);
                $out.= '</div>';
            }else{

                $amore2=array();
                $tids=db_query('select d.tid, d.name from {field_data_field_part} as f inner join {taxonomy_term_data} as d on f.entity_id=d.tid where f.entity_type=\'taxonomy_term\' and f.field_part_tid='.$term['tid'].' and d.vid<>8 order by d.name');
                while( $tid=$tids->fetchAssoc() ){
    
                    $amore2[]='<div class="submnu2 partis'.$tid['tid'].'"><a href="'.$GLOBALS['base_url'].'/node/add/item?part='.$term['tid'].'&subpart='.$tid['tid'].'">'.$tid['name'].'</a></div>';
                }
                if( isset($amore2) and is_array($amore2) and count($amore2) ){ 
                    $out.= '<div class="submnu_cnt submnu_cnt_tags">';
                    $out.= implode('', $amore2);
                    $out.= '</div>';
                }
                
            }

            $out.='</div>';
        }

    
    $fp = fopen('html/addsel_'.PDX_CITY_ID.'.htm', 'w'); fwrite($fp, '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru" dir="ltr"><head><title>Аренда вещей без проблем</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body id="start">'.$out.'</body></html>'); fclose($fp);
}
function pdxseparate_userpoints($op, $params = array()){
    if( $op=='points after' ){
        if( isset($params['uid']) and is_numeric($params['uid']) ){
            if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$params['uid'].'_sm_needto') ){
                unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$params['uid'].'_sm_needto');
            }
        }
    }
}
function htmlUserProf($us1){

    if( !is_dir('html/'.PDX_CITY_ID) ){
        mkdir('html/'.PDX_CITY_ID);
    }
    if( !is_dir('html/'.PDX_CITY_ID.'/user') ){
        mkdir('html/'.PDX_CITY_ID.'/user');
    }

        $out='';

        $usr=prepuser($us1);
        if( isset($usr->uid) and $usr->uid>0 and ( !isset( $usr->field_delete['und'][0]['value'] ) or $usr->field_delete['und'][0]['value']==0 ) ){
            $uri='';
    
            $path=path_load('user/'.$usr->uid);
            if( isset($path['alias']) and strlen($path['alias'])){
                $path=$path['alias'];
            }else{
                $path='user/'.$usr->uid;
            }
            
            if( isset($usr->field_items_active['und'][0]['value']) and is_numeric($usr->field_items_active['und'][0]['value']) and $usr->field_items_active['und'][0]['value']>0 ){
                $ttl='Об авторе';
                if( isset($usr->field_who['und'][0]['value']) and is_numeric($usr->field_who['und'][0]['value']) and $usr->field_who['und'][0]['value']==2 ){
                    $ttl='О компании';
                }
            }else{
                $ttl='Об участнике';
            }
            
            $out.= '<div class="userblocksm">';
            $out.= '<div class="block-title">';
            $out.= '<div class="favbutton favbutton_user fav_user_'.$usr->uid.'" style="display: none;"><span class="fv" onclick="favswitch(\'user\', '.$usr->uid.');">&nbsp;</span></div>';
            $out.= '<div class="title">'.$ttl.'</div></div>';

            $out.= '<div class="userblocksm_top">';
    
            if( isset($usr->picture->uri) and strlen($usr->picture->uri) ){
                $uri = image_style_url('user', $usr->picture->uri);
            }else{
                if( isset($usr->field_company_logo['und'][0]['fid']) and strlen($usr->field_company_logo['und'][0]['fid']) ){
                    $uri = file_load($usr->field_company_logo['und'][0]['fid'])->uri;
                    $uri = image_style_url('logosm', $uri);
                }else{
                    $uri = PDX_IMGPATH.'/img/happy2.png';
                }
            }
            $out.= '<div><a class="user_nm"';
            if( isset($uri) and strlen($uri) ){
                $out.= ' style="background: transparent url(\''.$uri.'\') no-repeat left top;"';
            }
            $out.= ' href="'.$GLOBALS['base_url'].'/'.$path.'">';
            if(isset($usr->roles[8])){
                $out.= '<div class="user_gold"><img alt="" title="Gold-аккаунт" src="'.PDX_IMGPATH.'/img/trophy_sm.png" /></div>';
            }
            
            $out.= '<div class="usernm isuser'.$usr->uid.'">';
            if( isset($usr->field_name['und'][0]['value']) and strlen($usr->field_name['und'][0]['value']) ){
                $out.= $usr->field_name['und'][0]['value'];
            }else{
                $out.= '&nbsp;';
            }
            if( isset($usr->field_company_name['und'][0]['value']) and strlen($usr->field_company_name['und'][0]['value']) ){
                $out.= ' ('.$usr->field_company_name['und'][0]['value'].')';
            }
            $out.= '<span title="offline" class="ustat ustat_'.$usr->uid.'"></span></div>';

            if( isset($usr->field_who['und'][0]['value']) and is_numeric($usr->field_who['und'][0]['value']) and $usr->field_who['und'][0]['value']>0 ){
                $out.= '<div class="user_is">';
                switch($usr->field_who['und'][0]['value']){
                case 2:
                    $out.='компания';
                    break;
                default:
                    $out.='
                    ';
                }
                $out.= '</div>';
            }

            $out.= '<div class="us_created">с нами <span class="datereg datereg_'.$usr->created.'"></span><span class="datereg_ago_is">≈ <span class="datereg_ago">???</span></span></div>';
            
            
            $out.= '</a></div>';

            $out.= '<div class="user_rat">';
            if( isset($usr->field_userrat['und'][0]['value']) and is_numeric($usr->field_userrat['und'][0]['value']) and $usr->field_userrat['und'][0]['value']>0 ){
                $usr->field_userrat['und'][0]['value']=intval($usr->field_userrat['und'][0]['value']/10);

                if( $usr->field_userrat['und'][0]['value']>=1 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
    
                if( $usr->field_userrat['und'][0]['value']>=2 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
    
                if( $usr->field_userrat['und'][0]['value']>=3 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
    
                if( $usr->field_userrat['und'][0]['value']>=4 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
    
                if( $usr->field_userrat['und'][0]['value']>=5 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
    
                if( $usr->field_userrat['und'][0]['value']>=6 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
    
                if( $usr->field_userrat['und'][0]['value']>=7 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
    
                if( $usr->field_userrat['und'][0]['value']>=8 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
    
                if( $usr->field_userrat['und'][0]['value']>=9 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
    
                if( $usr->field_userrat['und'][0]['value']==10 ){ $out.= '<div class="ratis raty">&nbsp;</div>';
                }else{ $out.= '<div class="ratis ratn">&nbsp;</div>'; }
/*    
            }else{
                $out.= '<div class="ratis ratn">&nbsp;</div>';
                $out.= '<div class="ratis ratn">&nbsp;</div>';
                $out.= '<div class="ratis ratn">&nbsp;</div>';
                $out.= '<div class="ratis ratn">&nbsp;</div>';
                $out.= '<div class="ratis ratn">&nbsp;</div>';
                $out.= '<div class="ratis ratn">&nbsp;</div>';
                $out.= '<div class="ratis ratn">&nbsp;</div>';
                $out.= '<div class="ratis ratn">&nbsp;</div>';
                $out.= '<div class="ratis ratn">&nbsp;</div>';
                $out.= '<div class="ratis ratn">&nbsp;</div>';
*/
            }
            $out.= '</div>';
            
            if( isset($usr->field_sex['und'][0]['value']) and is_numeric($usr->field_sex['und'][0]['value']) ){
                switch($usr->field_sex['und'][0]['value']){
                    case 0:
                        $out.= '<div class="umale"><img alt="" title="мужчина" src="'.PDX_IMGPATH.'/img/male.png" /></div>';
                        break;
                    case 1:
                        $out.= '<div class="umale"><img alt="" title="женщина" src="'.PDX_IMGPATH.'/img/female.png" /></div>';
                        break;
                }
            }
            
            $out.= '<div class="abuseme abuseuid" onclick=" abuse(1, '.$usr->uid.', this); " title="Пожаловаться на арендодателя"><span></span><img alt="" src="'.PDX_IMGPATH.'/img/msg_alert.png" />Пожаловаться</div></div>';
            $out.= '<div class="userblocksm_btm">';
            
            $tmpout='';
            if( isset($usr->field_webmoney['und'][0]['value']) and strlen($usr->field_webmoney['und'][0]['value']) ){
                $tmpout.='<div class="user_pay user_wm';
                if( isset($usr->field_preferrer['und'][0]['value']) and $usr->field_preferrer['und'][0]['value']==2 ){
                    $tmpout.=' paypref" title="WebMoney, предпочтительно';
                }else{
                    $tmpout.='" title="WebMoney';
                }
                $tmpout.='">&nbsp;</div>';
            }
            if( isset($usr->field_yad['und'][0]['value']) and strlen($usr->field_yad['und'][0]['value']) ){
                $tmpout.='<div class="user_pay user_yd';
                if( isset($usr->field_preferrer['und'][0]['value']) and $usr->field_preferrer['und'][0]['value']==3 ){
                    $tmpout.=' paypref" title="Яндекс.Деньги, предпочтительно';
                }else{
                    $tmpout.='" title="Яндекс.Деньги';
                }
                $tmpout.='">&nbsp;</div>';
            }
            if( isset($usr->field_qiwi['und'][0]['value']) and strlen($usr->field_qiwi['und'][0]['value']) ){
                $tmpout.='<div class="user_pay user_qiwi';
                if( isset($usr->field_preferrer['und'][0]['value']) and $usr->field_preferrer['und'][0]['value']==4 ){
                    $tmpout.=' paypref" title="QIWI, предпочтительно';
                }else{
                    $tmpout.='" title="QIWI';
                }
                $tmpout.='">&nbsp;</div>';
            }
            if( isset($usr->field_card['und'][0]['value']) and strlen($usr->field_card['und'][0]['value']) ){
                $tmpout.='<div class="user_pay user_card';
                if( isset($usr->field_preferrer['und'][0]['value']) and $usr->field_preferrer['und'][0]['value']==5 ){
                    $tmpout.=' paypref" title="Кредитная карта, предпочтительно';
                }else{
                    $tmpout.='" title="Кредитная карта';
                }
                $tmpout.='">&nbsp;</div>';
            }
            if( isset($tmpout) and strlen($tmpout) ){
                $out.='<div class="user_ttl">способы оплаты</div><div class="user_pays"><div class="user_pay user_nal';
                if( isset($usr->field_preferrer['und'][0]['value']) and $usr->field_preferrer['und'][0]['value']==1 ){
                    $out.=' paypref" title="Наличные, предпочтительно';
                }else{
                    $out.='" title="Наличные';
                }
                $out.='">&nbsp;</div>'.$tmpout.'</div>';
            }

            $outtmp='';
            if( isset($usr->field_skype['und'][0]['value']) and strlen($usr->field_skype['und'][0]['value']) ){
                $usr->field_skype['und'][0]['value']=str_replace("'",'',str_replace('"','',filter_xss(strip_tags($usr->field_skype['und'][0]['value']))));
                $outtmp.= '<div class="user_contact"><a rel="nofollow" title="Skype пользователя" class="user_skype" href="skype:'.$usr->field_skype['und'][0]['value'].'">'.$usr->field_skype['und'][0]['value'].'</a></div>';
            }
            if( isset($usr->mail) and strlen($usr->mail) and ( !isset( $usr->field_notemail['und'][0]['value'] ) or $usr->field_notemail['und'][0]['value']!=1 ) ){
                $outtmp.= '<div class="user_contact"><a rel="nofollow" class="user_email" href="mailto:'.$usr->mail.'" onclick=" yaCounter'.PDX_METRIKA_YANDEX.'.reachGoal(yacontact); ">'.$usr->mail.'</a></div>';
            }
            if( isset($usr->field_phones['und'][0]['value']) and strlen($usr->field_phones['und'][0]['value']) ){
                $outtmp.= '<div class="user_contact">';
                foreach( $usr->field_phones['und'] as $phone ){
                    $phone['value']=str_replace(" ",'',str_replace("'",'',str_replace('"','',filter_xss(strip_tags($phone['value'])))));
                    $classaddict='';
                    if( function_exists('pdxclassphone') ){
                        $classaddict=pdxclassphone($phone['value']);
                    }
                    $outtmp.= '<div><a rel="nofollow" class="user_phone" title="Телефон пользователя" href="tel:'.str_replace('-','',str_replace(' ','',str_replace('(','',str_replace(')','',$phone['value'])))).'" onclick=" yaCounter'.PDX_METRIKA_YANDEX.'.reachGoal(yacontact); ">';
                    $outtmp.= $phone['value'];
                    if( isset($classaddict) and strlen($classaddict) ){
                        $outtmp.= ' <span class="phoneop">'.$classaddict.'</span>';
                    }
                    $outtmp.= '</a></div>';
                }
                $outtmp.= '</div>';
            }
            


            if( isset($outtmp) and strlen($outtmp) ){
                
                $out.= '<div class="user_contacts"><noindex>';
                $out.= '<script type="text/javascript"> ';
                $out.= 'var carr = new Array();';
                $cnt=0;
                $outarr=array();
                while(1==1){
                    if( !mb_strlen($outtmp) ){
                        break;
                    }
                    $randis=mt_rand(2,3);
                    $tmp=mb_substr($outtmp, 0, $randis);
                    $outtmp=mb_substr($outtmp, $randis);
                    $outarr[]= 'carr['.($cnt++).']=\''.$tmp.'\';';
                }
                if( isset($outarr) and is_array($outarr) and count($outarr) ){ 
                    shuffle($outarr);
                    $out.=implode('', $outarr);
                }
                $out.= 'if( carr.length ){
                    var cares=\'\';
                    for( var i=0; i<carr.length; i++ ){
                        cares+=carr[i];
                    }
                    jQuery(\'.user_contacts_cnt\').html(cares); 
                }';
                $out.= ' </script>';
                $out.= '<div class="user_contacts_cnt">';
                $out.= '</div>';

            if( isset($usr->field_url_site['und'][0]['value']) and strlen($usr->field_url_site['und'][0]['value']) ){
                $usr->field_url_site['und'][0]['value']=str_replace('"','',filter_xss(strip_tags($usr->field_url_site['und'][0]['value'])));
                if( strpos($usr->field_url_site['und'][0]['value'], 'http://')===false and strpos($usr->field_url_site['und'][0]['value'], 'https://')===false ){
                    $usr->field_url_site['und'][0]['value']='http://'.$usr->field_url_site['und'][0]['value'];
                }
                $usr->field_url_site['und'][0]['value']=str_replace('///','//',$usr->field_url_site['und'][0]['value']);
                $out.= '<div class="user_contact"><a target="_blank" rel="nofollow" title="Сайт пользователя" class="user_url" href="'.$usr->field_url_site['und'][0]['value'].'">';
                if( mb_strlen( $usr->field_url_site['und'][0]['value'] )>27 ){
                    $usr->field_url_site['und'][0]['value']=mb_substr($usr->field_url_site['und'][0]['value'], 0, 23).'...';
                }                
                $out.= $usr->field_url_site['und'][0]['value'];
                $out.= '</a></div>';
            }

            if( isset($usr->field_url_vk['und'][0]['value']) and strlen($usr->field_url_vk['und'][0]['value']) ){
                $usr->field_url_vk['und'][0]['value']=str_replace('"','',filter_xss(strip_tags($usr->field_url_vk['und'][0]['value'])));
                if( strpos($usr->field_url_vk['und'][0]['value'], 'http://')===false and strpos($usr->field_url_vk['und'][0]['value'], 'https://')===false ){
                    $usr->field_url_vk['und'][0]['value']='http://'.$usr->field_url_vk['und'][0]['value'];
                }
                $usr->field_url_vk['und'][0]['value']=str_replace('///','//',$usr->field_url_vk['und'][0]['value']);
                $out.= '<div class="user_contact"><a target="_blank" rel="nofollow" title="Страничка ВКонтакте пользователя" class="user_vk" href="'.$usr->field_url_vk['und'][0]['value'].'">';
                if( mb_strlen( $usr->field_url_vk['und'][0]['value'] )>27 ){
                    $usr->field_url_vk['und'][0]['value']=mb_substr($usr->field_url_vk['und'][0]['value'], 0, 23).'...';
                }                
                $out.= $usr->field_url_vk['und'][0]['value'];
                $out.= '</a></div>';
            }

            if( isset($usr->field_url_fb['und'][0]['value']) and strlen($usr->field_url_fb['und'][0]['value']) ){
                $usr->field_url_fb['und'][0]['value']=str_replace('"','',filter_xss(strip_tags($usr->field_url_fb['und'][0]['value'])));
                if( strpos($usr->field_url_fb['und'][0]['value'], 'http://')===false and strpos($usr->field_url_fb['und'][0]['value'], 'https://')===false ){
                    $usr->field_url_fb['und'][0]['value']='http://'.$usr->field_url_fb['und'][0]['value'];
                }
                $usr->field_url_fb['und'][0]['value']=str_replace('///','//',$usr->field_url_fb['und'][0]['value']);
                $out.= '<div class="user_contact"><a target="_blank" rel="nofollow" title="Страничка Facebook пользователя" class="user_fb" href="'.$usr->field_url_fb['und'][0]['value'].'">';
                if( mb_strlen( $usr->field_url_fb['und'][0]['value'] )>27 ){
                    $usr->field_url_fb['und'][0]['value']=mb_substr($usr->field_url_fb['und'][0]['value'], 0, 23).'...';
                }                
                $out.= $usr->field_url_fb['und'][0]['value'];
                $out.= '</a></div>';
            }

            if( isset($usr->field_url_yt['und'][0]['value']) and strlen($usr->field_url_yt['und'][0]['value']) ){
                $usr->field_url_yt['und'][0]['value']=str_replace('"','',filter_xss(strip_tags($usr->field_url_yt['und'][0]['value'])));
                if( strpos($usr->field_url_yt['und'][0]['value'], 'http://')===false and strpos($usr->field_url_yt['und'][0]['value'], 'https://')===false ){
                    $usr->field_url_yt['und'][0]['value']='http://'.$usr->field_url_yt['und'][0]['value'];
                }
                $usr->field_url_yt['und'][0]['value']=str_replace('///','//',$usr->field_url_yt['und'][0]['value']);
                $out.= '<div class="user_contact"><a target="_blank" rel="nofollow" title="Страничка YouTube пользователя" class="user_yt" href="'.$usr->field_url_yt['und'][0]['value'].'">';
                if( mb_strlen( $usr->field_url_yt['und'][0]['value'] )>27 ){
                    $usr->field_url_yt['und'][0]['value']=mb_substr($usr->field_url_yt['und'][0]['value'], 0, 23).'...';
                }                
                $out.= $usr->field_url_yt['und'][0]['value'];
                $out.= '</a></div>';
            }

            if( isset($usr->field_url_in['und'][0]['value']) and strlen($usr->field_url_in['und'][0]['value']) ){
                $usr->field_url_in['und'][0]['value']=str_replace('"','',filter_xss(strip_tags($usr->field_url_in['und'][0]['value'])));
                if( strpos($usr->field_url_in['und'][0]['value'], 'http://')===false and strpos($usr->field_url_in['und'][0]['value'], 'https://')===false ){
                    $usr->field_url_in['und'][0]['value']='http://'.$usr->field_url_in['und'][0]['value'];
                }
                $usr->field_url_in['und'][0]['value']=str_replace('///','//',$usr->field_url_in['und'][0]['value']);
                $out.= '<div class="user_contact"><a target="_blank" rel="nofollow" title="Страничка Instagram пользователя" class="user_in" href="'.$usr->field_url_in['und'][0]['value'].'">';
                if( mb_strlen( $usr->field_url_in['und'][0]['value'] )>27 ){
                    $usr->field_url_in['und'][0]['value']=mb_substr($usr->field_url_in['und'][0]['value'], 0, 23).'...';
                }                
                $out.= $usr->field_url_in['und'][0]['value'];
                $out.= '</a></div>';
            }
    
                $out.= '</noindex></div>';
            }

            $outtmp='';
            if( isset($usr->field_rn['und'][0]['nid']) and is_numeric($usr->field_rn['und'][0]['nid']) ){
                $name=db_query('select title from {node} where nid='.$usr->field_rn['und'][0]['nid']);
                $name=$name->fetchAssoc();
                if( isset($name['title']) and strlen($name['title']) ){
                    $outtmp.= '<a target="_blank" href="'.$GLOBALS['base_url'].'/'.PDXCAT_USERNAME.'?field_rn[]='.$usr->field_rn['und'][0]['nid'].'">'.$name['title'].'</a>'; 
                }
            }
            if( isset($usr->field_who['und'][0]['value']) and $usr->field_who['und'][0]['value']==2 ){
                $outstreet=array();
                if( isset( $usr->field_address['und'][0]['value'] ) and strlen( $usr->field_address['und'][0]['value'] ) ){
                    foreach( $usr->field_address['und'] as $vl ){
                        $vl['value']=filter_xss(strip_tags($vl['value']));
                        $outstreet[]= '<div><span class="org_addr_'.$usr->uid.'">'.$vl['value'].'</span>.</div>';
                    }
                }
                if( isset($outstreet) and is_array($outstreet) and count($outstreet) ){ 
                    $outtmp.=implode('', $outstreet);
                }
                if( isset( $usr->field_org_info['und'][0]['value'] ) and strlen( $usr->field_org_info['und'][0]['value'] ) ){
                    $usr->field_org_info['und'][0]['value']=filter_xss(strip_tags($usr->field_org_info['und'][0]['value']));
                    $outtmp.= '<div class="org_info org_info_'.$usr->uid.'">'.$usr->field_org_info['und'][0]['value'].'</div>';
                }
            }
            
            if( isset($outtmp) and strlen($outtmp) ){
                $out.= '<div class="user_points">'.$outtmp.'</div>';
            }
            
            $isset=db_query('select uid from {pm_disable} where uid='.$usr->uid);
            $isset=$isset->fetchAssoc();
            if( !isset($isset['uid']) ){
                $out.= '<div class="sendpm" style="display: none;"><a href="'.$GLOBALS['base_url'].'/messages/new?to='.$us1.'" onclick=" sendpmgen(this); ">Отправить сообщение</a></div>';
            }
            
            $out.= '<div class="user_nids">';
            if( isset($usr->field_items_active['und'][0]['value']) and is_numeric($usr->field_items_active['und'][0]['value']) and $usr->field_items_active['und'][0]['value']>1 ){
                $out.= '<span class="slink" onclick=" smmi('.$usr->uid.');"><span class="slinkta"></span>Смотреть все ';
                if( function_exists('pdxnumfoot') ){
                    $out.= pdxnumfoot($usr->field_items_active['und'][0]['value'], 'объявление', 'объявлений', 'объявления');
                }else{
                    $out.= $usr->field_items_active['und'][0]['value'].' объявления';
                }
/*
                if( isset($usr->field_items_prokat['und'][0]['value']) and is_numeric($usr->field_items_prokat['und'][0]['value']) and $usr->field_items_prokat['und'][0]['value']>0 ){
                    $out.= '<br />';
                    $out.= $usr->field_items_prokat['und'][0]['value'];
                    $out.= ' сейчас в прокате';
                }
*/
                $out.= ' арендодателя</span>';
            }
            $out.= '</div>';
            $out.= ' <script type="text/javascript"> switchTime(); checkonline(); </script> ';
            
            $out.= '</div>';
            $out.= '</div>';
                        
        }else{
            $out='&nbsp;';
        }    

    $fp = fopen('html/'.PDX_CITY_ID.'/user/'.$us1.'.htm', 'w'); fwrite($fp, '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru" dir="ltr"><head><title>Аренда вещей без проблем</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body id="start">'.$out.'</body></html>'); fclose($fp);

}
function htmlUserMap($usr){

    $out='';
    $companyname='???';
    if( isset($usr->field_name['und'][0]['value']) and strlen($usr->field_name['und'][0]['value']) ){
        $companyname=$usr->field_name['und'][0]['value'];
        if( isset($usr->field_who['und'][0]['value']) and $usr->field_who['und'][0]['value']==2 ){
            if( isset($usr->field_company_name) and isset($usr->field_company_name['und']) and isset($usr->field_company_name['und'][0]['value']) and strlen($usr->field_company_name['und'][0]['value']) and $usr->field_company_name['und'][0]['value']!=$companyname ){
                $companyname=$usr->field_company_name['und'][0]['value'].' ('.$companyname.')';
            }
        }
    }
    $companyname=str_replace('"', '', $companyname);

    $txtout='';
    
    if( isset($usr->picture->uri) and strlen($usr->picture->uri) ){
        $uri = image_style_url('user', $usr->picture->uri);
    }else{
        if( isset($usr->field_company_logo['und'][0]['fid']) and strlen($usr->field_company_logo['und'][0]['fid']) ){
            $uri = file_load($usr->field_company_logo['und'][0]['fid'])->uri;
            $uri = image_style_url('logosm', $uri);
        }else{
            $uri = PDX_IMGPATH.'/img/happy2.png';
        }
    }
    if( isset($uri) and strlen($uri) ){
        $txtout.='<img style=\'float: left; margin: 0 11px 11px 0; \' alt=\'\' src=\''.$uri.'\' />';
    }
    
    $txtout.='<div><a href=\''.url('user/'.$usr->uid, array('absolute'=>TRUE)).'\'>Компания <strong>'.$companyname.'</strong></a></div><div class="m_addr">{{STREET}}</div><div class=\'clear\'>&nbsp;</div>';

    $isset=db_query('select uid from {pm_disable} where uid='.$usr->uid);
    $isset=$isset->fetchAssoc();
    if( !isset($isset['uid']) ){
        $txtout.='<div class=\'sendpm\' style=\'display: none;\'><a href=\''.$GLOBALS['base_url'].'/messages/new?to='.$usr->uid.'\' onclick=\' sendpmgen(this); \'>Отправить сообщение</a></div>';
    }

    
    if( isset($usr->field_address['und'][0]['value']) and strlen($usr->field_address['und'][0]['value']) and isset($usr->field_longitude['und'][0]['value']) and is_numeric($usr->field_longitude['und'][0]['value']) and isset($usr->field_latitude['und'][0]['value']) and is_numeric($usr->field_latitude['und'][0]['value']) ){

    
                            $points=array();
                            
                        foreach( $usr->field_longitude['und'] as $delta => $longitude ){ 
                            $points[$delta]['title']=str_replace('"', '', str_replace('{{STREET}}', $usr->field_address['und'][$delta]['value'], $txtout));
                            $points[$delta]['longitude']=$longitude['value'];
                            $points[$delta]['latitude']=$usr->field_latitude['und'][$delta]['value'];
                            $points[$delta]['address']=$usr->field_address['und'][$delta]['value'];
                        }
    
            $out.= '<div id=\'map_canvas_user\' style=\'width: 100%; height: 333px;\'></div><script type="text/javascript">
       jQuery(document).ready(function($){ window.ymaps && ymaps.ready(init); });
       var myMap;
       function init () {
           myMap = new ymaps.Map("map_canvas_user", {
                center: ['.$usr->field_longitude['und'][0]['value'].', '.$usr->field_latitude['und'][0]['value'].'],
                behaviors: [\'default\', \'scrollZoom\'],
                zoom: ';
            if( count($points)>1 ){
                $out.= '12';
            }else{
                $out.= '14';
            }
            $out.= '}, {
                searchControlProvider: \'yandex#search\'
            });
            ';
    
    if(is_array($points) and count($points)){
        foreach($points as $num=> $point){
            $out.= 'myPlacemark'.$num.' = new ymaps.Placemark(['.$point['longitude'].','.$point['latitude'].'], {
            iconContent: "'.$companyname.'", balloonContent: "'.$point['title'].'"
    	}, {
        preset: "islands#blueStretchyIcon",
        openEmptyBalloon: true
    });
    
    myMap.geoObjects.add(myPlacemark'.$num.');';
            if( $num==0 ){
                $out.= 'myPlacemark'.$num.'.balloon.open();';
            }
        }
        $out.= 'myMap.behaviors.disable(\'scrollZoom\');';
    }
                            $out.= '
       }
    </script>';
            

    }
    
    if( !is_dir('html/'.PDX_CITY_ID) ){
        mkdir('html/'.PDX_CITY_ID);
    }
    if( !is_dir('html/'.PDX_CITY_ID.'/map') ){
        mkdir('html/'.PDX_CITY_ID.'/map');
    }
    $fp = fopen('html/'.PDX_CITY_ID.'/map/'.$usr->uid.'.htm', 'w'); fwrite($fp, '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru" dir="ltr"><head><title>Арендодатель на карте</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body id="start">'.$out.'</body></html>'); fclose($fp);
    
}
function htmlNodeVideo($nd){
    $out='';
    if( isset($nd->nid) ){
        if( isset( $nd->field_youtube['und'] ) and is_array( $nd->field_youtube['und'] ) and count( $nd->field_youtube['und'] ) ){

                $outtmp=field_view_field('node', $nd, 'field_youtube', array(
          'label'=>'hidden',
          'type'=>'youtube_video',
          'settings'=>array(
            'youtube_size'=>'responsive',
          ),
        ));
                $out.=render($outtmp);
                $out.='<script type="text/javascript"> 
                    jQuery(\'.nid_video_'.$nd->nid.'_0\').html(\'<img alt="" src="'.PDX_IMGPATH.'/img/google_youtube.png" /> смотреть видео\');
                    jQuery(\'#videoblock'.$nd->nid.'\').show();
                </script>';

            if( !is_dir('html/'.PDX_CITY_ID) ){
                mkdir('html/'.PDX_CITY_ID);
            }
            if( !is_dir('html/'.PDX_CITY_ID.'/video') ){
                mkdir('html/'.PDX_CITY_ID.'/video');
            }
            $fp = fopen('html/'.PDX_CITY_ID.'/video/'.$nd->nid.'.htm', 'w'); fwrite($fp, '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru" dir="ltr"><head><title>Арендодатель на карте</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body id="start">'.$out.'</body></html>'); fclose($fp);

        }
    }
}
function pdx_meta_description_set(){
    $out='';
    if( drupal_is_front_page() ){
        $out='Всё, что можно взять в аренду в '.PDX_CITY_NAME2.', вы найдете у нас! А также на нашей площадке вы можете сдавать в аренду собственные вещи, которые вам в данный момент не нужны. Зарабатывая на них дополнительные деньги.';
    }else{
        switch(arg(0)){
        case 'catalog':
            if( is_numeric(arg(1)) ){
                switch(arg(1)){
                case 1952: //выпускной
                    $out='Выпускной - важный праздник в жизни каждого человека. Это переломный момент, первый шаг во взрослую жизнь. В этот день все выпускники хотят выглядеть потрясающе. И для этого нужно немало сил и денег. В данной рубрике мы предлагаем взять в аренду без переплат, и с экономией времени, все необходимое для важного дня в вашей жизни.';
                    break;
                case 1953: //день рождения
                    $out='День Рождения любимый праздник для многих из нас. В этот день мы хотим веселья и радости для себя и близких. Предпочтения у всех разные: кто-то любит отмечать в семейном кругу, а кто-то большой компанией. В данном разделе мы предлагаем взять в аренду все необходимое, для того чтобы сделать этот день лучшим.';
                    break;
                case 2166: //корпоратив
                    $out='Каждый из нас трудится на работе, вкладывая в свое дело много сил и времени, решает поставленные задачи. Но ведь нужно и отдыхать, для этого и существуют корпоративы. В данной рубрике вы найдете самое нужное для организации веселого корпоратива, все это по доступным ценам, быстро и качественно.';
                    break;
                case 1954: //новый год
                    $out='В данном разделе вы найдете большое разнообразие новогодних костюмов, красивую елку и украшения к ней, элементы декора. Новый Год праздник волшебства, мы загадываем заветные желания и хотим, чтобы они исполнились. Мы поможем вам запомнить этот праздник надолго, сделать его сказочным и красивым.';
                    break;
                case 1955: //свадьба
                    $out='В день свадьбы для любящей пары так важно, чтобы все прошло идеально. Это настолько нежный и наполненный любовью праздник, но в то же время настолько дорогой. Предлагаем обратить ваше внимание на данную рубрику, мы поможем выбрать для вас все самое лучшее, чтобы сделать ваш день счастливым и без лишних хлопот и переплат.';
                    break;
                case 1956: //хэллоуин
                    $out='Хеллоуин очень яркий и необычный праздник, который становится все популярнее в нашей стране. Самые смелые, интересные костюмы и украшения к ним, грим и устрашающие декорации вы найдете в данной рубрике. Ваш образ будет самым запоминающимся и незабываемым.';
                    break;
                case 2: //детский мир
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 94: //Для мамы
                            $out='Прокат аксессуаров для кормления, радио и видео-нянь от ведущих производителей по доступным ценам в '.PDX_CITY_NAME2.' – прекрасная возможность для молодых мам обзавестись всем необходимым для идеального ухода за ребенком без ущерба для семейного бюджета.';
                            break;
                        case 80: //Гуляем с малышом
                            $out='Прокат автокресел, колясок, слингов и других приспособлений по доступным ценам в '.PDX_CITY_NAME2.' дает родителям отличную возможность сэкономить, имея полный спектр нужных вещей для комфортных и безопасных поездок и пеших прогулок с ребенком.';
                            break;
                        case 67: //Игрушки
                            $out='Воспользуйтесь услугами проката в '.PDX_CITY_NAME2.' – так вы сможете познакомить малыша с большим количеством разнообразных качественных развивающих игрушек, сэкономите массу средств и не столкнетесь с проблемой хранения крупногабаритных вещей.';
                            break;
                        case 148: //Все для праздника
                            $out='Хотите устроить ребенку незабываемый праздник? Легко! Прокат ростовых кукол и иных товаров для детских праздников в '.PDX_CITY_NAME2.' – лучший способ обзавестись всем необходимым на наиболее выгодных условиях!';
                            break;
                        case 69: //Мебель для малыша
                            $out='Не успеваете обновлять мебель, из которой так быстро вырастает малыш? Надоело мучиться с пристроем и перепродажей детских товаров? Услуги проката в '.PDX_CITY_NAME2.' по низким ценам избавят родителей от подобных проблем и научат использовать свои средства более рационально!';
                            break;
                        }
                    }else{
                        $out='Арендуйте по доступным ценам любые товары для развития, игр, прогулок с малышом. Прокат детских товаров в '.PDX_CITY_NAME2.' поможет реально сэкономить в то время, когда ребенок стремительно растет! С '.$GLOBALS['base_url'].' легко сдавать и брать в аренду нужные вещи для самых маленьких.';
                    }
                    break;
                case 13: //одежда и украшения
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 2248: //одежда
                            $out='Всегда хорошо выглядеть, всегда иметь идеальный наряд для любого повода и при этом не разориться женщинам поможет сайт '.$GLOBALS['base_url'].'. Женская одежда по смешным ценам в '.PDX_CITY_NAME2.' – имейте больше, тратя меньше!';
                            break;
                        case 2704: //мужская одежда
                            $out='Нужен стильный костюм для важного мероприятия или торжества? В гардеробе не находится тематических вещей для запланированной фотосессии? Прокат мужской одежды в '.PDX_CITY_NAME2.' – всем необходимым можно воспользоваться за символическую сумму!';
                            break;
                        case 107: //для свадьбы
                            $out='Свадебные наряды приобретаются для одного выхода, но могут стоить, как недельное путешествие в экзотическую страну. Возьмите все необходимое для свадьбы на прокат в '.PDX_CITY_NAME2.'. Масса предложений с низкими ценами. А сэкономленным средствам вы быстро найдете лучшее применение!';
                            break;
                        case 998: //туризм
                            $out='Услуги проката одежды для туризма в '.PDX_CITY_NAME2.' – чувствуйте себя комфортно при любой погоде и в любых условиях! Доступные цены на аренду позволят сохранить больше средств для развлечений. На сайте '.$GLOBALS['base_url'].' вы быстро найдете и сможете арендоватьвсе необходимое.';
                            break;
                        case 77: //бижутерия
                            $out='Покупку аксессуаров сложно отнести к нужным тратам, но женщины понимают, что без этого порой никак не обойтись. Услуги проката бижутерии в '.PDX_CITY_NAME2.' позволят вам всегда находить нужные аксессуары для создания великолепных образов, не растрачивая при этом личный бюджет!';
                            break;
                        case 68: //для детей
                            $out='Прокат детской одежды в '.PDX_CITY_NAME2.' – выбор практичных родителей: экономя на том, из чего малыш быстро вырастет, вы сохраните средства на покупку более важных и нужных вещей, которые потом не придется пристраивать или перепродавать.';
                            break;
                        case 78: //драгоценности
                            $out='Драгоценные камни и металлы часто разделяют наши желания и возможности. Но ведь чтобы носить дорогие вещи, вовсе не обязательно ими обладать. Убедиться в этом помогут услуги проката драгоценностей в '.PDX_CITY_NAME2.' по невысоким ценам на сайте '.$GLOBALS['base_url'].'.';
                            break;
                        case 108: //карнавальные костюмы
                            $out='Прокат карнавальных костюмов в '.PDX_CITY_NAME2.' – прекрасная возможность эффектно выглядеть на тематическом мероприятии, затратив минимум средств. Аренда карнавального костюма избавит от хлопот с его хранением или перепродажей. А для новых вечеринок вы всегда сможете выбрать новый образ!';
                            break;
                        }
                    }else{
                        $out='С '.$GLOBALS['base_url'].' легко экономить и приумножать свои средства, арендуя и сдавая в прокат одежду и украшения. В каталоге – большой выбор товаров для взрослых и детей, торжественных и повседневных нарядов, одежды специального назначения. Вы обязательно найдете подходящий вариант для любого повода!';
                    }
                    break;
                case 3: //спорт и отдых
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 964: //для развлечений
                            $out='Прокат реквизита для развлечений, проведения активных игр, конкурсов, состязаний по невысоким ценам в '.PDX_CITY_NAME2.' – отличное решение, если вы задумали вылазку на природу с компанией друзей или организуете массовое мероприятие. Все необходимое можно арендовать быстро, легко и по приемлемой цене.';
                            break;
                        case 111: //Настольные игры
                            $out='Поклонникам настольных игр незачем тратиться на то, чтобы собрать коллекцию любимых развлечений. Прокат настольных игр в '.PDX_CITY_NAME2.' по невысоким ценам: любую игру можно арендовать в любое время на нужный вам срок без переплат и проблем с хранением!';
                            break;
                        case 75: //для активного отдыха
                            $out='Для любителей активного отдыха больше нет проблем с покупкой дорогостоящего оборудования, аксессуаров и спортивных снарядов, а также хранением всех этих вещей. Прокат товаров для активного отдыха в '.PDX_CITY_NAME2.': широкий ассортимент, доступные цены, выгодные условия!';
                            break;
                        case 928: //площадок и  помещений
                            $out='Поиск помещения или спортивной площадки для индивидуальной, групповой тренировки или организации секции больше не проблема. В '.PDX_CITY_NAME2.' можно снять в аренду помещение или площадку нужной вам площади и под нужный вид спорта по хорошей цене на любой срок!';
                            break;
                        case 882: //для дачи
                            $out='Не хватает средств, чтобы приобрести желаемый садовый инвентарь и товары для дачного отдыха? Прокат оборудования для дачи в '.PDX_CITY_NAME2.' – решение практичных и дальновидных людей! Зачем вам тратиться на дорогие сезонные приобретения, а потом ломать голову над вопросом их хранения!?';
                            break;
                        case 106: //для отдыха и туризма
                            $out='Есть желание сходить в поход или отправиться в путешествие? Нет возможности купить все необходимое? Не беда! Прокат туристического оборудования в '.PDX_CITY_NAME2.' по низким ценам – хороший выбор тех, кто хочет быть всегда мобильным, легким на подъем и иметь свободные средства!';
                            break;
                        case 105: //Других видов  тренажеров
                            $out='Тренажеры, массажеры, надувные игровые комплексы, батуты и иные приспособления для тренировок, активного отдыха, поддержания здоровья и хорошей физической формы можно взять на прокат в '.PDX_CITY_NAME2.' на нужный вам срок по доступной цене! Убедитесь сами – загляните в каталог '.$_SERVER['HTTP_HOST'].'!';
                            break;
                        case 70: //силовых тренажеров
                            $out='Хотите быть здоровыми, выглядеть красиво, иметь подтянутую фигуру, но не желаете тратить большие суммы денег на покупку силовых тренажеров? Не хотите превращать дом в хранилище «железа»? Тогда прокат силовых тренажеров в '.PDX_CITY_NAME2.' по отличным ценам – как раз то, что вам нужно!';
                            break;
                        case 104: //кардиотренажеров 
                            $out='Хотите заниматься на кардиотренажерах, но не хватает средств на их покупку? Не определились с выбором подходящего варианта? Прокат кардиотренажеров в '.PDX_CITY_NAME2.' по невысоким ценам: арендуйте любые изделия на нужный вам срок без серьезных финансовых потерь! Пробуйте и занимайтесь, сколько душе угодно!';
                            break;
                        case 2651: //отдых на воде
                            $out='Прокат оборудования для отдыха на воде – отличная возможность для тех, кто хочет открыть для себя новые виды спорта или активно заниматься полюбившимся делом, не покупая габаритных вещей. Доступные цены на прокат водного оборудования в '.PDX_CITY_NAME2.' сберегут ваш бюджет.';
                            break;
                        }
                    }else{
                        $out='Арендуйте в '.PDX_CITY_NAME2.' по доступным ценам любые товары для спорта и отдыха – это крайне выгодно и удобно. Прокат оборудования, экипировки, спортивных снарядов и прочих принадлежностей обойдется совсем недорого, а еще вам не придется беспокоиться о том, где все это хранить.';
                    }
                    break;
                case 1: //дом
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 983: //здоровье
                            $out='К сожалению, никто из нас не застрахован от проблем со здоровьем, а цены на уход за больным достаточно высоки. Поэтому прокат товаров медицинского назначения и предметов ухода за больными в '.PDX_CITY_NAME2.' – самое лучшее решение на пути к Вашему выздоровлению. По самым приемлемым  ценам, быстро и удобно для вас.';
                            break;
                        case 73: //для строительства
                            $out='Для тех, кто решил заняться строительством или сделать свой дом уютнее и современнее, больше не нужно целый день ходить по магазинам и тратить большие деньги. Специально для вас прокат всего для ремонта и строительства в '.PDX_CITY_NAME2.', на нужный срок, без проблем и переплат.';
                            break;
                        case 878: //Посуда
                            $out='Прокат посуды в '.PDX_CITY_NAME2.' для больших торжеств, для банкетов и фуршетов, для тихих семейных праздников или для милых пикников на природе. Мы предлагаем только качественную посуду и столовые приборы от лучших отечественных и европейских производителей по очень приятным ценам.';
                            break;
                        case 879: //Садовый инвентарь
                            $out='Красивый и ухоженный сад - это место где можно отдохнуть душой и телом. Соответственно уход за вашим любимым садом, требует много финансовых вложений и физического труда. Если вы хотите облегчить свою работу по усовершенствованию сада и не переплачивать, тогда хорошим решением для вас станет прокат садового инвентаря в '.PDX_CITY_NAME2.'. У нас есть вся необходимая техника.';
                            break;
                        }
                    }else{
                        $out='Если вы затеяли ремонт, хотите улучшить ваш сад или же понадобилась красивая посуда для приема гостей, тогда вам стоит обратить внимание на данную рубрику. Здесь вы легко сможете все это взять в аренду в '.PDX_CITY_NAME2.'.';
                    }
                    break;
                case 12: //техника
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 72: //для кухни
                            $out='Мы предлагаем лучшую кухонную технику на прокат в '.PDX_CITY_NAME2.', у нас есть все, что нужно: кофеварки, мультиварки, аэрогрили, все по доступным ценам и на удобный для вас срок.';
                            break;
                        case 71: //Фото
                            $out='Для того чтобы запечатлеть важные моменты из жизни, вы можете взять на прокат в '.PDX_CITY_NAME2.' профессиональное фото и видео оборудование а также аксессуары от ведущих мировых производителей.';
                            break;
                        case 74: //Прокат бытовой техники
                            $out='Прокат бытовой техники в '.PDX_CITY_NAME2.' позволит вам приобрести на нужное вам время качественную современную технику для дома.';
                            break;
                        case 76: //Аренда компьютерной техники
                            $out='Компьютеры, ноутбуки, планшеты. Все это можно взять в прокат в '.PDX_CITY_NAME2.' по доступным ценам.';
                            break;
                        case 112: //Игровые приставки
                            $out='Теперь вам не нужно платить большие деньги, достаточно просто взять в прокат современные игровые приставки в '.PDX_CITY_NAME2.': все виды Sony PlayStation, Xbox, аксессуары на любой срок и за невысокую цену.';
                            break;
                        case 881: //Аудиотехника 
                            $out='Прокат аудиотехники в Минске, позволит вам наслаждаться любимой музыкой, записывать и исполнять новые песни, научится играть на музыкальных инструментах. Только у нас широкий ассортимент, низкие цены, выгодные и удобные условия для вас.';
                            break;
                        }
                    }else{
                        $out='Данная рубрика позволит вам сполна насладиться комфортом и уютом вашего жилья. Если вы любите фотографировать, вам интересны компьютерные технологии, необходима кофеварка на кухню или вы обожаете громко слушать музыку, мы с удовольствием предоставим огромный выбор желаемого. Всего несколько кликов, и вы обладатель самой лучшей техники для дома и досуга, для вас самые популярные производители и современные новинки без переплат.';
                    }
                    break;
                case 5: //хобби
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 79: //для  рисования
                            $out='Если вы творческая личность и к вам пришло вдохновение написать картину, вы с легкостью можете взять на прокат в '.PDX_CITY_NAME2.' мольберт и начать творить, все что позволяет ваша фантазия. Наши цены, условия и качество товара вас приятно удивят.';
                            break;
                        case 867: //Книги и учебники
                            $out='Несмотря на то, что современное общество развивается с огромной скоростью, книги никогда не выйдут из нашей жизни, ведь только в них хранятся знания и опыт многих поколений людей.  Чтение с монитора компьютера не может сравниться с общением с бумажной книгой. Прокат книг в '.PDX_CITY_NAME2.', позволит вам наслаждаться любимыми писателями и их творениями.';
                            break;
                        case 868: //Зоотовары напрокат
                            $out='Вы очень любите своих домашних питомцев и хотите чтобы им было хорошо и комфортно жить рядом с вами? Прокат зоотоваров в '.PDX_CITY_NAME2.' позволит вам выбрать все необходимое для ухода за животными. вам больше не нужно переплачивать, тратить много времени на поиски и покупки, для того чтобы сделать домашних любимчиков счастливыми.';
                            break;
                        case 2810: //муз. инструменты
                            $out='Научится играть на музыкальных инструментах никогда не поздно, музыка всегда дарит радость и эстетичное удовольствие. Если вы решили заняться уроками музыки, или ваш инструмент поломался, тогда отличным решением для вас будет прокат музыкальных инструментов в '.PDX_CITY_NAME2.'. У нас большой выбор и приятные цены';
                            break;
                        }
                    }else{
                        $out='Мы предлагаем взять в аренду в '.PDX_CITY_NAME2.' музыкальные инструменты, мольберты, интересные книги, для того чтобы вы сделали этот мир еще прекраснее, раскрыли свой творческий потенциал.';
                    }
                    break;
                case 109: //бизнес
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 2555: //для заработка
                            $out='Прокат инструментов для заработка в '.PDX_CITY_NAME2.' позволит вам быстро, без переплат взять в аренду все необходимое для реализации ваших планов. Если вы решили подзаработать, или попробовать себя в роли частного предпринимателя, тогда мы с радостью поможем вам подобрать все, что вам нужно.';
                            break;
                        case 880: //для презентаций
                            $out='Если вам нужно провести презентацию нового проекта, произвести хорошее впечатление на начальство и поразить всех своими идеями, а времени на организацию не хватает, тогда на помощь вам придет прокат оборудования для презентаций в '.PDX_CITY_NAME2.'. Вас ждут выгодные условия, доставка и приятные цены.';
                            break;
                        case 110: //для шоу и мероприятий
                            $out='Все мы любим вечеринки, проводить время весело в кругу друзей и заводить новые знакомства, слушать музыку и наслаждаться хорошими моментами. Если вы решили затеять подобные развлечения, тогда прокат атрибутов для вечеринок и шоу в '.PDX_CITY_NAME2.' станет для вас отличным решением. Только качественное оборудование и приятные цены для вас.';
                            break;
                        case 2634: //аксессуары и реквизиты
                            $out='Прокат аксессуаров и реквизита для фотосессий в '.PDX_CITY_NAME2.' – отличная возможность быстро найти все необходимое по приемлемой цене. '.$GLOBALS['base_url'].' предлагает обширный каталог товаров для профессионалов и любителей, увлеченных искусством фотографии.';
                            break;
                        }
                    }else{
                        $out='Данная рубрика - это возможно первый шаг к открытию вашего собственного дела в '.PDX_CITY_NAME2.'. Взяв в прокат необходимое оборудование, вы можете попробовать себя в роли предпринимателя, оценить свои возможности. Также вы можете снять помещение под свою задумку.';
                    }
                    break;
                case 869: //транспорт
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 2187: //мото  транспорта
                            $out='Мотоциклы сочетают в себе скорость и силу. Для многих любителей экстрима – это любимый вид транспорта. Хороший байк в нынешнее время стоит достаточно дорого, и не каждый может себе позволить приобрести такое удовольствие. Прокат мототранспорта в '.PDX_CITY_NAME2.' позволит вам почувствовать силу и мощь за небольшое деньги на нужный  срок.';
                            break;
                        case 870: //легковых авто
                            $out='Автомобиль давно перестал быть роскошью. Он превратился не просто в средство передвижения, а стал для современного человека другом и помощником. Не все мы имеем возможность приобрести такого друга. А иногда очень нужно срочно поехать по делам или в путешествие. Поэтому отличным решением для вас будет взять в прокат автомобиль в '.PDX_CITY_NAME2.'.';
                            break;
                        case 871: //автобусов
                            $out='Прокат микроавтобусов и автобусов в '.PDX_CITY_NAME2.' позволит вам легко и без переплат воспользоваться данными видами транспорта для осуществления своих планов. Если вам нужно поехать на экскурсию в другой город или в гости большой компанией, тогда прокат будет отличным вариантом для вас.';
                            break;
                        case 874: //грузового транспорта
                            $out='Вам срочно необходимо переехать и перевезти всю мебель, или вы строите дом и нужно привезти тяжелые стройматериалы? Тогда прокат грузового транспорта в '.PDX_CITY_NAME2.' будет настоящим спасением. Все в удобное для вас время, качественно и за разумную цену.';
                            break;
                        case 873: //лимузинов
                            $out='Все мы хотим чтобы самые важные события в нашей жизни проходили идеально. Мы выбираем лучшие украшения, наряды, заведения для проведения праздников, и хорошим дополнением является праздничный транспорт. Прокат лимузинов в '.PDX_CITY_NAME2.' украсит лучшие моменты в вашей жизни: свадьбу, День Рождения, выпускной или юбилей.';
                            break;
                        case 875: //ретро транспорта
                            $out='Ретро-автомобиль, не простой транспорт, это настоящий символ эпохи. При этом страсть к ретро-автомобилям испытывают не только коллекционеры. К сожалению не все могут позволить себе такого «железного коня». Прокат  ретро-автомобилей в '.PDX_CITY_NAME2.' поможет вам почувствовать всю прелесть и роскошь данного транспорта, на желаемый срок и за хорошую цену.';
                            break;
                        case 1858: //кабриолетов
                            $out='Кабриолеты - сами по себе  достаточно эксклюзивное и дорогое удовольствие, которое не каждому человеку по карману. А ведь так хочется иногда проехаться с ветерком в летний солнечный день за рулем этого прекрасного автомобиля. Решение есть – прокат кабриолетов в '.PDX_CITY_NAME2.' позволит вам насладиться преимуществами автомобиля.';
                            break;
                        case 876: //Авто принадлежности
                            $out='Автолюбителям всегда хочется усовершенствовать свой транспорт. В продаже всегда появляются новые авто-принадлежности: GPS навигаторы, автохолодильники, все для двигателя и прочее. Для того чтобы не тратить большие деньги, вы можете взять в прокат все необходимое оборудование для своего автомобиля в '.PDX_CITY_NAME2.' по доступным ценам.';
                            break;
                        case 877: //спецтехники
                            $out='Прокат спецтехники в '.PDX_CITY_NAME2.' - отличное решение для тех, кто решил заняться стройкой, привести в порядок свой дом или земельный участок. У нас большой выбор техники от признанных мировых производителей, доступные цены и выгодные условия.';
                            break;
                        case 2111: //для спецтехники
                            $out='У нас есть все необходимое для вашей спецтехники: паллетные виллы, щетки с бункером, большой выбор запчастей. Возьмите в прокат в '.PDX_CITY_NAME2.' нужный инвентарь для спецтехники, по самым низким ценам и на любой срок.';
                            break;
                        case 2703: //карета
                            $out='Каждая девушка в детстве мечтала быть принцессой, мечтала о сказочной свадьбе. Теперь осуществить мечты очень просто! Взяв в прокат карету в '.PDX_CITY_NAME2.', вы почувствуете себя в самый важный день для вас, настоящей королевской парой. Также кареты подходят для романтических свиданий и сюрпризов. У нас самые лучшие цены и условия для вас.';
                            break;
                        }
                    }else{
                        $out='Данный раздел позволит вам взять в аренду абсолютно любой вид транспорта на любые случаи жизни в '.PDX_CITY_NAME2.'. Еще мы предлагаем взять в аренду необходимое оборудование и запчасти для вашего автомобиля или спецтехники.';
                    }
                    break;
                }
            }
            break;
        case 'users':
            if( is_string(arg(1)) and arg(1)=='rents' ){
                $out='В данном разделе вы с легкостью можете найти и ознакомиться с арендодателями в '.PDX_CITY_NAME2.', а также со всеми объявлениями компаний. Найти нужную вещь очень просто, с помощью функции «поиск вещи», которая находится вверху справа на данной странице.';
            }
            break;
        case 'node':
            if( isset($_SESSION['pdxpdx_node_type']) and strlen($_SESSION['pdxpdx_node_type']) and isset($_SESSION['pdxpdx_node_nid']) and is_numeric($_SESSION['pdxpdx_node_nid']) ){
                switch($_SESSION['pdxpdx_node_type']){
                case 'item':
                case 'news':
                case 'article':
                case 'webform':
                    if( $_SESSION['pdxpdx_node_nid']==135 ){
                        $out='В данном разделе вы найдете ответы на часто задаваемые вопросы. Для вашего удобства в колонке справа размещен рубрикатор с инструкциями по пользованию сайтом.';
                    }else{
                        $isbody=db_query('select body_value from {field_data_body} where entity_type=\'node\' and entity_id='.$_SESSION['pdxpdx_node_nid']);
                        $isbody=$isbody->fetchAssoc();
                        if( isset($isbody['body_value']) and strlen($isbody['body_value']) ){
                            $isbody['body_value']=str_replace("\r", "", str_replace("\n", "", strip_tags($isbody['body_value'])));
                            if( mb_strlen($isbody['body_value'])>250 ){
                                $isbody['body_value']=mb_substr($isbody['body_value'], 0, 247).'...';
                            }
                            $out=$isbody['body_value'];
                        }
                    }
                    break;
                }
            }
            break;
        }
    }
    if( mb_strlen($out)>250 ){
        $out=mb_substr($out, 0, 247).'...';
    }
    return $out;
}
function pdx_change_title($title=''){
    $out='';
    if( drupal_is_front_page() ){
    }else{
        switch(arg(0)){
        case 'catalog':
            if( is_numeric(arg(1)) ){
                switch(arg(1)){
                case 2: //детский мир
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 94: //Для мамы
                            $out= 'Товары для мамы напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 80: //Гуляем с малышом
                            $out= 'Прокат товаров для прогулки с малышом в '.PDX_CITY_NAME2;
                            break;
                        case 67: //Игрушки
                            $out= 'Детские игрушки напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 148: //Все для праздника
                            $out= 'Прокат разных вещей для детского праздника в '.PDX_CITY_NAME2;
                            break;
                        case 69: //Мебель для малыша
                            $out= 'Прокат детской мебели в '.PDX_CITY_NAME2;
                            break;
                        }
                    }else{
                        $out= 'Прокат вещей для мамы и малыша в '.PDX_CITY_NAME2;
                    }
                    break;
                case 13: //одежда и украшения
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 2248: //одежда
                            $out= 'Женская одежда напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 107: //для свадьбы
                            $out= 'Прокат свадебных принадлежностей в '.PDX_CITY_NAME2;
                            break;
                        case 998: //туризм
                            $out= 'Прокат туристического снаряжения в '.PDX_CITY_NAME2;
                            break;
                        case 77: //бижутерия
                            $out= 'Бижутерия, украшения напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 68: //для детей
                            $out= 'Прокат одежды для детей в '.PDX_CITY_NAME2;
                            break;
                        case 78: //драгоценности
                            $out= 'Драгоценности напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 108: //карнавальные костюмы
                            $out= 'Прокат карнавальных костюмов в '.PDX_CITY_NAME2;
                            break;
                        case 2704: //мужские костюмы
                            $out= 'Мужская одежда напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 2997: //Спецодежда и униформа
                            $out= 'Прокат Спецодежды и униформы в '.PDX_CITY_NAME2;
                            break;
                        }
                    }else{
                        $out= 'Прокат одежды, аксессуаров, украшений в '.PDX_CITY_NAME2;
                    }
                    break;
                case 3: //спорт и отдых
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 964: //для развлечений
                            $out= 'Прокат всего для развлечений в '.PDX_CITY_NAME2;
                            break;
                        case 111: //Настольные игры
                            $out= 'Настольные игры - прокат в '.PDX_CITY_NAME2;
                            break;
                        case 75: //для активного отдыха
                            $out= 'Прокат снаряжения для активного отдыха, в '.PDX_CITY_NAME2;
                            break;
                        case 928: //площадок и  помещений
                            $out= 'Аренда площадок и помещений в '.PDX_CITY_NAME2;
                            break;
                        case 882: //для охоты
                            $out= 'Прокат и аренда охотничьего снаряжения в '.PDX_CITY_NAME2;
                            break;
                        case 106: //для отдыха и туризма
                            $out= 'Прокат товаров для отдыха и туризма в '.PDX_CITY_NAME2;
                            break;
                        case 105: //Других видов  тренажеров
                            $out= 'Прокат других видов тренажеров в '.PDX_CITY_NAME2;
                            break;
                        case 70: //силовых тренажеров
                            $out= 'Прокат силовых тренажеров и оборудования для фитнеса в '.PDX_CITY_NAME2;
                            break;
                        case 104: //кардиотренажеров 
                            $out= 'Прокат кардиотренажеров и оборудования для фитнеса в '.PDX_CITY_NAME2;
                            break;
                        case 2651: //на воде
                            $out= 'Прокат водного транспорта и других принадлежностей для отдыха на воде, в '.PDX_CITY_NAME2;
                            break;
                        case 3005: //зимний отдых
                            $out= 'Прокат оборудования для зимнего отдыха в '.PDX_CITY_NAME2;
                            break;
                        }
                    }else{
                        $out= 'Аренда спортивных тренажеров и все для отдыха в '.PDX_CITY_NAME2;
                    }
                    break;
                case 1: //дом
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 983: //здоровье
                            $out= 'Товары для здоровья и ухода напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 73: //для строительства
                            $out= 'Инструменты для строительства и ремонта напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 878: //Посуда
                            $out= 'Посуда напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 879: //Садовый инвентарь
                            $out= 'Садовый инвентарь и инструменты напрокат в '.PDX_CITY_NAME2;
                            break;
                        }
                    }else{
                        $out= 'Аренда вещей, полезных в домашнем хозяйстве, в '.PDX_CITY_NAME2;
                    }
                    break;
                case 12: //техника
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 72: //для кухни
                            $out= 'Техника для кухни напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 71: //Фото
                            $out= 'Фото/видео прокат в '.PDX_CITY_NAME2;
                            break;
                        case 74: //Прокат бытовой техники
                            $out= 'Прокат бытовой техники в '.PDX_CITY_NAME2;
                            break;
                        case 76: //Аренда компьютерной техники
                            $out= 'Аренда компьютерной техники в '.PDX_CITY_NAME2;
                            break;
                        case 112: //Игровые приставки
                            $out= 'Игровые приставки напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 881: //Аудиотехника 
                            $out= 'Аудиотехника напрокат в '.PDX_CITY_NAME2;
                            break;
                        }
                    }else{
                        $out= 'Аренда фото-, видео-, аудио- и бытовой техники в '.PDX_CITY_NAME2;
                    }
                    break;
                case 5: //хобби
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 79: //для  рисования
                            $out= 'Прокат принадлежностей для рисования в '.PDX_CITY_NAME2;
                            break;
                        case 867: //Книги и учебники
                            $out= 'Книги и учебники напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 868: //Зоотовары напрокат
                            $out= 'Зоотовары напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 2810: //Муз инструменты
                            $out= 'Прокат музыкальных инструментов в '.PDX_CITY_NAME2;
                            break;
                        }
                    }else{
                        $out= 'Аренда вещей для хобби и вашего питомца в '.PDX_CITY_NAME2;
                    }
                    break;
                case 109: //бизнес
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 2555: //для заработка
                            $out= 'Прокат оборудования для заработка в '.PDX_CITY_NAME2;
                            break;
                        case 880: //для презентаций
                            $out= 'Прокат оборудования для презентаций в '.PDX_CITY_NAME2;
                            break;
                        case 110: //для шоу и мероприятий
                            $out= 'Прокат оборудования, аксессуаров для шоу и мероприятий в '.PDX_CITY_NAME2;
                            break;
                        case 2634: //реквизиты
                            $out= 'Аксессуары и реквизиты для фотосессии напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 2962: //помещания
                            $out= 'Аренда помещений под свои нужды в '.PDX_CITY_NAME2;
                            break;
                        case 2987: //все для офиса
                            $out= 'Прокат копировальных аппаратов, ксероксов и оргтехники в '.PDX_CITY_NAME2;
                            break;
                        }
                    }else{
                        $out= 'Аренда оборудования для бизнеса в '.PDX_CITY_NAME2;
                    }
                    break;
                case 869: //транспорт
                    if( is_numeric(arg(2)) ){
                        switch(arg(2)){
                        case 2187: //мото  транспорта
                            $out= 'Прокат мотоциклов в '.PDX_CITY_NAME2;
                            break;
                        case 870: //легковых авто
                            $out= 'Прокат легковых авто в '.PDX_CITY_NAME2;
                            break;
                        case 871: //автобусов
                            $out= 'Прокат автобусов в '.PDX_CITY_NAME2;
                            break;
                        case 874: //грузового транспорта
                            $out= 'Прокат грузового транспорта в '.PDX_CITY_NAME2;
                            break;
                        case 873: //лимузинов
                            $out= 'Прокат лимузинов в '.PDX_CITY_NAME2;
                            break;
                        case 875: //ретро транспорта
                            $out= 'Прокат ретро автомобилей в '.PDX_CITY_NAME2;
                            break;
                        case 1858: //кабриолетов
                            $out= 'Прокат кабриолетов в '.PDX_CITY_NAME2;
                            break;
                        case 876: //Авто принадлежности
                            $out= 'Авто принадлежности, оборудование напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 877: //спецтехники
                            $out= 'Аренда спецтехники в '.PDX_CITY_NAME2;
                            break;
                        case 2111: //для спецтехники
                            $out= 'Оборудование для спецтехники напрокат в '.PDX_CITY_NAME2;
                            break;
                        case 2703: //карета
                            $out= 'Прокат других видов транспорта в '.PDX_CITY_NAME2;
                            break;
                        case 2780: //дом на колесах
                            $out= 'Прокат домов на колесах в '.PDX_CITY_NAME2;
                            break;
                        }
                    }else{
                        $out= 'Прокат авто и мото транспорта в '.PDX_CITY_NAME2;
                    }
                    break;
                case 1952: //выпускной
                    $out= 'Аренда вещей на выпускной в '.PDX_CITY_NAME2;
                    break;
                case 1953: //др
                    $out= 'Прокат вещей на день рождения в '.PDX_CITY_NAME2;
                    break;
                case 2166: //корпоратив
                    $out= 'Аренда вещей для корпоратива в '.PDX_CITY_NAME2;
                    break;
                case 2154: //нг
                    $out= 'Аренда вещей на Новый Год в '.PDX_CITY_NAME2;
                    break;
                case 1955: //свадьба
                    $out= 'Аренда вещей на свадьбу в '.PDX_CITY_NAME2;
                    break;
                case 1956: //хэллоуин
                    $out= 'Аренда вещей на хэллоуин в '.PDX_CITY_NAME2;
                    break;
                }
                if( is_numeric(arg(3)) ){
                    $out.=': '.$title;
                }
            }else{
                $out= 'Каталог товаров, доступных к аренде в '.PDX_CITY_NAME2;
            }
            break;
        }
    }
    return $out;
}
function pdxseparate_cron() {
    $reqpath=getcwd() . '/sites/all/themes/pdxneedto/my.inc';
    $reqpath=str_replace('mcache/filecache-default/', '', $reqpath);
    require_once $reqpath;
/*    
    if( defined('PDX_CITY_ID') and PDX_CITY_ID!=28 ){
        $changed=$changedvid=0;
        $data='';
        $data=file_get_contents('http://mn.needto.me/curs/tax/delete');
        if( $data ){
            $data=unserialize($data);
            if( isset($data) and is_array($data) and count($data) ){
                foreach( $data as $tm => $dat ){
                    if( isset($dat) and is_array($dat) and count($dat) ){
                        foreach( $dat as $tid => $dt ){
                            if( is_numeric($tid) ){
                                $num=db_query('select tid, vid from {taxonomy_term_data} where tid='.$tid);
                                $num=$num->fetchAssoc();
                                if( isset($num['tid']) ){
                                    if( $num['vid']==2 or $num['vid']==10 ){
                                        $changedvid=2;
                                    }
                                    taxonomy_term_delete($num['tid']);
                                    $changed++;
                                }
                            }
                        }
                    }
                }
            }
        }
        $data='';
        $data=file_get_contents('http://mn.needto.me/curs/tax/insert');
        if( $data ){
            $data=unserialize($data);
            if( isset($data) and is_array($data) and count($data) ){
                foreach( $data as $tm => $dat ){
                    if( isset($dat) and is_array($dat) and count($dat) ){
                        foreach( $dat as $tid => $dt ){
                            if( is_numeric($tid) ){
                                $num=db_query('select tid from {taxonomy_term_data} where tid='.$tid);
                                $num=$num->fetchAssoc();
                                if( isset($num['tid']) ){}else{
                                    if( isset($dt) and is_array($dt) and count($dt) and isset($dt['vid']) and is_numeric($dt['vid']) and isset($dt['name']) and strlen($dt['name']) and isset($dt['weight']) and is_numeric($dt['weight']) ){
                                        $changed++;
                                        if( $dt['vid']==2 or $dt['vid']==10 ){
                                            $changedvid=2;
                                        }
                                        $desc='';
                                        if( isset($dt['desc']) and strlen($dt['desc']) ){
                                            $desc=filter_xss($dt['desc']);
                                        }
                                        db_query('insert into {taxonomy_term_data} (tid, vid, name, description, format, weight) VALUES ('.$tid.', '.$dt['vid'].', :combo1, :combo2, \'limited\', '.$dt['weight'].')', array(':combo1'=>strip_tags($dt['name']), ':combo2'=>$desc));
                                        db_query('insert into {taxonomy_term_hierarchy} (tid, parent) VALUES ('.$tid.', 0)');
                                        $bundle=db_query('select machine_name from {taxonomy_vocabulary} where vid='.$dt['vid']);
                                        $bundle=$bundle->fetchAssoc();
                                        if( isset( $bundle['machine_name'] ) and strlen( $bundle['machine_name'] ) ){
                                            if( isset($dt['field_part']) and is_numeric($dt['field_part']) ){
                                                db_query('insert into {field_data_field_part} (entity_type, bundle, deleted, entity_id, revision_id, language, delta, field_part_tid) VALUES (\'taxonomy_term\', :combo1, 0, '.$tid.', '.$tid.', \'und\', 0, '.$dt['field_part'].')', array(':combo1'=>$bundle['machine_name']));
                                            }
                                            if( isset($dt['field_subpart']) and is_numeric($dt['field_subpart']) ){
                                                db_query('insert into {field_data_field_subpart} (entity_type, bundle, deleted, entity_id, revision_id, language, delta, field_subpart_tid) VALUES (\'taxonomy_term\', :combo1, 0, '.$tid.', '.$tid.', \'und\', 0, '.$dt['field_subpart'].')', array(':combo1'=>$bundle['machine_name']));
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        $data='';
        $data=file_get_contents('http://mn.needto.me/curs/tax/update');
        if( $data ){
            $data=unserialize($data);
            if( isset($data) and is_array($data) and count($data) ){
                foreach( $data as $tm => $dat ){
                    if( isset($dat) and is_array($dat) and count($dat) ){
                        foreach( $dat as $tid => $dt ){
                            if( is_numeric($tid) and isset($dt) and is_array($dt) and isset($dt['name']) and strlen($dt['name']) ){
                                $num=db_query('select tid from {taxonomy_term_data} where tid='.$tid);
                                $num=$num->fetchAssoc();
                                if( isset($num['tid']) ){
                                    $dt['name']=strip_tags($dt['name']);
                                    db_query('update {taxonomy_term_data} set name=:combo where tid='.$num['tid'], array(':combo'=>$dt['name']));
                                    if( isset($dt['field_part']) and is_numeric($dt['field_part']) ){
                                        db_query('update {field_data_field_part} set field_part_tid='.$dt['field_part'].' where entity_type=\'taxonomy_term\' and entity_id='.$tid);
                                    }
                                    if( isset($dt['field_subpart']) and is_numeric($dt['field_subpart']) ){
                                        db_query('update {field_data_field_subpart} set field_subpart_tid='.$dt['field_subpart'].' where entity_type=\'taxonomy_term\' and entity_id='.$tid);
                                    }

                                }
                            }
                        }
                    }
                }
            }
        }
        if( $changed ){
            if( function_exists('getaddtocat') ){
                getaddtocat();
                if( $changedvid==2 ){
                    menu_rebuild();
                }
            }
        }
    }
*/    

    @file_get_contents($GLOBALS['base_url'].'/clearold.php');

    //vk
    if( !file_exists('pdxcache/simplenews_vk') ){
        $fp = fopen('pdxcache/simplenews_vk', 'w'); fwrite($fp, '0'); fclose($fp);
    }
    if( file_exists('pdxcache/simplenews_vk') ){
    $out= file_get_contents('pdxcache/simplenews_vk');
    if( !isset($out) or !is_numeric($out) or (time()-$out)>14777 ){
        if( defined('PDX_VKONTAKTE') and strlen(PDX_VKONTAKTE) and defined('PDX_CITY_ID') and PDX_CITY_ID ){
            $fp = fopen('pdxcache/simplenews_vk', 'w');
            fwrite($fp, time());
            fclose($fp);
            
            $lastnid=0;
            $out= file_get_contents('pdxcache/vk_nid_'.PDX_CITY_ID);
            if( isset($out) and strlen($out) and is_numeric($out) ){
                $lastnid=$out;
            }
        
            $style= image_style_load('product_full');
        
            $anids=array();
            $img='';
            $nids=db_query('select n.nid, n.title, i.field_image_fid, fb.body_value from {node} as n inner join {field_data_field_image} as i on (n.nid=i.entity_id and i.entity_type=\'node\' and i.delta=0) left join {field_data_body} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') left join {field_data_field_delete} as d on (n.nid=d.entity_id and d.entity_type=\'node\') left join {field_data_field_block} as b on (n.nid=b.entity_id and b.entity_type=\'node\') where n.type=\'item\' and n.status=1 and n.nid>'.$lastnid.' and ( d.field_delete_value IS NULL or d.field_delete_value=0 ) and ( b.field_block_value IS NULL or b.field_block_value=0 ) order by nid asc limit 0, 10');
            while( $nid=$nids->fetchAssoc() ){
                $anids[$nid['nid']]['title']=$nid['title'];
                $path=path_load('node/'.$nid['nid']); if(strlen($path['alias'])) $path=$path['alias']; else $path='node/'.$nid['nid'];
                $anids[$nid['nid']]['path']=$GLOBALS['base_url'].'/'.$path;


                $all = file_load($nid['field_image_fid']);
                $uri = $all->uri;
                if( isset( $uri ) and strlen( $uri ) ){
                    $img=image_style_url('product_full', $uri);
                    $imget = file_get_contents($img);
                    if($imget){
                        $fp = fopen(DRUPAL_ROOT . '/curs/v'.$nid['nid'].'.jpg', "w");
                        if($fp){
                            fwrite($fp, $imget);
                            fclose($fp);
                        }
                        $anids[$nid['nid']]['image']=DRUPAL_ROOT . '/curs/v'.$nid['nid'].'.jpg';
                    }
                }

            
/*
                $fl = file_create_url($uri);
                if( isset($fl) and strlen($fl) ){
                    $imget = file_get_contents($fl);
                    if($imget){
                        $fp = fopen(file_directory_temp().'/'.$all->filename, "w");
                        if($fp){
                            fwrite($fp, $imget);
                            fclose($fp);
                        }
                    }
                }
                $uri2 = file_directory_temp().'/'.$all->filename;
        
                if( file_exists($uri2) ){
                    $anids[$nid['nid']]['image']=$uri2;
                }
*/        
                
                $body='';
                if( isset($nid['body_value']) and strlen($nid['body_value']) ){
                    $nid['body_value']=strip_tags($nid['body_value']);
                    if( mb_strlen($nid['body_value'])>255 ){
                        $nid['body_value']=mb_substr($nid['body_value'], 0, 253).'...';
                    }
                    $body=$nid['body_value'];
                }
                $anids[$nid['nid']]['desc']=$body;
            
                $lastnid=$nid['nid'];
            }
            if( isset($anids) and is_array($anids) and count($anids) ){
                $desc='#'.PDX_CITY_NAME." #Аренда Новые товары, предлагаемые к аренде на сайте:
        ";
                $desc2='';
                $i=0;
                foreach( $anids as $nid => $obj ){
                    $desc.='
        ________________________________________________
        '.(++$i).'. '.$obj['title'].': '.$obj['path']."
        
        ".$obj['desc'];
                    $desc2.=$i.'. '.$obj['title'].': '.$obj['path']."<br />";
                }
                
                $images=array();
                foreach( $anids as $nid => $obj ){
                    $images[] = '@' . $obj['image'];
                }
        
                $image_ids='';
                if( isset($images) and is_array($images) and count($images) ){ 
                    $upload_url = _vkxp_get_upload_server();
                    $image_ids  = _vkxp_upload_images($upload_url, $images);
                }
                
                _vkxp_post_to_wall(html_entity_decode($desc), $image_ids, $GLOBALS['base_url']);

                foreach( $anids as $nid => $obj ){
                    if( isset($obj['image']) and strlen($obj['image']) and file_exists($obj['image']) ){
                        unlink($obj['image']);
                    }
                }
        
        
        /*
                $page_id = '996282783743830';
                $fb = facebook_autopost('post');
                
                $publication = array(
                'type' => 'post',
                'params' => array(
                'name' => 'Возьми в аренду в Минске: новые предложения',
                'link' => $GLOBALS['base_url'],
                'picture' => $img,
                'description' => $desc2,
                ),
                );
                $fb->publish($publication, $page_id);
        */
            
                $fp = fopen('pdxcache/vk_nid_'.PDX_CITY_ID, 'w');
                fwrite($fp, $lastnid);
                fclose($fp);
            
            
            }
            
        
        }
/*
$edit = new stdClass();  
$edit->type = 'simplenews';  
node_object_prepare($edit);        
$edit->title = 'Новые предложения от Needto.me: '.date('j', time()).' '.mb_strtolower(pdxneedto_month_declination_ru(format_date(time(),'custom','F'),date('n',time()))).' '.date('Y', time()).' года, '.date('H:i:s', time()); 
$edit->language = LANGUAGE_NONE;

$edit->body[$edit->language][0]['value'] = $desc;
$edit->body[$edit->language][0]['summary'] = '';
$edit->body[$edit->language][0]['format'] = 'full_html';

$tag=taxonomy_term_load(65);
if($tag){
    $edit->field_simplenews_term[$edit->language][0] = (array)$tag;
}

if($nd = node_submit($edit)) {
    node_save($nd);
    if($nd->nid){

    }
}
*/

        
    }
    }
    
    


    //в социалку новости
    if( defined('PDX_VKONTAKTE') and strlen(PDX_VKONTAKTE) ){
        
        $link=url('news', array('absolute'=>TRUE) );
        $img='';
    
        $lastnid=0;
        if( file_exists('pdxcache/news_nid') ){
            $out= file_get_contents('pdxcache/news_nid');
            if( isset($out) and strlen($out) and is_numeric($out) ){
                $lastnid=$out;
            }
        }
    //    $params=array('title'=>'Новости needto.me', 'description'=>'', 'link'=>'http://needto.me/news');
    
        $style= image_style_load('news_full');
    
        $anids=array();
        $nids=db_query('select n.nid, n.title, i.field_image_fid, fb.body_value from {node} as n left join {field_data_field_image} as i on (n.nid=i.entity_id and i.entity_type=\'node\' and i.delta=0) left join {field_data_body} as fb on (n.nid=fb.entity_id and fb.entity_type=\'node\') where n.type=\'news\' and n.status=1 and n.nid>'.$lastnid.' order by nid asc limit 0, 1');
        while( $nid=$nids->fetchAssoc() ){
            $anids[$nid['nid']]['title']=$nid['title'];
        
            $uri='';
            if( isset($nid['field_image_fid']) and is_numeric($nid['field_image_fid']) ){
                $uri = file_load($nid['field_image_fid'])->uri;
                $img=image_style_url('news_full', $uri);
                $real = drupal_realpath($uri);
                $uri = image_style_path('news_full', $uri);
                $uri = drupal_realpath($uri);
                if( !file_exists($uri) ){
                    image_style_create_derivative($style, $real, $uri);
                }
            }
            if(isset($uri) and strlen($uri)){
                $anids[$nid['nid']]['image']=$uri;
            }
            
            $body='#'.PDX_CITY_NAME.' #Новости ';
            if( isset($nid['body_value']) and strlen($nid['body_value']) ){
                $body.=strip_tags(nl2br($nid['body_value']));
            }
            $anids[$nid['nid']]['desc']=$body;
        
            $lastnid=$nid['nid'];
        }
        if( isset($anids) and is_array($anids) and count($anids) ){
            $desc="";
            $i=0;
            foreach( $anids as $nid => $obj ){
                $desc.=$obj['title']."
    
    ".$obj['desc']."
    --------------
    ";
            }
            
            $images=array();
            foreach( $anids as $nid => $obj ){
                $images[] = '@' . $obj['image'];
            }
    
    
            $image_ids='';
            if( isset($images) and is_array($images) and count($images) ){ 
                $upload_url = _vkxp_get_upload_server();
                $image_ids  = _vkxp_upload_images($upload_url, $images);
            }
            
            
        
            _vkxp_post_to_wall(html_entity_decode($desc), $image_ids, $link);
        
            $fp = fopen('pdxcache/news_nid', 'w');
            fwrite($fp, $lastnid);
            fclose($fp);
    
    /*
    	  if ($fb = _fb_api_init(558409070988219)) {
    	    try {
              $page_info = $fb->api('/996282783743830?fields=access_token');
    	      drupal_set_message('<pre>'.print_r($page_info, true). '</pre>');
    	      $params['access_token'] = $page_info['access_token'];
    	      $fb->api('/996282783743830/feed', 'POST', $params);
    	    }
    	    catch (FacebookApiException $e) {
    	      drupal_set_message('<pre>'.print_r($e, true). '</pre>Не удалось опубликовать на Facebook');
    	    }
    	  }
    */
    
            $page_id = '996282783743830';
            $fb = facebook_autopost('post');
            
            $publication = array(
            'type' => 'post',
            'params' => array(
            'name' => 'У нас свежие новости',
            'link' => $link,
            'picture' => $img,
            'description' => $desc,
            ),
            );
            $fb->publish($publication, $page_id);
        
        }
        
    
    
        //findmy
        $lastnid=0;
        if( file_exists('pdxcache/vk_findmy_'.PDX_CITY_ID) ){
            $out= file_get_contents('pdxcache/vk_findmy_'.PDX_CITY_ID);
            if( isset($out) and strlen($out) and is_numeric($out) ){
                $lastnid=$out;
            }
        }
    
        $anids=array();
        $nids=db_query('select n.nid, n.title, f.field_str1_value from {node} as n left join {field_data_field_str1} as f on (n.nid=f.entity_id and f.entity_type=\'node\') where n.type=\'findmy\' and n.status=1 and n.nid>'.$lastnid.' order by nid asc limit 0, 10');
        while( $nid=$nids->fetchAssoc() ){
            $anids[$nid['nid']]['path']=$GLOBALS['base_url'].'/findmy#findmy_nid_'.$nid['nid'];
            $anids[$nid['nid']]['title']=$nid['title'];
            if( isset($nid['field_str1_value']) and strlen($nid['field_str1_value']) ){
                $anids[$nid['nid']]['str1']=$nid['field_str1_value'];
            }
        
            $lastnid=$nid['nid'];
        }
        if( isset($anids) and is_array($anids) and count($anids) ){
            $desc='#'.PDX_CITY_NAME." #ВозьмуВАренду Новые заявки на аренду товаров:
    ";
            $i=0;
            foreach( $anids as $nid => $obj ){
                $desc.='
    ________________________________________________
    '.(++$i).'. '.$obj['title'].': '.$obj['path']."
    ";
            if( isset($obj['str1']) and strlen($obj['str1']) ){
                $desc.="
    ".$obj['str1'];
            }
            }
            
            $image_ids='';
        
            _vkxp_post_to_wall(html_entity_decode($desc), $image_ids, $GLOBALS['base_url']);
        
            $fp = fopen('pdxcache/vk_findmy_'.PDX_CITY_ID, 'w');
            fwrite($fp, $lastnid);
            fclose($fp);
        
        
        }
    

    }


}
function pdxseparate_taxonomy_term_insert($term) {
    if( !is_dir('curs') ){
        mkdir('curs');
    }
    if( !is_dir('curs/tax') ){
        mkdir('curs/tax');
    }
    if( file_exists('curs/tax/insert') ){
        $out= unserialize(file_get_contents('curs/tax/insert'));
    }
    if( !isset($out) or !is_array($out) ){
        $out=array();
    }else{
        $tmdel=time()-111111;
        foreach( $out as $tm => $ou ){
            if( $tm<$tmdel ){
                unset($out[$tm]);
            }
        }
    }
    $tmdel=time();
    $out[$tmdel][$term->tid]['name']=$term->name;
    $out[$tmdel][$term->tid]['vid']=$term->vid;
    $out[$tmdel][$term->tid]['weight']=$term->weight;
    $out[$tmdel][$term->tid]['desc']=$term->description;
    if( isset($term->field_part['und'][0]['tid']) and is_numeric($term->field_part['und'][0]['tid']) ){
        $out[$tmdel][$term->tid]['field_part']=$term->field_part['und'][0]['tid'];
    }
    if( isset($term->field_subpart['und'][0]['tid']) and is_numeric($term->field_subpart['und'][0]['tid']) ){
        $out[$tmdel][$term->tid]['field_subpart']=$term->field_subpart['und'][0]['tid'];
    }
    $fp = fopen('curs/tax/insert', 'w'); fwrite($fp, serialize($out)); fclose($fp);

    if( function_exists('pdxcleartermcaches') ){
        pdxcleartermcaches($term);
    }
}
function pdxseparate_taxonomy_term_update($term) {
    if( !is_dir('curs') ){
        mkdir('curs');
    }
    if( !is_dir('curs/tax') ){
        mkdir('curs/tax');
    }
    if( file_exists('curs/tax/update') ){
        $out= unserialize(file_get_contents('curs/tax/update'));
    }
    if( !isset($out) or !is_array($out) ){
        $out=array();
    }else{
        $tmdel=time()-111111;
        foreach( $out as $tm => $ou ){
            if( $tm<$tmdel ){
                unset($out[$tm]);
            }
        }
    }
    
    $tmdel=time();
    $out[$tmdel][$term->tid]['name']=$term->name;
    if( isset($term->field_part['und'][0]['tid']) and is_numeric($term->field_part['und'][0]['tid']) ){
        $out[$tmdel][$term->tid]['field_part']=$term->field_part['und'][0]['tid'];
    }
    if( isset($term->field_subpart['und'][0]['tid']) and is_numeric($term->field_subpart['und'][0]['tid']) ){
        $out[$tmdel][$term->tid]['field_subpart']=$term->field_subpart['und'][0]['tid'];
    }
    $fp = fopen('curs/tax/update', 'w'); fwrite($fp, serialize($out)); fclose($fp);

    if( function_exists('pdxcleartermcaches') ){
        pdxcleartermcaches($term);
    }
}
function pdxseparate_taxonomy_term_delete($term) {
    if( !is_dir('curs') ){
        mkdir('curs');
    }
    if( !is_dir('curs/tax') ){
        mkdir('curs/tax');
    }
    if( file_exists('curs/tax/delete') ){
        $out= unserialize(file_get_contents('curs/tax/delete'));
    }
    if( !isset($out) or !is_array($out) ){
        $out=array();
    }else{
        $tmdel=time()-111111;
        foreach( $out as $tm => $ou ){
            if( $tm<$tmdel ){
                unset($out[$tm]);
            }
        }
    }
    $out[time()][$term->tid]=1;
    $fp = fopen('curs/tax/delete', 'w'); fwrite($fp, serialize($out)); fclose($fp);
    
    if( function_exists('pdxcleartermcaches') ){
        pdxcleartermcaches($term);
    }
}
function pdxseparate_flag_unflag($flag, $entity_id, $account, $flagging) {
    global $user; if( $user->uid ){ 
        if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$user->uid.'_sm_needto') ){
            unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$user->uid.'_sm_needto');
        }
    }
}
function pdxseparate_flag_flag($flag, $entity_id, $account, $flagging) {
    global $user; if( $user->uid ){ 
        if( file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$user->uid.'_sm_needto') ){
            unlink('pdxcache/'.$_SERVER['HTTP_HOST'].'/user/'.$user->uid.'_sm_needto');
        }
    }
}
function pdxseparate_user_login(&$edit, $account) {
    setcookie("pdxuseruid",$account->uid);
    $_SESSION['pdxuseruid']=$account->uid;
    if(isset($account->roles[3])){
        $_SESSION['pdxuserrid']=3;
        setcookie("pdxuserrid",3);
    }elseif(isset($account->roles[4])){
        $_SESSION['pdxuserrid']=4;
        setcookie("pdxuserrid",4);
    }elseif(isset($account->roles[8])){
        $_SESSION['pdxuserrid']=8;
        setcookie("pdxuserrid",8);
    }elseif(isset($account->roles[2])){
        $_SESSION['pdxuserrid']=2;
        setcookie("pdxuserrid",2);
    }elseif(isset($account->roles[6])){
        $_SESSION['pdxuserrid']=2;
        setcookie("pdxuserrid",2);
    }else{
        $_SESSION['pdxuserrid']=0;
        setcookie("pdxuserrid",0);
    }
}
function pdxcreate_mail($mail, $id, $txt, $op=1){
    if( !is_dir('pdxcache/'.$_SERVER['HTTP_HOST'].'/mail') ){
        mkdir('pdxcache/'.$_SERVER['HTTP_HOST'].'/mail');
    }
    if( !is_dir('pdxcache/'.$_SERVER['HTTP_HOST'].'/mail/'.$op) ){
        mkdir('pdxcache/'.$_SERVER['HTTP_HOST'].'/mail/'.$op);
    }
    if( !is_dir('pdxcache/'.$_SERVER['HTTP_HOST'].'/mail/'.$op.'/'.$mail) ){
        mkdir('pdxcache/'.$_SERVER['HTTP_HOST'].'/mail/'.$op.'/'.$mail);
    }
    if( !file_exists('pdxcache/'.$_SERVER['HTTP_HOST'].'/mail/'.$op.'/'.$mail.'/'.$id) ){
        $fp = fopen('pdxcache/'.$_SERVER['HTTP_HOST'].'/mail/'.$op.'/'.$mail.'/'.$id, 'w'); fwrite($fp, $txt); fclose($fp);
    }
}
function pdxseparate_nomessage_form_submit($form, &$form_state){
    $tmpout=array();
    $out= drupal_get_messages('status');
    if( isset($out) and is_array($out) and count($out) ){
        foreach( $out as $ind=>$ou ){
            if( isset($ou) and is_array($ou) and count($ou) ){
                foreach( $ou as $ind2=>$o ){
                    if( strpos($o, 'placeholder')===false ){
                        $tmpout[]=$out[$ind][$ind2];
                    }
                }
            }
        }
    }
    if( isset($tmpout) and is_array($tmpout) and count($tmpout) ){
        drupal_set_message(implode('', $tmpout));
    }
    
}
function pdxgetcitys($cur=1){
    $out='';
    $out.= '<div id="iscityblock">&nbsp;';
    $topath='';
    if($cur){
        if( arg(0)==PDXCAT_NAME ){
            $topath=implode('/', arg());
        }else{
            switch(arg(0)){
            case 'news':
            case 'a':
            case 'i':
            case 'apply':
            case 'rules':
                $topath=arg(0);
                break;
            case 'users':
                if( is_string(arg(1)) and arg(1)=='rents' ){
                    $topath=implode('/', arg());
                }
                break;
            case 'findmy':
            case 'admin':
                $topath=implode('/', arg());
                break;
            case 'node':
                if( isset($_SESSION['pdxpdx_node_tid']) and is_numeric($_SESSION['pdxpdx_node_tid']) ){
                    $topath=PDXCAT_NAME.'/'.$_SESSION['pdxpdx_node_tid'];
                }
                break;
            }
        }
    }
    $out.= '<div id="city_current" onclick=" stpr(event || window.event); "><div id="city_current_is" onclick="showcountrys();" title="Сменить город">';
    if( $cur ){
        $out.= PDX_CITY_NAME;
    }else{
        $out.= 'Ваш город';
    }
    $out.= '</div>';
    $out.= '<div style="display: none;" id="city_current_list"><a target="blank" class="helpme" href="http://'.PDX_URL_HELP.'/vybor-goroda-s-kotorym-vy-budete-rabotat.html" title="Открыть справку в новом окне">&nbsp;</a><noindex>';
    $out.= '<div class="countrydiv">';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://needto.me/index.html"';
    if( !$cur ){
        $out.= ' class="active"';
    }
    $out.= '>все города</a></div>';
    $out.= '</div>';
    $out.= '<div class="countrydiv">';
    $out.= '<div class="countrylbl">Россия</div>';
    
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://sp.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==26 ){
        $out.= ' class="active"';
    }
    $out.= '>Санкт-Петербург</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://ekb.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==1 ){
        $out.= ' class="active"';
    }
    $out.= '>Екатеринбург</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://msc.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==2 ){
        $out.= ' class="active"';
    }
    $out.= '>Москва</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://nsb.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==3 ){
        $out.= ' class="active"';
    }
    $out.= '>Новосибирск</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://smr.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==4 ){
        $out.= ' class="active"';
    }
    $out.= '>Самара</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://tmn.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==5 ){
        $out.= ' class="active"';
    }
    $out.= '>Тюмень</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://chlb.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==6 ){
        $out.= ' class="active"';
    }
    $out.= '>Челябинск</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://nn.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==7 ){
        $out.= ' class="active"';
    }
    $out.= '>Нижний Новгород</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://kzn.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==8 ){
        $out.= ' class="active"';
    }
    $out.= '>Казань</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://omsk.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==9 ){
        $out.= ' class="active"';
    }
    $out.= '>Омск</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://ufa.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==10 ){
        $out.= ' class="active"';
    }
    $out.= '>Уфа</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://krs.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==11 ){
        $out.= ' class="active"';
    }
    $out.= '>Курск</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://perm.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==12 ){
        $out.= ' class="active"';
    }
    $out.= '>Пермь</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://vlg.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==13 ){
        $out.= ' class="active"';
    }
    $out.= '>Волгоград</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://vnzh.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==14 ){
        $out.= ' class="active"';
    }
    $out.= '>Воронеж</a></div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://rnd.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==15 ){
        $out.= ' class="active"';
    }
    $out.= '>Ростов-на-Дону</a></div>';
    
    $out.= '</div>';
    $out.= '<div class="countrydiv">';
    $out.= '<div class="countrylbl">Беларусь</div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://mn.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==28 ){
        $out.= ' class="active"';
    }
    $out.= '>Минск</a></div>';
    $out.= '</div>';
    $out.= '<div class="countrydiv">';
    $out.= '<div class="countrylbl">Украина</div>';
    $out.= '<div class="citylbl"><a rel="nofollow" href="http://od.needto.me/'.$topath.'"';
    if( $cur and PDX_CITY_ID==27 ){
        $out.= ' class="active"';
    }
    $out.= '>Одесса</a></div>';
    $out.= '</div>';
    $out.= '</noindex></div>';
    $out.= '</div>';
    $out.= '</div>';
    
    return $out;
}
function pdxgenhelp(){
    @file_get_contents('http://help.needto.me/render/start.php');
    return;
    
    if( defined('PDX_CITY_ID') and is_numeric(PDX_CITY_ID) and PDX_CITY_ID==28 and file_exists('html/help/index.tpl') ){
        $data=file_get_contents('html/help/index.tpl');
        if( isset($data) and strlen($data) ){
            $sitename='help.needto.me';
            $files=scandir('../../'.$sitename.'/public_html');
            if( isset($files) and is_array($files) and count($files) ){
                foreach( $files as $file ){
                    if( strlen($file)>3 ){
                        unlink('../../'.$sitename.'/public_html/'.$file);
                    }
                }
            }
            copy('html/help/.htaccess', '../../'.$sitename.'/public_html/.htaccess');
            copy('html/help/robots.txt', '../../'.$sitename.'/public_html/robots.txt');
            copy('mistakes.php', '../../'.$sitename.'/public_html/mistakes.php');
            @file_get_contents('http://mn.needto.me/html/help/compress.php');
            $apages=$apagestop=array();
            $datelast=gmdate("D, d M Y H:i:s ")."GMT";
            
            //главная

            $right='<p>На данном сайте мы попытались собрать инструкции по всем аспектам работы с сайтами сети <a href="http://needto.me">needto.me</a>. А также ответы на часто задаваемые вопросы. Ниже вы можете увидеть рубрикатор для доступа к ним.</p><div class="menuis"><ul>';
            
            $anids=pdxgethelpmenu();

            
            if( isset($anids) and is_array($anids) and count($anids) ){
                foreach($anids as $isnid=>$tmpval ){

                    $link=db_query('select alias from {url_alias} where source=\'node/'.$isnid.'\'');
                    $link=$link->fetchAssoc();
                    if( isset($link['alias']) and strlen( $link['alias'] ) ){
                            $link=$link['alias'].'.html';
                            $link='%%'.$link;
                            $link=str_replace('%%help/', '', $link);
                            $link=str_replace('%%', '', $link);
                            $link='/'.$link;
                    }else{
                        $link='node/'.$isnid.'.html';
                    }
                    $title=db_query('select title from {node} where nid='.$isnid);
                    $title=$title->fetchAssoc();
                    if( isset($title['title']) and strlen( $title['title'] ) ){
                        $title=$title['title'];
                    }else{
                        $title='';
                    }
                    $apages[$isnid]['parent']=0;
                    $apages[$isnid]['link']=$link;
                    $apages[$isnid]['mlid']=$isnid;
                    $apages[$isnid]['title']=$title;
                    $apagestop[]='<a class="lnk'.$isnid.'" href="'.$link.'">'.$title.'</a>';
                    $right.='<li><a href="'.$link.'">'.$title.'</a>';
                    
                    if( isset($tmpval) and is_array($tmpval) and count($tmpval) ){
                        $aaddon=array();
                        foreach($tmpval as $isnid2 ){
                            $link=db_query('select alias from {url_alias} where source=\'node/'.$isnid2.'\'');
                            $link=$link->fetchAssoc();
                            if( isset($link['alias']) and strlen( $link['alias'] ) ){
                                    $link=$link['alias'].'.html';
                                    $link='%%'.$link;
                                    $link=str_replace('%%help/', '', $link);
                                    $link=str_replace('%%', '', $link);
                                    $link='/'.$link;
                            }else{
                                $link='node/'.$isnid2.'.html';
                            }
                            $title=db_query('select title from {node} where nid='.$isnid2);
                            $title=$title->fetchAssoc();
                            if( isset($title['title']) and strlen( $title['title'] ) ){
                                $title=$title['title'];
                            }else{
                                $title='';
                            }
                            $apages[$isnid2]['parent']=$isnid;
                            $apages[$isnid2]['link']=$link;
                            $apages[$isnid2]['mlid']=$isnid2;
                            $apages[$isnid2]['title']=$title;
                            $aaddon[]='<li><a href="'.$link.'">'.$title.'</a>';
                        }
                        if( isset($aaddon) and is_array($aaddon) and count($aaddon) ){
                            $right.='<ul>';
                            $right.=implode('', $aaddon);
                            $right.='</ul>';
                        }
                    }

                    $right.='</li>';
                
                
                }
            }
            
            $right.='</ul></div>';
            
            $left='<div class="nothelp">Не нашли ответ на свой вопрос? Задайте его нам на e-mail <span class="thismymail"></span>.</div>';
            
            $filename='index.html';

            $outdata=str_replace('{{TITLE}}', 'Справочная система сети сайтов <a href="http://needto.me">NEEDTO.ME</a>', $data);
            $outdata=str_replace('{{SOC_TITLE}}', 'Справочная система сети сайтов NEEDTO.ME', $outdata);
            $outdata=str_replace('{{SOC_DESC}}', 'Справочная система по работе с сервисом аренды needto.me и его филиалами', $outdata);
            $outdata=str_replace('{{BREADCRUMB}}', '&nbsp;', $outdata);
            $outdata=str_replace('{{LEFT}}', $left, $outdata);
            $outdata=str_replace('{{RIGHT}}', $right, $outdata);
            $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
            if( function_exists('pdxgetcitys') ){
                $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
            }
            $outdata=str_replace('{{META_DESC}}', 'Справочная система по работе с сервисом аренды needto.me и его филиалами.', $outdata);
            $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);
            
//            drupal_set_message('<pre>'.print_r($apages, true). '</pre>');
            
            if( isset($apages) and is_array($apages) and count($apages) ){
                foreach( $apages as $nid => $page ){
                    $right=$soc_body=$meta_desc='';
                    $bread=array();
                    $bread[]='<span typeof="v:Breadcrumb"><a rel="v:url" property="v:title" href="/">В начало справки</a></span>';
                    
                    $body=db_query('select b.body_value, y.field_youtube_video_id from {field_data_body} as b left join {field_data_field_youtube} as y on (b.entity_id=y.entity_id and y.entity_type=\'node\') where b.entity_type=\'node\' and b.entity_id='.$nid);
                    $body=$body->fetchAssoc();
                    if( isset($body['field_youtube_video_id']) and strlen($body['field_youtube_video_id']) ){
                        $right.='<div class="video"><div class="videoin"><iframe id="youtube-field-player" class="youtube-field-player" width="100%" height="291px" src="https://www.youtube.com/embed/'.$body['field_youtube_video_id'].'?wmode=opaque" title="Видео по теме '.str_replace('"', '', $page['title']).'" frameborder="0" allowfullscreen></iframe></div></div>';
                    }
                    
                    if( isset($body['body_value']) and strlen($body['body_value']) ){
                        $right.=$body['body_value'];
                        $soc_body=$meta_desc=str_replace('"', '', strip_tags($body['body_value']));
                        if( mb_strlen($soc_body)>64 ){
                            $soc_body=mb_substr($soc_body,0,61).'...';
                        }
                        if( mb_strlen($meta_desc)>250 ){
                            $meta_desc=mb_substr($meta_desc,0,247).'...';
                        }
                    }



                    $moreis='';
                    $in=array();
                    if( isset( $anids[$nid] ) and is_array($anids[$nid]) and count( $anids[$nid] ) ){
                        foreach( $anids[$nid] as $nextnid ){
                            $isnid=$nextnid;
                            if( isset($apages[$isnid]['link']) and strlen($apages[$isnid]['link']) ){
                                $in[]='<li><a href="'.$apages[$isnid]['link'].'">'.$apages[$isnid]['title'].'</a></li>';
                            }
                        }
                    }
                    if( isset($in) and is_array($in) and count($in) ){
                        $moreis.= '<div class="ts"><div class="ttl">Читайте далее:</div><ul>';
                        $moreis.= implode('',$in);
                        $moreis.= '</ul></div>';
                    }else{
                        
                        if( isset( $apages[$nid]['parent'] ) and is_numeric( $apages[$nid]['parent'] ) and $apages[$nid]['parent']>0 and isset( $anids[$apages[$nid]['parent']] ) and is_array($anids[$apages[$nid]['parent']]) and count( $anids[$apages[$nid]['parent']] ) ){
                            foreach( $anids[$apages[$nid]['parent']] as $nextnid ){
                                $isnid=$nextnid;
                                if( isset($apages[$isnid]['link']) and strlen($apages[$isnid]['link']) ){
                                    $active='';
                                    if( $isnid==$nid ){
                                        $active=' class="active"';
                                    }
                                    $in[]='<li><a href="'.$apages[$isnid]['link'].'"'.$active.'>'.$apages[$isnid]['title'].'</a></li>';
                                }
                            }
                        }

                        if( isset($in) and is_array($in) and count($in) ){
                            if( count($in)>1 ){
                                $moreis.= '<div class="ts"><div class="ttl">Читайте далее:</div><ul>';
                                $moreis.= implode('',$in);
                                
                                
                                $moreis.= '<li class="article_back"><a href="'.$apages[$apages[$isnid]['parent']]['link'].'">Наверх к «';
                                $moreis.= $apages[$apages[$isnid]['parent']]['title'];
                                $moreis.= '»</a></li>';
                                $moreis.= '</ul></div>';
                            }elseif( isset( $apages[$nid]['parent'] ) and is_numeric( $apages[$nid]['parent'] ) and $apages[$nid]['parent']==0 ){

                                $in=array();
                                
                                
                                if( isset( $anids ) and is_array($anids) and count( $anids ) ){
                                    foreach( $anids as $isnid => $nextnid ){
                                        if( isset($apages[$isnid]['link']) and strlen($apages[$isnid]['link']) ){
                                            $active='';
                                            if( $isnid==$nid ){
                                                $active=' class="active"';
                                            }
                                            $in[]='<li><a href="'.$apages[$isnid]['link'].'"'.$active.'>'.$apages[$isnid]['title'].'</a></li>';
                                        }
                                    }
                                }
                                
                                
                                if( isset($in) and is_array($in) and count($in) ){
                                    $moreis.= '<div class="ts"><div class="ttl">Читайте далее:</div><ul>';
                                    $moreis.= implode('',$in);
                                    $moreis.= '</ul></div>';
                                }
                            }
                        }elseif( isset( $apages[$nid]['parent'] ) and is_numeric( $apages[$nid]['parent'] ) and $apages[$nid]['parent']==0 ){

                                $in=array();
                                
                                
                                if( isset( $anids ) and is_array($anids) and count( $anids ) ){
                                    foreach( $anids as $isnid => $nextnid ){
                                        if( isset($apages[$isnid]['link']) and strlen($apages[$isnid]['link']) ){
                                            $active='';
                                            if( $isnid==$nid ){
                                                $active=' class="active"';
                                            }
                                            $in[]='<li><a href="'.$apages[$isnid]['link'].'"'.$active.'>'.$apages[$isnid]['title'].'</a></li>';
                                        }
                                    }
                                }
                                
                                
                                if( isset($in) and is_array($in) and count($in) ){
                                    $moreis.= '<div class="ts"><div class="ttl">Читайте далее:</div><ul>';
                                    $moreis.= implode('',$in);
                                    $moreis.= '</ul></div>';
                                }
                            }
                    }
                    if( isset($moreis) and strlen($moreis) ){
                        $right.=$moreis;
                    }

                    $left='';
                    if( isset($apagestop) and is_array($apagestop) and count($apagestop) ){
                        $left.='<div class="menuis"><ul>';
                        foreach( $apagestop as $apagest ){
                            $left.='<li>';
                            $isact=0;
                            $curnid=$nid;
                            if( isset($page['parent']) and is_numeric($page['parent']) and $page['parent']>0 ){
                                $curnid=$page['parent'];
                            }
                            if( strpos($apagest, 'class="lnk'.$curnid.'"')===false ){}else{
                                $apagest=str_replace('class="lnk'.$curnid.'"', 'class="lnk'.$curnid.' active"', $apagest);
                                $isact=1;
                            }
                            $left.=$apagest;
                            if( $isact ){

                                $aaddon=array();
                                if( isset( $anids[$curnid] ) and is_array($anids[$curnid]) and count( $anids[$curnid] ) ){
                                    foreach( $anids[$curnid] as $nextnid ){
                                        $isnid2=$nextnid;
                                        if( isset($apages[$isnid2]['link']) and strlen($apages[$isnid2]['link']) ){
                                            $in[]='<li><a href="'.$apages[$isnid2]['link'].'">'.$apages[$isnid2]['title'].'</a></li>';
                                        }
                                        if( $nid==$isnid2 ){
                                            $aaddon[]='<li><a href="'.$apages[$isnid2]['link'].'" class="active">'.$apages[$isnid2]['title'].'</a>';
                                        }else{
                                            $aaddon[]='<li><a href="'.$apages[$isnid2]['link'].'">'.$apages[$isnid2]['title'].'</a>';
                                        }
                                    }
                                }                                

                                if( isset($aaddon) and is_array($aaddon) and count($aaddon) ){
                                    $left.='<ul>';
                                    $left.=implode('', $aaddon);
                                    $left.='</ul>';
                                }

                            }
                            $left.='</li>';
                        }
                        $left.='</ul></div><div class="nothelp">Не нашли ответ на свой вопрос? Задайте его нам на e-mail <span class="thismymail"></span>.</div>';
                    }

                    if( isset($page['parent']) and is_numeric($page['parent']) and $page['parent']>0 and isset( $apages[$page['parent']]['link'] ) and isset( $apages[$page['parent']]['title'] ) ){
                        $bread[]='<span typeof="v:Breadcrumb"><a rel="v:url" property="v:title" href="'.$apages[$page['parent']]['link'].'">'.$apages[$page['parent']]['title'].'</a></span>';
                    }
                    
                    $filename=$page['link'];
                    $soc_title=$page['title'];
                    if( mb_strlen($soc_title)>64 ){
                        $soc_title=mb_substr($soc_title,0,61).'...';
                    }
        
                    $outdata=str_replace('{{TITLE}}', $page['title'], $data);
                    $outdata=str_replace('{{SOC_TITLE}}', $soc_title, $outdata);
                    $outdata=str_replace('{{SOC_DESC}}', $soc_body, $outdata);
                    $outdata=str_replace('{{BREADCRUMB}}', implode(' / ', $bread), $outdata);
                    $outdata=str_replace('{{LEFT}}', $left, $outdata);
                    $outdata=str_replace('{{RIGHT}}', $right, $outdata);
                    $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
                    $outdata=str_replace('{{META_DESC}}', $meta_desc, $outdata);
                    if( function_exists('pdxgetcitys') ){
                        $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
                    }
                    $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);
                                
                }
            }
            

        }
    }
}
function pdxgenfront(){
    @file_get_contents('http://needto.me/render/start.php');
    return;
    
    if( isset($_SERVER['HTTP_HOST']) and strlen( $_SERVER['HTTP_HOST'] ) and strpos($_SERVER['HTTP_HOST'], 'site')===false and strpos($_SERVER['HTTP_HOST'], 'localhost')===false and strpos($_SERVER['HTTP_HOST'], '.loc')===false ){
    }else{
        return;
    }
    if( defined('PDX_CITY_ID') and is_numeric(PDX_CITY_ID) and PDX_CITY_ID==28 and file_exists('html/front/index.tpl') ){
        $data=file_get_contents('html/front/index.tpl');
        $data2=file_get_contents('html/front/other.tpl');
        if( isset($data) and strlen($data) and isset($data2) and strlen($data2) ){
            $sitename='needto.me';

            copy('html/front/.htaccess', '../../'.$sitename.'/public_html/.htaccess');
            copy('html/front/robots.txt', '../../'.$sitename.'/public_html/robots.txt');
            copy('mistakes.php', '../../'.$sitename.'/public_html/mistakes.php');
            @file_get_contents('http://mn.needto.me/html/front/compress.php');
            $apages=$apagestop=array(); 
            $datelast=gmdate("D, d M Y H:i:s ")."GMT";
            
            //главная

            $right='<div id="frontmap" style="width: 100%;"></div><div id="plashka"><div class="block"><div class="block-title"><a href="/news.html">Наши новости</a></div><div class="cnt">';
            $nums=db_query('select title from {node} where status=1 and type=\'news\' order by created desc limit 0,3');
            while( $num=$nums->fetchAssoc() ){
                $right.='<div class="news_item">'.$num['title'].'</div>';
            }
            $right.='<div class="tolink"><a href="/news.html">Еще новости</a></div></div></div></div>';

            
            $filename='index.html';

            $outdata=str_replace('{{SOC_TITLE}}', 'Аренда полезных вещей в Вашем городе', $data);
            $outdata=str_replace('{{SOC_DESC}}', 'Берите в аренду нужные вещи, и сдавайте в аренду то, что вам не нужно в данный момент', $outdata);
            $outdata=str_replace('{{RIGHT}}', $right, $outdata);
            $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
            $outdata=str_replace('{{META_DESC}}', 'Всё, что можно взять в аренду, вы найдете у нас! А также на нашей площадке вы можете сдавать в аренду собственные вещи, которые вам в данный момент не нужны. Зарабатывая на них дополнительные деньги.', $outdata);
            if( function_exists('pdxgetcitys') ){
                $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
            }
            $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);


            //новости

            $right='<div id="center_content"><div class="block-title">Наши новости</div><div class="cnt">';
            $nums=db_query('select n.title, b.body_value, i.field_image_fid from {node} as n inner join {field_data_body} as b on n.nid=b.entity_id left join {field_data_field_image} as i on (n.nid=i.entity_id and i.entity_type=\'node\') where n.status=1 and n.type=\'news\' order by n.created desc limit 0,77');
            while( $num=$nums->fetchAssoc() ){
                $img='';
                $right.='<div class="news_line">';
                if( isset( $num['field_image_fid'] ) and is_numeric( $num['field_image_fid'] ) ){
                    $file = file_load($num['field_image_fid']);
                    if( isset( $file->uri ) and strlen( $file->uri ) ){
                        $img=image_style_url('news_preview', $file->uri);
                    }
                    if( isset($img) and strlen($img) ){
                        $right.='<div class="image"><img alt="" src="'.$img.'" /></div>';
                    }
                    
                }
                $right.='<div class="news_right"><div class="title">'.$num['title'].'</div><div class="body">'.$num['body_value'].'</div></div><div class="clear">&nbsp;</div></div>';
            }
            $right.='</div></div>';

            
            $filename='news.html';
            $outdata=str_replace(' href="/'.$filename.'"', ' class="active" href="/'.$filename.'"', $data2);

            $outdata=str_replace('{{SOC_TITLE}}', 'Последние новости сайта аренды вещей NEEDTO.ME', $outdata);
            $outdata=str_replace('{{SOC_DESC}}', 'Что изменилось на сайтах сети NEEDTO.ME, какие новые возможности были добавлены, вы сможете узнать здесь', $outdata);
            $outdata=str_replace('{{RIGHT}}', $right, $outdata);
            $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
            $outdata=str_replace('{{META_DESC}}', 'Последние новости сайта аренды вещей NEEDTO.ME: все о новом функционале и улучшениях в текущих возможностях', $outdata);
            if( function_exists('pdxgetcitys') ){
                $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
            }
            $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);


            if( function_exists('pdxgettexts') ){
                //реклама на сайте
                $right='<div id="center_content"><div class="block-title">Реклама на сайте NEEDTO.ME выбранного города</div><div class="cnt">'.pdxgettexts('a').'<div class="clear">&nbsp;</div></div>';
                $filename='a.html';
                $outdata=str_replace(' href="/'.$filename.'"', ' class="active" href="/'.$filename.'"', $data2);
                $outdata=str_replace('{{SOC_TITLE}}', 'Реклама на сайте NEEDTO.ME Вашего города', $outdata);
                $outdata=str_replace('{{SOC_DESC}}', 'Мы готовы к любому сотрудничеству. Пишите или звоните нам.', $outdata);
                $outdata=str_replace('{{RIGHT}}', $right, $outdata);
                $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
                $outdata=str_replace('{{META_DESC}}', 'Заказать рекламу на сайте NEEDTO.ME Вашего города', $outdata);
                if( function_exists('pdxgetcitys') ){
                    $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
                }
                $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);
                //для прессы
                $right='<div id="center_content"><div class="block-title">Для прессы</div><div class="cnt">'.pdxgettexts('press').'</div><div class="clear">&nbsp;</div></div>';
                $filename='press.html';
                $outdata=str_replace(' href="/'.$filename.'"', ' class="active" href="/'.$filename.'"', $data2);
                $outdata=str_replace('{{SOC_TITLE}}', 'Информация для прессы', $outdata);
                $outdata=str_replace('{{SOC_DESC}}', 'Хотите написать о нас статью? Предложить сотрудничество? Задать какие-либо вопросы? Мы открыты для любого сотрудничества, и с радостью рассмотрим Ваши предложения', $outdata);
                $outdata=str_replace('{{RIGHT}}', $right, $outdata);
                $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
                $outdata=str_replace('{{META_DESC}}', 'Хотите написать о нас статью? Предложить сотрудничество? Задать какие-либо вопросы? Мы открыты для любого сотрудничества, и с радостью рассмотрим Ваши предложения', $outdata);
                if( function_exists('pdxgetcitys') ){
                    $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
                }
                $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);
                //api
                $right='<div id="center_content"><div class="block-title">Наш API</div><div class="cnt">'.pdxgettexts('apime').'</div><div class="clear">&nbsp;</div></div>';
                $filename='apime.html';
                $outdata=str_replace(' href="/'.$filename.'"', ' class="active" href="/'.$filename.'"', $data2);
                $outdata=str_replace('{{SOC_TITLE}}', 'Наш API', $outdata);
                $outdata=str_replace('{{SOC_DESC}}', 'API для доступа к материалам сайта NEEDTO.ME в вашем городе.', $outdata);
                $outdata=str_replace('{{RIGHT}}', $right, $outdata);
                $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
                $outdata=str_replace('{{META_DESC}}', 'API для доступа к материалам сайта NEEDTO.ME в вашем городе.', $outdata);
                if( function_exists('pdxgetcitys') ){
                    $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
                }
                $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);
                //rules
                $right='<div id="center_content"><div class="block-title">Правила сайтов сети NEEDTO.ME</div><div class="cnt">'.pdxgettexts('rules').'</div><div class="clear">&nbsp;</div></div>';
                $filename='rules.html';
                $outdata=str_replace(' href="/'.$filename.'"', ' class="active" href="/'.$filename.'"', $data2);
                $outdata=str_replace('{{SOC_TITLE}}', 'Наши правила', $outdata);
                $outdata=str_replace('{{SOC_DESC}}', 'Пользовательское соглашение по работе с сервисами сайта NEEDTO.ME.', $outdata);
                $outdata=str_replace('{{RIGHT}}', $right, $outdata);
                $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
                $outdata=str_replace('{{META_DESC}}', 'Пользовательское соглашение по работе с сервисами сайта NEEDTO.ME.', $outdata);
                if( function_exists('pdxgetcitys') ){
                    $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
                }
                $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);
                //dev
                $right='<div id="center_content"><div class="block-title">Нужен сайт? Нам по плечу проекты любой сложности!</div><div class="cnt">'.pdxgettexts('dev').'</div><div class="clear">&nbsp;</div></div>';
                $filename='dev.html';
                $outdata=str_replace(' href="/'.$filename.'"', ' class="active" href="/'.$filename.'"', $data2);
                $outdata=str_replace('{{SOC_TITLE}}', 'Нужен сайт? Нам по плечу проекты любой сложности!', $outdata);
                $outdata=str_replace('{{SOC_DESC}}', 'Наша команда всегда готова предложить вам свои услуги по разработке проектов любой сложности.', $outdata);
                $outdata=str_replace('{{RIGHT}}', $right, $outdata);
                $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
                $outdata=str_replace('{{META_DESC}}', 'Наша команда всегда готова предложить вам свои услуги по разработке проектов любой сложности. Мы занимаемся именно полным циклом запуска проекта: от его разработки, до запуска и первоначального продвижения.', $outdata);
                if( function_exists('pdxgetcitys') ){
                    $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
                }
                $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);
                //apply
                $right='<div id="center_content"><div class="block-title">Соглашение об использовании личных данных</div><div class="cnt">'.pdxgettexts('apply').'</div><div class="clear">&nbsp;</div></div>';
                $filename='apply.html';
                $outdata=str_replace(' href="/'.$filename.'"', ' class="active" href="/'.$filename.'"', $data2);
                $outdata=str_replace('{{SOC_TITLE}}', 'Соглашение об использовании личных данных', $outdata);
                $outdata=str_replace('{{SOC_DESC}}', 'Я выражаю согласие на обработку своих персональных данных, включая сбор, систематизацию, накопление, хранение, уточнение, использование, уничтожение персональных данных.', $outdata);
                $outdata=str_replace('{{RIGHT}}', $right, $outdata);
                $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
                $outdata=str_replace('{{META_DESC}}', 'Я выражаю согласие на обработку своих персональных данных, включая сбор, систематизацию, накопление, хранение, уточнение, использование, уничтожение персональных данных.', $outdata);
                if( function_exists('pdxgetcitys') ){
                    $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
                }
                $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);
                //i
                $right='<div id="center_content"><div class="block-title">Инвестирование в наш Интернет-ресурс</div><div class="cnt">'.pdxgettexts('i').'</div><div class="clear">&nbsp;</div></div>';
                $filename='i.html';
                $outdata=str_replace(' href="/'.$filename.'"', ' class="active" href="/'.$filename.'"', $data2);
                $outdata=str_replace('{{SOC_TITLE}}', 'Инвестирование в наш Интернет-ресурс', $outdata);
                $outdata=str_replace('{{SOC_DESC}}', 'Мы представляем одну из первых площадок, на которых любой пользователь может сдать свой товар в аренду.', $outdata);
                $outdata=str_replace('{{RIGHT}}', $right, $outdata);
                $outdata=str_replace('{{DATELAST}}', $datelast, $outdata);
                $outdata=str_replace('{{META_DESC}}', 'Мы представляем одну из первых площадок, на которых любой пользователь может сдать свой товар в аренду.', $outdata);
                if( function_exists('pdxgetcitys') ){
                    $outdata=str_replace('{{CITY}}', pdxgetcitys(0), $outdata);
                }
                $fp = fopen('../../'.$sitename.'/public_html/'.$filename, 'w'); fwrite($fp, $outdata); fclose($fp);
                
            }
            

        }
    }
}
function pdx_reapi($name, $uid){
    $newkey='';
    
    if( !is_dir('pdxcache/api') ){
        mkdir('pdxcache/api');
    }
    if( !is_dir('pdxcache/api/keys') ){
        mkdir('pdxcache/api/keys');
    }
    if( file_exists('pdxcache/api/'.$uid) ){
        $data=file_get_contents('pdxcache/api/'.$uid);
        if( isset($data) and strlen($data) ){
            if( file_exists('pdxcache/api/keys/'.urlencode($data)) ){
                unlink('pdxcache/api/keys/'.urlencode($data));
            }
        }
    }

    require_once DRUPAL_ROOT . '/includes/password.inc';
    while(1){
        $newkey=user_hash_password($name.mt_rand(3333,7777));
        $newkey=str_replace('"','',$newkey);
        $newkey=str_replace("'",'',$newkey);

        if( !file_exists('pdxcache/api/keys/'.urlencode($newkey)) ){
            break;
        }
    }
    if( strlen($newkey) ){
        $fp = fopen('pdxcache/api/keys/'.urlencode($newkey), 'w'); fwrite($fp, $uid); fclose($fp);
        $fp = fopen('pdxcache/api/'.$uid, 'w'); fwrite($fp, $newkey); fclose($fp);
    }    
}
function pdxgetshare($title='', $desc='', $img='', $url=''){
    if( !isset($img) or !strlen($img) ){
        $img='http://'.$_SERVER['HTTP_HOST'].'/sites/all/themes/pdxneedto/src512x512.jpg';
    }
    $out='';
    $out.='<div class="clear">&nbsp;</div><div class="itemis_bottom">';
    $out.=pdxgetshare2($title, $desc, $img, $url);
    $out.='</div>';
    return $out;
}
function pdxgetshare3($title='', $desc='', $img='', $url=''){
    if( !isset($img) or !strlen($img) ){
        $img='http://'.$_SERVER['HTTP_HOST'].'/sites/all/themes/pdxneedto/src512x512.jpg';
    }
    $out='';
    $out.='<div class="clear">&nbsp;</div><div class="itemis_bottom2">';
    $out.=pdxgetshare2($title, $desc, $img, $url);
    $out.='</div>';
    return $out;
}
function pdxgetshare2($title='', $desc='', $img='', $url=''){
    $out='';
    $out.='<div class="ya-share2"';
    if( isset($url) and strlen($url) ){
        $url=str_replace('"', '', $url);
        $out.= ' data-url="'.$url.'"';
    }
    if( isset($title) and strlen($title) ){
        $title=str_replace('"', '', $title);
        $out.= ' data-title="'.$title.'"';
    }
    if( isset($desc) and strlen($desc) ){
        $desc=str_replace('"', '', $desc);
        $out.= ' data-description="'.$desc.'"';
    }
    $out.=' data-image="'.$img.'" data-services="vkontakte,facebook,odnoklassniki,moimir,gplus,twitter,lj,viber,whatsapp" data-counter></div>';
    return $out;
}
function pdxskipreviewtd($title){
    switch($title){
        case 'E-mail':
        case 'Сумма':
            return '';
        case 'Оплата':
            $title='Способ оплаты';
            break;
    }
    return $title;
}
function pdxreplacereviewtd(){
    $out='';
    if( isset($_SESSION['cart_order']) and is_numeric($_SESSION['cart_order']) ){
        $isorder=uc_order_load($_SESSION['cart_order']);
        if( isset($isorder->order_total) and is_numeric($isorder->order_total) ){
            $out.='<tr><td class="title-col">Сумма для оплаты:</td><td class="data-col">'.$isorder->order_total.' ';
            $out.=PDX_CITY_CUR;
            $out.='</td></tr>';
            if( isset($isorder->payment_method) and strlen($isorder->payment_method) ){
                $out.='</tr><td class="title-col">Способ оплаты:</td><td class="data-col">';
                switch($isorder->payment_method){
                    case 'webmoney':
                        $out.='Webmoney';
                        break;
                    case 'ya_ubercart':
                        $out.='Яндекс.Касса';
                        break;
                    default:
                        $out.='Кредитная карта';
                }
                $out.='</td></tr>';
            }
        }
    }
    
    
    
    return $out;
}
function pdxgethelpmenu(){
    $anids=array();
                $anids=array(
                    163=>array(),
                    136=>array(142, 144, 143, 151, 1890),
                    137=>array(),
                    139=>array(150, 152, 153, 154),
                    138=>array(156, 167, 168),
                    141=>array(145, 146),
                    1734=>array(1735),
                    140=>array(164, 165, 171, 147, 148, 149),
                    1892=>array(),
                    4480=>array(),
                );
    if( file_exists('pdxcache/') ){
        
    }
    
    return $anids;
}